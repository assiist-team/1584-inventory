<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      /* MOBILE-FIRST: Default to mobile layout for forms */
      /* ULTIMATE OVERRIDE: Force mobile layout regardless of parent container */
      * {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 100% !important;
      }

      body{
        font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        padding:16px;
        margin:0;
        font-size:16px;
        overflow-x:hidden;
        width:100% !important;
        max-width:100% !important;
        min-width:100% !important;
      }
      label{
        display:block;
        margin-top:16px;
        margin-bottom:8px;
        font-size:16px;
      }
      input, textarea{
        width:100%;
        padding:12px;
        border-radius:6px;
        border:1px solid #ddd;
        font-size:16px;
        min-height:44px;
        box-sizing:border-box;
      }
      .primary{
        background:#9C8160;
        color:#fff;
        padding:12px;
        border-radius:8px;
        border:none;
        margin-top:12px;
        min-height:44px;
        font-size:16px;
      }
      .btn {
        background:#f7f7f7;
        color:#222;
        padding:12px 16px;
        border-radius:8px;
        border:1px solid #ddd;
        cursor:pointer;
        min-height:44px;
        font-size:16px;
        width:100%;
        margin-top:8px;
      }
      .btn:hover { background:#efefef; }
      .btn.ghost { background:transparent; border-color:#ddd; }
      .btn.btn-icon {
        box-sizing: border-box;
        padding:8px;
        font-size:16px;
        height:44px;
        width:44px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        border-radius:8px;
        min-height:44px;
        min-width:44px;
      }
      .btn.btn-icon svg { width:24px; height:24px; }
      /* Bookmark active state: fill icon with current color and remove stroke so it appears filled */
      .btn.btn-icon.active svg * { fill: currentColor !important; stroke: none !important; }
      /* Ensure SVG strokes remain visible and inherit the button border color for consistent appearance */
      .btn.btn-icon svg * { stroke: currentColor; stroke-width: 1px; }

      /* SPECIFICALLY TARGET 50% WIDTH CONTAINERS */
      /* This should catch any container with width: 50% or similar desktop constraints */
      div[style*="width: 50%"],
      div[style*="max-width: 50%"],
      div[style*="width:468px"],
      div[style*="width: 50"],
      [style*="width: 50%"],
      [style*="max-width: 50%"],
      [style*="width:468px"] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 100% !important;
        position: static !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Mobile-specific overrides for better responsive behavior */
      @media (max-width: 480px) {
        body { padding: 12px; }
        /* Increase touch targets */
        .btn.btn-icon { height: 44px; width: 44px; padding: 8px; }
        /* Ensure full width usage */
        input, textarea, select { width: 100%; min-width: 0; }
        /* Improve form layout on mobile */
        label { margin-top: 16px; margin-bottom: 8px; }
        /* Prevent horizontal overflow */
        body, div { overflow-wrap: anywhere; word-break: break-word; }
      }

      /* Touch-device override: force full-screen layout on touch devices
         This addresses layout viewport issues on mobile devices */
      @media (hover: none) and (pointer: coarse), (max-width: 500px) {
        /* Override body for full-screen mobile layout */
        body {
          padding: 12px !important;
          margin: 0 !important;
          overflow-x: hidden !important;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial !important;
          font-size: 16px !important;
        }
        /* Override main container */
        #formRoot {
          padding: 0 !important;
          margin: 0 !important;
          width: 100% !important;
          max-width: 100% !important;
        }
        /* Ensure form controls use full width on touch devices */
        input, textarea, select {
          width: 100% !important;
          min-width: 0 !important;
          font-size: 16px !important;
          padding: 12px !important;
          min-height: 44px !important;
          box-sizing: border-box !important;
        }
        /* Override form row layout */
        .form-row {
          flex-direction: column !important;
          gap: 8px !important;
          width: 100% !important;
        }
        .form-row > * {
          width: 100% !important;
          min-width: 0 !important;
        }
        /* Increase touch targets for all buttons */
        .btn {
          min-height: 44px !important;
          padding: 10px 14px !important;
          font-size: 16px !important;
          width: 100% !important;
          margin-top: 8px !important;
        }
        .btn.btn-icon {
          height: 44px !important;
          width: 44px !important;
          padding: 8px !important;
          min-height: 44px !important;
          min-width: 44px !important;
        }
        /* Override labels */
        label {
          font-size: 16px !important;
          margin-top: 16px !important;
          margin-bottom: 8px !important;
        }
        /* Override key-value grid */
        .kv {
          grid-template-columns: auto 1fr !important;
          gap: 12px !important;
          margin-bottom: 12px !important;
        }
        .field-label {
          font-size: 14px !important;
        }
        .field-value {
          font-size: 16px !important;
        }
        /* Override toolbar */
        .toolbar {
          gap: 8px !important;
          flex-wrap: wrap !important;
        }
      }
    </style>

    <!-- Fallback JavaScript override for mobile devices when CSS media queries fail -->
    <script>
      (function() {
        // ULTIMATE MOBILE OVERRIDE: Force mobile layout regardless of parent container
        function applyLayoutOverrides() {
          // Multiple detection methods to catch mobile devices in Google Apps Script
          var isMobileScreen = window.screen && window.screen.width < 500;
          var isTouchDevice = window.matchMedia && window.matchMedia('(hover: none) and (pointer: coarse)').matches;
          var isSmallViewport = window.innerWidth < 600;
          var isGoogleAppsScript = window.location.hostname === 'script.google.com';
          var isDesktopWithMouse = window.matchMedia && window.matchMedia('(min-width: 901px) and (pointer: fine) and (hover: hover)').matches;

          console.log('ULTIMATE: Screen:', window.screen.width, 'InnerWidth:', window.innerWidth, 'Touch:', isTouchDevice, 'Desktop:', isDesktopWithMouse, 'GAS:', isGoogleAppsScript);

          // Apply mobile overrides if ANY mobile condition is detected
          if ((isMobileScreen || isTouchDevice || isSmallViewport) && (isGoogleAppsScript || !isDesktopWithMouse)) {
            console.log('ULTIMATE: Applying aggressive ItemForm mobile overrides');

            var body = document.body;
            var formRoot = document.getElementById('formRoot');
            var allElements = document.querySelectorAll('*');

            // FORCE MOBILE LAYOUT ON ALL ELEMENTS
            if (body) {
              var bodyStyle = body.style;
              body.style.cssText = `
                margin: 0 !important;
                padding: 16px !important;
                overflow-x: hidden !important;
                font-size: 16px !important;
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial !important;
              `;
            }

            if (formRoot) {
              var formRootStyle = formRoot.style;
              formRoot.style.cssText = `
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                box-sizing: border-box !important;
              `;
            }

            // Override any parent containers that might be constraining width
            allElements.forEach(function(el) {
              if (el !== body && el !== formRoot) {
                var computedStyle = window.getComputedStyle(el);
                if (computedStyle.width === '50%' || computedStyle.maxWidth === '50%' || computedStyle.width === '468px') {
                  console.log('ULTIMATE: Overriding parent container:', el.tagName, computedStyle.width);
                  el.style.setProperty('width', '100%', 'important');
                  el.style.setProperty('max-width', '100%', 'important');
                  el.style.setProperty('min-width', '100%', 'important');
                }
              }
            });

            // Force all inputs to mobile size
            var allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(function(input) {
              var inputStyle = input.style;
              inputStyle.setProperty('font-size', '16px', 'important');
              inputStyle.setProperty('padding', '12px', 'important');
              inputStyle.setProperty('min-height', '44px', 'important');
              inputStyle.setProperty('width', '100%', 'important');
              inputStyle.setProperty('box-sizing', 'border-box', 'important');
            });

            // Force all buttons to mobile size
            var allButtons = document.querySelectorAll('.btn, button');
            allButtons.forEach(function(btn) {
              var btnStyle = btn.style;
              btnStyle.setProperty('min-height', '44px', 'important');
              btnStyle.setProperty('padding', '12px 16px', 'important');
              btnStyle.setProperty('font-size', '16px', 'important');
              btnStyle.setProperty('width', '100%', 'important');
              btnStyle.setProperty('margin-top', '8px', 'important');
            });

            // Force all icon buttons to mobile size
            var iconButtons = document.querySelectorAll('.btn.btn-icon');
            iconButtons.forEach(function(btn) {
              var btnStyle = btn.style;
              btnStyle.setProperty('height', '44px', 'important');
              btnStyle.setProperty('width', '44px', 'important');
              btnStyle.setProperty('padding', '8px', 'important');
              btnStyle.setProperty('min-height', '44px', 'important');
              btnStyle.setProperty('min-width', '44px', 'important');
            });

            // Force all labels to mobile size
            var labels = document.querySelectorAll('label');
            labels.forEach(function(label) {
              var labelStyle = label.style;
              labelStyle.setProperty('font-size', '16px', 'important');
              labelStyle.setProperty('margin-top', '16px', 'important');
              labelStyle.setProperty('margin-bottom', '8px', 'important');
            });
          }
        }

        // Apply immediately and repeatedly to ensure it takes effect
        applyLayoutOverrides();
        setTimeout(applyLayoutOverrides, 50);
        setTimeout(applyLayoutOverrides, 100);
        setTimeout(applyLayoutOverrides, 300);
        setTimeout(applyLayoutOverrides, 1000);

        // Listen for resize and media query changes
        window.addEventListener('resize', applyLayoutOverrides);
        window.addEventListener('orientationchange', applyLayoutOverrides);

        // Also listen for media query changes
        if (window.matchMedia) {
          var mediaQueries = [
            window.matchMedia('(min-width: 901px) and (pointer: fine) and (hover: hover)'),
            window.matchMedia('(hover: none) and (pointer: coarse)'),
            window.matchMedia('(max-width: 900px)')
          ];

          mediaQueries.forEach(function(mq) {
            mq.addListener(applyLayoutOverrides);
          });
        }
      })();
    </script>
  </head>
  <body>
    <h3 id="itemFormTitle">Edit Item</h3>
    <div id="debug" style="white-space:pre-wrap;color:#666;margin-bottom:12px;font-size:13px">Debug output will appear here.</div>
    <div id="formRoot">Loading…</div>
    
    <script>
      var itemId = '<?= itemUrlId ?>';
      var BASE_URL = '<?= baseUrl ?>';
      var PRINTER_SVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9h12v6H6z"></path><path d="M6 9V6h12v3"></path><rect x="9" y="13" width="6" height="4"></rect></svg>';
      var BOOKMARK_SVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12v18l-6-4-6 4V2z"></path></svg>';
      function writeDebug(msg){ var d = document.getElementById('debug'); if (d) d.textContent = msg; else console.log(msg); }
      function escapeHtml(str){ return String(str||'').replace(/[&<>\"]/g,function(s){return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s]}); }
      // Render a non-edit detailed view of the item (key/value layout) with Edit/Bookmark/Print
      function renderView(item){
        var root = document.getElementById('formRoot');
        var html = '';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
        html += '<div style="font-size:18px;font-weight:600">' + escapeHtml(item.description || '(No description)') + '</div>';
        var bmState = (item && (item.bookmark === true || String(item.bookmark).toUpperCase() === 'TRUE')) ? ' active' : '';
        html += '<div class="toolbar"><button id="editBtn" class="primary">Edit</button><button id="bookmarkViewBtn" class="btn btn-icon' + bmState + '" data-item-id="' + encodeURIComponent(item.item_id||'') + '" title="Bookmark">' + BOOKMARK_SVG + '</button><button id="printViewBtn" class="btn btn-icon" data-item-id="' + encodeURIComponent(item.item_id||'') + '" data-qr-key="' + encodeURIComponent(item.qr_key||'') + '" title="Print QR">' + PRINTER_SVG + '</button></div>';
        html += '</div>';
        html += '<div style="margin-top:8px">';
        html += '<div><strong>Description</strong><div>' + escapeHtml(item.description || '') + '</div></div>';
        html += '<div><strong>Source</strong><div>' + escapeHtml(item.source || '') + '</div></div>';
        html += '<div><strong>SKU</strong><div>' + escapeHtml(item.sku || '') + '</div></div>';
        html += '<div><strong>Price</strong><div>' + escapeHtml(item.price || '') + '</div></div>';
        html += '<div><strong>1584 Resale Price</strong><div>' + escapeHtml(item["1584_resale_price"] || item.resale_price || '') + '</div></div>';
        html += '<div><strong>Market Value</strong><div>' + escapeHtml(item.market_value || '') + '</div></div>';
        html += '<div><strong>Payment Method</strong><div>' + escapeHtml(item.payment_method || '') + '</div></div>';
        html += '<div><strong>Disposition</strong><div>' + escapeHtml(item.disposition || '') + '</div></div>';
        html += '<div><strong>Notes</strong><div>' + escapeHtml(item.notes || '') + '</div></div>';
        html += '<div><strong>Date Created</strong><div>' + escapeHtml(item.date_created || '') + '</div></div>';
        html += '<div><strong>Last Updated</strong><div>' + escapeHtml(item.last_updated || '') + '</div></div>';
        html += '<div><strong>Item ID</strong><div>' + escapeHtml(item.item_id || '') + '</div></div>';
        html += '<div><strong>Transaction ID</strong><div>' + escapeHtml(item.transaction_id || '') + '</div></div>';
        html += '<div><strong>Project ID</strong><div>' + escapeHtml(item.project_id || '') + '</div></div>';
        html += '</div>';
        root.innerHTML = html;
        try { if (document.getElementById('f_disposition')) document.getElementById('f_disposition').value = item.disposition || ''; } catch(e){}
        // Wire handlers
        try { document.getElementById('editBtn').onclick = function(){ renderForm(item); }; } catch(e){}
        try {
          var pb = document.getElementById('printViewBtn');
          if (pb) pb.onclick = function(ev){
            var id = decodeURIComponent((ev.currentTarget.getAttribute('data-item-id')||''));
            var key = ev.currentTarget.getAttribute('data-qr-key') || '';
            var url = key ? (BASE_URL + '?action=qrImage&k=' + encodeURIComponent(key) + '&mode=png') : (BASE_URL + '?action=generateBatchPdf&sheetName=' + encodeURIComponent(item._sheet || item.project_name || '') + '&items[]=' + encodeURIComponent(id) + '&mode=single');
            window.open(url, '_blank');
            ev.stopPropagation();
          };
        } catch(e) { console.error('print handler failed', e); }
        try {
          var bb = document.getElementById('bookmarkViewBtn');
          if (bb) bb.onclick = function(ev){
            var id = decodeURIComponent((ev.currentTarget.getAttribute('data-item-id')||''));
            var btn = ev.currentTarget;
            var newState = btn.classList.contains('active') ? false : true;
            if (newState) btn.classList.add('active'); else btn.classList.remove('active');
            google.script.run.withFailureHandler(function(err){ writeDebug('bookmark update failed: ' + String(err)); try { if (btn) { if (newState) btn.classList.remove('active'); else btn.classList.add('active'); } } catch(e){} }).withSuccessHandler(function(res){ writeDebug('bookmark updated for ' + id + ' -> ' + newState); }).updateItem({ item_id: id, data: { bookmark: newState }, sheet_name: item._sheet });
            ev.stopPropagation();
          };
        } catch(e) { console.error('bookmark view handler failed', e); }
      }

      function renderForm(item){
        var root = document.getElementById('formRoot');
        var html = '';
        // Fields in requested order
        html += '<div><label>Description</label><input id="f_description" value="'+escapeHtml(item.description||'')+'"></div>';
        html += '<div><label>Source</label><input id="f_source" value="'+escapeHtml(item.source||'')+'"></div>';
        html += '<div><label>SKU</label><input id="f_sku" value="'+escapeHtml(item.sku||'')+'"></div>';
        html += '<div><label>Price</label><input id="f_price" type="number" step="0.01" value="'+escapeHtml(item.price||'')+'"></div>';
        html += '<div><label>1584 Resale Price</label><input id="f_1584_resale_price" type="number" step="0.01" value="'+escapeHtml(item["1584_resale_price"]||item.resale_price||'')+'"></div>';
        html += '<div><label>Market Value</label><input id="f_market_value" type="number" step="0.01" value="'+escapeHtml(item.market_value||'')+'"></div>';
        html += '<div><label>Payment Method</label><input id="f_payment_method" value="'+escapeHtml(item.payment_method||'')+'"></div>';
        html += '<div><label>Disposition</label><select id="f_disposition"><option value="">(none)</option><option value="keep">Keep</option><option value="return">Return</option><option value="1584">1584</option></select></div>';
        html += '<div><label>Notes</label><textarea id="f_notes">'+escapeHtml(item.notes||'')+'</textarea></div>';
        html += '<div><label>Date Created</label><input id="f_date_created" value="'+escapeHtml(item.date_created||'')+'" disabled></div>';
        html += '<div><label>Last Updated</label><input id="f_last_updated" value="'+escapeHtml(item.last_updated||'')+'" disabled></div>';
        html += '<div><label>Item ID</label><input id="f_item_id" value="'+escapeHtml(item.item_id||'')+'" readonly></div>';
        html += '<div><label>Transaction ID</label><input id="f_transaction_id" value="'+escapeHtml(item.transaction_id||'')+'"></div>';
        html += '<div><label>Project ID</label><input id="f_project_id" value="'+escapeHtml(item.project_id||'')+'"></div>';
        html += '<div style="display:flex;gap:8px"><button id="saveBtn" class="primary">Save</button><button id="bookmarkBtn" class="btn btn-icon" data-item-id="' + encodeURIComponent(item.item_id||'') + '" title="Bookmark">' + BOOKMARK_SVG + '</button><button id="returnBtn" class="btn btn-icon' + (item && item.disposition === 'return' ? ' active' : '') + '" data-item-id="' + encodeURIComponent(item.item_id||'') + '" title="Return">' + RETURN_SVG + '</button><button id="printBtn" class="btn btn-icon" data-item-id="' + encodeURIComponent(item.item_id||'') + '" title="Print QR">' + PRINTER_SVG + '</button></div>';
        root.innerHTML = html;
        document.getElementById('saveBtn').onclick = function(){
          var data = {
            description: document.getElementById('f_description').value,
            source: document.getElementById('f_source').value,
            sku: document.getElementById('f_sku').value,
            price: document.getElementById('f_price').value,
            "1584_resale_price": (document.getElementById('f_1584_resale_price') ? document.getElementById('f_1584_resale_price').value : ''),
            market_value: (document.getElementById('f_market_value') ? document.getElementById('f_market_value').value : ''),
            payment_method: document.getElementById('f_payment_method').value,
            notes: document.getElementById('f_notes').value,
            disposition: (document.getElementById('f_disposition') ? document.getElementById('f_disposition').value : ''),
            date_created: document.getElementById('f_date_created').value,
            last_updated: document.getElementById('f_last_updated').value,
            item_id: document.getElementById('f_item_id').value,
            transaction_id: document.getElementById('f_transaction_id').value,
            project_id: document.getElementById('f_project_id').value
          };
          writeDebug('Saving...');
          google.script.run.withFailureHandler(function(err){ writeDebug('Save failed: ' + String(err)); })
            .withSuccessHandler(function(res){
              // After update, fetch fresh item and render view
              google.script.run.withSuccessHandler(function(getRes){ if (getRes && getRes.item) { renderView(getRes.item); writeDebug('Saved.'); alert('Saved.'); } else { writeDebug('Saved (no item returned)'); alert('Saved.'); } }).getItem(itemId);
            })
            .updateItem({ item_id: itemId, data: data, sheet_name: item._sheet });
        };
        // attach print behavior: always open printable batch PDF (single item)
        try {
          var pb = document.getElementById('printBtn');
          if (pb) pb.onclick = function(ev){
            var id = decodeURIComponent((ev.currentTarget.getAttribute('data-item-id')||''));
            // Prefer direct single-item QR endpoint by key. Fallback to batch by item id if qr_key missing.
            var url;
            if (item.qr_key) {
              // Request the PNG save path so the server will persist a PNG to Drive
              url = BASE_URL + '?action=qrImage&k=' + encodeURIComponent(item.qr_key) + '&mode=png';
            } else {
              url = BASE_URL + '?action=generateBatchPdf&sheetName=' + encodeURIComponent(item._sheet || item.project_name || '') + '&items[]=' + encodeURIComponent(id) + '&format=pdf&mode=single';
            }
            console.log('[print] opening', url);
            window.open(url, '_blank');
            ev.stopPropagation();
          };
        } catch (e) { console.error('Failed to attach print button', e); }

        try {
          var bb = document.getElementById('bookmarkBtn');
          if (bb) bb.onclick = function(ev){
            var id = decodeURIComponent((ev.currentTarget.getAttribute('data-item-id')||''));
            writeDebug('Toggled bookmark for ' + id);
            var btn = ev.currentTarget;
            var newState = btn.classList.contains('active') ? false : true;
            if (newState) btn.classList.add('active'); else btn.classList.remove('active');
            try {
              google.script.run.withFailureHandler(function(err){
                writeDebug('bookmark update failed: ' + String(err));
                // revert visual state on failure
                try { if (btn) { if (newState) btn.classList.remove('active'); else btn.classList.add('active'); } } catch(e) {}
                try { console.error('Bookmark save failed: ' + String(err)); } catch(e) {}
              }).withSuccessHandler(function(res){ writeDebug('bookmark updated for ' + id + ' -> ' + newState); }).updateItem({ item_id: id, data: { bookmark: newState }, sheet_name: item._sheet });
            } catch (e) { writeDebug('bookmark persistence exception: ' + String(e)); }
            ev.stopPropagation();
          };
          var ret = document.getElementById('returnBtn');
          if (ret) ret.onclick = function(ev){
            var id = decodeURIComponent((ev.currentTarget.getAttribute('data-item-id')||''));
            var btn = ev.currentTarget;
            var newDisposition = btn.classList.contains('active') ? 'keep' : 'return';
            try { if (newDisposition === 'return') btn.classList.add('active'); else btn.classList.remove('active'); } catch(e){}
            try {
              google.script.run.withFailureHandler(function(err){ writeDebug('return update failed: ' + String(err)); try { if (newDisposition === 'return') btn.classList.remove('active'); else btn.classList.add('active'); } catch(e){}; alert('Return update failed'); })
                .withSuccessHandler(function(res){ writeDebug('Disposition updated for ' + id + ' -> ' + newDisposition); }).updateItem({ item_id: id, data: { disposition: newDisposition }, sheet_name: item._sheet });
            } catch(e){ writeDebug('return persistence exception: ' + String(e)); }
            ev.stopPropagation();
          };
        } catch (e) { console.error('Failed to attach bookmark/return buttons', e); }

        // If page was opened with _print=true param, auto-open the printable batch PDF (single item)
        try {
          if (window.location && window.location.search && window.location.search.indexOf('_print=true') !== -1) {
            var url = BASE_URL + '?action=qrImage&k=' + encodeURIComponent(item.qr_key || '') + '&_print_auto=1&mode=png';
            if (!item.qr_key) url = BASE_URL + '?action=generateBatchPdf&sheetName=' + encodeURIComponent(item._sheet || item.project_name || '') + '&items[]=' + encodeURIComponent(item.item_id || '') + '&mode=single';
            console.log('[auto-print] opening', url);
            window.open(url, '_blank');
          }
        } catch (e) {}
      }
      if (!itemId) { writeDebug('No item id'); }
      else {
        writeDebug('Loading item...');
        google.script.run.withFailureHandler(function(err){ writeDebug('getItem failed: ' + String(err)); })
          .withSuccessHandler(function(res){ if (res && res.item) renderForm(res.item); else writeDebug('Item not found'); }).getItem(itemId);
      }

      // visualViewport fallback: if the reported layout viewport is much larger than the visual
      // viewport (common when hosted inside wrappers), scale the root to fit the visual viewport
      (function(){
        try {
          var root = document.querySelector('body');
          function update(){
            try {
              var layoutW = window.innerWidth || document.documentElement.clientWidth || 0;
              var vw = (window.visualViewport && window.visualViewport.width) ? window.visualViewport.width : null;
              if (!vw || !layoutW || layoutW <= vw * 1.2) {
                root.style.transform = '';
                root.style.transformOrigin = '';
                root.style.width = '';
                root.removeAttribute('data-scale-factor');
                root.classList.remove('scaled-for-viewport');
                return;
              }
              var s = vw / layoutW;
              root.style.transformOrigin = 'top left';
              root.style.transform = 'scale(' + s + ')';
              root.style.width = layoutW + 'px';
              root.setAttribute('data-scale-factor', String(s.toFixed(3)));
              root.classList.add('scaled-for-viewport');
            } catch (e) { console.error('visualViewport update failed', e); }
          }
          update();
          window.addEventListener('resize', update);
          window.addEventListener('orientationchange', update);
          if (window.visualViewport) {
            try { window.visualViewport.addEventListener('resize', update); window.visualViewport.addEventListener('scroll', update); } catch(e) {}
          }
        } catch(e) {}
      })();
    </script>
  </body>
</html>


