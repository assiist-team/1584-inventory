import{a as Y,j as e}from"./index.js";import{r as l}from"./vendor.js";import{b as Z,c as ee,d as te,L as h}from"./router.js";import{f as se}from"./dateUtils.js";import{i as g,p as re}from"./inventoryService.js";import{I as M,g as w,a as k}from"./imageService.js";import{I as ae}from"./ImagePreview.js";import{e as T,B as oe,f as ie,Q as ne,g as ce,h as P,i as R,j as U,T as le,D as A,k as me,l as de}from"./ui.js";import"./firebase.js";function be(){const{id:u,itemId:B}=Z(),F=ee(),[x]=te(),[t,m]=l.useState(null),[y,L]=l.useState(""),[C,j]=l.useState(!1),[I,p]=l.useState(0),[N,$]=l.useState(!1),[z,q]=l.useState(!1),{showError:f}=Y(),_=l.useRef(null),d=B||u,o=x.get("project")||u,D=x.get("from")==="transaction",E=l.useMemo(()=>t?t.item_id==="I-1"&&t.description==="Marble Countertop Sample"?`/project/${o}?tab=inventory`:D&&t.transaction_id&&o?`/project/${o}/transaction/${t.transaction_id}`:`/project/${o}?tab=inventory`:`/project/${o}?tab=inventory`,[t,o,D]),b={item_id:d||"I-1",description:"Marble Countertop Sample",source:"Home Depot",sku:"MCT-001",price:"150.00",market_value:"300.00",payment_method:"1584 Design",notes:"High-end marble sample for client presentation",qr_key:"QR001",bookmark:!0,disposition:"keep",transaction_id:"T-1",project_id:"P-1",date_created:"2024-01-15",last_updated:"2024-01-20"};l.useEffect(()=>{(async()=>{if(d)try{if(o){const[a,r]=await Promise.all([g.getItem(o,d),re.getProject(o)]);a?m(a):(console.error("Item not found in project:",o,"with ID:",d),m(b)),r&&L(r.name)}else console.error("No project ID found in URL parameters"),m(b)}catch(a){console.error("Failed to fetch item:",a),m(b)}else m(b)})()},[d,u,x]),l.useEffect(()=>{const s=u||x.get("project");if(!s||!d)return;console.log("Setting up real-time listener for item:",d);const a=g.subscribeToItems(s,r=>{var c;console.log("Real-time items update:",r.length,"items");const i=r.find(n=>n.item_id===d);i&&(console.log("Found updated item with",((c=i.images)==null?void 0:c.length)||0,"images"),m(i))});return()=>{console.log("Cleaning up real-time listener for item:",d),a()}},[x,d,u]),l.useEffect(()=>{const s=a=>{if(N&&!a.target)return;const r=a.target;!r.closest(".disposition-menu")&&!r.closest(".disposition-badge")&&$(!1)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[N]),l.useEffect(()=>{const s=()=>{if(_.current){const r=_.current.getBoundingClientRect().top<=0;q(r)}};return window.addEventListener("scroll",s),s(),()=>{window.removeEventListener("scroll",s)}},[]);const Q=async()=>{if(t)try{await g.updateItem(t.project_id,t.item_id,{bookmark:!t.bookmark}),m({...t,bookmark:!t.bookmark})}catch(s){console.error("Failed to update bookmark:",s)}},G=async s=>{if(t)try{await g.updateItem(t.project_id,t.item_id,{disposition:s}),m({...t,disposition:s}),$(!1)}catch(a){console.error("Failed to update disposition:",a)}},H=()=>{$(!N)},O=s=>{const a="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium cursor-pointer transition-colors hover:opacity-80";switch(s){case"keep":return`${a} bg-green-100 text-green-800`;case"to return":case"return":return`${a} bg-red-100 text-red-700`;case"returned":return`${a} bg-red-800 text-red-100`;case"inventory":return`${a} bg-blue-100 text-blue-800`;default:return`${a} bg-gray-100 text-gray-800`}},V=async()=>{if(!(!t||!o)&&confirm("Are you sure you want to delete this item? This action cannot be undone."))try{await g.deleteItem(o,t.item_id),F(`/project/${o}?tab=inventory`)}catch(s){console.error("Failed to delete item:",s),f("Failed to delete item. Please try again.")}},K=async s=>{if(!(!t||!y))try{j(!0),p(0),console.log("Starting multiple image upload for",s.length,"files");for(let n=0;n<s.length;n++)console.log(`Processing file ${n+1}:`,s[n].name);const a=await M.uploadMultipleItemImages(s,y,t.item_id,(n,S)=>{const v=Math.round((n+S.percentage/100)/s.length*100);p(v)});console.log("All uploads completed successfully:",a.length,"images");const r=a.map((n,S)=>{var v;return{url:n.url,alt:n.fileName,isPrimary:((v=t.images)==null?void 0:v.length)===0&&S===0,uploadedAt:new Date,fileName:n.fileName,size:n.size,mimeType:n.mimeType}});console.log("New image objects created:",r.length);const i=t.images||[],c=[...i,...r];console.log("Before update - item.images length:",i.length),console.log("After update - updatedImages length:",c.length),console.log("New images URLs:",r.map(n=>n.url)),o&&(console.log("Updating item in database with multiple new images"),await g.updateItem(o,t.item_id,{images:c})),m({...t,images:c}),p(100),console.log("Multiple image upload completed successfully")}catch(a){console.error("Error uploading multiple images:",a);const r=w(a),i=k(a);f(`${r} Suggestion: ${i}`)}finally{j(!1),p(0)}},J=async()=>{var s,a;if(!(!t||!y))try{j(!0);const r=await M.selectFromGallery();r&&r.length>0?(console.log("Selected",r.length,"files from gallery"),await K(r)):console.log("No files selected from gallery")}catch(r){if(console.error("Error selecting from gallery:",r),(s=r.message)!=null&&s.includes("timeout")||(a=r.message)!=null&&a.includes("canceled")){console.log("User canceled image selection or selection timed out");return}const i=w(r),c=k(r);f(`${i} Suggestion: ${c}`)}finally{j(!1),p(0)}},W=async s=>{var a;if(!(!t||!o))try{o&&await g.removeItemImage(o,t.item_id,s);const r=((a=t.images)==null?void 0:a.filter(i=>i.url!==s))||[];m({...t,images:r})}catch(r){console.error("Error removing image:",r);const i=w(r),c=k(r);f(`${i} Suggestion: ${c}`)}},X=async s=>{var a;if(!(!t||!o))try{o&&await g.setPrimaryImage(o,t.item_id,s);const r=((a=t.images)==null?void 0:a.map(i=>({...i,isPrimary:i.url===s})))||[];m({...t,images:r})}catch(r){console.error("Error setting primary image:",r);const i=w(r),c=k(r);f(`${i} Suggestion: ${c}`)}};return t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{ref:_,className:`sticky top-0 bg-gray-50 z-10 px-4 py-2 ${z?"border-b border-gray-200":""}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs(h,{to:E,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:space-x-2",children:[e.jsx("button",{onClick:Q,className:`inline-flex items-center justify-center p-2 border text-sm font-medium rounded-md ${t.bookmark?"border-red-300 text-red-700 bg-red-50 hover:bg-red-100":"border-gray-300 text-gray-700 bg-white hover:bg-gray-50"} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500`,title:t.bookmark?"Remove Bookmark":"Add Bookmark",children:e.jsx(oe,{className:"h-4 w-4",fill:t.bookmark?"currentColor":"none"})}),e.jsx(h,{to:`/project/${o}/edit-item/${t.item_id}?project=${o}`,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Item",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsx("button",{className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",onClick:()=>window.open(`/qr-image/${t.qr_key}`,"_blank"),title:"View QR Code",children:e.jsx(ne,{className:"h-4 w-4"})}),e.jsxs("div",{className:"relative",children:[e.jsxs("span",{onClick:H,className:`disposition-badge ${O(t.disposition||"keep")}`,children:[t.disposition==="to return"?"To Return":(t.disposition||"keep").charAt(0).toUpperCase()+(t.disposition||"keep").slice(1),e.jsx(ce,{className:"h-3 w-3 ml-1"})]}),N&&e.jsx("div",{className:"disposition-menu absolute top-full right-0 mt-1 w-40 bg-white border border-gray-200 rounded-md shadow-lg z-20",children:e.jsx("div",{className:"py-2",children:["keep","to return","returned","inventory"].map(s=>e.jsx("button",{onClick:()=>G(s),className:`block w-full text-left px-4 py-3 text-sm hover:bg-gray-50 ${t.disposition===s||s==="to return"&&t.disposition==="return"?"bg-gray-100 text-gray-900":"text-gray-700"}`,children:s==="to return"?"To Return":s.charAt(0).toUpperCase()+s.slice(1)},s))})})]})]})]})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4",children:e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:t.description})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(P,{className:"h-5 w-5 mr-2"}),"Item Images"]}),e.jsxs("button",{onClick:J,disabled:C,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Add images from gallery or camera",children:[e.jsx(P,{className:"h-3 w-3 mr-1"}),C?I>0&&I<100?`Uploading... ${Math.round(I)}%`:"Uploading...":"Add Images"]})]}),t.images&&t.images.length>0?e.jsx(ae,{images:t.images,onRemoveImage:W,onSetPrimary:X,maxImages:5,size:"md",showControls:!0}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(P,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No images uploaded"})]})]}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(R,{className:"h-5 w-5 mr-2"}),"Item Details"]}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[t.transaction_id&&e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"Transaction"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:e.jsx(h,{to:`/project/${o}/transaction/${t.transaction_id}`,className:"text-primary-600 hover:text-primary-800 underline",children:t.transaction_id})})]}),t.source&&e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"Source"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.source})]}),t.sku&&e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"SKU"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.sku})]}),t.price&&e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),"Price"]}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.price]})]}),t.market_value&&e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(A,{className:"h-4 w-4 mr-1"}),"Market Value"]}),e.jsxs("dd",{className:"mt-1 text-sm text-green-600 font-medium",children:["$",t.market_value]})]}),t.payment_method&&e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),"Payment Method"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.payment_method})]}),t.notes&&t.notes!=="No notes"&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),"Notes"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md",children:t.notes})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:y})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Transaction"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:e.jsx(h,{to:`/project/${o}/transaction/${t.transaction_id}`,className:"text-primary-600 hover:text-primary-800 underline",children:t.transaction_id})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:se(t.date_created)})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:V,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Item",children:e.jsx(de,{className:"h-4 w-4"})})})]})})]})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs(h,{to:E,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(T,{className:"h-4 w-4 mr-1"}),"Back"]})}),e.jsx("div",{className:"bg-white shadow rounded-lg",children:e.jsxs("div",{className:"px-4 py-5 sm:p-6",children:[e.jsx("p",{className:"text-gray-500",children:"Item not found."}),o&&e.jsxs("p",{className:"text-sm text-gray-400 mt-2",children:["Project ID: ",o]}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Item ID: ",d||"unknown"]})]})})]})}export{be as default};
//# sourceMappingURL=ItemDetail.js.map
