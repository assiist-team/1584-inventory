import{a as G,j as e}from"./index.js";import{r as g}from"./vendor.js";import{u as H,b as Q,c as V,L as N}from"./router.js";import{f as J}from"./dateUtils.js";import{i as d,p as O}from"./inventoryService.js";import{I as D,g as v,a as w}from"./imageService.js";import{I as W}from"./ImagePreview.js";import{d as C,e as X,B as Y,R as M,f as Z,T as ee,g as R,h as te,i as se,D as _,j as re,k as ie}from"./ui.js";import"./firebase.js";import"./ImageGallery.js";function pe(){const{id:x,itemId:T}=H(),E=Q(),[u]=V(),[t,c]=g.useState(null),[h,U]=g.useState(""),[$,y]=g.useState(!1),[k,p]=g.useState(0),{showError:f}=G(),l=T||x,i=u.get("project")||x,P=u.get("from")==="transaction",S=g.useMemo(()=>t?t.item_id==="I-1"&&t.description==="Marble Countertop Sample"?`/project/${i}?tab=inventory`:P&&t.transaction_id&&i?`/project/${i}/transaction/${t.transaction_id}`:`/project/${i}?tab=inventory`:`/project/${i}?tab=inventory`,[t,i,P]),j={item_id:l||"I-1",description:"Marble Countertop Sample",source:"Home Depot",sku:"MCT-001",price:"150.00",resale_price:"250.00",market_value:"300.00",payment_method:"1584 Card",notes:"High-end marble sample for client presentation",qr_key:"QR001",bookmark:!0,disposition:"keep",transaction_id:"T-1",project_id:"P-1",date_created:"2024-01-15",last_updated:"2024-01-20"};g.useEffect(()=>{(async()=>{if(l)try{if(i){const[a,s]=await Promise.all([d.getItem(i,l),O.getProject(i)]);a?c(a):(console.error("Item not found in project:",i,"with ID:",l),c(j)),s&&U(s.name)}else console.error("No project ID found in URL parameters"),c(j)}catch(a){console.error("Failed to fetch item:",a),c(j)}else c(j)})()},[l,x,u]),g.useEffect(()=>{const r=x||u.get("project");if(!r||!l)return;console.log("Setting up real-time listener for item:",l);const a=d.subscribeToItems(r,s=>{var m;console.log("Real-time items update:",s.length,"items");const o=s.find(n=>n.item_id===l);o&&(console.log("Found updated item with",((m=o.images)==null?void 0:m.length)||0,"images"),c(o))});return()=>{console.log("Cleaning up real-time listener for item:",l),a()}},[u,l,x]);const F=async()=>{if(t)try{await d.updateItem(t.project_id,t.item_id,{bookmark:!t.bookmark}),c({...t,bookmark:!t.bookmark})}catch(r){console.error("Failed to update bookmark:",r)}},B=async()=>{if(t)try{let r;switch(t.disposition){case"keep":r="to return";break;case"to return":r="returned";break;case"returned":r="inventory";break;case"inventory":r="keep";break;case"return":r="to return";break;default:r="keep"}await d.updateItem(t.project_id,t.item_id,{disposition:r}),c({...t,disposition:r})}catch(r){console.error("Failed to update disposition:",r)}},A=async()=>{if(!(!t||!i)&&confirm("Are you sure you want to delete this item? This action cannot be undone."))try{await d.deleteItem(i,t.item_id),E(`/project/${i}?tab=inventory`)}catch(r){console.error("Failed to delete item:",r),f("Failed to delete item. Please try again.")}},L=async r=>{if(!(!t||!h))try{y(!0),p(0),console.log("Starting multiple image upload for",r.length,"files");for(let n=0;n<r.length;n++)console.log(`Processing file ${n+1}:`,r[n].name);const a=await D.uploadMultipleItemImages(r,h,t.item_id,(n,I)=>{const b=Math.round((n+I.percentage/100)/r.length*100);p(b)});console.log("All uploads completed successfully:",a.length,"images");const s=a.map((n,I)=>{var b;return{url:n.url,alt:n.fileName,isPrimary:((b=t.images)==null?void 0:b.length)===0&&I===0,uploadedAt:new Date,fileName:n.fileName,size:n.size,mimeType:n.mimeType}});console.log("New image objects created:",s.length);const o=t.images||[],m=[...o,...s];console.log("Before update - item.images length:",o.length),console.log("After update - updatedImages length:",m.length),console.log("New images URLs:",s.map(n=>n.url)),i&&(console.log("Updating item in database with multiple new images"),await d.updateItem(i,t.item_id,{images:m})),c({...t,images:m}),p(100),console.log("Multiple image upload completed successfully")}catch(a){console.error("Error uploading multiple images:",a);const s=v(a),o=w(a);f(`${s} Suggestion: ${o}`)}finally{y(!1),p(0)}},q=async()=>{var r,a;if(!(!t||!h))try{y(!0);const s=await D.selectFromGallery();s&&s.length>0?(console.log("Selected",s.length,"files from gallery"),await L(s)):console.log("No files selected from gallery")}catch(s){if(console.error("Error selecting from gallery:",s),(r=s.message)!=null&&r.includes("timeout")||(a=s.message)!=null&&a.includes("canceled")){console.log("User canceled image selection or selection timed out");return}const o=v(s),m=w(s);f(`${o} Suggestion: ${m}`)}finally{y(!1),p(0)}},K=async r=>{var a;if(!(!t||!i))try{i&&await d.removeItemImage(i,t.item_id,r);const s=((a=t.images)==null?void 0:a.filter(o=>o.url!==r))||[];c({...t,images:s})}catch(s){console.error("Error removing image:",s);const o=v(s),m=w(s);f(`${o} Suggestion: ${m}`)}},z=async r=>{var a;if(!(!t||!i))try{i&&await d.setPrimaryImage(i,t.item_id,r);const s=((a=t.images)==null?void 0:a.map(o=>({...o,isPrimary:o.url===r})))||[];c({...t,images:s})}catch(s){console.error("Error setting primary image:",s);const o=v(s),m=w(s);f(`${o} Suggestion: ${m}`)}};return t?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs(N,{to:S,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(C,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:space-x-2",children:[e.jsxs(N,{to:`/project/${i}/edit-item/${t.item_id}?project=${i}`,className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Edit"]}),e.jsxs("button",{onClick:F,className:`inline-flex items-center px-3 py-2 border text-sm font-medium rounded-md ${t.bookmark?"border-red-300 text-red-700 bg-red-50 hover:bg-red-100":"border-gray-300 text-gray-700 bg-white hover:bg-gray-50"} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500`,children:[e.jsx(Y,{className:"h-4 w-4 mr-2",fill:t.bookmark?"currentColor":"none"}),t.bookmark?"Bookmarked":"Bookmark"]}),e.jsxs("button",{onClick:B,className:`inline-flex items-center px-3 py-2 border text-sm font-medium rounded-md ${t.disposition==="to return"||t.disposition==="return"?"border-red-300 text-red-700 bg-red-50 hover:bg-red-100":t.disposition==="returned"?"border-red-800 text-red-100 bg-red-800 hover:bg-red-900":t.disposition==="inventory"?"border-blue-300 text-blue-700 bg-blue-50 hover:bg-blue-100":"border-gray-300 text-gray-700 bg-white hover:bg-gray-50"} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500`,children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),t.disposition==="keep"?"To Return":t.disposition==="to return"||t.disposition==="return"?"Returned":t.disposition==="returned"?"Inventory":(t.disposition==="inventory","Keep")]}),e.jsxs("button",{className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",onClick:()=>window.open(`/qr-image/${t.qr_key}`,"_blank"),children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"QR"]}),e.jsxs("button",{onClick:A,className:"inline-flex items-center px-3 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:t.description})}),e.jsx("div",{className:"px-6 py-4",children:e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),"Description"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.description})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),"Source"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.source})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(se,{className:"h-4 w-4 mr-1"}),"SKU"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.sku})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),"Price"]}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.price]})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),"Market Value"]}),e.jsxs("dd",{className:"mt-1 text-sm text-green-600 font-medium",children:["$",t.market_value||""]})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(_,{className:"h-4 w-4 mr-1"}),"1584 Resale Price"]}),e.jsxs("dd",{className:"mt-1 text-sm text-primary-600 font-medium",children:["$",t.resale_price||""]})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),"Payment Method"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.payment_method})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(M,{className:"h-4 w-4 mr-1"}),"Disposition"]}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex px-2 py-1 text-xs font-medium rounded-full ${t.disposition==="keep"?"bg-green-100 text-green-800":t.disposition==="to return"||t.disposition==="return"?"bg-red-100 text-red-700":t.disposition==="returned"?"bg-red-800 text-red-100":t.disposition==="inventory"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:t.disposition==="to return"||t.disposition==="return"?"To Return":t.disposition==="returned"?"Returned":t.disposition==="keep"?"Keep":t.disposition==="inventory"?"Inventory":t.disposition})})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),"Notes"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md",children:t.notes||"No notes"})]})]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Item Images"}),e.jsxs("button",{onClick:q,disabled:$,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Add images from gallery or camera",children:[e.jsx(ie,{className:"h-3 w-3 mr-1"}),$?k>0&&k<100?`Uploading... ${Math.round(k)}%`:"Uploading...":"Add Images"]})]}),t.images&&t.images.length>0?e.jsx(W,{images:t.images,onRemoveImage:K,onSetPrimary:z,maxImages:5,size:"md",showControls:!0}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"No images for this item yet"})})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:h})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Transaction"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:e.jsx(N,{to:`/project/${i}/transaction/${t.transaction_id}`,className:"text-primary-600 hover:text-primary-800 underline",children:t.transaction_id})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:J(t.date_created)})]})]})})]})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs(N,{to:S,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(C,{className:"h-4 w-4 mr-1"}),"Back"]})}),e.jsx("div",{className:"bg-white shadow rounded-lg",children:e.jsxs("div",{className:"px-4 py-5 sm:p-6",children:[e.jsx("p",{className:"text-gray-500",children:"Item not found."}),i&&e.jsxs("p",{className:"text-sm text-gray-400 mt-2",children:["Project ID: ",i]}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Item ID: ",l||"unknown"]})]})})]})}export{pe as default};
//# sourceMappingURL=ItemDetail.js.map
