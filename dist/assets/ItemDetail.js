import{d as Z,e as ee,j as e}from"./index.js";import{r as u}from"./vendor.js";import{c as te,b as se,d as re,L as b}from"./router.js";import{u as g,l as ae,f as v,a as oe,p as ie,i as ne}from"./inventoryService.js";import{I as T,g as w,a as k}from"./imageService.js";import{I as ce}from"./ImagePreview.js";import{I as le}from"./ItemLineageBreadcrumb.js";import{u as de}from"./useDuplication.js";import{u as me}from"./useNavigationContext.js";import{g as F,B as ue,h as ge,i as xe,Q as pe,j as fe,k as E,l as he,T as ye}from"./ui.js";import"./supabase.js";import"./taxPresetsService.js";function De(){const{id:f,itemId:L}=te(),z=se(),{currentAccountId:o}=Z(),[j]=re(),[t,l]=u.useState(null),[D,R]=u.useState(""),[B,I]=u.useState(!1),[P,h]=u.useState(0),[y,$]=u.useState(!1),[V,W]=u.useState(!1),{showError:x}=ee(),{buildContextUrl:A,getBackDestination:U}=me(),S=u.useRef(null),d=L||f,m=j.get("project")||f,p=!m&&location.pathname.startsWith("/business-inventory/"),{duplicateItem:q}=de({items:t?[t]:[],setItems:s=>{typeof s=="function"?l(r=>s([r])[0]||r):s.length>0&&l(s[0])},projectId:m,accountId:o||void 0}),M=u.useMemo(()=>{if(!t)return p?"/business-inventory":`/project/${m}?tab=inventory`;const s=p?"/business-inventory":`/project/${m}?tab=inventory`;return U(s)},[t,m,U,p]);u.useEffect(()=>{(async()=>{if(console.log("ðŸ”„ ItemDetail useEffect triggered. itemId:",d,"id:",f,"projectId:",m),d)try{if(!o)return;if(p){console.log("ðŸ“¦ Fetching business inventory item (no project context)...");const r=await g.getItemById(o,d);r?(console.log("âœ… Business inventory item loaded successfully:",r.itemId),l(r),R("Business Inventory")):(console.error("âŒ Business inventory item not found with ID:",d),l(null))}else if(m){console.log("ðŸ“¡ Fetching item and project data...");const[r,a]=await Promise.all([g.getItemById(o,d),ie.getProject(o,m)]);r?(console.log("âœ… Item loaded successfully:",r.itemId),l(r)):(console.error("âŒ Item not found in project:",m,"with ID:",d),l(null)),a&&(console.log("âœ… Project loaded:",a.name),R(a.name))}else console.error("âŒ No project ID found in URL parameters"),l(null)}catch(r){console.error("âŒ Failed to fetch item:",r),l(null)}else console.log("âš ï¸ No itemId or id in URL parameters"),l(null)})()},[d,f,j,o]),u.useEffect(()=>{const s=f||j.get("project");if(!s||!d||!o)return;console.log("Setting up real-time listener for item:",d);const r=g.subscribeToProjectItems(o,s,a=>{var n;console.log("Real-time items update:",a.length,"items");const i=a.find(c=>c.itemId===d);i&&(console.log("Found updated item with",((n=i.images)==null?void 0:n.length)||0,"images"),l(i))});return()=>{console.log("Cleaning up real-time listener for item:",d),r()}},[j,d,f,o]),u.useEffect(()=>{if(!d||!o)return;const s=ae.subscribeToItemLineageForItem(o,d,async()=>{try{const r=await g.getItemById(o,d);r&&l(r)}catch(r){console.debug("ItemDetail - failed to refetch item on lineage event",r)}});return()=>{try{s()}catch{}}},[d,o]),u.useEffect(()=>{const s=r=>{if(y&&!r.target)return;const a=r.target;!a.closest(".disposition-menu")&&!a.closest(".disposition-badge")&&$(!1)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[y]),u.useEffect(()=>{const s=()=>{if(S.current){const a=S.current.getBoundingClientRect().top<=0;W(a)}};return window.addEventListener("scroll",s),s(),()=>{window.removeEventListener("scroll",s)}},[]);const Q=async()=>{if(!(!t||!o))try{await g.updateItem(o,t.itemId,{bookmark:!t.bookmark}),l({...t,bookmark:!t.bookmark})}catch(s){console.error("Failed to update bookmark:",s)}},_=async s=>{if(console.log("ðŸŽ¯ updateDisposition called with:",s,"Current item:",t==null?void 0:t.itemId),!t||!o){console.error("âŒ No item available for disposition update");return}console.log("ðŸ“ Updating disposition from",t.disposition,"to",s);try{if(await g.updateItem(o,t.itemId,{disposition:s}),console.log("ðŸ’¾ Database updated successfully"),l({...t,disposition:s}),$(!1),s==="inventory"){console.log("ðŸš€ Starting deallocation process for item:",t.itemId);try{await ne.handleItemDeallocation(o,t.itemId,t.projectId||"",s),console.log("âœ… Deallocation completed successfully");const r=await g.getItemById(o,t.itemId);r&&l(r)}catch(r){console.error("âŒ Failed to handle deallocation:",r),await g.updateItem(o,t.itemId,{disposition:t.disposition}),l({...t,disposition:t.disposition}),x("Failed to move item to inventory. Please try again.")}}}catch(r){console.error("Failed to update disposition:",r),x("Failed to update disposition. Please try again.")}},G=()=>{console.log("ðŸ–±ï¸ toggleDispositionMenu called, current state:",y,"item:",t==null?void 0:t.itemId),$(!y)},H=s=>{const r="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium cursor-pointer transition-colors hover:opacity-80";switch(s){case"keep":return`${r} bg-green-100 text-green-800`;case"to return":case"return":return`${r} bg-red-100 text-red-700`;case"returned":return`${r} bg-red-800 text-red-100`;case"inventory":return`${r} bg-primary-100 text-primary-600`;default:return`${r} bg-gray-100 text-gray-800`}},K=async()=>{if(!(!t||!o)&&confirm("Are you sure you want to delete this item? This action cannot be undone."))try{await g.deleteItem(o,t.itemId),z(p?"/business-inventory":`/project/${m}?tab=inventory`)}catch(s){console.error("Failed to delete item:",s),x("Failed to delete item. Please try again.")}},O=async s=>{if(t)try{I(!0),h(0),console.log("Starting multiple image upload for",s.length,"files");for(let c=0;c<s.length;c++)console.log(`Processing file ${c+1}:`,s[c].name);const r=await T.uploadMultipleItemImages(s,D||"Business Inventory",t.itemId,(c,C)=>{const N=Math.round((c+C.percentage/100)/s.length*100);h(N)});console.log("All uploads completed successfully:",r.length,"images");const a=r.map((c,C)=>{var N;return{url:c.url,alt:c.fileName,isPrimary:((N=t.images)==null?void 0:N.length)===0&&C===0,uploadedAt:new Date,fileName:c.fileName,size:c.size,mimeType:c.mimeType}});console.log("New image objects created:",a.length);const i=t.images||[],n=[...i,...a];console.log("Before update - item.images length:",i.length),console.log("After update - updatedImages length:",n.length),console.log("New images URLs:",a.map(c=>c.url)),m&&o&&(console.log("Updating item in database with multiple new images"),await g.updateItem(o,t.itemId,{images:n})),l({...t,images:n}),h(100),console.log("Multiple image upload completed successfully")}catch(r){console.error("Error uploading multiple images:",r);const a=w(r),i=k(r);x(`${a} Suggestion: ${i}`)}finally{I(!1),h(0)}},J=async()=>{var s,r;if(t)try{I(!0);const a=await T.selectFromGallery();a&&a.length>0?(console.log("Selected",a.length,"files from gallery"),await O(a)):console.log("No files selected from gallery")}catch(a){if(console.error("Error selecting from gallery:",a),(s=a.message)!=null&&s.includes("timeout")||(r=a.message)!=null&&r.includes("canceled")){console.log("User canceled image selection or selection timed out");return}const i=w(a),n=k(a);x(`${i} Suggestion: ${n}`)}finally{I(!1),h(0)}},X=async s=>{var r,a;if(!(!t||!o))try{await g.updateItem(o,t.itemId,{images:((r=t.images)==null?void 0:r.filter(n=>n.url!==s))||[]});const i=((a=t.images)==null?void 0:a.filter(n=>n.url!==s))||[];l({...t,images:i})}catch(i){console.error("Error removing image:",i);const n=w(i),c=k(i);x(`${n} Suggestion: ${c}`)}},Y=async s=>{var r,a;if(!(!t||!o))try{await g.updateItem(o,t.itemId,{images:((r=t.images)==null?void 0:r.map(n=>({...n,isPrimary:n.url===s})))||[]});const i=((a=t.images)==null?void 0:a.map(n=>({...n,isPrimary:n.url===s})))||[];l({...t,images:i})}catch(i){console.error("Error setting primary image:",i);const n=w(i),c=k(i);x(`${n} Suggestion: ${c}`)}};return t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{ref:S,className:`sticky top-0 bg-gray-50 z-10 px-4 py-2 ${V?"border-b border-gray-200":""}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs(b,{to:M,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:space-x-2",children:[e.jsx("button",{onClick:Q,className:`inline-flex items-center justify-center p-2 border text-sm font-medium rounded-md ${t.bookmark?"border-red-300 text-red-700 bg-red-50 hover:bg-red-100":"border-gray-300 text-gray-700 bg-white hover:bg-gray-50"} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500`,title:t.bookmark?"Remove Bookmark":"Add Bookmark",children:e.jsx(ue,{className:"h-4 w-4",fill:t.bookmark?"currentColor":"none"})}),e.jsx(b,{to:p?`/business-inventory/${t.itemId}/edit?returnTo=${encodeURIComponent(window.location.pathname+window.location.search)}`:`/project/${m}/edit-item/${t.itemId}?project=${m}&returnTo=${encodeURIComponent(window.location.pathname+window.location.search)}`,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Item",children:e.jsx(ge,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>q(t.itemId),className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Duplicate Item",children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx("button",{className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",onClick:()=>window.open(`/qr-image/${t.qrKey}`,"_blank"),title:"View QR Code",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsxs("div",{className:"relative",children:[e.jsxs("span",{onClick:G,className:`disposition-badge ${H(t.disposition||"keep")}`,children:[t.disposition==="to return"?"To Return":(t.disposition||"keep").charAt(0).toUpperCase()+(t.disposition||"keep").slice(1),e.jsx(fe,{className:"h-3 w-3 ml-1"})]}),y&&e.jsx("div",{className:"disposition-menu absolute top-full right-0 mt-1 w-40 bg-white border border-gray-200 rounded-md shadow-lg z-20",children:e.jsx("div",{className:"py-2",children:["keep","to return","returned","inventory"].map(s=>e.jsx("button",{onClick:()=>_(s),className:`block w-full text-left px-4 py-3 text-sm hover:bg-gray-50 ${t.disposition===s||s==="to return"&&t.disposition==="return"?"bg-gray-100 text-gray-900":"text-gray-700"}`,children:s==="to return"?"To Return":s.charAt(0).toUpperCase()+s.slice(1)},s))})})]})]})]})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4",children:e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:t.description})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(E,{className:"h-5 w-5 mr-2"}),"Item Images"]}),e.jsxs("button",{onClick:J,disabled:B,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Add images from gallery or camera",children:[e.jsx(E,{className:"h-3 w-3 mr-1"}),B?P>0&&P<100?`Uploading... ${Math.round(P)}%`:"Uploading...":"Add Images"]})]}),t.images&&t.images.length>0?e.jsx(ce,{images:t.images,onRemoveImage:X,onSetPrimary:Y,maxImages:5,size:"md",showControls:!0}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No images uploaded"})]})]}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(he,{className:"h-5 w-5 mr-2"}),"Item Details"]}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[t.source&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 capitalize",children:t.source})]}),t.sku&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"SKU"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.sku})]}),t.space&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Space"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.space})]}),t.purchasePrice&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Purchase Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"What the item was purchased for"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:v(t.purchasePrice)}),t.taxAmountPurchasePrice!==void 0&&e.jsxs("p",{className:"mt-1 text-sm text-gray-600",children:["Tax on purchase: ",v(t.taxAmountPurchasePrice)]})]}),t.projectPrice&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Project Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"What the client is charged"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:v(t.projectPrice)}),t.taxAmountProjectPrice!==void 0&&e.jsxs("p",{className:"mt-1 text-sm text-gray-600",children:["Tax on project: ",v(t.taxAmountProjectPrice)]})]}),t.marketValue&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Market Value"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"The fair market value of the item"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.marketValue]})]}),t.taxRatePct!==void 0&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Tax Rate"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Applied tax rate for this item"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:[t.taxRatePct,"%"]})]}),t.paymentMethod&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Payment Method"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.paymentMethod})]}),t.notes&&t.notes!=="No notes"&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md",children:t.notes})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:D})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:oe(t.dateCreated)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Transaction"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:e.jsx(b,{to:A(p?`/business-inventory/transaction/${t.transactionId}`:`/project/${m}/transaction/${t.transactionId}`),className:"text-primary-600 hover:text-primary-800 underline",children:t.transactionId?t.transactionId.startsWith("INV_PURCHASE")?"INV_PURCHASE...":t.transactionId.length>12?`${t.transactionId.slice(0,12)}...`:t.transactionId:""})})]}),t.itemId&&e.jsx("div",{className:"sm:col-span-3 mt-2",children:e.jsx(le,{itemId:t.itemId})})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:K,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Item",children:e.jsx(ye,{className:"h-4 w-4"})})})]})})]})})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs(b,{to:M,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Back"]})}),e.jsx("div",{className:"bg-white shadow rounded-lg",children:e.jsxs("div",{className:"px-4 py-5 sm:p-6",children:[e.jsx("p",{className:"text-gray-500",children:"Item not found."}),m&&e.jsxs("p",{className:"text-sm text-gray-400 mt-2",children:["Project ID: ",m]}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Item ID: ",d||"unknown"]})]})})]})}export{De as default};
//# sourceMappingURL=ItemDetail.js.map
