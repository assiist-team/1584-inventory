import{t as _,w as m,x as g,y as S,z as p,A as b,B as l,D as q,G as k,H as h,I as u,J as C,K as j,M as x}from"./firebase-DTZupgGV.js";import{e as f,c as y,d}from"./index-CX_-pvtV.js";const R={async getProjects(){await f();const s=_(d,"projects"),t=m(s,g("updatedAt","desc"));return(await h(t)).docs.map(n=>{const a=y(n.data());return{id:n.id,...a}})},async getProject(s){await f();const t=p(d,"projects",s),e=await k(t);if(e.exists()){const n=y(e.data());return{id:e.id,...n}}return null},async createProject(s){const t=_(d,"projects"),e=new Date,n={...s,createdAt:e,updatedAt:e};return(await q(t,n)).id},async updateProject(s,t){const e=p(d,"projects",s);await l(e,{...t,updatedAt:new Date})},async deleteProject(s){const t=p(d,"projects",s);await b(t)},subscribeToProjects(s){const t=_(d,"projects"),e=m(t,g("updatedAt","desc"));return S(e,n=>{const a=n.docs.map(i=>{const o=y(i.data());return{id:i.id,...o}});s(a)})}},v={async getItems(s,t,e){const n=_(d,"projects",s,"items");let a=m(n);if(t!=null&&t.status&&(a=m(a,u("status","==",t.status))),t!=null&&t.category&&(a=m(a,u("category","==",t.category))),t!=null&&t.tags&&t.tags.length>0&&(a=m(a,u("tags","array-contains-any",t.tags))),t!=null&&t.priceRange&&(a=m(a,u("price",">=",t.priceRange.min),u("price","<=",t.priceRange.max))),t!=null&&t.searchQuery){const c=t.searchQuery.toLowerCase();a=m(a,u("description",">=",c),u("description","<=",c+""))}a=m(a,g("last_updated","desc")),e&&(a=m(a,j(e.limit)),e.page>0&&(a=m(a,j(e.page*e.limit))));let o=(await h(a)).docs.map(c=>({item_id:c.id,...c.data()}));if(t!=null&&t.searchQuery&&o.length>0){const c=t.searchQuery.toLowerCase();o=o.filter(r=>r.description.toLowerCase().includes(c)||r.source.toLowerCase().includes(c)||r.sku.toLowerCase().includes(c)||r.payment_method.toLowerCase().includes(c))}return o},async getItem(s,t){var a,i;console.log("getItem called with:",{projectId:s,itemId:t}),await f();const e=p(d,"projects",s,"items",t);console.log("Document path:",e.path);const n=await k(e);if(n.exists()){const o=n.data();console.log("Raw Firebase data:",o),console.log("Images in Firebase:",((a=o.images)==null?void 0:a.length)||0,"images");const c={item_id:n.id,description:o.description,source:o.source,sku:o.sku,price:o.price,resale_price:o.resale_price||o["1584_resale_price"]||"",market_value:o.market_value,payment_method:o.payment_method,disposition:o.disposition,notes:o.notes,qr_key:o.qr_key,bookmark:o.bookmark,transaction_id:o.transaction_id,project_id:o.project_id,date_created:o.date_created,last_updated:o.last_updated,images:o.images||[]};return console.log("Mapped item data:",c),console.log("Mapped images:",((i=c.images)==null?void 0:i.length)||0,"images"),c}return console.log("Document does not exist at path:",e.path),console.log("itemSnap.exists():",n.exists()),console.log("Item not found"),null},async createItem(s,t){const e=_(d,"projects",s,"items"),n=new Date,a={description:t.description,source:t.source,sku:t.sku,price:t.price,"1584_resale_price":t.resale_price,market_value:t.market_value,payment_method:t.payment_method,disposition:t.disposition,notes:t.notes,qr_key:t.qr_key||`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,bookmark:t.bookmark,transaction_id:t.transaction_id,project_id:t.project_id,date_created:n.toISOString(),last_updated:n.toISOString()},i=await q(e,a);return await R.updateProject(s,{metadata:{totalItems:await v.getItemCount(s)+1,lastActivity:n}}),i.id},async updateItem(s,t,e){var i;const n=p(d,"projects",s,"items",t),a={last_updated:new Date().toISOString()};e.resale_price!==void 0&&(a["1584_resale_price"]=e.resale_price),e.market_value!==void 0&&(a.market_value=e.market_value),e.description!==void 0&&(a.description=e.description),e.source!==void 0&&(a.source=e.source),e.sku!==void 0&&(a.sku=e.sku),e.price!==void 0&&(a.price=e.price),e.payment_method!==void 0&&(a.payment_method=e.payment_method),e.disposition!==void 0&&(a.disposition=e.disposition),e.notes!==void 0&&(a.notes=e.notes),e.bookmark!==void 0&&(a.bookmark=e.bookmark),e.images!==void 0&&(console.log("Updating item images:",(i=e.images)==null?void 0:i.length,"images"),a.images=e.images),console.log("Updating item in database:",t,"with updates:",Object.keys(a)),await l(n,a),console.log("Item updated successfully in database")},async addItemImage(s,t,e){const n=p(d,"projects",s,"items",t),a=await k(n);if(!a.exists())throw new Error("Item not found");const c=[...a.data().images||[],e];await l(n,{images:c,last_updated:new Date().toISOString()})},async updateItemImages(s,t,e){const n=p(d,"projects",s,"items",t);await l(n,{images:e,last_updated:new Date().toISOString()})},async removeItemImage(s,t,e){const n=p(d,"projects",s,"items",t),a=await k(n);if(!a.exists())throw new Error("Item not found");const c=(a.data().images||[]).filter(r=>r.url!==e);await l(n,{images:c,last_updated:new Date().toISOString()})},async setPrimaryImage(s,t,e){const n=p(d,"projects",s,"items",t),a=await k(n);if(!a.exists())throw new Error("Item not found");const c=(a.data().images||[]).map(r=>({...r,isPrimary:r.url===e}));await l(n,{images:c,last_updated:new Date().toISOString()})},async deleteItem(s,t){const e=p(d,"projects",s,"items",t);await b(e);const n=new Date;await R.updateProject(s,{metadata:{totalItems:Math.max(0,await v.getItemCount(s)-1),lastActivity:n}})},async getItemCount(s){const t=_(d,"projects",s,"items");return(await x(t)).data().count},subscribeToItems(s,t,e){const n=_(d,"projects",s,"items");let a=m(n,g("last_updated","desc"));return e!=null&&e.status&&(a=m(a,u("disposition","==",e.status))),e!=null&&e.category&&(a=m(a,u("source","==",e.category))),S(a,i=>{console.log("Real-time items snapshot received:",i.docs.length,"documents");let o=i.docs.map(c=>{const r=c.data();return{item_id:c.id,description:r.description,source:r.source,sku:r.sku,price:r.price,resale_price:r.resale_price||r["1584_resale_price"]||"",market_value:r.market_value,payment_method:r.payment_method,disposition:r.disposition,notes:r.notes,qr_key:r.qr_key,bookmark:r.bookmark,transaction_id:r.transaction_id,project_id:r.project_id,date_created:r.date_created,last_updated:r.last_updated,images:r.images||[]}});if(e!=null&&e.searchQuery){const c=e.searchQuery.toLowerCase();o=o.filter(r=>r.description.toLowerCase().includes(c)||r.source.toLowerCase().includes(c)||r.sku.toLowerCase().includes(c)||r.payment_method.toLowerCase().includes(c))}console.log("Real-time items callback with",o.length,"items"),t(o)})},async searchItems(s,t){if(t.length<2)return[];const e=_(d,"projects",s,"items"),n=m(e,u("description",">=",t.toLowerCase()),u("description","<=",t.toLowerCase()+""),g("description"),j(20));return(await h(n)).docs.map(i=>{const o=i.data();return{item_id:i.id,description:o.description,source:o.source,sku:o.sku,price:o.price,resale_price:o.resale_price||o["1584_resale_price"]||"",market_value:o.market_value,payment_method:o.payment_method,disposition:o.disposition,notes:o.notes,qr_key:o.qr_key,bookmark:o.bookmark,transaction_id:o.transaction_id,project_id:o.project_id,date_created:o.date_created,last_updated:o.last_updated}})},async batchUpdateItems(s,t){const e=C(d);t.forEach(({id:n,updates:a})=>{const i=p(d,"projects",s,"items",n),o={last_updated:new Date().toISOString()};a.resale_price!==void 0&&(o["1584_resale_price"]=a.resale_price),a.market_value!==void 0&&(o.market_value=a.market_value),a.description!==void 0&&(o.description=a.description),a.source!==void 0&&(o.source=a.source),a.sku!==void 0&&(o.sku=a.sku),a.price!==void 0&&(o.price=a.price),a.payment_method!==void 0&&(o.payment_method=a.payment_method),a.disposition!==void 0&&(o.disposition=a.disposition),a.notes!==void 0&&(o.notes=a.notes),a.bookmark!==void 0&&(o.bookmark=a.bookmark),e.update(i,o)}),await e.commit()},async createTransactionItems(s,t,e,n,a){const i=C(d),o=[],c=new Date;a.forEach(w=>{const I=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;o.push(I);const T=p(d,"projects",s,"items",I),A=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,D={item_id:I,description:w.description,source:n,sku:w.sku||"",price:w.price,market_value:w.market_value||"",payment_method:"Client Card",disposition:"keep",notes:w.notes||"",qr_key:A,bookmark:!1,transaction_id:t,project_id:s,date_created:e,last_updated:c.toISOString(),images:[]};i.set(T,D)}),await i.commit();const r=await v.getItemCount(s);return await R.updateProject(s,{metadata:{totalItems:r,lastActivity:c}}),o},async getTransactionItems(s,t){const e=_(d,"projects",s,"items"),n=m(e,u("transaction_id","==",t),g("date_created","asc"));return(await h(n)).docs.map(i=>i.id)}},O={async getTransactions(s){const t=_(d,"projects",s,"transactions"),e=m(t,g("created_at","desc"));return(await h(e)).docs.map(a=>{const i=y(a.data()),o={...i,transaction_images:Array.isArray(i.transaction_images)?i.transaction_images:[]};return{transaction_id:a.id,...o}})},async getTransaction(s,t){const e=p(d,"projects",s,"transactions",t),n=await k(e);if(n.exists()){const a=y(n.data());console.log("inventoryService - raw data:",a),console.log("inventoryService - transaction_images:",a.transaction_images),console.log("inventoryService - transaction_images type:",typeof a.transaction_images);const i={...a,transaction_images:Array.isArray(a.transaction_images)?a.transaction_images:[]};return console.log("inventoryService - processed transactionData:",i),{transaction_id:n.id,...i}}return null},async createTransaction(s,t,e){try{const n=_(d,"projects",s,"transactions"),i={...t,created_at:new Date().toISOString()};console.log("Creating transaction:",i),console.log("Transaction items:",e);const c=(await q(n,i)).id;if(console.log("Transaction created successfully:",c),e&&e.length>0){console.log("Creating items for transaction:",c);const r=await v.createTransactionItems(s,c,t.transaction_date,t.source,e);console.log("Created items:",r)}return c}catch(n){throw console.error("Error creating transaction:",n),n}},async updateTransaction(s,t,e){const n=p(d,"projects",s,"transactions",t);await l(n,e)},async deleteTransaction(s,t){const e=p(d,"projects",s,"transactions",t);await b(e)},subscribeToTransactions(s,t){const e=_(d,"projects",s,"transactions"),n=m(e,g("created_at","desc"));return S(n,a=>{const i=a.docs.map(o=>{const c=y(o.data()),r={...c,transaction_images:Array.isArray(c.transaction_images)?c.transaction_images:[]};return{transaction_id:o.id,...r}});t(i)})},subscribeToTransaction(s,t,e){const n=p(d,"projects",s,"transactions",t);return S(n,a=>{if(a.exists()){const i=y(a.data());console.log("inventoryService - real-time raw data:",i),console.log("inventoryService - real-time transaction_images:",i.transaction_images);const o={...i,transaction_images:Array.isArray(i.transaction_images)?i.transaction_images:[]};console.log("inventoryService - real-time processed transactionData:",o);const c={transaction_id:a.id,...o};e(c)}else e(null)})}};export{v as i,R as p,O as t};
//# sourceMappingURL=inventoryService-DVKkbR7H.js.map
