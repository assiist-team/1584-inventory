{"version":3,"file":"taxPresetsService.js","sources":["../../src/constants/taxPresets.ts","../../src/services/accountPresetsService.ts","../../src/services/taxPresetsService.ts"],"sourcesContent":["export interface TaxPreset {\n  id: string\n  name: string\n  rate: number // percentage, e.g., 8.375\n}\n\n// Default tax presets - these can be updated via Settings page\nexport const DEFAULT_TAX_PRESETS: TaxPreset[] = [\n  { id: 'nv', name: 'NV', rate: 8.375 },\n  { id: 'ut', name: 'UT', rate: 7.10 },\n  { id: 'ca', name: 'CA', rate: 7.25 },\n  { id: 'tx', name: 'TX', rate: 6.25 },\n  { id: 'az', name: 'AZ', rate: 8.6 }\n]\n\n// Supabase table name for tax presets\nexport const TAX_PRESETS_DOC_PATH = 'settings/taxPresets'\n\n// Helper to create a map of preset ID to preset\nexport const createPresetMap = (presets: TaxPreset[]): Map<string, TaxPreset> => {\n  const map = new Map<string, TaxPreset>()\n  presets.forEach(preset => {\n    map.set(preset.id, preset)\n  })\n  return map\n}\n\n","import { supabase } from './supabase'\nimport { convertTimestamps, ensureAuthenticatedForDatabase } from './databaseService'\n\nexport interface AccountPresets {\n  defaultCategoryId?: string | null\n  presets?: any\n}\n\n/**\n * Fetch account_presets row for the given account.\n * Returns null if not found.\n */\nexport async function getAccountPresets(accountId: string): Promise<AccountPresets | null> {\n  if (!accountId) return null\n  try {\n    const { data, error } = await supabase\n      .from('account_presets')\n      .select('*')\n      .eq('account_id', accountId)\n      .single()\n\n    if (error) {\n      if (error.code === 'PGRST116') return null\n      throw error\n    }\n\n    const converted: any = convertTimestamps(data)\n    return {\n      defaultCategoryId: converted.default_category_id || null,\n      presets: converted.presets || {}\n    }\n  } catch (err) {\n    console.error('Error fetching account presets:', err)\n    return null\n  }\n}\n\n/**\n * Upsert account_presets for an account. Allows partial updates.\n */\nexport async function upsertAccountPresets(accountId: string, updates: Partial<AccountPresets>): Promise<void> {\n  await ensureAuthenticatedForDatabase()\n  const payload: any = {\n    account_id: accountId,\n    updated_at: new Date().toISOString()\n  }\n  if (updates.defaultCategoryId !== undefined) payload.default_category_id = updates.defaultCategoryId\n  if (updates.presets !== undefined) payload.presets = updates.presets\n\n  const { error } = await supabase\n    .from('account_presets')\n    .upsert(payload, { onConflict: 'account_id' })\n\n  if (error) throw error\n}\n\nexport async function getDefaultCategory(accountId: string): Promise<string | null> {\n  const ap = await getAccountPresets(accountId)\n  return ap?.defaultCategoryId ?? null\n}\n\nexport async function setDefaultCategory(accountId: string, categoryId: string | null): Promise<void> {\n  await upsertAccountPresets(accountId, { defaultCategoryId: categoryId })\n}\n\n\n","import { DEFAULT_TAX_PRESETS, TaxPreset } from '@/constants/taxPresets'\nimport { getAccountPresets, upsertAccountPresets } from './accountPresetsService'\n\n/**\n * Get tax presets from Postgres for an account, falling back to defaults if not found\n */\nexport async function getTaxPresets(accountId: string): Promise<TaxPreset[]> {\n  try {\n    // Read canonical presets from account_presets\n    const ap = await getAccountPresets(accountId)\n    const migrated: any = ap?.presets?.tax_presets\n    if (Array.isArray(migrated) && migrated.length > 0) {\n      return migrated as TaxPreset[]\n    }\n\n    // If missing, initialize with defaults in account_presets and return defaults\n    try {\n      await upsertAccountPresets(accountId, { presets: { tax_presets: DEFAULT_TAX_PRESETS } })\n    } catch (err) {\n      console.warn('Failed to initialize tax_presets in account_presets:', err)\n    }\n    return DEFAULT_TAX_PRESETS\n  } catch (error) {\n    console.error('Error fetching tax presets from Postgres:', error)\n    // Fallback to defaults on error\n    return DEFAULT_TAX_PRESETS\n  }\n}\n\n/**\n * Update tax presets in Postgres for an account\n * @param accountId Account ID\n * @param presets Array of tax presets to save\n */\nexport async function updateTaxPresets(accountId: string, presets: TaxPreset[]): Promise<void> {\n  try {\n    // Validate presets\n    if (!Array.isArray(presets) || presets.length === 0) {\n      throw new Error('Presets must be a non-empty array')\n    }\n\n    if (presets.length > 5) {\n      throw new Error('Cannot have more than 5 tax presets')\n    }\n\n    // Validate each preset\n    for (const preset of presets) {\n      if (!preset.id || !preset.name || typeof preset.rate !== 'number') {\n        throw new Error('Each preset must have id, name, and rate fields')\n      }\n      if (preset.rate < 0 || preset.rate > 100) {\n        throw new Error('Tax rate must be between 0 and 100')\n      }\n    }\n\n    // Check for duplicate IDs\n    const ids = presets.map(p => p.id)\n    if (new Set(ids).size !== ids.length) {\n      throw new Error('Preset IDs must be unique')\n    }\n\n    // Persist exclusively to the canonical account_presets table\n    await upsertAccountPresets(accountId, { presets: { tax_presets: presets } })\n    console.log('Tax presets updated successfully (account_presets)')\n  } catch (error) {\n    console.error('Error updating tax presets:', error)\n    throw error\n  }\n}\n\n/**\n * Get a specific preset by ID for an account\n */\nexport async function getTaxPresetById(accountId: string, presetId: string): Promise<TaxPreset | null> {\n  const presets = await getTaxPresets(accountId)\n  return presets.find(p => p.id === presetId) || null\n}\n\n"],"names":["DEFAULT_TAX_PRESETS","getAccountPresets","accountId","data","error","supabase","converted","convertTimestamps","err","upsertAccountPresets","updates","ensureAuthenticatedForDatabase","payload","getDefaultCategory","ap","setDefaultCategory","categoryId","getTaxPresets","migrated","_a","updateTaxPresets","presets","preset","ids","p","getTaxPresetById","presetId"],"mappings":"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"}