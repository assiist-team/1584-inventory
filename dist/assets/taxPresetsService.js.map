{"version":3,"file":"taxPresetsService.js","sources":["../../src/constants/taxPresets.ts","../../src/services/taxPresetsService.ts"],"sourcesContent":["export interface TaxPreset {\n  id: string\n  name: string\n  rate: number // percentage, e.g., 8.375\n}\n\n// Default tax presets - these can be updated via Settings page\nexport const DEFAULT_TAX_PRESETS: TaxPreset[] = [\n  { id: 'nv', name: 'NV', rate: 8.375 },\n  { id: 'ut', name: 'UT', rate: 7.10 },\n  { id: 'ca', name: 'CA', rate: 7.25 },\n  { id: 'tx', name: 'TX', rate: 6.25 },\n  { id: 'az', name: 'AZ', rate: 8.6 }\n]\n\n// Supabase table name for tax presets\nexport const TAX_PRESETS_DOC_PATH = 'settings/taxPresets'\n\n// Helper to create a map of preset ID to preset\nexport const createPresetMap = (presets: TaxPreset[]): Map<string, TaxPreset> => {\n  const map = new Map<string, TaxPreset>()\n  presets.forEach(preset => {\n    map.set(preset.id, preset)\n  })\n  return map\n}\n\n","import { supabase } from './supabase'\nimport { DEFAULT_TAX_PRESETS, TaxPreset } from '@/constants/taxPresets'\n\n/**\n * Get tax presets from Postgres for an account, falling back to defaults if not found\n */\nexport async function getTaxPresets(accountId: string): Promise<TaxPreset[]> {\n  try {\n    const { data, error } = await supabase\n      .from('tax_presets')\n      .select('presets')\n      .eq('account_id', accountId)\n      .single()\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        // Not found - initialize with defaults\n        await updateTaxPresets(accountId, DEFAULT_TAX_PRESETS)\n        return DEFAULT_TAX_PRESETS\n      }\n      throw error\n    }\n\n    if (data.presets && Array.isArray(data.presets) && data.presets.length > 0) {\n      return data.presets as TaxPreset[]\n    }\n\n    // If presets array is empty, initialize with defaults\n    await updateTaxPresets(accountId, DEFAULT_TAX_PRESETS)\n    return DEFAULT_TAX_PRESETS\n  } catch (error) {\n    console.error('Error fetching tax presets from Postgres:', error)\n    // Fallback to defaults on error\n    return DEFAULT_TAX_PRESETS\n  }\n}\n\n/**\n * Update tax presets in Postgres for an account\n * @param accountId Account ID\n * @param presets Array of tax presets to save\n */\nexport async function updateTaxPresets(accountId: string, presets: TaxPreset[]): Promise<void> {\n  try {\n    // Validate presets\n    if (!Array.isArray(presets) || presets.length === 0) {\n      throw new Error('Presets must be a non-empty array')\n    }\n\n    if (presets.length > 5) {\n      throw new Error('Cannot have more than 5 tax presets')\n    }\n\n    // Validate each preset\n    for (const preset of presets) {\n      if (!preset.id || !preset.name || typeof preset.rate !== 'number') {\n        throw new Error('Each preset must have id, name, and rate fields')\n      }\n      if (preset.rate < 0 || preset.rate > 100) {\n        throw new Error('Tax rate must be between 0 and 100')\n      }\n    }\n\n    // Check for duplicate IDs\n    const ids = presets.map(p => p.id)\n    if (new Set(ids).size !== ids.length) {\n      throw new Error('Preset IDs must be unique')\n    }\n\n    // Check if presets exist for this account\n    const { data: existing, error: checkError } = await supabase\n      .from('tax_presets')\n      .select('account_id')\n      .eq('account_id', accountId)\n      .single()\n\n    // Handle \"not found\" error gracefully - it means we need to insert\n    const shouldInsert = !existing || (checkError && checkError.code === 'PGRST116')\n\n    const presetData = {\n      account_id: accountId,\n      presets: presets,\n      updated_at: new Date().toISOString()\n    }\n\n    if (!shouldInsert) {\n      // Update existing\n      const { error } = await supabase\n        .from('tax_presets')\n        .update(presetData)\n        .eq('account_id', accountId)\n\n      if (error) throw error\n    } else {\n      // Create new\n      const { error } = await supabase\n        .from('tax_presets')\n        .insert(presetData)\n\n      if (error) throw error\n    }\n\n    console.log('Tax presets updated successfully')\n  } catch (error) {\n    console.error('Error updating tax presets:', error)\n    throw error\n  }\n}\n\n/**\n * Get a specific preset by ID for an account\n */\nexport async function getTaxPresetById(accountId: string, presetId: string): Promise<TaxPreset | null> {\n  const presets = await getTaxPresets(accountId)\n  return presets.find(p => p.id === presetId) || null\n}\n\n"],"names":["DEFAULT_TAX_PRESETS","getTaxPresets","accountId","data","error","supabase","updateTaxPresets","presets","preset","ids","p","existing","checkError","shouldInsert","presetData","getTaxPresetById","presetId"],"mappings":"+BAOO,MAAMA,EAAmC,CAC9C,CAAE,GAAI,KAAM,KAAM,KAAM,KAAM,KAAA,EAC9B,CAAE,GAAI,KAAM,KAAM,KAAM,KAAM,GAAA,EAC9B,CAAE,GAAI,KAAM,KAAM,KAAM,KAAM,IAAA,EAC9B,CAAE,GAAI,KAAM,KAAM,KAAM,KAAM,IAAA,EAC9B,CAAE,GAAI,KAAM,KAAM,KAAM,KAAM,GAAA,CAChC,ECPA,eAAsBC,EAAcC,EAAyC,CAC3E,GAAI,CACF,KAAM,CAAE,KAAAC,EAAM,MAAAC,CAAA,EAAU,MAAMC,EAC3B,KAAK,aAAa,EAClB,OAAO,SAAS,EAChB,GAAG,aAAcH,CAAS,EAC1B,OAAA,EAEH,GAAIE,EAAO,CACT,GAAIA,EAAM,OAAS,WAEjB,aAAME,EAAiBJ,EAAWF,CAAmB,EAC9CA,EAET,MAAMI,CACR,CAEA,OAAID,EAAK,SAAW,MAAM,QAAQA,EAAK,OAAO,GAAKA,EAAK,QAAQ,OAAS,EAChEA,EAAK,SAId,MAAMG,EAAiBJ,EAAWF,CAAmB,EAC9CA,EACT,OAASI,EAAO,CACd,eAAQ,MAAM,4CAA6CA,CAAK,EAEzDJ,CACT,CACF,CAOA,eAAsBM,EAAiBJ,EAAmBK,EAAqC,CAC7F,GAAI,CAEF,GAAI,CAAC,MAAM,QAAQA,CAAO,GAAKA,EAAQ,SAAW,EAChD,MAAM,IAAI,MAAM,mCAAmC,EAGrD,GAAIA,EAAQ,OAAS,EACnB,MAAM,IAAI,MAAM,qCAAqC,EAIvD,UAAWC,KAAUD,EAAS,CAC5B,GAAI,CAACC,EAAO,IAAM,CAACA,EAAO,MAAQ,OAAOA,EAAO,MAAS,SACvD,MAAM,IAAI,MAAM,iDAAiD,EAEnE,GAAIA,EAAO,KAAO,GAAKA,EAAO,KAAO,IACnC,MAAM,IAAI,MAAM,oCAAoC,CAExD,CAGA,MAAMC,EAAMF,EAAQ,IAAIG,GAAKA,EAAE,EAAE,EACjC,GAAI,IAAI,IAAID,CAAG,EAAE,OAASA,EAAI,OAC5B,MAAM,IAAI,MAAM,2BAA2B,EAI7C,KAAM,CAAE,KAAME,EAAU,MAAOC,CAAA,EAAe,MAAMP,EACjD,KAAK,aAAa,EAClB,OAAO,YAAY,EACnB,GAAG,aAAcH,CAAS,EAC1B,OAAA,EAGGW,EAAe,CAACF,GAAaC,GAAcA,EAAW,OAAS,WAE/DE,EAAa,CACjB,WAAYZ,EACZ,QAAAK,EACA,WAAY,IAAI,KAAA,EAAO,YAAA,CAAY,EAGrC,GAAKM,EAQE,CAEL,KAAM,CAAE,MAAAT,GAAU,MAAMC,EACrB,KAAK,aAAa,EAClB,OAAOS,CAAU,EAEpB,GAAIV,EAAO,MAAMA,CACnB,KAfmB,CAEjB,KAAM,CAAE,MAAAA,CAAA,EAAU,MAAMC,EACrB,KAAK,aAAa,EAClB,OAAOS,CAAU,EACjB,GAAG,aAAcZ,CAAS,EAE7B,GAAIE,EAAO,MAAMA,CACnB,CASA,QAAQ,IAAI,kCAAkC,CAChD,OAASA,EAAO,CACd,cAAQ,MAAM,8BAA+BA,CAAK,EAC5CA,CACR,CACF,CAKA,eAAsBW,EAAiBb,EAAmBc,EAA6C,CAErG,OADgB,MAAMf,EAAcC,CAAS,GAC9B,KAAKQ,GAAKA,EAAE,KAAOM,CAAQ,GAAK,IACjD"}