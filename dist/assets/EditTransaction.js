import{u as J,U as Q,j as e}from"./index.js";import{u as Z,b as ee,L as E}from"./router.js";import{r as g}from"./vendor.js";import{t as U,p as te,i as y}from"./inventoryService.js";import{I as P}from"./imageService.js";import{T as ae,I as se}from"./TransactionItemsList.js";import{S as A}from"./Select.js";import{q as re,d as ne,b as oe,r as ie}from"./ui.js";import"./firebase.js";import"./ImagePreview.js";import"./ImageGallery.js";function ve(){const{id:c,transactionId:m}=Z(),L=ee(),{hasRole:R}=J();if(!R(Q.DESIGNER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(re,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to edit transactions. Please contact an administrator if you need access."}),e.jsx(E,{to:`/project/${c}`,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Project"})]})});const[I,M]=g.useState(""),[o,S]=g.useState({transaction_date:"",source:"",transaction_type:"Purchase",payment_method:"",amount:"",budget_category:"Furnishings",notes:"",transaction_images:[],receipt_emailed:!1}),[n,b]=g.useState({}),[k,F]=g.useState(!1),[q,W]=g.useState(!0),[$,T]=g.useState(!1),[j,z]=g.useState([]),[N,_]=g.useState([]),[D,B]=g.useState(new Map);g.useEffect(()=>{(async()=>{if(!(!c||!m))try{const[s,d]=await Promise.all([U.getTransaction(c,m),te.getProject(c)]);if(d&&M(d.name),s){S({transaction_date:s.transaction_date||"",source:s.source,transaction_type:s.transaction_type,payment_method:s.payment_method,amount:s.amount,budget_category:s.budget_category||"Furnishings",notes:s.notes||"",transaction_images:[],receipt_emailed:s.receipt_emailed});const i=s.transaction_images||[];z(Array.isArray(i)?i:[]);try{const l=await y.getTransactionItems(c,m);console.log("Loaded transaction item IDs:",l);const p=await Promise.all(l.map(async a=>{var f,h;const r=await y.getItem(c,a);return console.log(`Loaded item ${a}:`,{id:a,description:(r==null?void 0:r.description)||"",hasValidFormat:a.startsWith("I-")&&a.length>10}),{id:a,description:(r==null?void 0:r.description)||"",price:((f=r==null?void 0:r.price)==null?void 0:f.toString())||"",sku:(r==null?void 0:r.sku)||"",market_value:((h=r==null?void 0:r.market_value)==null?void 0:h.toString())||"",notes:(r==null?void 0:r.notes)||"",imageFiles:[],images:(r==null?void 0:r.images)||[]}}));console.log("Loaded transaction items:",p.map(a=>({id:a.id,description:a.description,isTempId:a.id.startsWith("temp-")}))),_(p)}catch(l){console.error("Error loading transaction items:",l)}}}catch(s){console.error("Error loading transaction:",s)}finally{W(!1)}})()},[c,m]);const K=()=>{var s;const t={};return o.source.trim()||(t.source="Source is required"),o.transaction_type.trim()||(t.transaction_type="Transaction type is required"),o.payment_method.trim()||(t.payment_method="Payment method is required"),(s=o.budget_category)!=null&&s.trim()||(t.budget_category="Budget category is required"),o.amount.trim()?(isNaN(Number(o.amount))||Number(o.amount)<=0)&&(t.amount="Amount must be a positive number"):t.amount="Amount is required",o.transaction_date||(t.transaction_date="Transaction date is required"),b(t),Object.keys(t).length===0},V=async t=>{if(t.preventDefault(),!(!K()||!c||!m)){F(!0);try{if(N.length>0){console.log("All items before processing:",N.map(a=>({id:a.id,description:a.description,price:a.price,sku:a.sku,isTempId:a.id.startsWith("temp-"),idFormat:a.id.startsWith("I-")?"database":a.id.startsWith("temp-")?"temp":"unknown"})));const i=[],l=[];N.forEach(a=>{a.id.startsWith("temp-")?l.push(a):a.id.startsWith("I-")&&a.id.length>10?i.push(a):a.id.length>5&&!a.id.includes("_")?(console.warn(`Item with ambiguous ID treated as existing: ${a.id} - ${a.description}`),i.push(a)):(console.warn(`Item with unclear ID format treated as new: ${a.id} - ${a.description}`),l.push(a))}),console.log(`Separated ${i.length} existing items and ${l.length} new items`);for(const a of i)await y.updateItem(c,a.id,{description:a.description,price:a.price,sku:a.sku,market_value:a.market_value,notes:a.notes,transaction_id:m});let p=[];if(l.length>0&&(p=await y.createTransactionItems(c,m,o.transaction_date,o.source,l),console.log("Created new items:",p),_(a=>a.map(r=>{const f=l.findIndex(h=>h.id===r.id);return f>=0&&f<p.length?{...r,id:p[f]}:r}))),D.size>0&&l.length>0)try{console.log("Starting item image upload process for new items...");const a=await y.getTransactionItems(c,m);console.log("Updated item IDs after creation:",a);for(let r=0;r<l.length&&r<p.length;r++){const f=l[r],h=p[r],v=D.get(f.id);if(v&&v.length>0){console.log(`Uploading ${v.length} images for new item ${h}`);const X=v.map(async(u,Y)=>{try{console.log(`Uploading file ${Y+1}/${v.length}: ${u.name}`);const w=await P.uploadItemImage(u,I,h);return console.log(`Upload successful for ${u.name}:`,w),{url:w.url,alt:u.name,isPrimary:!1,uploadedAt:new Date,fileName:u.name,size:u.size,mimeType:u.type}}catch(w){return console.error(`Failed to upload ${u.name}:`,w),null}}),C=(await Promise.all(X)).filter(u=>u!==null);C.length>0&&(await y.updateItemImages(c,h,C),console.log(`Successfully updated new item ${h} with ${C.length} images`))}}}catch(a){console.error("Error in item image upload process:",a)}}let s=[...j];if(o.transaction_images&&o.transaction_images.length>0){T(!0);try{const i=await P.uploadMultipleTransactionImages(o.transaction_images,I,m,H),l=P.convertFilesToTransactionImages(i);s=[...j,...l]}catch(i){console.error("Error uploading images:",i),b({transaction_images:"Failed to upload transaction images. Please try again."}),F(!1),T(!1);return}T(!1)}else s=j;const d={...o,transaction_images:s};await U.updateTransaction(c,m,d),L(`/project/${c}?tab=transactions`)}catch(s){console.error("Error updating transaction:",s),b({general:s instanceof Error?s.message:"Failed to update transaction. Please try again."})}finally{F(!1)}}},x=(t,s)=>{S(d=>({...d,[t]:s})),n[t]&&b(d=>({...d,[t]:void 0}))},G=t=>{S(s=>({...s,transaction_images:t})),n.transaction_images&&b(s=>({...s,transaction_images:void 0}))},H=(t,s)=>{console.log(`Upload progress for file ${t}: ${s.percentage}%`)},O=(t,s)=>{B(d=>{const i=new Map(d);return i.set(t,s),i}),_(d=>d.map(i=>i.id===t?{...i,imageFiles:s}:i))};return q?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(E,{to:`/project/${c}?tab=transactions`,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Edit Transaction"})}),e.jsxs("form",{onSubmit:V,className:"space-y-6 p-6",children:[n.general&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:n.general})})]})})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"amount",className:"block text-sm font-medium text-gray-700",children:"Amount *"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"amount",value:o.amount,onChange:t=>x("amount",t.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.amount?"border-red-300":"border-gray-300"}`})]}),n.amount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.amount})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"source",className:"block text-sm font-medium text-gray-700",children:"Source/Vendor *"}),e.jsx("input",{type:"text",id:"source",value:o.source,onChange:t=>x("source",t.target.value),placeholder:"e.g., Home Depot, Amazon, Local Store",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.source?"border-red-300":"border-gray-300"}`}),n.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.source})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"payment_method",className:"block text-sm font-medium text-gray-700",children:"Payment Method *"}),e.jsx("input",{type:"text",id:"payment_method",value:o.payment_method,onChange:t=>x("payment_method",t.target.value),placeholder:"e.g., 1584 Card, Client Card, Cash, Check",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.payment_method?"border-red-300":"border-gray-300"}`}),n.payment_method&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.payment_method})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"transaction_date",className:"block text-sm font-medium text-gray-700",children:"Transaction Date *"}),e.jsx("input",{type:"date",id:"transaction_date",value:o.transaction_date,onChange:t=>{x("transaction_date",t.target.value)},className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.transaction_date?"border-red-300":"border-gray-300"}`}),n.transaction_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.transaction_date})]}),e.jsxs(A,{label:"Transaction Type *",id:"transaction_type",value:o.transaction_type,onChange:t=>x("transaction_type",t.target.value),error:n.transaction_type,children:[e.jsx("option",{value:"Purchase",children:"Purchase"}),e.jsx("option",{value:"Return",children:"Return"})]}),e.jsxs(A,{label:"Budget Category *",id:"budget_category",value:o.budget_category||"Furnishings",onChange:t=>x("budget_category",t.target.value),error:n.budget_category,children:[e.jsx("option",{value:"Design Fee",children:"Design Fee"}),e.jsx("option",{value:"Furnishings",children:"Furnishings"}),e.jsx("option",{value:"Property Management",children:"Property Management"}),e.jsx("option",{value:"Kitchen",children:"Kitchen"}),e.jsx("option",{value:"Install",children:"Install"}),e.jsx("option",{value:"Storage & Receiving",children:"Storage & Receiving"}),e.jsx("option",{value:"Fuel",children:"Fuel"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"receipt_emailed",checked:o.receipt_emailed,onChange:t=>x("receipt_emailed",t.target.checked),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"receipt_emailed",className:"ml-2 block text-sm text-gray-900",children:"Receipt emailed to client"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:o.notes,onChange:t=>x("notes",t.target.value),placeholder:"Additional notes about this transaction...",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.notes?"border-red-300":"border-gray-300"}`}),n.notes&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.notes})]}),e.jsx("div",{children:e.jsx(ae,{items:N,onItemsChange:t=>{_(t)},projectId:c,projectName:I,onImageFilesChange:O})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Transaction Images"}),j.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-600 mb-2",children:"Current Images:"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4",children:j.map((t,s)=>e.jsx("div",{className:"relative group",children:e.jsxs("div",{className:"aspect-w-4 aspect-h-3 rounded-lg overflow-hidden bg-gray-100",children:[e.jsx("img",{src:t.url,alt:t.fileName,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center",children:e.jsx("p",{className:"text-white text-xs opacity-0 group-hover:opacity-100 text-center p-2",children:t.fileName})})]})},s))})]}),e.jsx(se,{onImagesChange:G,maxImages:5,maxFileSize:10,disabled:k||$,className:"mb-2"}),n.transaction_images&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.transaction_images})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsxs(E,{to:`/project/${c}?tab=transactions`,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:k||$,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),k?"Updating...":$?"Uploading Images...":"Update Transaction"]})]})]})]})]})}export{ve as default};
//# sourceMappingURL=EditTransaction.js.map
