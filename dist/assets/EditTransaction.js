import{u as Z,U as ee,j as e}from"./index.js";import{u as te,b as ae,L as P}from"./router.js";import{r as p}from"./vendor.js";import{T as A}from"./transactionSources.js";import{t as L,p as se,i as f}from"./inventoryService.js";import{I as D}from"./imageService.js";import{T as re,I as ne}from"./TransactionItemsList.js";import{r as ie,d as oe,b as ce,s as le}from"./ui.js";import"./firebase.js";import"./ImagePreview.js";import"./ImageGallery.js";function ve(){const{id:l,transactionId:x}=te(),M=ae(),{hasRole:W}=Z();if(!W(ee.DESIGNER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(ie,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to edit transactions. Please contact an administrator if you need access."}),e.jsx(P,{to:`/project/${l}`,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Project"})]})});const[I,q]=p.useState(""),[r,k]=p.useState({transaction_date:"",source:"",transaction_type:"Purchase",payment_method:"",amount:"",budget_category:"Furnishings",notes:"",transaction_images:[],receipt_emailed:!1}),[i,j]=p.useState({}),[C,F]=p.useState(!1),[B,z]=p.useState(!0),[S,T]=p.useState(!1),[_,O]=p.useState([]),[N,v]=p.useState([]),[U,K]=p.useState(new Map),[R,$]=p.useState(!1);p.useEffect(()=>{(async()=>{if(!(!l||!x))try{const[a,g]=await Promise.all([L.getTransaction(l,x),se.getProject(l)]);if(g&&q(g.name),a){const d=!!(a.source&&!A.includes(a.source));k({transaction_date:a.transaction_date||"",source:a.source,transaction_type:a.transaction_type,payment_method:a.payment_method,amount:a.amount,budget_category:a.budget_category||"Furnishings",notes:a.notes||"",transaction_images:[],receipt_emailed:a.receipt_emailed}),$(d);const m=a.transaction_images||[];O(Array.isArray(m)?m:[]);try{const u=await f.getTransactionItems(l,x);console.log("Loaded transaction item IDs:",u);const s=await Promise.all(u.map(async o=>{var y,b;const n=await f.getItem(l,o);return console.log(`Loaded item ${o}:`,{id:o,description:(n==null?void 0:n.description)||"",hasValidFormat:o.startsWith("I-")&&o.length>10}),{id:o,description:(n==null?void 0:n.description)||"",price:((y=n==null?void 0:n.price)==null?void 0:y.toString())||"",sku:(n==null?void 0:n.sku)||"",market_value:((b=n==null?void 0:n.market_value)==null?void 0:b.toString())||"",notes:(n==null?void 0:n.notes)||"",imageFiles:[],images:(n==null?void 0:n.images)||[]}}));console.log("Loaded transaction items:",s.map(o=>({id:o.id,description:o.description,isTempId:o.id.startsWith("temp-")}))),v(s)}catch(u){console.error("Error loading transaction items:",u)}}}catch(a){console.error("Error loading transaction:",a)}finally{z(!1)}})()},[l,x]);const V=()=>{var a;const t={};return r.source.trim()||(t.source="Source is required"),r.transaction_type.trim()||(t.transaction_type="Transaction type is required"),r.payment_method.trim()||(t.payment_method="Payment method is required"),(a=r.budget_category)!=null&&a.trim()||(t.budget_category="Budget category is required"),r.amount.trim()?(isNaN(Number(r.amount))||Number(r.amount)<=0)&&(t.amount="Amount must be a positive number"):t.amount="Amount is required",r.transaction_date||(t.transaction_date="Transaction date is required"),j(t),Object.keys(t).length===0},Y=async t=>{if(t.preventDefault(),!(!V()||!l||!x)){F(!0);try{if(N.length>0){console.log("All items before processing:",N.map(s=>({id:s.id,description:s.description,price:s.price,sku:s.sku,isTempId:s.id.startsWith("temp-"),idFormat:s.id.startsWith("I-")?"database":s.id.startsWith("temp-")?"temp":"unknown"})));const d=[],m=[];N.forEach(s=>{s.id.startsWith("temp-")?m.push(s):s.id.startsWith("I-")&&s.id.length>10?d.push(s):s.id.length>5&&!s.id.includes("_")?(console.warn(`Item with ambiguous ID treated as existing: ${s.id} - ${s.description}`),d.push(s)):(console.warn(`Item with unclear ID format treated as new: ${s.id} - ${s.description}`),m.push(s))}),console.log(`Separated ${d.length} existing items and ${m.length} new items`);for(const s of d)await f.updateItem(l,s.id,{description:s.description,price:s.price,sku:s.sku,market_value:s.market_value,notes:s.notes,transaction_id:x});let u=[];if(m.length>0&&(u=await f.createTransactionItems(l,x,r.transaction_date,r.source,m),console.log("Created new items:",u),v(s=>s.map(o=>{const n=m.findIndex(y=>y.id===o.id);return n>=0&&n<u.length?{...o,id:u[n]}:o}))),U.size>0&&m.length>0)try{console.log("Starting item image upload process for new items...");const s=await f.getTransactionItems(l,x);console.log("Updated item IDs after creation:",s);for(let o=0;o<m.length&&o<u.length;o++){const n=m[o],y=u[o],b=U.get(n.id);if(b&&b.length>0){console.log(`Uploading ${b.length} images for new item ${y}`);const J=b.map(async(h,Q)=>{try{console.log(`Uploading file ${Q+1}/${b.length}: ${h.name}`);const w=await D.uploadItemImage(h,I,y);return console.log(`Upload successful for ${h.name}:`,w),{url:w.url,alt:h.name,isPrimary:!1,uploadedAt:new Date,fileName:h.name,size:h.size,mimeType:h.type}}catch(w){return console.error(`Failed to upload ${h.name}:`,w),null}}),E=(await Promise.all(J)).filter(h=>h!==null);E.length>0&&(await f.updateItemImages(l,y,E),console.log(`Successfully updated new item ${y} with ${E.length} images`))}}}catch(s){console.error("Error in item image upload process:",s)}}let a=[..._];if(r.transaction_images&&r.transaction_images.length>0){T(!0);try{const d=await D.uploadMultipleTransactionImages(r.transaction_images,I,x,X),m=D.convertFilesToTransactionImages(d);a=[..._,...m]}catch(d){console.error("Error uploading images:",d),j({transaction_images:"Failed to upload transaction images. Please try again."}),F(!1),T(!1);return}T(!1)}else a=_;const g={...r,transaction_images:a};await L.updateTransaction(l,x,g),M(`/project/${l}?tab=transactions`)}catch(a){console.error("Error updating transaction:",a),j({general:a instanceof Error?a.message:"Failed to update transaction. Please try again."})}finally{F(!1)}}},c=(t,a)=>{k(g=>({...g,[t]:a})),i[t]&&j(g=>({...g,[t]:void 0}))},G=t=>{k(a=>({...a,transaction_images:t})),i.transaction_images&&j(a=>({...a,transaction_images:void 0}))},X=(t,a)=>{console.log(`Upload progress for file ${t}: ${a.percentage}%`)},H=(t,a)=>{K(g=>{const d=new Map(g);return d.set(t,a),d}),v(g=>g.map(d=>d.id===t?{...d,imageFiles:a}:d))};return B?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(P,{to:`/project/${l}?tab=transactions`,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(oe,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Edit Transaction"})}),e.jsxs("form",{onSubmit:Y,className:"space-y-6 p-6",children:[i.general&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:i.general})})]})})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"transaction_date",className:"block text-sm font-medium text-gray-700",children:"Transaction Date *"}),e.jsx("input",{type:"date",id:"transaction_date",value:r.transaction_date,onChange:t=>{c("transaction_date",t.target.value)},className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.transaction_date?"border-red-300":"border-gray-300"}`}),i.transaction_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.transaction_date})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Source/Vendor *"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 mb-3",children:A.map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`source_${t.toLowerCase().replace(/\s+/g,"_")}`,name:"source",value:t,checked:r.source===t,onChange:a=>{c("source",a.target.value),$(!1)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`source_${t.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:t})]},t))}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"source_custom",name:"source",value:"custom",checked:R,onChange:()=>{$(!0),c("source","")},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"source_custom",className:"ml-2 block text-sm text-gray-900",children:"Other"})]}),R&&e.jsx("input",{type:"text",id:"source_custom_input",value:r.source,onChange:t=>c("source",t.target.value),placeholder:"Enter custom source...",className:`mt-3 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.source?"border-red-300":"border-gray-300"}`}),i.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.source})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Transaction Type *"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"type_purchase",name:"transaction_type",value:"Purchase",checked:r.transaction_type==="Purchase",onChange:t=>c("transaction_type",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"type_purchase",className:"ml-2 block text-sm text-gray-900",children:"Purchase"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"type_return",name:"transaction_type",value:"Return",checked:r.transaction_type==="Return",onChange:t=>c("transaction_type",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"type_return",className:"ml-2 block text-sm text-gray-900",children:"Return"})]})]}),i.transaction_type&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.transaction_type})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"amount",className:"block text-sm font-medium text-gray-700",children:"Amount *"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"amount",value:r.amount,onChange:t=>c("amount",t.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.amount?"border-red-300":"border-gray-300"}`})]}),i.amount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.amount})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Transaction Method *"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"method_client_card",name:"payment_method",value:"Client Card",checked:r.payment_method==="Client Card",onChange:t=>c("payment_method",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"method_client_card",className:"ml-2 block text-sm text-gray-900",children:"Client Card"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"method_1584_card",name:"payment_method",value:"1584 Design",checked:r.payment_method==="1584 Design",onChange:t=>c("payment_method",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"method_1584_card",className:"ml-2 block text-sm text-gray-900",children:"1584 Design"})]})]}),i.payment_method&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.payment_method})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Budget Category *"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_design_fee",name:"budget_category",value:"Design Fee",checked:r.budget_category==="Design Fee",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_design_fee",className:"ml-2 block text-sm text-gray-900",children:"Design Fee"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_furnishings",name:"budget_category",value:"Furnishings",checked:r.budget_category==="Furnishings",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_furnishings",className:"ml-2 block text-sm text-gray-900",children:"Furnishings"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_property_management",name:"budget_category",value:"Property Management",checked:r.budget_category==="Property Management",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_property_management",className:"ml-2 block text-sm text-gray-900",children:"Property Management"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_kitchen",name:"budget_category",value:"Kitchen",checked:r.budget_category==="Kitchen",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_kitchen",className:"ml-2 block text-sm text-gray-900",children:"Kitchen"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_install",name:"budget_category",value:"Install",checked:r.budget_category==="Install",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_install",className:"ml-2 block text-sm text-gray-900",children:"Install"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_storage_receiving",name:"budget_category",value:"Storage & Receiving",checked:r.budget_category==="Storage & Receiving",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_storage_receiving",className:"ml-2 block text-sm text-gray-900",children:"Storage & Receiving"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_fuel",name:"budget_category",value:"Fuel",checked:r.budget_category==="Fuel",onChange:t=>c("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_fuel",className:"ml-2 block text-sm text-gray-900",children:"Fuel"})]})]}),i.budget_category&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.budget_category})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Receipt Email Copy"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"receipt_yes",name:"receipt_emailed",checked:r.receipt_emailed===!0,onChange:()=>c("receipt_emailed",!0),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"receipt_yes",className:"ml-2 block text-sm text-gray-900",children:"Yes"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"receipt_no",name:"receipt_emailed",checked:r.receipt_emailed===!1,onChange:()=>c("receipt_emailed",!1),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"receipt_no",className:"ml-2 block text-sm text-gray-900",children:"No"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:r.notes,onChange:t=>c("notes",t.target.value),placeholder:"Additional notes about this transaction...",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.notes?"border-red-300":"border-gray-300"}`}),i.notes&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.notes})]}),e.jsx("div",{children:e.jsx(re,{items:N,onItemsChange:t=>{v(t)},projectId:l,projectName:I,onImageFilesChange:H})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Transaction Images"}),_.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-600 mb-2",children:"Current Images:"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4",children:_.map((t,a)=>e.jsx("div",{className:"relative group",children:e.jsxs("div",{className:"aspect-w-4 aspect-h-3 rounded-lg overflow-hidden bg-gray-100",children:[e.jsx("img",{src:t.url,alt:t.fileName,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center",children:e.jsx("p",{className:"text-white text-xs opacity-0 group-hover:opacity-100 text-center p-2",children:t.fileName})})]})},a))})]}),e.jsx(ne,{onImagesChange:G,maxImages:5,maxFileSize:10,disabled:C||S,className:"mb-2"}),i.transaction_images&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.transaction_images})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsxs(P,{to:`/project/${l}?tab=transactions`,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:C||S,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),C?"Updating...":S?"Uploading Images...":"Update Transaction"]})]})]})]})]})}export{ve as default};
//# sourceMappingURL=EditTransaction.js.map
