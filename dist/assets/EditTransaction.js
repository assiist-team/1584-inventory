import{u as J,U as K,j as e}from"./index.js";import{u as Q,b as Z,L as F}from"./router.js";import{r as p}from"./vendor.js";import{t as D,p as ee,i as y}from"./inventoryService.js";import{I as P}from"./imageService.js";import{T as te,I as ae}from"./TransactionItemsList.js";import{n as se,d as re,b as ne,o as oe}from"./ui.js";import"./firebase.js";import"./ImagePreview.js";import"./ImageGallery.js";function be(){const{id:c,transactionId:m}=Q(),A=Z(),{hasRole:L}=J();if(!L(K.DESIGNER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(se,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to edit transactions. Please contact an administrator if you need access."}),e.jsx(F,{to:`/project/${c}`,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Project"})]})});const[_,R]=p.useState(""),[o,k]=p.useState({transaction_date:"",source:"",transaction_type:"Purchase",payment_method:"",amount:"",notes:"",transaction_images:[],receipt_emailed:!1}),[n,b]=p.useState({}),[S,$]=p.useState(!1),[M,W]=p.useState(!0),[T,C]=p.useState(!1),[j,q]=p.useState([]),[v,w]=p.useState([]),[U,z]=p.useState(new Map);p.useEffect(()=>{(async()=>{if(!(!c||!m))try{const[s,d]=await Promise.all([D.getTransaction(c,m),ee.getProject(c)]);if(d&&R(d.name),s){k({transaction_date:s.transaction_date||"",source:s.source,transaction_type:s.transaction_type,payment_method:s.payment_method,amount:s.amount,notes:s.notes||"",transaction_images:[],receipt_emailed:s.receipt_emailed});const i=s.transaction_images||[];q(Array.isArray(i)?i:[]);try{const l=await y.getTransactionItems(c,m);console.log("Loaded transaction item IDs:",l);const g=await Promise.all(l.map(async t=>{var x,h;const r=await y.getItem(c,t);return console.log(`Loaded item ${t}:`,{id:t,description:(r==null?void 0:r.description)||"",hasValidFormat:t.startsWith("I-")&&t.length>10}),{id:t,description:(r==null?void 0:r.description)||"",price:((x=r==null?void 0:r.price)==null?void 0:x.toString())||"",sku:(r==null?void 0:r.sku)||"",market_value:((h=r==null?void 0:r.market_value)==null?void 0:h.toString())||"",notes:(r==null?void 0:r.notes)||"",imageFiles:[],images:(r==null?void 0:r.images)||[]}}));console.log("Loaded transaction items:",g.map(t=>({id:t.id,description:t.description,isTempId:t.id.startsWith("temp-")}))),w(g)}catch(l){console.error("Error loading transaction items:",l)}}}catch(s){console.error("Error loading transaction:",s)}finally{W(!1)}})()},[c,m]);const B=()=>{const a={};return o.source.trim()||(a.source="Source is required"),o.transaction_type.trim()||(a.transaction_type="Transaction type is required"),o.payment_method.trim()||(a.payment_method="Payment method is required"),o.amount.trim()?(isNaN(Number(o.amount))||Number(o.amount)<=0)&&(a.amount="Amount must be a positive number"):a.amount="Amount is required",o.transaction_date||(a.transaction_date="Transaction date is required"),b(a),Object.keys(a).length===0},V=async a=>{if(a.preventDefault(),!(!B()||!c||!m)){$(!0);try{if(v.length>0){console.log("All items before processing:",v.map(t=>({id:t.id,description:t.description,price:t.price,sku:t.sku,isTempId:t.id.startsWith("temp-"),idFormat:t.id.startsWith("I-")?"database":t.id.startsWith("temp-")?"temp":"unknown"})));const i=[],l=[];v.forEach(t=>{t.id.startsWith("temp-")?l.push(t):t.id.startsWith("I-")&&t.id.length>10?i.push(t):t.id.length>5&&!t.id.includes("_")?(console.warn(`Item with ambiguous ID treated as existing: ${t.id} - ${t.description}`),i.push(t)):(console.warn(`Item with unclear ID format treated as new: ${t.id} - ${t.description}`),l.push(t))}),console.log(`Separated ${i.length} existing items and ${l.length} new items`);for(const t of i)await y.updateItem(c,t.id,{description:t.description,price:t.price,sku:t.sku,market_value:t.market_value,notes:t.notes,transaction_id:m});let g=[];if(l.length>0&&(g=await y.createTransactionItems(c,m,o.transaction_date,o.source,l),console.log("Created new items:",g),w(t=>t.map(r=>{const x=l.findIndex(h=>h.id===r.id);return x>=0&&x<g.length?{...r,id:g[x]}:r}))),U.size>0&&l.length>0)try{console.log("Starting item image upload process for new items...");const t=await y.getTransactionItems(c,m);console.log("Updated item IDs after creation:",t);for(let r=0;r<l.length&&r<g.length;r++){const x=l[r],h=g[r],N=U.get(x.id);if(N&&N.length>0){console.log(`Uploading ${N.length} images for new item ${h}`);const X=N.map(async(u,Y)=>{try{console.log(`Uploading file ${Y+1}/${N.length}: ${u.name}`);const I=await P.uploadItemImage(u,_,h);return console.log(`Upload successful for ${u.name}:`,I),{url:I.url,alt:u.name,isPrimary:!1,uploadedAt:new Date,fileName:u.name,size:u.size,mimeType:u.type}}catch(I){return console.error(`Failed to upload ${u.name}:`,I),null}}),E=(await Promise.all(X)).filter(u=>u!==null);E.length>0&&(await y.updateItemImages(c,h,E),console.log(`Successfully updated new item ${h} with ${E.length} images`))}}}catch(t){console.error("Error in item image upload process:",t)}}let s=[...j];if(o.transaction_images&&o.transaction_images.length>0){C(!0);try{const i=await P.uploadMultipleTransactionImages(o.transaction_images,_,m,H),l=P.convertFilesToTransactionImages(i);s=[...j,...l]}catch(i){console.error("Error uploading images:",i),b({transaction_images:"Failed to upload transaction images. Please try again."}),$(!1),C(!1);return}C(!1)}else s=j;const d={...o,transaction_images:s};await D.updateTransaction(c,m,d),A(`/project/${c}?tab=transactions`)}catch(s){console.error("Error updating transaction:",s),b({general:s instanceof Error?s.message:"Failed to update transaction. Please try again."})}finally{$(!1)}}},f=(a,s)=>{k(d=>({...d,[a]:s})),n[a]&&b(d=>({...d,[a]:void 0}))},G=a=>{k(s=>({...s,transaction_images:a})),n.transaction_images&&b(s=>({...s,transaction_images:void 0}))},H=(a,s)=>{console.log(`Upload progress for file ${a}: ${s.percentage}%`)},O=(a,s)=>{z(d=>{const i=new Map(d);return i.set(a,s),i}),w(d=>d.map(i=>i.id===a?{...i,imageFiles:s}:i))};return M?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(F,{to:`/project/${c}?tab=transactions`,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Edit Transaction"})}),e.jsxs("form",{onSubmit:V,className:"space-y-6 p-6",children:[n.general&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:n.general})})]})})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"amount",className:"block text-sm font-medium text-gray-700",children:"Amount *"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"amount",value:o.amount,onChange:a=>f("amount",a.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.amount?"border-red-300":"border-gray-300"}`})]}),n.amount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.amount})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"source",className:"block text-sm font-medium text-gray-700",children:"Source/Vendor *"}),e.jsx("input",{type:"text",id:"source",value:o.source,onChange:a=>f("source",a.target.value),placeholder:"e.g., Home Depot, Amazon, Local Store",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.source?"border-red-300":"border-gray-300"}`}),n.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.source})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"payment_method",className:"block text-sm font-medium text-gray-700",children:"Payment Method *"}),e.jsx("input",{type:"text",id:"payment_method",value:o.payment_method,onChange:a=>f("payment_method",a.target.value),placeholder:"e.g., 1584 Card, Client Card, Cash, Check",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.payment_method?"border-red-300":"border-gray-300"}`}),n.payment_method&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.payment_method})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"transaction_date",className:"block text-sm font-medium text-gray-700",children:"Transaction Date *"}),e.jsx("input",{type:"date",id:"transaction_date",value:o.transaction_date,onChange:a=>{f("transaction_date",a.target.value)},className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.transaction_date?"border-red-300":"border-gray-300"}`}),n.transaction_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.transaction_date})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"transaction_type",className:"block text-sm font-medium text-gray-700",children:"Transaction Type *"}),e.jsxs("select",{id:"transaction_type",value:o.transaction_type,onChange:a=>f("transaction_type",a.target.value),className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.transaction_type?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"Purchase",children:"Purchase"}),e.jsx("option",{value:"Return",children:"Return"})]}),n.transaction_type&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.transaction_type})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"receipt_emailed",checked:o.receipt_emailed,onChange:a=>f("receipt_emailed",a.target.checked),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"receipt_emailed",className:"ml-2 block text-sm text-gray-900",children:"Receipt emailed to client"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:o.notes,onChange:a=>f("notes",a.target.value),placeholder:"Additional notes about this transaction...",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${n.notes?"border-red-300":"border-gray-300"}`}),n.notes&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.notes})]}),e.jsx("div",{children:e.jsx(te,{items:v,onItemsChange:a=>{w(a)},projectId:c,projectName:_,onImageFilesChange:O})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Transaction Images"}),j.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"text-xs font-medium text-gray-600 mb-2",children:"Current Images:"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-4",children:j.map((a,s)=>e.jsx("div",{className:"relative group",children:e.jsxs("div",{className:"aspect-w-4 aspect-h-3 rounded-lg overflow-hidden bg-gray-100",children:[e.jsx("img",{src:a.url,alt:a.fileName,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center",children:e.jsx("p",{className:"text-white text-xs opacity-0 group-hover:opacity-100 text-center p-2",children:a.fileName})})]})},s))})]}),e.jsx(ae,{onImagesChange:G,maxImages:5,maxFileSize:10,disabled:S||T,className:"mb-2"}),n.transaction_images&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:n.transaction_images})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsxs(F,{to:`/project/${c}?tab=transactions`,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:S||T,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),S?"Updating...":T?"Uploading Images...":"Update Transaction"]})]})]})]})]})}export{be as default};
//# sourceMappingURL=EditTransaction.js.map
