import{d as oe,e as le,j as e,C as de,f as me,h as be,i as je,B as re}from"./index.js";import{r as l}from"./vendor.js";import{L as R,c as ue,b as we,u as ve,d as Ne}from"./router.js";import{l as xe,u as F,i as Ce,f as ke,a as Ie,t as _,p as G}from"./inventoryService.js";import{I as ie}from"./imageService.js";import{u as Se}from"./useBookmark.js";import{u as Pe}from"./useDuplication.js";import{u as Te}from"./useNavigationContext.js";import{f as ge,m as he,n as fe,Q as Ee,T as pe,R as De,B as Le,h as ye,i as Ae,j as Fe,o as $e,g as ae,l as ce,D as Be,p as Me,q as Re,r as Ue,P as ze}from"./ui.js";import{B as Oe,P as _e}from"./BudgetProgress.js";import"./supabase.js";import"./taxPresetsService.js";function qe({projectId:c,projectName:g,items:b}){const{currentAccountId:a,loading:p}=oe(),[w,$]=l.useState(""),[n,P]=l.useState(new Set),[u,k]=l.useState(b||[]),[E,z]=l.useState(!1),[T,v]=l.useState(null),j=p,[B,M]=l.useState(new Set),[r,x]=l.useState(null),[h,f]=l.useState("all"),[N,C]=l.useState(!1),{showSuccess:I,showError:D}=le();l.useEffect(()=>{console.log("üîç InventoryList - accountLoading:",p,"propItems length:",(b==null?void 0:b.length)||0,"isLoading:",j)},[p,b,j]),l.useEffect(()=>{console.log("üîç InventoryList - propItems changed:",(b==null?void 0:b.length)||0),k(b||[])},[b]),l.useEffect(()=>{if(!a||u.length===0)return;const t=new Map;try{u.forEach(s=>{if(!(s!=null&&s.itemId))return;const i=xe.subscribeToItemLineageForItem(a,s.itemId,async()=>{try{const m=await F.getItemById(a,s.itemId);m&&(m.projectId===c?k(y=>y.map(S=>S.itemId===m.itemId?m:S)):k(y=>y.filter(S=>S.itemId!==m.itemId)))}catch(m){console.debug("InventoryList - failed to refetch item on lineage event",m)}});t.set(s.itemId,i)})}catch(s){console.debug("InventoryList - failed to setup per-item lineage subscriptions",s)}return()=>{t.forEach(s=>{try{s()}catch{}})}},[u.map(t=>t.itemId).join(","),a,c]),l.useEffect(()=>()=>{M(new Set)},[]),l.useEffect(()=>{const t=s=>{if(r&&!s.target)return;const i=s.target;!i.closest(".disposition-menu")&&!i.closest(".disposition-badge")&&x(null),N&&!i.closest(".filter-menu")&&!i.closest(".filter-button")&&C(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[r,N]);const V=t=>{P(t?new Set(u.map(s=>s.itemId)):new Set)},O=(t,s)=>{const i=new Set(n);s?i.add(t):i.delete(t),P(i)},{toggleBookmark:W}=Se({items:u,setItems:k,updateItemService:(t,s)=>{if(!a)throw new Error("Account ID is required");return F.updateItem(a,t,s)},projectId:c}),{duplicateItem:q}=Pe({items:u,setItems:k,projectId:c}),{buildContextUrl:H}=Te(),K=async(t,s)=>{console.log("üéØ InventoryList updateDisposition called:",t,s);try{const i=u.find(m=>m.itemId===t);if(!i){console.error("‚ùå Item not found for disposition update:",t);return}if(console.log("üìù Updating disposition from",i.disposition,"to",s),!a)throw new Error("Account ID is required");if(await F.updateItem(a,t,{disposition:s}),console.log("üíæ Database updated successfully"),s==="inventory"){console.log("üöÄ Starting deallocation process for item:",t);try{await Ce.handleItemDeallocation(a,t,i.projectId||"",s),console.log("‚úÖ Deallocation completed successfully"),x(null)}catch(m){console.error("‚ùå Failed to handle deallocation:",m),await F.updateItem(a,t,{disposition:i.disposition}),v("Failed to move item to inventory. Please try again.");return}}else k(u.map(m=>m.itemId===t?{...m,disposition:s}:m)),x(null)}catch(i){console.error("‚ùå Failed to update disposition:",i),v("Failed to update item disposition. Please try again.")}},X=t=>{x(r===t?null:t)},J=t=>{const s="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium cursor-pointer transition-colors hover:opacity-80";switch(t){case"keep":return`${s} bg-green-100 text-green-800`;case"to return":case"return":return`${s} bg-red-100 text-red-700`;case"returned":return`${s} bg-red-800 text-red-100`;case"inventory":return`${s} bg-primary-100 text-primary-600`;default:return`${s} bg-gray-100 text-gray-800`}},Z=async t=>{var s,i;try{M(y=>new Set(y).add(t));const m=await ie.selectFromGallery();if(m.length>0)for(let y=0;y<m.length;y++){const S=m[y];await ee(t,S,m)}}catch(m){if(console.error("Error adding image:",m),(s=m.message)!=null&&s.includes("timeout")||(i=m.message)!=null&&i.includes("canceled")){console.log("User canceled image selection or selection timed out");return}D("Failed to add image. Please try again.")}finally{M(m=>{const y=new Set(m);return y.delete(t),y})}},ee=async(t,s,i)=>{const y={url:(await ie.uploadItemImage(s,g,t)).url,alt:s.name,isPrimary:!0,uploadedAt:new Date,fileName:s.name,size:s.size,mimeType:s.type};if(!a)throw new Error("Account ID is required");if(await F.updateItem(a,t,{images:[y]}),i&&i.indexOf(s)===i.length-1){const S=i.length>1?`${i.length} images uploaded successfully!`:"Image uploaded successfully!";I(S)}},te=async()=>{if(n.size===0)return;const t=`Are you sure you want to delete ${n.size} item(s)? This action cannot be undone.`;if(confirm(t)){if(!a){v("Account ID is required");return}try{const s=Array.from(n).map(i=>F.deleteItem(a,i));await Promise.all(s),P(new Set),v(null)}catch(s){console.error("Failed to delete items:",s),v("Failed to delete some items. Please try again.")}}},Q=u.filter(t=>{var m,y;const s=t.description.toLowerCase().includes(w.toLowerCase())||t.source.toLowerCase().includes(w.toLowerCase())||((m=t.sku)==null?void 0:m.toLowerCase().includes(w.toLowerCase()))||((y=t.paymentMethod)==null?void 0:y.toLowerCase().includes(w.toLowerCase()))||t.space&&t.space.toLowerCase().includes(w.toLowerCase());let i=!1;switch(h){case"all":i=!0;break;case"bookmarked":i=t.bookmark;break;case"to-inventory":i=t.disposition==="inventory";break;case"from-inventory":i=t.source==="Inventory";break;default:i=!0}return s&&i});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-2",children:e.jsxs(R,{to:`/project/${c}/item/add`,className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200 w-full sm:w-auto",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Add Item"]})}),e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 pb-0 mb-2",children:e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"relative pt-2",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(he,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",className:"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base",placeholder:"Search items...",value:w,onChange:t=>$(t.target.value)})]}),e.jsxs("div",{className:"flex items-center justify-between gap-4 p-3 rounded-lg",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4",onChange:t=>V(t.target.checked),checked:n.size===u.length&&u.length>0}),e.jsx("span",{className:"ml-3 text-sm font-medium text-gray-700",children:"Select all"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[n.size>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:[n.size," of ",u.length," selected"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>C(!N),className:`filter-button inline-flex items-center justify-center px-3 py-2 border text-sm font-medium rounded-md transition-colors duration-200 ${h==="all"?"border-gray-300 text-gray-700 bg-white hover:bg-gray-50":"border-primary-500 text-primary-600 bg-primary-50 hover:bg-primary-100"}`,title:"Filter items",children:e.jsx(fe,{className:"h-4 w-4"})}),N&&e.jsx("div",{className:"filter-menu absolute top-full left-0 mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10",children:e.jsxs("div",{className:"py-1",children:[e.jsx("button",{onClick:()=>{f("all"),C(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${h==="all"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"All Items"}),e.jsx("button",{onClick:()=>{f("bookmarked"),C(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${h==="bookmarked"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"Bookmarked"}),e.jsx("button",{onClick:()=>{f("to-inventory"),C(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${h==="to-inventory"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"To Inventory"}),e.jsx("button",{onClick:()=>{f("from-inventory"),C(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${h==="from-inventory"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"From Inventory"})]})})]}),e.jsx("button",{className:"inline-flex items-center justify-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 transition-colors duration-200",disabled:n.size===0,title:"Generate QR Codes",children:e.jsx(Ee,{className:"h-4 w-4"})}),e.jsx("button",{onClick:te,className:"inline-flex items-center justify-center px-3 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200",disabled:n.size===0,title:"Delete All",children:e.jsx(pe,{className:"h-4 w-4"})})]})]})]})]})}),j&&e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-gray-400 animate-spin mb-4",children:e.jsxs("svg",{fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Loading inventory..."}),e.jsx("p",{className:"text-sm text-gray-500",children:"Fetching your project items."})]}),T&&e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-red-400 mb-4",children:"‚ö†Ô∏è"}),e.jsx("h3",{className:"text-lg font-medium text-red-900 mb-2",children:"Error loading inventory"}),e.jsx("p",{className:"text-sm text-red-500 mb-6 max-w-sm mx-auto",children:T}),e.jsxs("button",{onClick:()=>window.location.reload(),className:"inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors duration-200 w-full sm:w-auto max-w-xs",children:[e.jsx(De,{className:"h-5 w-5 mr-2"}),"Retry"]})]}),!j&&!T&&Q.length===0?e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-gray-400 -mb-1",children:"üì¶"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No items yet"})]}):!j&&!T&&e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:e.jsx("ul",{className:"divide-y divide-gray-200",children:Q.map(t=>e.jsxs("li",{className:"relative bg-gray-50 transition-colors duration-200 hover:bg-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0 px-4 py-3",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4 flex-shrink-0",checked:n.has(t.itemId),onChange:s=>O(t.itemId,s.target.checked)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),W(t.itemId)},className:`inline-flex items-center justify-center p-2 border text-sm font-medium rounded-md transition-colors ${t.bookmark?"border-red-300 text-red-700 bg-red-50 hover:bg-red-100":"border-gray-300 text-gray-700 bg-white hover:bg-gray-50"} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500`,title:t.bookmark?"Remove Bookmark":"Add Bookmark",children:e.jsx(Le,{className:"h-4 w-4",fill:t.bookmark?"currentColor":"none"})}),e.jsx(R,{to:`/project/${c}/edit-item/${t.itemId}?project=${c}&returnTo=${encodeURIComponent(window.location.pathname+window.location.search)}`,onClick:s=>s.stopPropagation(),className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors",title:"Edit item",children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),q(t.itemId)},className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors",title:"Duplicate item",children:e.jsx(Ae,{className:"h-4 w-4"})}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs("span",{onClick:s=>{s.preventDefault(),s.stopPropagation(),X(t.itemId)},className:`disposition-badge ${J(t.disposition)}`,children:[t.disposition==="to return"?"To Return":t.disposition?t.disposition.charAt(0).toUpperCase()+t.disposition.slice(1):"Not Set",e.jsx(Fe,{className:"h-3 w-3 ml-1"})]}),r===t.itemId&&e.jsx("div",{className:"disposition-menu absolute top-full left-0 mt-1 w-32 bg-white border border-gray-200 rounded-md shadow-lg z-10",children:e.jsx("div",{className:"py-1",children:["keep","to return","returned","inventory"].map(s=>e.jsx("button",{onClick:i=>{i.preventDefault(),i.stopPropagation(),K(t.itemId,s)},className:`block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 ${t.disposition===s||s==="to return"&&t.disposition==="return"?"bg-gray-100 text-gray-900":"text-gray-700"}`,disabled:!t.disposition,children:s==="to return"?"To Return":s.charAt(0).toUpperCase()+s.slice(1)},s))})})]})]})]}),e.jsx(R,{to:H(`/item/${t.itemId}`,{project:c}),children:e.jsx("div",{className:"block bg-transparent",children:e.jsxs("div",{className:"px-4 pb-3 sm:px-6",children:[e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsx("div",{className:"flex-shrink-0",children:t.images&&t.images.length>0?(()=>{const s=t.images.find(i=>i.isPrimary)||t.images[0];return e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:s.url,alt:s.alt||"Item image",className:"w-full h-full object-cover"})})})():e.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),Z(t.itemId)},disabled:B.has(t.itemId),className:"w-16 h-16 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:border-gray-400 transition-colors disabled:opacity-50",title:"Add image (camera or gallery)",children:e.jsx($e,{className:"h-6 w-6"})})}),e.jsx("div",{className:"flex-1 min-w-0 flex items-center",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-900 line-clamp-2 break-words",children:t.description}),t.space&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.space})]})})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[(t.projectPrice||t.purchasePrice)&&e.jsxs("span",{className:"font-medium text-gray-700",children:["$",t.projectPrice||t.purchasePrice]}),t.source&&e.jsxs(e.Fragment,{children:[(t.projectPrice||t.purchasePrice)&&e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.source})]}),t.sku&&e.jsxs(e.Fragment,{children:[(t.projectPrice||t.purchasePrice||t.source)&&e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.sku})]})]})})]})})})]},t.itemId))})})]})}const We=c=>{var g,b;return(g=c.transactionId)!=null&&g.startsWith("INV_SALE_")?be:(b=c.transactionId)!=null&&b.startsWith("INV_PURCHASE_")?je:c.source},ne=()=>{document.querySelectorAll(".no-icon").forEach(g=>{Array.from(g.childNodes).forEach(a=>{a.nodeType!==Node.TEXT_NODE&&g.removeChild(a)})})};function Qe({projectId:c,transactions:g}){const{id:b}=ue(),{currentAccountId:a}=oe(),p=c||b,[w,$]=l.useState(g||[]),[n,P]=l.useState(!g),[u,k]=l.useState({}),[E,z]=l.useState(""),[T,v]=l.useState(!1),[j,B]=l.useState("all");l.useEffect(()=>{if(g){$(g);return}let r;const x=f=>{!p||!a||(r=_.subscribeToTransactions(a,p,N=>{$(N)},f))};return(async()=>{if(!p||!a){P(!1);return}if(!g)try{const f=await _.getTransactions(a,p);$(f),x(f)}catch(f){console.error("Error loading transactions:",f),$([])}finally{P(!1)}})(),()=>{r&&r()}},[p,a,g]),l.useEffect(()=>{let r=!0;return(async()=>{if(!(!p||!a||w.length===0))try{const h=w.filter(I=>I.needsReview===void 0),f=h.map(I=>_.getTransactionCompleteness(a,p,I.transactionId).catch(D=>(console.debug("Failed to load completeness for",I.transactionId,D),null))),N=await Promise.all(f);if(!r)return;const C={};h.forEach((I,D)=>{C[I.transactionId]=N[D]}),k(C)}catch(h){console.error("Error loading transaction completeness:",h)}})(),()=>{r=!1}},[w,p,a]);const M=l.useMemo(()=>{let r=w;if(j!=="all"&&(j==="we-owe"?r=r.filter(x=>x.reimbursementType===de):j==="client-owes"&&(r=r.filter(x=>x.reimbursementType===me))),E){const x=E.toLowerCase();r=r.filter(h=>{var f,N,C;return((f=h.source)==null?void 0:f.toLowerCase().includes(x))||((N=h.transactionType)==null?void 0:N.toLowerCase().includes(x))||((C=h.notes)==null?void 0:C.toLowerCase().includes(x))})}return r},[w,j,E]);return l.useEffect(()=>{const r=x=>{if(!x.target)return;const h=x.target;!h.closest(".filter-menu")&&!h.closest(".filter-button")&&v(!1)};return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]),l.useEffect(()=>{ne();const r=setTimeout(ne,100),x=setTimeout(ne,500);return()=>{clearTimeout(r),clearTimeout(x)}},[w]),n?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2",children:e.jsxs(R,{to:`/project/${p}/transaction/add`,className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200 w-full sm:w-auto",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Add Transaction"]})}),e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 pb-0 mb-2",children:e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"relative pt-2",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(he,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",className:"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base",placeholder:"Search transactions by source, type, or notes...",value:E||"",onChange:r=>z(r.target.value)})]}),e.jsx("div",{className:"flex items-center justify-end gap-4 p-3 rounded-lg",children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>v(!T),className:`filter-button inline-flex items-center justify-center px-3 py-2 border text-sm font-medium rounded-md transition-colors duration-200 ${j==="all"?"border-gray-300 text-gray-700 bg-white hover:bg-gray-50":"border-primary-500 text-primary-600 bg-primary-50 hover:bg-primary-100"}`,title:"Filter transactions",children:e.jsx(fe,{className:"h-4 w-4"})}),T&&e.jsx("div",{className:"filter-menu absolute top-full right-0 mt-1 w-40 bg-white border border-gray-200 rounded-md shadow-lg z-10",children:e.jsxs("div",{className:"py-1",children:[e.jsx("button",{onClick:()=>{B("all"),v(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${j==="all"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"All Transactions"}),e.jsx("button",{onClick:()=>{B("we-owe"),v(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${j==="we-owe"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"We Owe"}),e.jsx("button",{onClick:()=>{B("client-owes"),v(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${j==="client-owes"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"Client Owes"})]})})]})})]})}),M.length===0?e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-gray-400 -mb-1",children:"üßæ"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No transactions found"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:E||j!=="all"?"Try adjusting your search or filter criteria.":"No transactions found."})]}):e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:e.jsx("ul",{className:"divide-y divide-gray-200",children:M.map(r=>{var x;return e.jsx("li",{className:"relative",children:e.jsx(R,{to:`/project/${p}/transaction/${r.transactionId}`,className:"block bg-gray-50 transition-colors duration-200 hover:bg-gray-100",children:e.jsxs("div",{className:"px-4 py-4 sm:px-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("div",{className:"flex items-center",children:e.jsx("h3",{className:"text-base font-medium text-gray-900",children:We(r)})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500",children:[e.jsx("span",{className:"font-medium text-gray-700",children:ke(r.amount)}),e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700 capitalize",children:r.paymentMethod}),e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:Ie(r.transactionDate)})]}),r.notes&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:r.notes})]}),e.jsxs("div",{className:"mt-3 flex items-center flex-wrap gap-2",children:[r.budgetCategory&&e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${r.budgetCategory==="Design Fee"?"bg-amber-100 text-amber-800":r.budgetCategory==="Furnishings"?"bg-yellow-100 text-yellow-800":r.budgetCategory==="Property Management"?"bg-orange-100 text-orange-800":r.budgetCategory==="Kitchen"?"bg-amber-200 text-amber-900":r.budgetCategory==="Install"?"bg-yellow-200 text-yellow-900":r.budgetCategory==="Storage & Receiving"?"bg-orange-200 text-orange-900":r.budgetCategory==="Fuel"?"bg-amber-300 text-amber-900":"bg-gray-100 text-gray-800"}`,children:r.budgetCategory}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium no-icon ${r.transactionType==="Purchase"?"bg-green-100 text-green-800":r.transactionType==="Return"?"bg-red-100 text-red-800":r.transactionType==="To Inventory"?"bg-primary-100 text-primary-800":"bg-gray-100 text-gray-800"}`,children:r.transactionType}),r.needsReview===!0?e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800",children:"Needs Review"}):u[r.transactionId]&&((x=u[r.transactionId])==null?void 0:x.completenessStatus)!=="complete"&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800",children:"Missing Items"})]})]})})},r.transactionId)})})})]})}function nt(){var S;const{id:c}=ue(),g=we(),b=ve(),{currentAccountId:a}=oe(),[p,w]=Ne(),$=p.get("budgetTab"),[n,P]=l.useState(null),[u,k]=l.useState([]),[E,z]=l.useState([]),[T,v]=l.useState(!0),[j,B]=l.useState(null),[M,r]=l.useState(!1),[x,h]=l.useState(!1),[f,N]=l.useState(!1),{showError:C}=le(),I=p.get("tab")||"transactions",[D,V]=l.useState(()=>$==="accounting"?"accounting":"budget"),O=new URLSearchParams(b.search),W=O.get("from")==="business-inventory-item",q=l.useMemo(()=>{const o=O.get("returnTo");if(o)return o;if(W){const d=O.get("returnTo");return d&&d.includes("/business-inventory/")?d:"/business-inventory"}return"/projects"},[W,O]),H=o=>{const d=new URLSearchParams(p);d.set("tab",o),w(d)},K=o=>{V(o);const d=new URLSearchParams(p);d.set("budgetTab",o),w(d)},X=l.useMemo(()=>u.filter(o=>o.status!=="canceled").filter(o=>o.reimbursementType===me).reduce((o,d)=>o+parseFloat(d.amount||"0"),0),[u]),J=l.useMemo(()=>u.filter(o=>o.status!=="canceled").filter(o=>o.reimbursementType===de).reduce((o,d)=>o+parseFloat(d.amount||"0"),0),[u]);l.useEffect(()=>{console.log("üîç ProjectDetail - useEffect triggered. id:",c,"currentAccountId:",a,"isLoading:",T);let o,d;const Y=A=>{!c||!a||(o=_.subscribeToTransactions(a,c,U=>{k(U)},A))},L=A=>{!c||!a||(d=F.subscribeToProjectItems(a,c,U=>{z(U)},A))};return(async()=>{if(console.log("üîç ProjectDetail - loadData called. id:",c,"currentAccountId:",a),!c){console.warn("No project ID provided, redirecting to projects"),g("/projects");return}if(!a){console.log("üîç ProjectDetail - No account ID yet, waiting...");return}v(!0);try{console.log("üîç ProjectDetail - Loading project data for ID:",c);const A=await G.getProject(a,c);if(A){console.log("üîç ProjectDetail - Project loaded successfully:",A.name),P(A);const[U,se]=await Promise.all([_.getTransactions(a,c),F.getItemsByProject(a,c)]);console.log("üîç ProjectDetail - Loaded",U.length,"transactions and",se.length,"items"),k(U),z(se),Y(U),L(se)}else console.warn("Project not found:",c),g("/projects")}catch(A){console.error("Error loading project:",A),B("Failed to load project. Please try again.")}finally{v(!1)}})(),()=>{o&&o(),d&&d()}},[c,a,g]),l.useEffect(()=>{if(!a||!c||u.length===0)return;const o=[];try{u.forEach(d=>{if(!d.transactionId)return;const Y=xe.subscribeToEdgesFromTransaction(a,d.transactionId,async()=>{try{const L=await F.getItemsByProject(a,c);z(L)}catch(L){console.debug("ProjectDetail - failed to refresh items on lineage event",L)}try{const L=await _.getTransactions(a,c);k(L)}catch(L){console.debug("ProjectDetail - failed to refresh transactions on lineage event",L)}});o.push(Y)})}catch(d){console.debug("ProjectDetail - failed to subscribe to edges from transactions",d)}return()=>{o.forEach(d=>{try{d()}catch{}})}},[u.map(o=>o.transactionId).join(","),a,c]);const Z=()=>{B(null),c&&a&&g(0)},ee=async o=>{if(!(!n||!c||!a))try{await G.updateProject(a,c,o);const d=await G.getProject(a,c);P(d),r(!1)}catch(d){throw console.error("Error updating project:",d),d}},te=()=>{r(!0)},Q=()=>{r(!1)},t=()=>{h(!0)},s=()=>{h(!1)},i=async()=>{if(!(!c||!a)){N(!0);try{await G.deleteProject(a,c),g("/projects")}catch(o){console.error("Error deleting project:",o),N(!1),h(!1),C("Failed to delete project. Please try again.")}}},m=[{id:"inventory",name:"Items",icon:ze},{id:"transactions",name:"Transactions",icon:ce}],y=[{id:"budget",name:"Budget",icon:ce},{id:"accounting",name:"Accounting",icon:Be}];return T?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading project..."})]})}):j?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-red-400",children:"‚ö†Ô∏è"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Error Loading Project"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:j}),e.jsxs("div",{className:"mt-6 flex justify-center space-x-3",children:[e.jsx("button",{onClick:Z,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Try Again"}),e.jsxs(R,{to:q,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Back to Projects"]})]})]}):n?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(R,{to:q,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("button",{onClick:te,className:"inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Edit"]}),e.jsxs("button",{onClick:t,className:"inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-1",children:n.name}),n.clientName&&e.jsx("p",{className:"text-lg text-gray-600 mb-6",children:n.clientName})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"-mb-px flex space-x-8",children:y.map(o=>{const d=o.icon;return e.jsxs("button",{onClick:()=>K(o.id),className:`py-4 px-1 border-b-2 font-medium text-base flex items-center ${D===o.id?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),o.name]},o.id)})})}),e.jsxs("div",{className:"pt-6",children:[D==="budget"&&n&&e.jsx(Oe,{budget:n.budget,designFee:n.designFee,budgetCategories:n.budgetCategories,transactions:u}),D==="accounting"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("section",{children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 mb-0.5",children:"Owed to Design Business"}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:["$",X.toFixed(2)]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 mb-0.5",children:"Owed to Client"}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:["$",J.toFixed(2)]})]})]})}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Reports"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(re,{variant:"secondary",onClick:()=>g(`/project/${n.id}/property-management-summary`),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Generate Property Management Summary"]}),e.jsxs(re,{variant:"secondary",onClick:()=>g(`/project/${n.id}/client-summary`),children:[e.jsx(Re,{className:"h-4 w-4 mr-2"}),"Generate Client Summary"]}),e.jsxs(re,{variant:"secondary",onClick:()=>g(`/project/${n.id}/invoice`),children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Generate Invoice"]})]})]})]})]})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"-mb-px flex space-x-8 px-6",children:m.map(o=>{const d=o.icon;return e.jsxs("button",{onClick:()=>H(o.id),className:`py-4 px-1 border-b-2 font-medium text-base flex items-center ${I===o.id?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),o.name]},o.id)})})}),e.jsxs("div",{className:"px-6 py-6",children:[I==="inventory"&&n&&e.jsxs(e.Fragment,{children:[console.log("üîç ProjectDetail - Rendering InventoryList with",E.length,"items"),e.jsx(qe,{projectId:n.id,projectName:n.name,items:E})]}),I==="transactions"&&n&&e.jsx(Qe,{projectId:n.id,transactions:u})]})]}),M&&n&&e.jsx(_e,{initialData:{name:n.name,description:n.description,clientName:n.clientName,budget:n.budget,designFee:n.designFee,budgetCategories:n.budgetCategories},onSubmit:ee,onCancel:Q}),x&&e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Delete"}),e.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"mt-2",children:[e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Are you sure you want to delete the project ",e.jsxs("strong",{children:['"',n==null?void 0:n.name,'"']}),"? This action cannot be undone and will permanently delete the project and all associated data."]}),n&&((S=n.metadata)==null?void 0:S.totalItems)&&n.metadata.totalItems>0&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Warning"}),e.jsx("div",{className:"mt-1 text-sm text-yellow-700",children:e.jsxs("p",{children:["This project contains ",n.metadata.totalItems," item(s). Deleting the project will permanently remove all associated data."]})})]})})}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:s,disabled:f,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:i,disabled:f,className:"px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50",children:f?"Deleting...":"Delete"})]})]})]})})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"üìÅ"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Project not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The project you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(R,{to:q,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Back to Projects"]})})]})}export{nt as default};
//# sourceMappingURL=ProjectDetail.js.map
