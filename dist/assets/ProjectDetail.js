import{d as ie,e as de,j as e,C as me,f as ue,h as ve,i as Ne,B as re}from"./index.js";import{r as c}from"./vendor.js";import{b as xe,u as we,c as Ce}from"./router.js";import{C as ae}from"./ContextBackLink.js";import{u as ke}from"./useStackedNavigate.js";import{l as ge,u as F,i as Ie,f as Se,a as Pe,t as U,p as G}from"./inventoryService.js";import{C as W}from"./ContextLink.js";import{I as ce}from"./imageService.js";import{d as Te,a as Ee,n as De}from"./dispositionUtils.js";import{u as Le}from"./useBookmark.js";import{u as Ae}from"./useDuplication.js";import{u as he}from"./useNavigationContext.js";import{f as fe,m as pe,n as ye,T as be,R as Fe,B as $e,h as je,i as Be,j as Me,o as Re,g as ne,l as le,D as ze,p as Ue,q as Oe,r as _e,P as qe}from"./ui.js";import{B as We,P as Ye}from"./BudgetProgress.js";import"./supabase.js";import"./taxPresetsService.js";import"./CategorySelect.js";function Qe({projectId:i,projectName:x,items:b}){const{currentAccountId:n,loading:h}=ie(),$=!1,[w,l]=c.useState(""),[C,v]=c.useState(new Set),[p,P]=c.useState(b||[]),[T,O]=c.useState(!1),[E,k]=c.useState(null),j=h,[B,D]=c.useState(new Set),[r,u]=c.useState(null),[g,y]=c.useState("all"),[I,N]=c.useState(!1),{showSuccess:S,showError:M}=de();c.useEffect(()=>{console.log("üîç InventoryList - accountLoading:",h,"propItems length:",(b==null?void 0:b.length)||0,"isLoading:",j)},[h,b,j]),c.useEffect(()=>{console.log("üîç InventoryList - propItems changed:",(b==null?void 0:b.length)||0),P(b||[])},[b]),c.useEffect(()=>{if(!n||p.length===0)return;const t=new Map;try{p.forEach(s=>{if(!(s!=null&&s.itemId))return;const o=ge.subscribeToItemLineageForItem(n,s.itemId,async()=>{try{const m=await F.getItemById(n,s.itemId);m&&(m.projectId===i?P(f=>f.map(a=>a.itemId===m.itemId?m:a)):P(f=>f.filter(a=>a.itemId!==m.itemId)))}catch(m){console.debug("InventoryList - failed to refetch item on lineage event",m)}});t.set(s.itemId,o)})}catch(s){console.debug("InventoryList - failed to setup per-item lineage subscriptions",s)}return()=>{t.forEach(s=>{try{s()}catch{}})}},[p.map(t=>t.itemId).join(","),n,i]),c.useEffect(()=>()=>{D(new Set)},[]),c.useEffect(()=>{const t=s=>{if(r&&!s.target)return;const o=s.target;!o.closest(".disposition-menu")&&!o.closest(".disposition-badge")&&u(null),I&&!o.closest(".filter-menu")&&!o.closest(".filter-button")&&N(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[r,I]);const z=t=>{v(t?new Set(p.map(s=>s.itemId)):new Set)},Y=(t,s)=>{const o=new Set(C);s?o.add(t):o.delete(t),v(o)},{toggleBookmark:_}=Le({items:p,setItems:P,updateItemService:(t,s)=>{if(!n)throw new Error("Account ID is required");return F.updateItem(n,t,s)},projectId:i}),{duplicateItem:H}=Ae({items:p,setItems:P,projectId:i}),{buildContextUrl:q}=he(),K=async(t,s)=>{console.log("üéØ InventoryList updateDisposition called:",t,s);try{const o=p.find(m=>m.itemId===t);if(!o){console.error("‚ùå Item not found for disposition update:",t);return}if(console.log("üìù Updating disposition from",o.disposition,"to",s),!n)throw new Error("Account ID is required");if(await F.updateItem(n,t,{disposition:s}),console.log("üíæ Database updated successfully"),s==="inventory"){console.log("üöÄ Starting deallocation process for item:",t);try{await Ie.handleItemDeallocation(n,t,o.projectId||"",s),console.log("‚úÖ Deallocation completed successfully"),u(null)}catch(m){console.error("‚ùå Failed to handle deallocation:",m),await F.updateItem(n,t,{disposition:o.disposition}),k("Failed to move item to inventory. Please try again.");return}}else P(p.map(m=>m.itemId===t?{...m,disposition:s}:m)),u(null)}catch(o){console.error("‚ùå Failed to update disposition:",o),k("Failed to update item disposition. Please try again.")}},X=t=>{u(r===t?null:t)},J=t=>{const s="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium cursor-pointer transition-colors hover:opacity-80";switch(De(t)){case"keep":return`${s} bg-green-100 text-green-800`;case"to return":return`${s} bg-red-100 text-red-700`;case"returned":return`${s} bg-red-800 text-red-100`;case"inventory":return`${s} bg-primary-100 text-primary-600`;default:return`${s} bg-gray-100 text-gray-800`}},Z=async t=>{var s,o;try{D(f=>new Set(f).add(t));const m=await ce.selectFromGallery();if(m.length>0)for(let f=0;f<m.length;f++){const a=m[f];await ee(t,a,m)}}catch(m){if(console.error("Error adding image:",m),(s=m.message)!=null&&s.includes("timeout")||(o=m.message)!=null&&o.includes("canceled")){console.log("User canceled image selection or selection timed out");return}M("Failed to add image. Please try again.")}finally{D(m=>{const f=new Set(m);return f.delete(t),f})}},ee=async(t,s,o)=>{const f={url:(await ce.uploadItemImage(s,x,t)).url,alt:s.name,isPrimary:!0,uploadedAt:new Date,fileName:s.name,size:s.size,mimeType:s.type};if(!n)throw new Error("Account ID is required");if(await F.updateItem(n,t,{images:[f]}),o&&o.indexOf(s)===o.length-1){const a=o.length>1?`${o.length} images uploaded successfully!`:"Image uploaded successfully!";S(a)}},te=async()=>{if(C.size===0)return;const t=`Are you sure you want to delete ${C.size} item(s)? This action cannot be undone.`;if(confirm(t)){if(!n){k("Account ID is required");return}try{const s=Array.from(C).map(o=>F.deleteItem(n,o));await Promise.all(s),v(new Set),k(null)}catch(s){console.error("Failed to delete items:",s),k("Failed to delete some items. Please try again.")}}},Q=p.filter(t=>{var m,f;const s=t.description.toLowerCase().includes(w.toLowerCase())||t.source.toLowerCase().includes(w.toLowerCase())||((m=t.sku)==null?void 0:m.toLowerCase().includes(w.toLowerCase()))||((f=t.paymentMethod)==null?void 0:f.toLowerCase().includes(w.toLowerCase()))||t.space&&t.space.toLowerCase().includes(w.toLowerCase());let o=!1;switch(g){case"all":o=!0;break;case"bookmarked":o=t.bookmark;break;case"to-inventory":o=t.disposition==="inventory";break;case"from-inventory":o=t.source==="Inventory";break;default:o=!0}return s&&o});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-2",children:e.jsxs(W,{to:q(`/project/${i}/item/add`,{project:i}),className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200 w-full sm:w-auto",children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Add Item"]})}),e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 pb-0 mb-2",children:e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"relative pt-2",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(pe,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",className:"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base",placeholder:"Search items...",value:w,onChange:t=>l(t.target.value)})]}),e.jsxs("div",{className:"flex items-center justify-between gap-4 p-3 rounded-lg",children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4",onChange:t=>z(t.target.checked),checked:C.size===p.length&&p.length>0}),e.jsx("span",{className:"ml-3 text-sm font-medium text-gray-700",children:"Select all"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[C.size>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:[C.size," of ",p.length," selected"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>N(!I),className:`filter-button inline-flex items-center justify-center px-3 py-2 border text-sm font-medium rounded-md transition-colors duration-200 ${g==="all"?"border-gray-300 text-gray-700 bg-white hover:bg-gray-50":"border-primary-500 text-primary-600 bg-primary-50 hover:bg-primary-100"}`,title:"Filter items",children:e.jsx(ye,{className:"h-4 w-4"})}),I&&e.jsx("div",{className:"filter-menu absolute top-full left-0 mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10",children:e.jsxs("div",{className:"py-1",children:[e.jsx("button",{onClick:()=>{y("all"),N(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${g==="all"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"All Items"}),e.jsx("button",{onClick:()=>{y("bookmarked"),N(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${g==="bookmarked"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"Bookmarked"}),e.jsx("button",{onClick:()=>{y("to-inventory"),N(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${g==="to-inventory"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"To Inventory"}),e.jsx("button",{onClick:()=>{y("from-inventory"),N(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${g==="from-inventory"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"From Inventory"})]})})]}),$,e.jsx("button",{onClick:te,className:"inline-flex items-center justify-center px-3 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200",disabled:C.size===0,title:"Delete All",children:e.jsx(be,{className:"h-4 w-4"})})]})]})]})]})}),j&&e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-gray-400 animate-spin mb-4",children:e.jsxs("svg",{fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Loading inventory..."}),e.jsx("p",{className:"text-sm text-gray-500",children:"Fetching your project items."})]}),E&&e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-red-400 mb-4",children:"‚ö†Ô∏è"}),e.jsx("h3",{className:"text-lg font-medium text-red-900 mb-2",children:"Error loading inventory"}),e.jsx("p",{className:"text-sm text-red-500 mb-6 max-w-sm mx-auto",children:E}),e.jsxs("button",{onClick:()=>window.location.reload(),className:"inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors duration-200 w-full sm:w-auto max-w-xs",children:[e.jsx(Fe,{className:"h-5 w-5 mr-2"}),"Retry"]})]}),!j&&!E&&Q.length===0?e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-gray-400 -mb-1",children:"üì¶"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No items yet"})]}):!j&&!E&&e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:e.jsx("ul",{className:"divide-y divide-gray-200",children:Q.map(t=>e.jsxs("li",{className:"relative bg-gray-50 transition-colors duration-200 hover:bg-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0 px-4 py-3",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4 flex-shrink-0",checked:C.has(t.itemId),onChange:s=>Y(t.itemId,s.target.checked)})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),_(t.itemId)},className:`inline-flex items-center justify-center p-2 border text-sm font-medium rounded-md transition-colors ${t.bookmark?"border-red-300 text-red-700 bg-red-50 hover:bg-red-100":"border-gray-300 text-gray-700 bg-white hover:bg-gray-50"} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500`,title:t.bookmark?"Remove Bookmark":"Add Bookmark",children:e.jsx($e,{className:"h-4 w-4",fill:t.bookmark?"currentColor":"none"})}),e.jsx(W,{to:q(`/project/${i}/edit-item/${t.itemId}`,{project:i}),onClick:s=>s.stopPropagation(),className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors",title:"Edit item",children:e.jsx(je,{className:"h-4 w-4"})}),e.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),H(t.itemId)},className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors",title:"Duplicate item",children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsxs("div",{className:"relative ml-1",children:[e.jsxs("span",{onClick:s=>{s.preventDefault(),s.stopPropagation(),X(t.itemId)},className:`disposition-badge ${J(t.disposition)}`,children:[Te(t.disposition)||"Not Set",e.jsx(Me,{className:"h-3 w-3 ml-1"})]}),r===t.itemId&&e.jsx("div",{className:"disposition-menu absolute top-full left-0 mt-1 w-32 bg-white border border-gray-200 rounded-md shadow-lg z-10",children:e.jsx("div",{className:"py-1",children:["keep","to return","returned","inventory"].map(s=>e.jsx("button",{onClick:o=>{o.preventDefault(),o.stopPropagation(),K(t.itemId,s)},className:`block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 ${Ee(t.disposition,s)?"bg-gray-100 text-gray-900":"text-gray-700"}`,disabled:!t.disposition,children:s==="to return"?"To Return":s.charAt(0).toUpperCase()+s.slice(1)},s))})})]})]})]}),e.jsx(W,{to:q(`/item/${t.itemId}`,{project:i}),children:e.jsx("div",{className:"block bg-transparent",children:e.jsxs("div",{className:"px-4 pb-3 sm:px-6",children:[e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsx("div",{className:"flex-shrink-0",children:t.images&&t.images.length>0?(()=>{const s=t.images.find(o=>o.isPrimary)||t.images[0];return e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:s.url,alt:s.alt||"Item image",className:"w-full h-full object-cover"})})})():e.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),Z(t.itemId)},disabled:B.has(t.itemId),className:"w-16 h-16 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:border-gray-400 transition-colors disabled:opacity-50",title:"Add image (camera or gallery)",children:e.jsx(Re,{className:"h-6 w-6"})})}),e.jsx("div",{className:"flex-1 min-w-0 flex items-center",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-900 line-clamp-2 break-words",children:t.description}),t.space&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.space})]})})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[(t.projectPrice||t.purchasePrice)&&e.jsxs("span",{className:"font-medium text-gray-700",children:["$",t.projectPrice||t.purchasePrice]}),t.source&&e.jsxs(e.Fragment,{children:[(t.projectPrice||t.purchasePrice)&&e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.source})]}),t.sku&&e.jsxs(e.Fragment,{children:[(t.projectPrice||t.purchasePrice||t.source)&&e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.sku})]})]})})]})})})]},t.itemId))})})]})}const Ve=i=>{var x,b;return(x=i.transactionId)!=null&&x.startsWith("INV_SALE_")?ve:(b=i.transactionId)!=null&&b.startsWith("INV_PURCHASE_")?Ne:i.source},oe=()=>{document.querySelectorAll(".no-icon").forEach(x=>{Array.from(x.childNodes).forEach(n=>{n.nodeType!==Node.TEXT_NODE&&x.removeChild(n)})})};function Ge({projectId:i,transactions:x}){const{id:b}=xe(),{currentAccountId:n}=ie(),h=i||b,{buildContextUrl:$}=he(),[w,l]=c.useState(x||[]),[C,v]=c.useState(!x),[p,P]=c.useState({}),[T,O]=c.useState(""),[E,k]=c.useState(!1),[j,B]=c.useState("all");c.useEffect(()=>{if(x){l(x);return}let r;const u=y=>{!h||!n||(r=U.subscribeToTransactions(n,h,I=>{l(I)},y))};return(async()=>{if(!h||!n){v(!1);return}if(!x)try{const y=await U.getTransactions(n,h);l(y),u(y)}catch(y){console.error("Error loading transactions:",y),l([])}finally{v(!1)}})(),()=>{r&&r()}},[h,n,x]),c.useEffect(()=>{let r=!0;return(async()=>{if(!(!h||!n||w.length===0))try{const g=w.filter(S=>S.needsReview===void 0),y=g.map(S=>U.getTransactionCompleteness(n,h,S.transactionId).catch(M=>(console.debug("Failed to load completeness for",S.transactionId,M),null))),I=await Promise.all(y);if(!r)return;const N={};g.forEach((S,M)=>{N[S.transactionId]=I[M]}),P(N)}catch(g){console.error("Error loading transaction completeness:",g)}})(),()=>{r=!1}},[w,h,n]);const D=c.useMemo(()=>{let r=w;if(j!=="all"&&(j==="we-owe"?r=r.filter(u=>u.reimbursementType===me):j==="client-owes"&&(r=r.filter(u=>u.reimbursementType===ue))),T){const u=T.toLowerCase();r=r.filter(g=>{var y,I,N;return((y=g.source)==null?void 0:y.toLowerCase().includes(u))||((I=g.transactionType)==null?void 0:I.toLowerCase().includes(u))||((N=g.notes)==null?void 0:N.toLowerCase().includes(u))})}return r},[w,j,T]);return c.useEffect(()=>{const r=u=>{if(!u.target)return;const g=u.target;!g.closest(".filter-menu")&&!g.closest(".filter-button")&&k(!1)};return document.addEventListener("mousedown",r),()=>{document.removeEventListener("mousedown",r)}},[]),c.useEffect(()=>{oe();const r=setTimeout(oe,100),u=setTimeout(oe,500);return()=>{clearTimeout(r),clearTimeout(u)}},[w]),C?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2",children:e.jsxs(W,{to:$(`/project/${h}/transaction/add`,{project:h}),className:"inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 transition-colors duration-200 w-full sm:w-auto",children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Add Transaction"]})}),e.jsx("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 pb-0 mb-2",children:e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"relative pt-2",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(pe,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{type:"text",className:"block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-base",placeholder:"Search transactions by source, type, or notes...",value:T||"",onChange:r=>O(r.target.value)})]}),e.jsx("div",{className:"flex items-center justify-end gap-4 p-3 rounded-lg",children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>k(!E),className:`filter-button inline-flex items-center justify-center px-3 py-2 border text-sm font-medium rounded-md transition-colors duration-200 ${j==="all"?"border-gray-300 text-gray-700 bg-white hover:bg-gray-50":"border-primary-500 text-primary-600 bg-primary-50 hover:bg-primary-100"}`,title:"Filter transactions",children:e.jsx(ye,{className:"h-4 w-4"})}),E&&e.jsx("div",{className:"filter-menu absolute top-full right-0 mt-1 w-40 bg-white border border-gray-200 rounded-md shadow-lg z-10",children:e.jsxs("div",{className:"py-1",children:[e.jsx("button",{onClick:()=>{B("all"),k(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${j==="all"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"All Transactions"}),e.jsx("button",{onClick:()=>{B("we-owe"),k(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${j==="we-owe"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"We Owe"}),e.jsx("button",{onClick:()=>{B("client-owes"),k(!1)},className:`block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 ${j==="client-owes"?"bg-primary-50 text-primary-600":"text-gray-700"}`,children:"Client Owes"})]})})]})})]})}),D.length===0?e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx("div",{className:"mx-auto h-16 w-16 text-gray-400 -mb-1",children:"üßæ"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"No transactions found"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:T||j!=="all"?"Try adjusting your search or filter criteria.":"No transactions found."})]}):e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-md",children:e.jsx("ul",{className:"divide-y divide-gray-200",children:D.map(r=>{var u;return e.jsx("li",{className:"relative",children:e.jsx(W,{to:$(`/project/${h}/transaction/${r.transactionId}`,{project:h,transactionId:r.transactionId}),className:"block bg-gray-50 transition-colors duration-200 hover:bg-gray-100",children:e.jsxs("div",{className:"px-4 py-4 sm:px-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-3",children:e.jsx("div",{className:"flex items-center",children:e.jsx("h3",{className:"text-base font-medium text-gray-900",children:Ve(r)})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500",children:[e.jsx("span",{className:"font-medium text-gray-700",children:Se(r.amount)}),e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700 capitalize",children:r.paymentMethod}),e.jsx("span",{className:"hidden sm:inline",children:"‚Ä¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:Pe(r.transactionDate)})]}),r.notes&&e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:r.notes})]}),e.jsxs("div",{className:"mt-3 flex items-center flex-wrap gap-2",children:[r.budgetCategory&&e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${r.budgetCategory==="Design Fee"?"bg-amber-100 text-amber-800":r.budgetCategory==="Furnishings"?"bg-yellow-100 text-yellow-800":r.budgetCategory==="Property Management"?"bg-orange-100 text-orange-800":r.budgetCategory==="Kitchen"?"bg-amber-200 text-amber-900":r.budgetCategory==="Install"?"bg-yellow-200 text-yellow-900":r.budgetCategory==="Storage & Receiving"?"bg-orange-200 text-orange-900":r.budgetCategory==="Fuel"?"bg-amber-300 text-amber-900":"bg-gray-100 text-gray-800"}`,children:r.budgetCategory}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium no-icon ${r.transactionType==="Purchase"?"bg-green-100 text-green-800":r.transactionType==="Return"?"bg-red-100 text-red-800":r.transactionType==="To Inventory"?"bg-primary-100 text-primary-800":"bg-gray-100 text-gray-800"}`,children:r.transactionType}),r.needsReview===!0?e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800",children:"Needs Review"}):p[r.transactionId]&&((u=p[r.transactionId])==null?void 0:u.completenessStatus)!=="complete"&&e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800",children:"Missing Items"})]})]})})},r.transactionId)})})})]})}function xt(){var f;const{id:i}=xe(),x=ke(),b=we(),{currentAccountId:n}=ie(),[h,$]=Ce(),w=h.get("budgetTab"),[l,C]=c.useState(null),[v,p]=c.useState([]),[P,T]=c.useState([]),[O,E]=c.useState(!0),[k,j]=c.useState(null),[B,D]=c.useState(!1),[r,u]=c.useState(!1),[g,y]=c.useState(!1),{showError:I}=de(),N=h.get("tab")||"transactions",[S,M]=c.useState(()=>w==="accounting"?"accounting":"budget"),z=new URLSearchParams(b.search),Y=z.get("from")==="business-inventory-item",_=c.useMemo(()=>{const a=z.get("returnTo");if(a)return a;if(Y){const d=z.get("returnTo");return d&&d.includes("/business-inventory/")?d:"/business-inventory"}return"/projects"},[Y,z]),H=a=>{const d=new URLSearchParams(h);d.set("tab",a),$(d)},q=a=>{M(a);const d=new URLSearchParams(h);d.set("budgetTab",a),$(d)},K=c.useMemo(()=>v.filter(a=>a.status!=="canceled").filter(a=>a.reimbursementType===ue).reduce((a,d)=>a+parseFloat(d.amount||"0"),0),[v]),X=c.useMemo(()=>v.filter(a=>a.status!=="canceled").filter(a=>a.reimbursementType===me).reduce((a,d)=>a+parseFloat(d.amount||"0"),0),[v]);c.useEffect(()=>{console.log("üîç ProjectDetail - useEffect triggered. id:",i,"currentAccountId:",n,"isLoading:",O);let a,d;const V=A=>{!i||!n||(a=U.subscribeToTransactions(n,i,R=>{p(R)},A))},L=A=>{!i||!n||(d=F.subscribeToProjectItems(n,i,R=>{T(R)},A))};return(async()=>{if(console.log("üîç ProjectDetail - loadData called. id:",i,"currentAccountId:",n),!i){console.warn("No project ID provided, redirecting to projects"),x("/projects");return}if(!n){console.log("üîç ProjectDetail - No account ID yet, waiting...");return}E(!0);try{console.log("üîç ProjectDetail - Loading project data for ID:",i);const A=await G.getProject(n,i);if(A){console.log("üîç ProjectDetail - Project loaded successfully:",A.name),C(A);const[R,se]=await Promise.all([U.getTransactions(n,i),F.getItemsByProject(n,i)]);console.log("üîç ProjectDetail - Loaded",R.length,"transactions and",se.length,"items"),p(R),T(se),V(R),L(se)}else console.warn("Project not found:",i),x("/projects")}catch(A){console.error("Error loading project:",A),j("Failed to load project. Please try again.")}finally{E(!1)}})(),()=>{a&&a(),d&&d()}},[i,n,x]),c.useEffect(()=>{if(!n||!i||v.length===0)return;const a=[];try{v.forEach(d=>{if(!d.transactionId)return;const V=ge.subscribeToEdgesFromTransaction(n,d.transactionId,async()=>{try{const L=await F.getItemsByProject(n,i);T(L)}catch(L){console.debug("ProjectDetail - failed to refresh items on lineage event",L)}try{const L=await U.getTransactions(n,i);p(L)}catch(L){console.debug("ProjectDetail - failed to refresh transactions on lineage event",L)}});a.push(V)})}catch(d){console.debug("ProjectDetail - failed to subscribe to edges from transactions",d)}return()=>{a.forEach(d=>{try{d()}catch{}})}},[v.map(a=>a.transactionId).join(","),n,i]);const J=()=>{j(null),i&&n&&x(0)},Z=async a=>{if(!(!l||!i||!n))try{await G.updateProject(n,i,a);const d=await G.getProject(n,i);C(d),D(!1)}catch(d){throw console.error("Error updating project:",d),d}},ee=()=>{D(!0)},te=()=>{D(!1)},Q=()=>{u(!0)},t=()=>{u(!1)},s=async()=>{if(!(!i||!n)){y(!0);try{await G.deleteProject(n,i),x("/projects")}catch(a){console.error("Error deleting project:",a),y(!1),u(!1),I("Failed to delete project. Please try again.")}}},o=[{id:"inventory",name:"Items",icon:qe},{id:"transactions",name:"Transactions",icon:le}],m=[{id:"budget",name:"Budget",icon:le},{id:"accounting",name:"Accounting",icon:ze}];return O?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading project..."})]})}):k?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-red-400",children:"‚ö†Ô∏è"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Error Loading Project"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:k}),e.jsxs("div",{className:"mt-6 flex justify-center space-x-3",children:[e.jsx("button",{onClick:J,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Try Again"}),e.jsxs(ae,{fallback:_,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Back to Projects"]})]})]}):l?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ae,{fallback:_,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("button",{onClick:ee,className:"inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Edit"]}),e.jsxs("button",{onClick:Q,className:"inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-1",children:l.name}),l.clientName&&e.jsx("p",{className:"text-lg text-gray-600 mb-6",children:l.clientName})]}),e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"-mb-px flex space-x-8",children:m.map(a=>{const d=a.icon;return e.jsxs("button",{onClick:()=>q(a.id),className:`py-4 px-1 border-b-2 font-medium text-base flex items-center ${S===a.id?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),a.name]},a.id)})})}),e.jsxs("div",{className:"pt-6",children:[S==="budget"&&l&&e.jsx(We,{budget:l.budget,designFee:l.designFee,budgetCategories:l.budgetCategories,transactions:v}),S==="accounting"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("section",{children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 mb-0.5",children:"Owed to Design Business"}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:["$",K.toFixed(2)]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 mb-0.5",children:"Owed to Client"}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:["$",X.toFixed(2)]})]})]})}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Reports"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(re,{variant:"secondary",onClick:()=>x(`/project/${l.id}/property-management-summary`),children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Generate Property Management Summary"]}),e.jsxs(re,{variant:"secondary",onClick:()=>x(`/project/${l.id}/client-summary`),children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"Generate Client Summary"]}),e.jsxs(re,{variant:"secondary",onClick:()=>x(`/project/${l.id}/invoice`),children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Generate Invoice"]})]})]})]})]})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"border-b border-gray-200",children:e.jsx("nav",{className:"-mb-px flex space-x-8 px-6",children:o.map(a=>{const d=a.icon;return e.jsxs("button",{onClick:()=>H(a.id),className:`py-4 px-1 border-b-2 font-medium text-base flex items-center ${N===a.id?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:[e.jsx(d,{className:"h-4 w-4 mr-2"}),a.name]},a.id)})})}),e.jsxs("div",{className:"px-6 py-6",children:[N==="inventory"&&l&&e.jsxs(e.Fragment,{children:[console.log("üîç ProjectDetail - Rendering InventoryList with",P.length,"items"),e.jsx(Qe,{projectId:l.id,projectName:l.name,items:P})]}),N==="transactions"&&l&&e.jsx(Ge,{projectId:l.id,transactions:v})]})]}),B&&l&&e.jsx(Ye,{initialData:{name:l.name,description:l.description,clientName:l.clientName,budget:l.budget,designFee:l.designFee,budgetCategories:l.budgetCategories},onSubmit:Z,onCancel:te}),r&&e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Delete"}),e.jsx("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"mt-2",children:[e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Are you sure you want to delete the project ",e.jsxs("strong",{children:['"',l==null?void 0:l.name,'"']}),"? This action cannot be undone and will permanently delete the project and all associated data."]}),l&&((f=l.metadata)==null?void 0:f.totalItems)&&l.metadata.totalItems>0&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"ml-3",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Warning"}),e.jsx("div",{className:"mt-1 text-sm text-yellow-700",children:e.jsxs("p",{children:["This project contains ",l.metadata.totalItems," item(s). Deleting the project will permanently remove all associated data."]})})]})})}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:t,disabled:g,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50",children:"Cancel"}),e.jsx("button",{onClick:s,disabled:g,className:"px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50",children:g?"Deleting...":"Delete"})]})]})]})})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"üìÅ"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Project not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The project you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(ae,{fallback:_,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Back to Projects"]})})]})}export{xt as default};
//# sourceMappingURL=ProjectDetail.js.map
