import{t as p,z as d,M as g,N as D,m as _,O as q,B as I,P as A,q as S,u as v,A as u,Q as L,s as O,R as f,S as E,U as $}from"./firebase.js";import{e as h,f as j,d as m}from"./index.js";import"./vendor.js";import"./router.js";import"./ui.js";const C={async getProjects(){await h();const n=p(m,"projects"),t=d(n,g("updatedAt","desc"));return(await v(t)).docs.map(s=>{const a=j(s.data());return{id:s.id,...a}})},async getProject(n){await h();const t=_(m,"projects",n),e=await S(t);if(e.exists()){const s=j(e.data());return{id:e.id,...s}}return null},async createProject(n){const t=p(m,"projects"),e=new Date,s={...n,createdAt:e,updatedAt:e};return(await A(t,s)).id},async updateProject(n,t){const e=_(m,"projects",n);await I(e,{...t,updatedAt:new Date})},async deleteProject(n){const t=_(m,"projects",n);await q(t)},subscribeToProjects(n){const t=p(m,"projects"),e=d(t,g("updatedAt","desc"));return D(e,s=>{const a=s.docs.map(i=>{const o=j(i.data());return{id:i.id,...o}});n(a)})}},b={async getItems(n,t,e){const s=p(m,"projects",n,"items");let a=d(s);if(t!=null&&t.status&&(a=d(a,u("disposition","==",t.status))),t!=null&&t.category&&(a=d(a,u("source","==",t.category))),t!=null&&t.tags&&t.tags.length>0&&(a=d(a,u("tags","array-contains-any",t.tags))),t!=null&&t.priceRange&&(a=d(a,u("price",">=",t.priceRange.min),u("price","<=",t.priceRange.max))),t!=null&&t.searchQuery){const r=t.searchQuery.toLowerCase();a=d(a,u("description",">=",r),u("description","<=",r+""))}a=d(a,g("last_updated","desc")),e&&(a=d(a,f(e.limit)),e.page>0&&(a=d(a,f(e.page*e.limit))));let o=(await v(a)).docs.map(r=>({item_id:r.id,...r.data()}));if(t!=null&&t.searchQuery&&o.length>0){const r=t.searchQuery.toLowerCase();o=o.filter(c=>c.description.toLowerCase().includes(r)||c.source.toLowerCase().includes(r)||c.sku.toLowerCase().includes(r)||c.payment_method.toLowerCase().includes(r))}return o},async getItem(n,t){var a,i;console.log("getItem called with:",{projectId:n,itemId:t}),await h();const e=_(m,"projects",n,"items",t);console.log("Document path:",e.path);const s=await S(e);if(s.exists()){const o=s.data();console.log("Raw Firebase data:",o),console.log("Images in Firebase:",((a=o.images)==null?void 0:a.length)||0,"images");const r={item_id:s.id,description:o.description,source:o.source,sku:o.sku,purchase_price:o.purchase_price,project_price:o.project_price,market_value:o.market_value,payment_method:o.payment_method,disposition:o.disposition,notes:o.notes,space:o.space,qr_key:o.qr_key,bookmark:o.bookmark,transaction_id:o.transaction_id,project_id:o.project_id,date_created:o.date_created,last_updated:o.last_updated,images:o.images||[]};return console.log("Mapped item data:",r),console.log("Mapped images:",((i=r.images)==null?void 0:i.length)||0,"images"),r}return console.log("Document does not exist at path:",e.path),console.log("itemSnap.exists():",s.exists()),console.log("Item not found"),null},async createItem(n,t){const e=p(m,"projects",n,"items"),s=new Date,a={description:t.description,source:t.source,sku:t.sku,purchase_price:t.purchase_price,project_price:t.project_price,market_value:t.market_value,payment_method:t.payment_method,disposition:t.disposition||"keep",notes:t.notes,space:t.space,qr_key:t.qr_key||`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,bookmark:t.bookmark,transaction_id:t.transaction_id,project_id:t.project_id,date_created:s.toISOString(),last_updated:s.toISOString()},i=await A(e,a);return await C.updateProject(n,{metadata:{totalItems:await b.getItemCount(n)+1,lastActivity:s}}),i.id},async updateItem(n,t,e){var i;const s=_(m,"projects",n,"items",t),a={last_updated:new Date().toISOString()};e.purchase_price!==void 0&&(a.purchase_price=e.purchase_price),e.project_price!==void 0&&(a.project_price=e.project_price),e.market_value!==void 0&&(a.market_value=e.market_value),e.description!==void 0&&(a.description=e.description),e.source!==void 0&&(a.source=e.source),e.sku!==void 0&&(a.sku=e.sku),e.payment_method!==void 0&&(a.payment_method=e.payment_method),e.disposition!==void 0&&(a.disposition=e.disposition),e.notes!==void 0&&(a.notes=e.notes),e.space!==void 0&&(a.space=e.space),e.bookmark!==void 0&&(a.bookmark=e.bookmark),e.images!==void 0&&(console.log("Updating item images:",(i=e.images)==null?void 0:i.length,"images"),a.images=e.images),console.log("Updating item in database:",t,"with updates:",Object.keys(a)),await I(s,a),console.log("Item updated successfully in database")},async addItemImage(n,t,e){const s=_(m,"projects",n,"items",t),a=await S(s);if(!a.exists())throw new Error("Item not found");const r=[...a.data().images||[],e];await I(s,{images:r,last_updated:new Date().toISOString()})},async updateItemImages(n,t,e){const s=_(m,"projects",n,"items",t);await I(s,{images:e,last_updated:new Date().toISOString()})},async removeItemImage(n,t,e){const s=_(m,"projects",n,"items",t),a=await S(s);if(!a.exists())throw new Error("Item not found");const r=(a.data().images||[]).filter(c=>c.url!==e);await I(s,{images:r,last_updated:new Date().toISOString()})},async setPrimaryImage(n,t,e){const s=_(m,"projects",n,"items",t),a=await S(s);if(!a.exists())throw new Error("Item not found");const r=(a.data().images||[]).map(c=>({...c,isPrimary:c.url===e}));await I(s,{images:r,last_updated:new Date().toISOString()})},async deleteItem(n,t){const e=_(m,"projects",n,"items",t);await q(e);const s=new Date;await C.updateProject(n,{metadata:{totalItems:Math.max(0,await b.getItemCount(n)-1),lastActivity:s}})},async getItemCount(n){const t=p(m,"projects",n,"items");return(await E(t)).data().count},subscribeToItems(n,t,e){const s=p(m,"projects",n,"items");let a=d(s,g("last_updated","desc"));return e!=null&&e.status&&(a=d(a,u("disposition","==",e.status))),e!=null&&e.category&&(a=d(a,u("source","==",e.category))),D(a,i=>{console.log("Real-time items snapshot received:",i.docs.length,"documents");let o=i.docs.map(r=>{const c=r.data();return{item_id:r.id,description:c.description,source:c.source,sku:c.sku,purchase_price:c.purchase_price,project_price:c.project_price,market_value:c.market_value,payment_method:c.payment_method,disposition:c.disposition,notes:c.notes,space:c.space,qr_key:c.qr_key,bookmark:c.bookmark,transaction_id:c.transaction_id,project_id:c.project_id,date_created:c.date_created,last_updated:c.last_updated,images:c.images||[]}});if(e!=null&&e.searchQuery){const r=e.searchQuery.toLowerCase();o=o.filter(c=>c.description.toLowerCase().includes(r)||c.source.toLowerCase().includes(r)||c.sku.toLowerCase().includes(r)||c.payment_method.toLowerCase().includes(r))}console.log("Real-time items callback with",o.length,"items"),t(o)})},async searchItems(n,t){if(t.length<2)return[];const e=p(m,"projects",n,"items"),s=d(e,u("description",">=",t.toLowerCase()),u("description","<=",t.toLowerCase()+""),g("description"),f(20));return(await v(s)).docs.map(i=>{const o=i.data();return{item_id:i.id,description:o.description,source:o.source,sku:o.sku,purchase_price:o.purchase_price,project_price:o.project_price,market_value:o.market_value,payment_method:o.payment_method,disposition:o.disposition,notes:o.notes,space:o.space,qr_key:o.qr_key,bookmark:o.bookmark,transaction_id:o.transaction_id,project_id:o.project_id,date_created:o.date_created,last_updated:o.last_updated}})},async batchUpdateItems(n,t){const e=L(m);t.forEach(({id:s,updates:a})=>{const i=_(m,"projects",n,"items",s),o={last_updated:new Date().toISOString()};a.purchase_price!==void 0&&(o.purchase_price=a.purchase_price),a.project_price!==void 0&&(o.project_price=a.project_price),a.market_value!==void 0&&(o.market_value=a.market_value),a.description!==void 0&&(o.description=a.description),a.source!==void 0&&(o.source=a.source),a.sku!==void 0&&(o.sku=a.sku),a.payment_method!==void 0&&(o.payment_method=a.payment_method),a.disposition!==void 0&&(o.disposition=a.disposition),a.notes!==void 0&&(o.notes=a.notes),a.space!==void 0&&(o.space=a.space),a.bookmark!==void 0&&(o.bookmark=a.bookmark),e.update(i,o)}),await e.commit()},async duplicateItem(n,t){const e=await this.getItem(n,t);if(!e)throw new Error("Original item not found");const s=new Date,a=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,i=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,o={item_id:a,description:e.description,source:e.source,sku:e.sku||"",purchase_price:e.purchase_price||"",project_price:e.project_price||"",market_value:e.market_value||"",payment_method:e.payment_method,disposition:"keep",notes:e.notes||"",space:e.space||"",qr_key:i,bookmark:!1,transaction_id:e.transaction_id,project_id:n,date_created:s.toISOString(),last_updated:s.toISOString(),images:e.images||[]};Object.keys(o).forEach(y=>{o[y]===void 0&&delete o[y]});const r=_(m,"projects",n,"items",a);await O(r,o);const c=await this.getItemCount(n);return await C.updateProject(n,{metadata:{totalItems:c,lastActivity:s}}),a},async createTransactionItems(n,t,e,s,a){const i=L(m),o=[],r=new Date;a.forEach(y=>{const w=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;o.push(w);const l=_(m,"projects",n,"items",w),R=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,P={item_id:w,description:y.description,source:s,sku:y.sku||"",purchase_price:y.purchase_price,project_price:y.project_price,market_value:y.market_value||"",payment_method:"Client Card",disposition:"keep",notes:y.notes||"",qr_key:R,bookmark:!1,transaction_id:t,project_id:n,date_created:e,last_updated:r.toISOString(),images:[]};i.set(l,P)}),await i.commit();const c=await this.getItemCount(n);return await C.updateProject(n,{metadata:{totalItems:c,lastActivity:r}}),o},async getTransactionItems(n,t){const e=p(m,"projects",n,"items"),s=d(e,u("transaction_id","==",t),g("date_created","asc"));return(await v(s)).docs.map(i=>i.id)},async addItemToTransaction(n,t,e,s,a){const i=new Date,o=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,r=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,c={item_id:o,description:a.description,source:s,sku:a.sku||"",purchase_price:a.purchase_price,project_price:a.project_price,market_value:a.market_value||"",payment_method:"Client Card",disposition:"keep",notes:a.notes||"",space:"",qr_key:r,bookmark:!1,transaction_id:t,project_id:n,date_created:e,last_updated:i.toISOString(),images:[]},y=_(m,"projects",n,"items",o);return await O(y,c),await C.updateProject(n,{metadata:{totalItems:await b.getItemCount(n)+1,lastActivity:i}}),o}},B={async getTransactions(n){const t=p(m,"projects",n,"transactions"),e=d(t,g("created_at","desc"));return(await v(e)).docs.map(a=>{const i=j(a.data()),o={...i,transaction_images:Array.isArray(i.transaction_images)?i.transaction_images:[],receipt_images:Array.isArray(i.receipt_images)?i.receipt_images:[],other_images:Array.isArray(i.other_images)?i.other_images:[]};return{transaction_id:a.id,...o}})},async getTransaction(n,t){const e=_(m,"projects",n,"transactions",t),s=await S(e);if(s.exists()){const a=j(s.data());console.log("inventoryService - raw data:",a),console.log("inventoryService - transaction_images:",a.transaction_images),console.log("inventoryService - transaction_images type:",typeof a.transaction_images);const i={...a,transaction_images:Array.isArray(a.transaction_images)?a.transaction_images:[],receipt_images:Array.isArray(a.receipt_images)?a.receipt_images:[],other_images:Array.isArray(a.other_images)?a.other_images:[]};return console.log("inventoryService - processed transactionData:",i),{transaction_id:s.id,...i}}return null},async getTransactionById(n){const t=await C.getProjects();for(const e of t)try{const s=await this.getTransaction(e.id,n);if(s)return{transaction:s,projectId:e.id}}catch(s){console.error(`Error searching for transaction ${n} in project ${e.id}:`,s)}return{transaction:null,projectId:null}},async createTransaction(n,t,e){try{const s=p(m,"projects",n,"transactions"),i={...t,created_at:new Date().toISOString(),status:t.status||"completed",reimbursement_type:t.reimbursement_type||null,trigger_event:t.trigger_event||null};console.log("Creating transaction:",i),console.log("Transaction items:",e);const r=(await A(s,i)).id;if(console.log("Transaction created successfully:",r),e&&e.length>0){console.log("Creating items for transaction:",r);const c=await b.createTransactionItems(n,r,t.transaction_date,t.source,e);console.log("Created items:",c)}return r}catch(s){throw console.error("Error creating transaction:",s),s}},async updateTransaction(n,t,e){const s=_(m,"projects",n,"transactions",t),a={...e};a.status==="completed"&&a.reimbursement_type!==void 0&&(a.reimbursement_type=$()),a.reimbursement_type===""&&(a.reimbursement_type=$()),a.reimbursement_type&&a.status==="completed"&&(a.status="pending"),await I(s,a)},async deleteTransaction(n,t){const e=_(m,"projects",n,"transactions",t);await q(e)},subscribeToTransactions(n,t){const e=p(m,"projects",n,"transactions"),s=d(e,g("created_at","desc"));return D(s,a=>{const i=a.docs.map(o=>{const r=j(o.data()),c={...r,transaction_images:Array.isArray(r.transaction_images)?r.transaction_images:[],receipt_images:Array.isArray(r.receipt_images)?r.receipt_images:[],other_images:Array.isArray(r.other_images)?r.other_images:[]};return{transaction_id:o.id,...c}});t(i)})},subscribeToTransaction(n,t,e){const s=_(m,"projects",n,"transactions",t);return D(s,a=>{if(a.exists()){const i=j(a.data());console.log("inventoryService - real-time raw data:",i),console.log("inventoryService - real-time transaction_images:",i.transaction_images);const o={...i,transaction_images:Array.isArray(i.transaction_images)?i.transaction_images:[],receipt_images:Array.isArray(i.receipt_images)?i.receipt_images:[],other_images:Array.isArray(i.other_images)?i.other_images:[]};console.log("inventoryService - real-time processed transactionData:",o);const r={transaction_id:a.id,...o};e(r)}else e(null)})},async getPendingTransactions(n){const t=p(m,"projects",n,"transactions"),e=d(t,u("status","==","pending"),g("created_at","desc"));return(await v(e)).docs.map(a=>{const i=j(a.data()),o={...i,transaction_images:Array.isArray(i.transaction_images)?i.transaction_images:[],receipt_images:Array.isArray(i.receipt_images)?i.receipt_images:[],other_images:Array.isArray(i.other_images)?i.other_images:[]};return{transaction_id:a.id,...o}})},async updateTransactionStatus(n,t,e,s){const a=_(m,"projects",n,"transactions",t),i={status:e,...s};e==="completed"&&!(s!=null&&s.transaction_date)&&(i.transaction_date=new Date().toISOString()),await I(a,i)}},M={async getItemsByProject(n,t,e){await h();const s=p(m,"items");let a=d(s,u("project_id","==",n));if(t!=null&&t.status&&(a=d(a,u("disposition","==",t.status))),t!=null&&t.category&&(a=d(a,u("source","==",t.category))),t!=null&&t.tags&&t.tags.length>0&&(a=d(a,u("tags","array-contains-any",t.tags))),t!=null&&t.priceRange&&(a=d(a,u("project_price",">=",t.priceRange.min),u("project_price","<=",t.priceRange.max))),t!=null&&t.searchQuery){const r=t.searchQuery.toLowerCase();a=d(a,u("description",">=",r),u("description","<=",r+""))}a=d(a,g("last_updated","desc")),e&&(a=d(a,f(e.limit)),e.page>0&&(a=d(a,f(e.page*e.limit))));let o=(await v(a)).docs.map(r=>({item_id:r.id,...r.data()}));if(t!=null&&t.searchQuery&&o.length>0){const r=t.searchQuery.toLowerCase();o=o.filter(c=>c.description.toLowerCase().includes(r)||c.source.toLowerCase().includes(r)||c.sku.toLowerCase().includes(r)||c.payment_method.toLowerCase().includes(r))}return o},subscribeToItemsByProject(n,t,e){const s=p(m,"items");let a=d(s,u("project_id","==",n),g("last_updated","desc"));if(e!=null&&e.status&&(a=d(a,u("disposition","==",e.status))),e!=null&&e.category&&(a=d(a,u("source","==",e.category))),e!=null&&e.searchQuery){const i=e.searchQuery.toLowerCase();a=d(a,u("description",">=",i),u("description","<=",i+""))}return D(a,i=>{let o=i.docs.map(r=>({item_id:r.id,...r.data()}));if(e!=null&&e.searchQuery){const r=e.searchQuery.toLowerCase();o=o.filter(c=>c.description.toLowerCase().includes(r)||c.source.toLowerCase().includes(r)||c.sku.toLowerCase().includes(r)||c.payment_method.toLowerCase().includes(r))}t(o)})},async getBusinessInventoryItems(n,t){await h();const e=p(m,"items");let s=d(e,u("project_id","==",null));n!=null&&n.status&&(s=d(s,u("inventory_status","==",n.status))),s=d(s,g("last_updated","desc")),t&&(s=d(s,f(t.limit)),t.page>0&&(s=d(s,f(t.page*t.limit))));let i=(await v(s)).docs.map(o=>({item_id:o.id,...o.data()}));if(n!=null&&n.searchQuery){const o=n.searchQuery.toLowerCase();i=i.filter(r=>{var c;return r.description.toLowerCase().includes(o)||r.source.toLowerCase().includes(o)||r.sku.toLowerCase().includes(o)||((c=r.business_inventory_location)==null?void 0:c.toLowerCase().includes(o))})}return i},subscribeToBusinessInventory(n,t){const e=p(m,"items");let s=d(e,u("project_id","==",null),g("last_updated","desc"));return t!=null&&t.status&&(s=d(s,u("inventory_status","==",t.status))),D(s,a=>{let i=a.docs.map(o=>({item_id:o.id,...o.data()}));if(t!=null&&t.searchQuery){const o=t.searchQuery.toLowerCase();i=i.filter(r=>{var c;return r.description.toLowerCase().includes(o)||r.source.toLowerCase().includes(o)||r.sku.toLowerCase().includes(o)||((c=r.business_inventory_location)==null?void 0:c.toLowerCase().includes(o))})}n(i)})},async createItem(n){await h();const t=p(m,"items"),e=new Date,s={...n,inventory_status:n.inventory_status||"available",date_created:e.toISOString(),last_updated:e.toISOString()};return(await A(t,s)).id},async updateItem(n,t){await h();const e=_(m,"items",n),s={last_updated:new Date().toISOString()};t.inventory_status!==void 0&&(s.inventory_status=t.inventory_status),t.project_id!==void 0&&(s.project_id=t.project_id),t.business_inventory_location!==void 0&&(s.business_inventory_location=t.business_inventory_location),t.pending_transaction_id!==void 0&&(s.pending_transaction_id=t.pending_transaction_id),t.purchase_price!==void 0&&(s.purchase_price=t.purchase_price),t.project_price!==void 0&&(s.project_price=t.project_price),t.description!==void 0&&(s.description=t.description),t.source!==void 0&&(s.source=t.source),t.sku!==void 0&&(s.sku=t.sku),t.market_value!==void 0&&(s.market_value=t.market_value),t.payment_method!==void 0&&(s.payment_method=t.payment_method),t.disposition!==void 0&&(s.disposition=t.disposition),t.notes!==void 0&&(s.notes=t.notes),t.space!==void 0&&(s.space=t.space),t.bookmark!==void 0&&(s.bookmark=t.bookmark),t.images!==void 0&&(s.images=t.images),await I(e,s)},async deleteItem(n){await h();const t=_(m,"items",n);await q(t)},async getItemsForTransaction(n,t){await h();const e=p(m,"items");let s=d(e,u("pending_transaction_id","==",t),g("date_created","asc"));return(await v(s)).docs.map(i=>({item_id:i.id,...i.data()}))},async allocateItemToProject(n,t,e,s){await h();const a=await this.getItemById(n);if(!a)throw new Error("Business inventory item not found");const i=e||a.project_price||a.market_value||"0.00",o=`INV_SALE_${t}`,r=_(m,"projects",t,"transactions",o),c={project_id:t,transaction_date:new Date().toISOString(),source:"Inventory Allocation",transaction_type:"Reimbursement",payment_method:"Pending",amount:i,budget_category:"Furnishings",notes:s||"Item allocated from business inventory",status:"pending",reimbursement_type:"Client Owes",trigger_event:"Inventory allocation",item_ids:[n],created_by:"system",last_updated:new Date().toISOString()};return await O(r,c,{merge:!0}),await this.updateItem(n,{project_id:t,inventory_status:"pending",pending_transaction_id:o}),o},async batchAllocateItemsToProject(n,t,e={}){await h();const s=p(m,"items"),a=d(s,u("__name__","in",n),u("project_id","==",null)),i=await v(a);if(i.empty)throw new Error("No business inventory items found");const o=`INV_SALE_${t}`,r=e.amount||i.docs.map(l=>l.data().project_price||l.data().market_value||"0.00").reduce((l,R)=>l+parseFloat(R||"0"),0).toFixed(2),c=_(m,"projects",t,"transactions",o),y={project_id:t,transaction_date:new Date().toISOString(),source:"Batch Inventory Allocation",transaction_type:"Reimbursement",payment_method:"Pending",amount:r,budget_category:"Furnishings",notes:e.notes||`Batch allocation of ${n.length} items from business inventory`,status:"pending",reimbursement_type:"Client Owes",trigger_event:"Inventory allocation",item_ids:n,created_by:"system",last_updated:new Date().toISOString()};await O(c,y,{merge:!0});const w=L(m);return i.docs.forEach(l=>{const R=l.id;w.update(_(m,"items",R),{project_id:t,inventory_status:"pending",pending_transaction_id:o,last_updated:new Date().toISOString()})}),await w.commit(),o},async returnItemFromProject(n,t,e,s){await h();const a=await this.getItemById(n);if(!a)throw new Error("Item not found");const i=`INV_BUY_${t}`,o=e||a.purchase_price||a.market_value||"0.00",r=_(m,"projects",t,"transactions",i),c={project_id:t,transaction_date:new Date().toISOString(),source:"Inventory Return",transaction_type:"Reimbursement",payment_method:"Pending",amount:o,budget_category:"Furnishings",notes:s||"Item returned to business inventory",status:"pending",reimbursement_type:"We Owe",trigger_event:"Inventory return",item_ids:[n],created_by:"system",last_updated:new Date().toISOString()};return await O(r,c,{merge:!0}),await this.updateItem(n,{project_id:null,inventory_status:"available",pending_transaction_id:i}),i},async completePendingTransaction(n,t,e){await h();const s=n==="sale"?`INV_SALE_${t}`:`INV_BUY_${t}`,a=_(m,"projects",t,"transactions",s),i=await S(a);if(!i.exists())throw new Error("Transaction not found");const r=i.data().item_ids||[];await I(a,{status:"completed",payment_method:e,transaction_date:new Date().toISOString(),last_updated:new Date().toISOString()});const c=L(m);for(const y of r){const w=_(m,"items",y);n==="sale"?c.update(w,{pending_transaction_id:null,inventory_status:"sold",last_updated:new Date().toISOString()}):c.update(w,{project_id:null,pending_transaction_id:null,inventory_status:"available",last_updated:new Date().toISOString()})}await c.commit()},async getItemById(n){await h();const t=_(m,"items",n),e=await S(t);return e.exists()?{item_id:e.id,...e.data()}:null}},T={async getBusinessInventoryItems(n,t){const e=p(m,"business_inventory");let s=d(e);n!=null&&n.status&&(s=d(s,u("inventory_status","==",n.status))),s=d(s,g("last_updated","desc")),t&&(s=d(s,f(t.limit)),t.page>0&&(s=d(s,f(t.page*t.limit))));let i=(await v(s)).docs.map(o=>({item_id:o.id,...o.data()}));if(n!=null&&n.searchQuery){const o=n.searchQuery.toLowerCase();i=i.filter(r=>{var c;return r.description.toLowerCase().includes(o)||r.source.toLowerCase().includes(o)||r.sku.toLowerCase().includes(o)||((c=r.business_inventory_location)==null?void 0:c.toLowerCase().includes(o))})}return i},async getBusinessInventoryItem(n){const t=_(m,"business_inventory",n),e=await S(t);return e.exists()?{item_id:e.id,...e.data()}:null},async duplicateBusinessInventoryItem(n){const t=await this.getBusinessInventoryItem(n);if(!t)throw new Error("Original business inventory item not found");const e=new Date,s=`BI-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,a=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,i={item_id:s,description:t.description,source:t.source,sku:t.sku||"",purchase_price:t.purchase_price||"",project_price:t.project_price||"",market_value:t.market_value||"",payment_method:t.payment_method,disposition:"keep",notes:t.notes||"",space:t.space||"",qr_key:a,bookmark:!1,inventory_status:"available",business_inventory_location:t.business_inventory_location||"",pending_transaction_id:void 0,transaction_id:t.transaction_id,date_created:e.toISOString(),last_updated:e.toISOString(),images:t.images||[]};Object.keys(i).forEach(r=>{i[r]===void 0&&delete i[r]});const o=_(m,"business_inventory",s);return await O(o,i),s},async createBusinessInventoryItem(n){const t=p(m,"business_inventory"),e=new Date,s={...n,inventory_status:n.inventory_status||"available",date_created:e.toISOString(),last_updated:e.toISOString()};return(await A(t,s)).id},async updateBusinessInventoryItem(n,t){const e=_(m,"business_inventory",n),s={last_updated:new Date().toISOString()};t.inventory_status!==void 0&&(s.inventory_status=t.inventory_status),t.business_inventory_location!==void 0&&(s.business_inventory_location=t.business_inventory_location),t.pending_transaction_id!==void 0&&(s.pending_transaction_id=t.pending_transaction_id),t.purchase_price!==void 0&&(s.purchase_price=t.purchase_price),t.project_price!==void 0&&(s.project_price=t.project_price),t.description!==void 0&&(s.description=t.description),t.source!==void 0&&(s.source=t.source),t.sku!==void 0&&(s.sku=t.sku),t.market_value!==void 0&&(s.market_value=t.market_value),t.payment_method!==void 0&&(s.payment_method=t.payment_method),t.disposition!==void 0&&(s.disposition=t.disposition),t.notes!==void 0&&(s.notes=t.notes),t.space!==void 0&&(s.space=t.space),t.bookmark!==void 0&&(s.bookmark=t.bookmark),t.images!==void 0&&(s.images=t.images),await I(e,s)},async deleteBusinessInventoryItem(n){const t=_(m,"business_inventory",n);await q(t)},async getBusinessInventoryStats(){const n=p(m,"business_inventory"),t=await E(n),e=d(n),s=await v(e);let a=0,i=0,o=0;return s.docs.forEach(r=>{switch(r.data().inventory_status){case"available":a++;break;case"pending":i++;break;case"sold":o++;break}}),{totalItems:t.data().count,availableItems:a,pendingItems:i,soldItems:o}},subscribeToBusinessInventory(n,t){const e=p(m,"business_inventory");let s=d(e,g("last_updated","desc"));return t!=null&&t.status&&(s=d(s,u("inventory_status","==",t.status))),D(s,a=>{let i=a.docs.map(o=>({item_id:o.id,...o.data()}));if(t!=null&&t.searchQuery){const o=t.searchQuery.toLowerCase();i=i.filter(r=>{var c;return r.description.toLowerCase().includes(o)||r.source.toLowerCase().includes(o)||r.sku.toLowerCase().includes(o)||((c=r.business_inventory_location)==null?void 0:c.toLowerCase().includes(o))})}n(i)})},async allocateItemToProject(n,t,e,s){const a=await this.getBusinessInventoryItem(n);if(!a)throw new Error("Business inventory item not found");const i=e||a.project_price||a.market_value||"0.00",o={project_id:t,transaction_date:new Date().toISOString(),source:"Inventory Allocation",transaction_type:"Reimbursement",payment_method:"Pending",amount:i,budget_category:"Furnishings",notes:s||"Item allocated from business inventory",created_by:"system",status:"pending",reimbursement_type:"Client Owes",trigger_event:"Inventory allocation"},r=p(m,"projects",t,"transactions"),c=await A(r,o);return await this.updateBusinessInventoryItem(n,{inventory_status:"pending",pending_transaction_id:c.id}),c.id},async batchAllocateItemsToProject(n,t,e={}){const s=L(m),a=[],i=new Date,o=p(m,"business_inventory"),r=d(o,u("__name__","in",n)),c=await v(r);if(c.empty)throw new Error("No business inventory items found");const y={project_id:t,transaction_date:i.toISOString(),source:"Batch Inventory Allocation",transaction_type:"Reimbursement",payment_method:"Pending",amount:e.amount||"0.00",budget_category:"Furnishings",notes:e.notes||`Batch allocation of ${n.length} items from business inventory`,created_by:"system",status:"pending",reimbursement_type:"Client Owes",trigger_event:"Inventory allocation"},w=p(m,"projects",t,"transactions"),l=_(w);s.set(l,y),a.push(l.id),c.docs.forEach(P=>{const k=P.data(),Q=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,x=_(m,"projects",t,"items",Q),F={item_id:Q,description:k.description,source:k.source,sku:k.sku,project_price:k.project_price,market_value:k.market_value||"",payment_method:"1584",disposition:"keep",notes:k.notes||"",space:e.space||"",qr_key:`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,bookmark:!1,transaction_id:l.id,project_id:t,date_created:k.date_created,last_updated:i.toISOString(),images:k.images||[]};s.set(x,F)}),n.forEach(P=>{const k=_(m,"business_inventory",P);s.update(k,{inventory_status:"sold",pending_transaction_id:l.id,last_updated:i.toISOString()})}),await s.commit();const R=await b.getItemCount(t);return await C.updateProject(t,{metadata:{totalItems:R,lastActivity:i}}),a},async returnItemFromProject(n,t,e){const s=_(m,"projects",e,"transactions",t);await I(s,{status:"cancelled"}),await this.updateBusinessInventoryItem(n,{inventory_status:"available",pending_transaction_id:void 0})},async markItemAsSold(n,t,e,s){const a=_(m,"projects",e,"transactions",t);await I(a,{status:"completed",transaction_date:new Date().toISOString(),payment_method:s}),await this.updateBusinessInventoryItem(n,{inventory_status:"sold",pending_transaction_id:void 0})},async moveItemToBusinessInventory(n,t,e,s){const a=p(m,"projects",t,"items"),i=d(a,u("item_id","==",n)),o=await v(i);if(o.empty)throw new Error("Item not found in project");const r=o.docs[0].data(),c={project_id:t,transaction_date:new Date().toISOString(),source:"Client Purchase",transaction_type:"Reimbursement",payment_method:"Pending",amount:e,budget_category:"Furnishings",notes:s||"Client-purchased item moved to business inventory",created_by:"system",status:"pending",reimbursement_type:"We Owe",trigger_event:"Purchase from client"},y=p(m,"projects",t,"transactions"),w=await A(y,c),l={description:r.description,source:r.source,sku:r.sku,price:r.price,market_value:r.market_value,payment_method:r.payment_method,disposition:r.disposition||"keep",notes:r.notes,space:r.space,qr_key:r.qr_key,bookmark:r.bookmark||!1,inventory_status:"available",business_inventory_location:"Warehouse - Client Purchase",transaction_id:w.id,images:r.images||[]};return await this.createBusinessInventoryItem(l),await q(o.docs[0].ref),w.id}},N={async handleInventoryDesignation(n,t,e){if(e==="inventory")try{const s=await b.getItem(t,n);if(!s)throw new Error("Item not found");s.transaction_id?await this.handleExistingTransactionCase(s,t):await this.handleDirectInventoryDesignation(s,t)}catch(s){throw console.error("Error handling inventory designation:",s),s}},async handleExistingTransactionCase(n,t){const e=n.transaction_id,s=await b.getTransactionItems(t,e),a=await Promise.all(s.map(o=>b.getItem(t,o)));await this.findBusinessInventoryItemByTransaction(e)?await this.handleBusinessInventoryReturn(n,e,t,a):await this.handleDirectInventoryMovement(n,t,a)},async handleDirectInventoryDesignation(n,t){n.payment_method==="Client Card"?await this.createPurchaseTransaction(n,t):await this.moveToBusinessInventoryDirectly(n,t)},async findBusinessInventoryItemByTransaction(n){return(await T.getBusinessInventoryItems({})).find(e=>e.pending_transaction_id===n||e.transaction_id===n)||null},async handleBusinessInventoryReturn(n,t,e,s){const a=s.filter(o=>o.disposition==="inventory"),i=s.filter(o=>o.disposition!=="inventory");this.areAllTransactionItemsBeingDeallocated(s)?await this.executeAtomicOperation(async()=>{await this.cancelTransactionCompletely(t,e);for(const o of a){const r=await this.findBusinessInventoryItemByTransaction(t);r&&await T.returnItemFromProject(r.item_id,t,e),await b.deleteItem(e,o.item_id)}},[async()=>{const o=this.calculateTotalAmount(s);await B.updateTransaction(e,t,{status:"pending",amount:o})}]):await this.executeAtomicOperation(async()=>{const o=this.calculateRemainingAmount(i);await B.updateTransaction(e,t,{amount:o,status:"pending"});for(const r of a){const c=await this.findBusinessInventoryItemByTransaction(t);c&&await T.returnItemFromProject(c.item_id,t,e),await b.deleteItem(e,r.item_id)}},[async()=>{const o=this.calculateTotalAmount(s);await B.updateTransaction(e,t,{amount:o})}])},async handleDirectInventoryMovement(n,t,e){const s=e.filter(a=>a.disposition==="inventory");if(s.length===1)await this.createWeOweTransaction(n,t),await b.deleteItem(t,n.item_id);else{const a=this.calculateTotalAmount(s);await this.createBundledWeOweTransaction(s,t,a);for(const i of s)await b.deleteItem(t,i.item_id)}},async createPurchaseTransaction(n,t){await T.moveItemToBusinessInventory(n.item_id,t,n.project_price||"0.00","Business purchase from client - item moved to inventory")},async moveToBusinessInventoryDirectly(n,t){const e={description:n.description,source:n.source,sku:n.sku,purchase_price:n.purchase_price,project_price:n.project_price,market_value:n.market_value,payment_method:n.payment_method,disposition:"keep",notes:n.notes,space:n.space,qr_key:n.qr_key,bookmark:n.bookmark,inventory_status:"available",business_inventory_location:"Warehouse - Business Purchase",date_created:n.date_created,last_updated:new Date().toISOString(),images:n.images||[]};await M.createItem({...e,project_id:null,inventory_status:"available",transaction_id:n.transaction_id||""})},async createWeOweTransaction(n,t){const e={project_id:t,project_name:"",transaction_date:new Date().toISOString(),source:"Inventory Return",transaction_type:"Reimbursement",payment_method:"Pending",amount:n.project_price||"0.00",budget_category:"Furnishings",notes:"Item returned to business inventory",receipt_emailed:!1,created_by:"system",status:"pending",reimbursement_type:"We Owe",trigger_event:"Inventory return"};await B.createTransaction(t,e)},async createBundledWeOweTransaction(n,t,e){const s={project_id:t,project_name:"",transaction_date:new Date().toISOString(),source:"Bulk Inventory Return",transaction_type:"Reimbursement",payment_method:"Pending",amount:e,budget_category:"Furnishings",notes:`Bulk return of ${n.length} items to business inventory`,receipt_emailed:!1,created_by:"system",status:"pending",reimbursement_type:"We Owe",trigger_event:"Inventory return"};await B.createTransaction(t,s)},async cancelTransactionCompletely(n,t){await B.updateTransaction(t,n,{status:"cancelled",amount:"0.00"})},calculateRemainingAmount(n){const t=n.reduce((e,s)=>{const a=this.safeParseCurrency(s.project_price);return e+a},0);return this.formatCurrency(t)},calculateTotalAmount(n){const t=n.reduce((e,s)=>{const a=this.safeParseCurrency(s.project_price);return e+a},0);return this.formatCurrency(t)},async executeAtomicOperation(n,t=[]){try{return await n()}catch(e){for(const s of t.reverse())try{await s()}catch(a){console.error("Rollback operation failed:",a)}throw e}},safeParseCurrency(n){if(!n)return 0;const t=parseFloat(n.toString());return isNaN(t)?0:t},formatCurrency(n){return n.toFixed(2)},areAllTransactionItemsBeingDeallocated(n){return n.every(t=>t.disposition==="inventory")},areAnyTransactionItemsBeingDeallocated(n){return n.some(t=>t.disposition==="inventory")}},z={async allocateBusinessInventoryToProject(n,t,e,s){return await T.allocateItemToProject(n,t,e,s)},async returnItemToBusinessInventory(n,t,e){return await T.returnItemFromProject(n,t,e)},async completePendingTransaction(n,t,e,s){return await T.markItemAsSold(n,t,e,s)},async handleItemDeallocation(n,t,e){return await N.handleInventoryDesignation(n,t,e)}};export{T as businessInventoryService,N as deallocationService,z as integrationService,b as itemService,C as projectService,B as transactionService,M as unifiedItemsService};
//# sourceMappingURL=inventoryService.js.map
