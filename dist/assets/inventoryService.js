import{t as g,z as m,M as _,N as S,m as p,O as b,B as y,P as q,q as k,u as h,A as u,Q as C,R as j,S as x}from"./firebase.js";import{e as f,c as l,d}from"./index.js";const R={async getProjects(){await f();const s=g(d,"projects"),t=m(s,_("updatedAt","desc"));return(await h(t)).docs.map(n=>{const a=l(n.data());return{id:n.id,...a}})},async getProject(s){await f();const t=p(d,"projects",s),e=await k(t);if(e.exists()){const n=l(e.data());return{id:e.id,...n}}return null},async createProject(s){const t=g(d,"projects"),e=new Date,n={...s,createdAt:e,updatedAt:e};return(await q(t,n)).id},async updateProject(s,t){const e=p(d,"projects",s);await y(e,{...t,updatedAt:new Date})},async deleteProject(s){const t=p(d,"projects",s);await b(t)},subscribeToProjects(s){const t=g(d,"projects"),e=m(t,_("updatedAt","desc"));return S(e,n=>{const a=n.docs.map(c=>{const o=l(c.data());return{id:c.id,...o}});s(a)})}},v={async getItems(s,t,e){const n=g(d,"projects",s,"items");let a=m(n);if(t!=null&&t.status&&(a=m(a,u("status","==",t.status))),t!=null&&t.category&&(a=m(a,u("category","==",t.category))),t!=null&&t.tags&&t.tags.length>0&&(a=m(a,u("tags","array-contains-any",t.tags))),t!=null&&t.priceRange&&(a=m(a,u("price",">=",t.priceRange.min),u("price","<=",t.priceRange.max))),t!=null&&t.searchQuery){const i=t.searchQuery.toLowerCase();a=m(a,u("description",">=",i),u("description","<=",i+""))}a=m(a,_("last_updated","desc")),e&&(a=m(a,j(e.limit)),e.page>0&&(a=m(a,j(e.page*e.limit))));let o=(await h(a)).docs.map(i=>({item_id:i.id,...i.data()}));if(t!=null&&t.searchQuery&&o.length>0){const i=t.searchQuery.toLowerCase();o=o.filter(r=>r.description.toLowerCase().includes(i)||r.source.toLowerCase().includes(i)||r.sku.toLowerCase().includes(i)||r.payment_method.toLowerCase().includes(i))}return o},async getItem(s,t){var a,c;console.log("getItem called with:",{projectId:s,itemId:t}),await f();const e=p(d,"projects",s,"items",t);console.log("Document path:",e.path);const n=await k(e);if(n.exists()){const o=n.data();console.log("Raw Firebase data:",o),console.log("Images in Firebase:",((a=o.images)==null?void 0:a.length)||0,"images");const i={item_id:n.id,description:o.description,source:o.source,sku:o.sku,price:o.price,market_value:o.market_value,payment_method:o.payment_method,disposition:o.disposition,notes:o.notes,space:o.space,qr_key:o.qr_key,bookmark:o.bookmark,transaction_id:o.transaction_id,project_id:o.project_id,date_created:o.date_created,last_updated:o.last_updated,images:o.images||[]};return console.log("Mapped item data:",i),console.log("Mapped images:",((c=i.images)==null?void 0:c.length)||0,"images"),i}return console.log("Document does not exist at path:",e.path),console.log("itemSnap.exists():",n.exists()),console.log("Item not found"),null},async createItem(s,t){const e=g(d,"projects",s,"items"),n=new Date,a={description:t.description,source:t.source,sku:t.sku,price:t.price,market_value:t.market_value,payment_method:t.payment_method,disposition:t.disposition,notes:t.notes,space:t.space,qr_key:t.qr_key||`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,bookmark:t.bookmark,transaction_id:t.transaction_id,project_id:t.project_id,date_created:n.toISOString(),last_updated:n.toISOString()},c=await q(e,a);return await R.updateProject(s,{metadata:{totalItems:await v.getItemCount(s)+1,lastActivity:n}}),c.id},async updateItem(s,t,e){var c;const n=p(d,"projects",s,"items",t),a={last_updated:new Date().toISOString()};e.market_value!==void 0&&(a.market_value=e.market_value),e.description!==void 0&&(a.description=e.description),e.source!==void 0&&(a.source=e.source),e.sku!==void 0&&(a.sku=e.sku),e.price!==void 0&&(a.price=e.price),e.payment_method!==void 0&&(a.payment_method=e.payment_method),e.disposition!==void 0&&(a.disposition=e.disposition),e.notes!==void 0&&(a.notes=e.notes),e.space!==void 0&&(a.space=e.space),e.bookmark!==void 0&&(a.bookmark=e.bookmark),e.images!==void 0&&(console.log("Updating item images:",(c=e.images)==null?void 0:c.length,"images"),a.images=e.images),console.log("Updating item in database:",t,"with updates:",Object.keys(a)),await y(n,a),console.log("Item updated successfully in database")},async addItemImage(s,t,e){const n=p(d,"projects",s,"items",t),a=await k(n);if(!a.exists())throw new Error("Item not found");const i=[...a.data().images||[],e];await y(n,{images:i,last_updated:new Date().toISOString()})},async updateItemImages(s,t,e){const n=p(d,"projects",s,"items",t);await y(n,{images:e,last_updated:new Date().toISOString()})},async removeItemImage(s,t,e){const n=p(d,"projects",s,"items",t),a=await k(n);if(!a.exists())throw new Error("Item not found");const i=(a.data().images||[]).filter(r=>r.url!==e);await y(n,{images:i,last_updated:new Date().toISOString()})},async setPrimaryImage(s,t,e){const n=p(d,"projects",s,"items",t),a=await k(n);if(!a.exists())throw new Error("Item not found");const i=(a.data().images||[]).map(r=>({...r,isPrimary:r.url===e}));await y(n,{images:i,last_updated:new Date().toISOString()})},async deleteItem(s,t){const e=p(d,"projects",s,"items",t);await b(e);const n=new Date;await R.updateProject(s,{metadata:{totalItems:Math.max(0,await v.getItemCount(s)-1),lastActivity:n}})},async getItemCount(s){const t=g(d,"projects",s,"items");return(await x(t)).data().count},subscribeToItems(s,t,e){const n=g(d,"projects",s,"items");let a=m(n,_("last_updated","desc"));return e!=null&&e.status&&(a=m(a,u("disposition","==",e.status))),e!=null&&e.category&&(a=m(a,u("source","==",e.category))),S(a,c=>{console.log("Real-time items snapshot received:",c.docs.length,"documents");let o=c.docs.map(i=>{const r=i.data();return{item_id:i.id,description:r.description,source:r.source,sku:r.sku,price:r.price,market_value:r.market_value,payment_method:r.payment_method,disposition:r.disposition,notes:r.notes,space:r.space,qr_key:r.qr_key,bookmark:r.bookmark,transaction_id:r.transaction_id,project_id:r.project_id,date_created:r.date_created,last_updated:r.last_updated,images:r.images||[]}});if(e!=null&&e.searchQuery){const i=e.searchQuery.toLowerCase();o=o.filter(r=>r.description.toLowerCase().includes(i)||r.source.toLowerCase().includes(i)||r.sku.toLowerCase().includes(i)||r.payment_method.toLowerCase().includes(i))}console.log("Real-time items callback with",o.length,"items"),t(o)})},async searchItems(s,t){if(t.length<2)return[];const e=g(d,"projects",s,"items"),n=m(e,u("description",">=",t.toLowerCase()),u("description","<=",t.toLowerCase()+""),_("description"),j(20));return(await h(n)).docs.map(c=>{const o=c.data();return{item_id:c.id,description:o.description,source:o.source,sku:o.sku,price:o.price,market_value:o.market_value,payment_method:o.payment_method,disposition:o.disposition,notes:o.notes,space:o.space,qr_key:o.qr_key,bookmark:o.bookmark,transaction_id:o.transaction_id,project_id:o.project_id,date_created:o.date_created,last_updated:o.last_updated}})},async batchUpdateItems(s,t){const e=C(d);t.forEach(({id:n,updates:a})=>{const c=p(d,"projects",s,"items",n),o={last_updated:new Date().toISOString()};a.market_value!==void 0&&(o.market_value=a.market_value),a.description!==void 0&&(o.description=a.description),a.source!==void 0&&(o.source=a.source),a.sku!==void 0&&(o.sku=a.sku),a.price!==void 0&&(o.price=a.price),a.payment_method!==void 0&&(o.payment_method=a.payment_method),a.disposition!==void 0&&(o.disposition=a.disposition),a.notes!==void 0&&(o.notes=a.notes),a.space!==void 0&&(o.space=a.space),a.bookmark!==void 0&&(o.bookmark=a.bookmark),e.update(c,o)}),await e.commit()},async createTransactionItems(s,t,e,n,a){const c=C(d),o=[],i=new Date;a.forEach(w=>{const I=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;o.push(I);const T=p(d,"projects",s,"items",I),A=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,D={item_id:I,description:w.description,source:n,sku:w.sku||"",price:w.price,market_value:w.market_value||"",payment_method:"Client Card",disposition:"keep",notes:w.notes||"",qr_key:A,bookmark:!1,transaction_id:t,project_id:s,date_created:e,last_updated:i.toISOString(),images:[]};c.set(T,D)}),await c.commit();const r=await v.getItemCount(s);return await R.updateProject(s,{metadata:{totalItems:r,lastActivity:i}}),o},async getTransactionItems(s,t){const e=g(d,"projects",s,"items"),n=m(e,u("transaction_id","==",t),_("date_created","asc"));return(await h(n)).docs.map(c=>c.id)}},O={async getTransactions(s){const t=g(d,"projects",s,"transactions"),e=m(t,_("created_at","desc"));return(await h(e)).docs.map(a=>{const c=l(a.data()),o={...c,transaction_images:Array.isArray(c.transaction_images)?c.transaction_images:[]};return{transaction_id:a.id,...o}})},async getTransaction(s,t){const e=p(d,"projects",s,"transactions",t),n=await k(e);if(n.exists()){const a=l(n.data());console.log("inventoryService - raw data:",a),console.log("inventoryService - transaction_images:",a.transaction_images),console.log("inventoryService - transaction_images type:",typeof a.transaction_images);const c={...a,transaction_images:Array.isArray(a.transaction_images)?a.transaction_images:[]};return console.log("inventoryService - processed transactionData:",c),{transaction_id:n.id,...c}}return null},async createTransaction(s,t,e){try{const n=g(d,"projects",s,"transactions"),c={...t,created_at:new Date().toISOString()};console.log("Creating transaction:",c),console.log("Transaction items:",e);const i=(await q(n,c)).id;if(console.log("Transaction created successfully:",i),e&&e.length>0){console.log("Creating items for transaction:",i);const r=await v.createTransactionItems(s,i,t.transaction_date,t.source,e);console.log("Created items:",r)}return i}catch(n){throw console.error("Error creating transaction:",n),n}},async updateTransaction(s,t,e){const n=p(d,"projects",s,"transactions",t);await y(n,e)},async deleteTransaction(s,t){const e=p(d,"projects",s,"transactions",t);await b(e)},subscribeToTransactions(s,t){const e=g(d,"projects",s,"transactions"),n=m(e,_("created_at","desc"));return S(n,a=>{const c=a.docs.map(o=>{const i=l(o.data()),r={...i,transaction_images:Array.isArray(i.transaction_images)?i.transaction_images:[]};return{transaction_id:o.id,...r}});t(c)})},subscribeToTransaction(s,t,e){const n=p(d,"projects",s,"transactions",t);return S(n,a=>{if(a.exists()){const c=l(a.data());console.log("inventoryService - real-time raw data:",c),console.log("inventoryService - real-time transaction_images:",c.transaction_images);const o={...c,transaction_images:Array.isArray(c.transaction_images)?c.transaction_images:[]};console.log("inventoryService - real-time processed transactionData:",o);const i={transaction_id:a.id,...o};e(i)}else e(null)})}};export{v as i,R as p,O as t};
//# sourceMappingURL=inventoryService.js.map
