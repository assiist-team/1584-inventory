import{v as p,s as m,w as F,C as D,f as x,x as E}from"./index.js";import{a as A}from"./taxPresetsService.js";const N=t=>{if(!t)return null;if(t instanceof Date)return t;if(typeof t=="object"&&t){if("toDate"in t&&typeof t.toDate=="function")try{return t.toDate()}catch(e){return console.warn("Failed to convert timestamp to Date:",e),null}if("seconds"in t&&"nanoseconds"in t)try{return new Date(t.seconds*1e3+t.nanoseconds/1e6)}catch(e){return console.warn("Failed to convert timestamp to Date:",e),null}}if(typeof t=="string")try{if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const[o,n,a]=t.split("-").map(Number),i=new Date(o,n-1,a);return isNaN(i.getTime())?null:i}const e=new Date(t);return isNaN(e.getTime())?null:e}catch(e){return console.warn("Failed to parse date string:",t,e),null}if(typeof t=="number")try{const e=new Date(t);return isNaN(e.getTime())?null:e}catch(e){return console.warn("Failed to convert number to Date:",t,e),null}return null},B=(t,e="Unknown",o)=>{const n=N(t);if(!n)return e;try{const i={...{year:"numeric",month:"short",day:"numeric"},...o};return n.toLocaleDateString("en-US",i)}catch(a){return console.warn("Failed to format date:",t,a),e}},U=(t,e="$0.00")=>{const o=typeof t=="string"?parseFloat(t):t;return isNaN(o)?e:o.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2})},P=t=>{if(!t)return"";if(typeof t=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const e=N(t);if(!e)return"";const o=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${o}-${n}-${a}`},v={async logAllocationEvent(t,e,o,n,a,i){try{let s=null,r={};typeof a=="string"?(s=a,r=i||{}):(s=null,r=a||{});const{error:c}=await m.from("audit_logs").insert({account_id:t,event_type:e,item_id:o,project_id:n,transaction_id:s,details:r,timestamp:new Date().toISOString(),created_at:new Date().toISOString()});c?console.warn("âš ï¸ Failed to log audit event (non-critical):",c):console.log(`ðŸ“‹ Audit logged: ${e} for item ${o}`)}catch(s){console.warn("âš ï¸ Failed to log audit event (non-critical):",s)}},async logTransactionStateChange(t,e,o,n,a){try{const{error:i}=await m.from("transaction_audit_logs").insert({account_id:t,transaction_id:e,change_type:o,old_state:n||null,new_state:a||null,timestamp:new Date().toISOString(),created_at:new Date().toISOString()});i?console.warn("âš ï¸ Failed to log transaction audit (non-critical):",i):console.log(`ðŸ“‹ Transaction audit logged: ${o} for ${e}`)}catch(i){console.warn("âš ï¸ Failed to log transaction audit (non-critical):",i)}}},j={async getProjects(t){await p();const{data:e,error:o}=await m.from("projects").select("*").eq("account_id",t).order("updated_at",{ascending:!1});if(o)throw o;return(e||[]).map(n=>{const a=E(n);return{id:a.id,accountId:a.account_id,name:a.name,description:a.description||"",clientName:a.client_name||"",budget:a.budget?parseFloat(a.budget):void 0,designFee:a.design_fee?parseFloat(a.design_fee):void 0,budgetCategories:a.budget_categories||void 0,createdAt:a.created_at,updatedAt:a.updated_at,createdBy:a.created_by,settings:a.settings||void 0,metadata:a.metadata||void 0,itemCount:a.item_count||0,transactionCount:a.transaction_count||0,totalValue:a.total_value?parseFloat(a.total_value):0}})},async getProject(t,e){await p();const{data:o,error:n}=await m.from("projects").select("*").eq("id",e).eq("account_id",t).single();if(n){if(n.code==="PGRST116")return null;throw n}if(!o)return null;const a=E(o);return{id:a.id,accountId:a.account_id,name:a.name,description:a.description||"",clientName:a.client_name||"",budget:a.budget?parseFloat(a.budget):void 0,designFee:a.design_fee?parseFloat(a.design_fee):void 0,budgetCategories:a.budget_categories||void 0,createdAt:a.created_at,updatedAt:a.updated_at,createdBy:a.created_by,settings:a.settings||void 0,metadata:a.metadata||void 0,itemCount:a.item_count||0,transactionCount:a.transaction_count||0,totalValue:a.total_value?parseFloat(a.total_value):0}},async createProject(t,e){await p();const{data:o,error:n}=await m.from("projects").insert({account_id:t,name:e.name,description:e.description||null,client_name:e.clientName||null,budget:e.budget||null,design_fee:e.designFee||null,budget_categories:e.budgetCategories||{},settings:e.settings||{},metadata:e.metadata||{},created_by:e.createdBy,item_count:0,transaction_count:0,total_value:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select("id").single();if(n)throw n;return o.id},async updateProject(t,e,o){await p();const n={updated_at:new Date().toISOString()};o.name!==void 0&&(n.name=o.name),o.description!==void 0&&(n.description=o.description),o.clientName!==void 0&&(n.client_name=o.clientName),o.budget!==void 0&&(n.budget=o.budget),o.designFee!==void 0&&(n.design_fee=o.designFee),o.budgetCategories!==void 0&&(n.budget_categories=o.budgetCategories),o.settings!==void 0&&(n.settings=o.settings),o.metadata!==void 0&&(n.metadata=o.metadata);const{error:a}=await m.from("projects").update(n).eq("id",e).eq("account_id",t);if(a)throw a},async deleteProject(t,e){await p();const{error:o}=await m.from("projects").delete().eq("id",e).eq("account_id",t);if(o)throw o},subscribeToProjects(t,e,o){let n=[...o||[]];const a=m.channel(`projects:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"projects",filter:`account_id=eq.${t}`},i=>{console.log("Projects change received!",i);const{eventType:s,new:r,old:c}=i;if(s==="INSERT")n=[j._convertProjectFromDb(r),...n];else if(s==="UPDATE"){const u=j._convertProjectFromDb(r);n=n.map(d=>d.id===u.id?u:d)}else if(s==="DELETE"){const u=c.id;n=n.filter(d=>d.id!==u)}e([...n])}).subscribe((i,s)=>{i==="SUBSCRIBED"&&console.log("Subscribed to projects channel"),s&&console.error("Error subscribing to projects channel:",s)});return()=>{a.unsubscribe()}},_convertProjectFromDb(t){const e=E(t);return{id:e.id,accountId:e.account_id,name:e.name,description:e.description||"",clientName:e.client_name||"",budget:e.budget?parseFloat(e.budget):void 0,designFee:e.design_fee?parseFloat(e.design_fee):void 0,budgetCategories:e.budget_categories||void 0,createdAt:e.created_at,updatedAt:e.updated_at,createdBy:e.created_by,settings:e.settings||void 0,metadata:e.metadata||void 0,itemCount:e.item_count||0,transactionCount:e.transaction_count||0,totalValue:e.total_value?parseFloat(e.total_value):0}}};function I(t){const e=E(t);return{transactionId:e.transaction_id,projectId:e.project_id||void 0,projectName:e.project_name||void 0,transactionDate:e.transaction_date,source:e.source||"",transactionType:e.transaction_type||"",paymentMethod:e.payment_method||"",amount:e.amount||"0.00",budgetCategory:e.budget_category||void 0,notes:e.notes||void 0,transactionImages:Array.isArray(e.transaction_images)?e.transaction_images:[],receiptImages:Array.isArray(e.receipt_images)?e.receipt_images:[],otherImages:Array.isArray(e.other_images)?e.other_images:[],receiptEmailed:e.receipt_emailed||!1,createdAt:e.created_at,createdBy:e.created_by||"",status:e.status||"completed",reimbursementType:e.reimbursement_type||void 0,triggerEvent:e.trigger_event||void 0,itemIds:Array.isArray(e.item_ids)?e.item_ids:[],taxRatePreset:e.tax_rate_preset||void 0,taxRatePct:e.tax_rate_pct?parseFloat(e.tax_rate_pct):void 0,subtotal:e.subtotal||void 0}}async function S(t,e,o){if([...new Set(e.map(i=>i.projectId).filter(i=>!!i))].length===0)return e;const a=new Map;try{(await j.getProjects(t)).forEach(s=>{a.set(s.id,s.name)})}catch(i){console.warn("Failed to fetch projects for transaction enrichment:",i)}return e.map(i=>{if(i.projectId&&!i.projectName){const s=a.get(i.projectId);if(s)return{...i,projectName:s}}return i})}function q(t){const e={};return t.transactionId!==void 0&&(e.transaction_id=t.transactionId),t.projectId!==void 0&&(e.project_id=t.projectId??null),t.transactionDate!==void 0&&(e.transaction_date=t.transactionDate),t.source!==void 0&&(e.source=t.source),t.transactionType!==void 0&&(e.transaction_type=t.transactionType),t.paymentMethod!==void 0&&(e.payment_method=t.paymentMethod),t.amount!==void 0&&(e.amount=t.amount),t.budgetCategory!==void 0&&(e.budget_category=t.budgetCategory),t.notes!==void 0&&(e.notes=t.notes),t.transactionImages!==void 0&&(e.transaction_images=t.transactionImages),t.receiptImages!==void 0&&(e.receipt_images=t.receiptImages),t.otherImages!==void 0&&(e.other_images=t.otherImages),t.receiptEmailed!==void 0&&(e.receipt_emailed=t.receiptEmailed),t.createdAt!==void 0&&(e.created_at=t.createdAt),t.createdBy!==void 0&&(e.created_by=t.createdBy),t.status!==void 0&&(e.status=t.status),t.reimbursementType!==void 0&&(e.reimbursement_type=t.reimbursementType),t.triggerEvent!==void 0&&(e.trigger_event=t.triggerEvent),t.itemIds!==void 0&&(e.item_ids=t.itemIds),t.taxRatePreset!==void 0&&(e.tax_rate_preset=t.taxRatePreset),t.taxRatePct!==void 0&&(e.tax_rate_pct=t.taxRatePct),t.subtotal!==void 0&&(e.subtotal=t.subtotal),e}const R={async getTransactions(t,e){await p();const{data:o,error:n}=await m.from("transactions").select("*").eq("account_id",t).eq("project_id",e).order("created_at",{ascending:!1});if(n)throw n;const a=(o||[]).map(i=>I(i));return await S(t,a)},async getTransactionsForProjects(t,e,o){if(await p(),e.length===0)return[];const{data:n,error:a}=await m.from("transactions").select("*").eq("account_id",t).in("project_id",e).order("created_at",{ascending:!1});if(a)throw a;const i=(n||[]).map(s=>I(s));return await S(t,i)},async getTransaction(t,e,o){await p();const{data:n,error:a}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",o).single();if(a){if(a.code==="PGRST116")return null;throw a}if(!n)return null;const i=I(n);return(await S(t,[i]))[0]||null},async getTransactionById(t,e){await p();const{data:o,error:n}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",e).single();if(n||!o)return{transaction:null,projectId:null};const a=E(o),i=I(o);return{transaction:(await S(t,[i]))[0]||i,projectId:a.project_id||null}},async createTransaction(t,e,o,n){try{await p();const a=await F();if(!(o.createdBy||(a==null?void 0:a.id)||null))throw new Error("User must be authenticated to create transactions");const s=new Date,r=crypto.randomUUID(),c=q({...o,transactionId:r,createdAt:s.toISOString()});if(c.account_id=t,c.created_at=s.toISOString(),c.updated_at=s.toISOString(),c.status||(c.status="completed"),console.log("Creating transaction:",c),console.log("Transaction items:",n),c.tax_rate_preset)if(c.tax_rate_preset==="Other"){const d=parseFloat(c.amount||"0"),l=parseFloat(c.subtotal||"0");if(isNaN(l)||l<=0)throw new Error("Subtotal must be greater than 0 when Tax Rate Preset is Other.");if(isNaN(d)||d<l)throw new Error("Subtotal cannot exceed the total amount.");const _=(d-l)/l*100;c.tax_rate_pct=Math.round(_*1e4)/1e4}else{const d=await A(t,c.tax_rate_preset);if(!d)throw new Error(`Tax preset with ID '${c.tax_rate_preset}' not found.`);c.tax_rate_pct=d.rate,c.subtotal=null}const{error:u}=await m.from("transactions").insert(c);if(u)throw u;if(console.log("Transaction created successfully:",r),n&&n.length>0){console.log("Creating items for transaction:",r);const d=n.map(_=>({..._})),l=await T.createTransactionItems(t,e||"",r,o.transactionDate,o.source,d,c.tax_rate_pct);console.log("Created items:",l)}return r}catch(a){throw console.error("Error creating transaction:",a),a}},async updateTransaction(t,e,o,n){await p();const a={...n};if(a.status==="completed"&&a.reimbursementType!==void 0&&(a.reimbursementType=null),a.reimbursementType===""&&(a.reimbursementType=null),a.reimbursementType&&a.status==="completed"&&(a.status="pending"),a.taxRatePreset!==void 0)if(a.taxRatePreset==="Other"){const{data:r}=await m.from("transactions").select("amount, subtotal").eq("account_id",t).eq("transaction_id",o).single(),c=r,u=a.amount!==void 0?parseFloat(a.amount):parseFloat((c==null?void 0:c.amount)||"0"),d=a.subtotal!==void 0?parseFloat(a.subtotal):parseFloat((c==null?void 0:c.subtotal)||"0");if(!isNaN(u)&&!isNaN(d)&&d>0&&u>=d){const l=(u-d)/d*100;a.taxRatePct=Math.round(l*1e4)/1e4}}else try{const r=await A(t,a.taxRatePreset);r?(a.taxRatePct=r.rate,a.subtotal=void 0):console.warn(`Tax preset with ID '${a.taxRatePreset}' not found during update`)}catch(r){console.warn("Tax preset lookup failed during update:",r)}const i=q(a);i.updated_at=new Date().toISOString();const{error:s}=await m.from("transactions").update(i).eq("account_id",t).eq("transaction_id",o);if(s)throw s;if(a.taxRatePct!==void 0)try{const r=await T.getItemsForTransaction(t,e,o);if(r&&r.length>0)for(const c of r)await T.updateItem(t,c.itemId,{taxRatePct:a.taxRatePct})}catch(r){console.warn("Failed to propagate tax_rate_pct to items:",r)}},async deleteTransaction(t,e,o){await p();const{error:n}=await m.from("transactions").delete().eq("account_id",t).eq("transaction_id",o);if(n)throw n},subscribeToTransactions(t,e,o,n){let a=[...n||[]];const i=m.channel(`transactions:${t}:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`account_id=eq.${t}`},async s=>{console.log("Transactions change received (account scope)!",s);const{eventType:r,new:c,old:u}=s,d=(c==null?void 0:c.project_id)??null,l=(u==null?void 0:u.project_id)??null,_=g=>g===e;if(r==="INSERT"){if(_(d)){const g=I(c),[h]=await S(t,[g]);a=[h,...a.filter(y=>y.transactionId!==h.transactionId)]}}else if(r==="UPDATE"){const g=I(c),[h]=await S(t,[g]),y=a.some(b=>b.transactionId===h.transactionId),w=_(d);w&&!y?a=[h,...a]:!w&&y?a=a.filter(b=>b.transactionId!==h.transactionId):w&&y&&(a=a.map(b=>b.transactionId===h.transactionId?h:b))}else if(r==="DELETE"&&_(l)){const g=u.transaction_id;a=a.filter(h=>h.transactionId!==g)}const f=[...a].sort((g,h)=>new Date(h.createdAt).getTime()-new Date(g.createdAt).getTime());o(f)}).subscribe((s,r)=>{s==="SUBSCRIBED"&&console.log("Subscribed to transactions channel"),r&&console.error("Error subscribing to transactions channel:",r)});return()=>{i.unsubscribe()}},subscribeToAllTransactions(t,e,o){let n=[...o||[]];const a=m.channel(`transactions:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`account_id=eq.${t}`},async i=>{console.log("All transactions change received!",i);const{eventType:s,new:r,old:c}=i;if(s==="INSERT"){const d=I(r),[l]=await S(t,[d]);n=[l,...n.filter(_=>_.transactionId!==l.transactionId)]}else if(s==="UPDATE"){const d=I(r),[l]=await S(t,[d]);n=n.map(_=>_.transactionId===l.transactionId?l:_)}else if(s==="DELETE"){const d=c.transaction_id;n=n.filter(l=>l.transactionId!==d)}const u=[...n].sort((d,l)=>new Date(l.createdAt).getTime()-new Date(d.createdAt).getTime());e(u)}).subscribe((i,s)=>{i==="SUBSCRIBED"&&console.log("Subscribed to all transactions channel"),s&&console.error("Error subscribing to all transactions channel:",s)});return()=>{a.unsubscribe()}},subscribeToTransaction(t,e,o,n){const a=m.channel(`transaction:${t}:${o}`).on("postgres_changes",{event:"*",schema:"public",table:"transactions",filter:`account_id=eq.${t} AND transaction_id=eq.${o}`},async()=>{try{const{data:s,error:r}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",o).single();if(r){if(r.code==="PGRST116"){n(null);return}console.error("Error fetching transaction in subscription:",r);return}if(s){const c=I(s),u=await S(t,[c]);n(u[0]||null)}else n(null)}catch(s){console.error("Error in transaction subscription callback:",s)}}).subscribe();return(async()=>{try{const{data:s,error:r}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",o).single();if(r){if(r.code==="PGRST116"){n(null);return}console.error("Error fetching initial transaction:",r);return}if(s){const c=I(s),u=await S(t,[c]);n(u[0]||null)}else n(null)}catch(s){console.error("Error in initial transaction fetch:",s)}})(),()=>{a.unsubscribe()}},async getPendingTransactions(t,e){await p();const{data:o,error:n}=await m.from("transactions").select("*").eq("account_id",t).eq("project_id",e).eq("status","pending").order("created_at",{ascending:!1});if(n)throw n;const a=(o||[]).map(i=>I(i));return await S(t,a)},async updateTransactionStatus(t,e,o,n,a){await p();const i={status:n,updated_at:new Date().toISOString()};a&&(a.transactionDate!==void 0&&(i.transaction_date=a.transactionDate),a.paymentMethod!==void 0&&(i.payment_method=a.paymentMethod),a.amount!==void 0&&(i.amount=a.amount),a.notes!==void 0&&(i.notes=a.notes)),n==="completed"&&!(a!=null&&a.transactionDate)&&(i.transaction_date=P(new Date));const{error:s}=await m.from("transactions").update(i).eq("account_id",t).eq("transaction_id",o);if(s)throw s},async getInventoryRelatedTransactions(t){await p();const{data:e,error:o}=await m.from("transactions").select("*").eq("account_id",t).in("reimbursement_type",[x,D]).order("created_at",{ascending:!1});if(o)throw o;const n=(e||[]).map(a=>I(a));return await S(t,n)},async getBusinessInventoryTransactions(t){await p();const{data:e,error:o}=await m.from("transactions").select("*").eq("account_id",t).is("project_id",null).order("created_at",{ascending:!1});if(o)throw o;const n=(e||[]).map(a=>I(a));return await S(t,n)}},T={_convertItemFromDb(t){const e=E(t);return{itemId:e.item_id,accountId:e.account_id,projectId:e.project_id||void 0,transactionId:e.transaction_id||void 0,name:e.name||void 0,description:e.description||"",sku:e.sku||"",source:e.source||"",purchasePrice:e.purchase_price||void 0,projectPrice:e.project_price||void 0,marketValue:e.market_value||void 0,paymentMethod:e.payment_method||"",disposition:e.disposition||void 0,notes:e.notes||void 0,space:e.space||void 0,qrKey:e.qr_key||"",bookmark:e.bookmark||!1,dateCreated:e.date_created||"",lastUpdated:e.last_updated?typeof e.last_updated=="string"?e.last_updated:e.last_updated.toISOString():"",images:Array.isArray(e.images)?e.images:[],inventoryStatus:e.inventory_status||void 0,businessInventoryLocation:e.business_inventory_location||void 0,taxRatePct:e.tax_rate_pct?parseFloat(e.tax_rate_pct):void 0,taxAmount:e.tax_amount||void 0,createdBy:e.created_by||void 0,createdAt:e.created_at}},_convertItemToDb(t){const e={};return t.itemId!==void 0&&(e.item_id=t.itemId),t.accountId!==void 0&&(e.account_id=t.accountId),t.projectId!==void 0&&(e.project_id=t.projectId??null),t.transactionId!==void 0&&(e.transaction_id=t.transactionId??null),t.name!==void 0&&(e.name=t.name),t.description!==void 0&&(e.description=t.description),t.sku!==void 0&&(e.sku=t.sku),t.source!==void 0&&(e.source=t.source),t.purchasePrice!==void 0&&(e.purchase_price=t.purchasePrice),t.projectPrice!==void 0&&(e.project_price=t.projectPrice),t.marketValue!==void 0&&(e.market_value=t.marketValue),t.paymentMethod!==void 0&&(e.payment_method=t.paymentMethod),t.disposition!==void 0&&(e.disposition=t.disposition),t.notes!==void 0&&(e.notes=t.notes),t.space!==void 0&&(e.space=t.space),t.qrKey!==void 0&&(e.qr_key=t.qrKey),t.bookmark!==void 0&&(e.bookmark=t.bookmark),t.dateCreated!==void 0&&(e.date_created=t.dateCreated),t.lastUpdated!==void 0&&(e.last_updated=t.lastUpdated),t.images!==void 0&&(e.images=t.images),t.inventoryStatus!==void 0&&(e.inventory_status=t.inventoryStatus),t.businessInventoryLocation!==void 0&&(e.business_inventory_location=t.businessInventoryLocation),t.taxRatePct!==void 0&&(e.tax_rate_pct=t.taxRatePct),t.taxAmount!==void 0&&(e.tax_amount=t.taxAmount),t.createdBy!==void 0&&(e.created_by=t.createdBy),t.createdAt!==void 0&&(e.created_at=t.createdAt),e},async getItemsByProject(t,e,o,n){await p();let a=m.from("items").select("*").eq("account_id",t).eq("project_id",e);if(o!=null&&o.status&&(a=a.eq("disposition",o.status)),o!=null&&o.category&&(a=a.eq("source",o.category)),o!=null&&o.priceRange&&(a=a.gte("project_price",o.priceRange.min.toString()),a=a.lte("project_price",o.priceRange.max.toString())),o!=null&&o.searchQuery&&(a=a.or(`description.ilike.%${o.searchQuery}%,source.ilike.%${o.searchQuery}%,sku.ilike.%${o.searchQuery}%,payment_method.ilike.%${o.searchQuery}%`)),a=a.order("last_updated",{ascending:!1}),n){const r=n.page>0?(n.page-1)*n.limit:0;a=a.range(r,r+n.limit-1)}const{data:i,error:s}=await a;if(s)throw s;return(i||[]).map(r=>this._convertItemFromDb(r))},subscribeToProjectItems(t,e,o,n){let a=[...n||[]];const i=m.channel(`project-items:${t}:${e}`).on("postgres_changes",{event:"*",schema:"public",table:"items",filter:`account_id=eq.${t}`},s=>{console.log("Project items change received (broad filter)!",s);const{eventType:r,new:c,old:u}=s;if(r==="INSERT")c.project_id===e&&(a=[this._convertItemFromDb(c),...a]);else if(r==="UPDATE"){const d=this._convertItemFromDb(c),l=a.some(f=>f.itemId===d.itemId),_=d.projectId===e;_&&!l?a=[d,...a]:!_&&l?a=a.filter(f=>f.itemId!==d.itemId):_&&l&&(a=a.map(f=>f.itemId===d.itemId?d:f))}else if(r==="DELETE"){const d=u.item_id;a=a.filter(l=>l.itemId!==d)}o([...a])}).subscribe((s,r)=>{s==="SUBSCRIBED"&&console.log("Subscribed to project items channel"),r&&console.error("Error subscribing to project items channel:",r)});return()=>{i.unsubscribe()}},async getBusinessInventoryItems(t,e,o){await p();let n=m.from("items").select("*").eq("account_id",t).is("project_id",null);if(e!=null&&e.status&&(n=n.eq("inventory_status",e.status)),e!=null&&e.searchQuery&&(n=n.or(`description.ilike.%${e.searchQuery}%,source.ilike.%${e.searchQuery}%,sku.ilike.%${e.searchQuery}%,business_inventory_location.ilike.%${e.searchQuery}%`)),n=n.order("last_updated",{ascending:!1}),o){const s=o.page>0?(o.page-1)*o.limit:0;n=n.range(s,s+o.limit-1)}const{data:a,error:i}=await n;if(i)throw i;return(a||[]).map(s=>this._convertItemFromDb(s))},subscribeToBusinessInventory(t,e,o,n){let a=[...n||[]];const i=m.channel(`business-inventory:${t}`).on("postgres_changes",{event:"*",schema:"public",table:"items",filter:`account_id=eq.${t}`},s=>{console.log("Business inventory change received!",s);const{eventType:r,new:c,old:u}=s;if(r==="INSERT")c.project_id||(a=[this._convertItemFromDb(c),...a]);else if(r==="UPDATE"){const d=this._convertItemFromDb(c);d.projectId?a=a.filter(l=>l.itemId!==d.itemId):a=a.map(l=>l.itemId===d.itemId?d:l)}else if(r==="DELETE"){const d=u.item_id;a=a.filter(l=>l.itemId!==d)}e([...a])}).subscribe((s,r)=>{s==="SUBSCRIBED"&&console.log("Subscribed to business inventory channel"),r&&console.error("Error subscribing to business inventory channel:",r)});return()=>{i.unsubscribe()}},async createItem(t,e){await p();const o=new Date,n=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,a=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,i=this._convertItemToDb({...e,itemId:n,qrKey:e.qrKey||a});i.date_created=P(o),i.last_updated=o.toISOString(),i.account_id=t,i.created_at=o.toISOString(),i.date_created||(i.date_created=P(o)),i.last_updated||(i.last_updated=o.toISOString()),i.inventory_status||(i.inventory_status="available");try{if(i.transaction_id&&i.tax_rate_pct===null){const{data:r}=await m.from("transactions").select("tax_rate_pct").eq("account_id",t).eq("transaction_id",i.transaction_id).single();r&&r.tax_rate_pct!==void 0&&r.tax_rate_pct!==null&&(i.tax_rate_pct=r.tax_rate_pct)}}catch(r){console.warn("Failed to inherit tax_rate_pct when creating item:",r)}const{error:s}=await m.from("items").insert(i);if(s)throw s;return n},async updateItem(t,e,o){await p();const n=this._convertItemToDb({...o,lastUpdated:new Date().toISOString()});try{const i=o.transactionId!==void 0&&o.transactionId!==null,s=o.taxRatePct===void 0||o.taxRatePct===null;if(i&&s){const r=o.transactionId;if(r){const{data:c}=await m.from("transactions").select("tax_rate_pct").eq("account_id",t).eq("transaction_id",r).single();c&&c.tax_rate_pct!==void 0&&c.tax_rate_pct!==null&&(n.tax_rate_pct=c.tax_rate_pct)}}}catch(i){console.warn("Failed to inherit tax_rate_pct when updating item:",i)}const{error:a}=await m.from("items").update(n).eq("account_id",t).eq("item_id",e);if(a)throw a},async deleteItem(t,e){await p();const{error:o}=await m.from("items").delete().eq("account_id",t).eq("item_id",e);if(o)throw o},async getItemsForTransaction(t,e,o){await p();const{data:n,error:a}=await m.from("items").select("*").eq("account_id",t).eq("transaction_id",o).order("date_created",{ascending:!0});if(a)throw a;return(n||[]).map(i=>this._convertItemFromDb(i))},async allocateItemToProject(t,e,o,n,a,i){await p();const s=await this.getItemById(t,e);if(!s)throw new Error("Item not found");const r=n||s.projectPrice||s.marketValue||"0.00",c=s.transactionId||null;console.log("ðŸ”„ Starting allocation process:",{itemId:e,projectId:o,currentTransactionId:c,itemProjectId:s.projectId,finalAmount:r});try{await v.logAllocationEvent(t,"allocation",e,s.projectId??null,c??null,{action:"allocation_started",target_project_id:o,current_transaction_id:c,amount:r})}catch(u){console.warn("âš ï¸ Failed to log allocation start:",u)}return c!=null&&c.startsWith("INV_SALE_")?c.replace("INV_SALE_","")===o?(console.log("ðŸ“‹ Scenario A.1: Item in Sale, allocating to same project â†’ move to inventory"),await this.handleSaleToInventoryMove(t,e,c,o,r,a,i)):(console.log("ðŸ“‹ Scenario A.2: Item in Sale, allocating to different project"),await this.handleSaleToDifferentProjectMove(t,e,c,o,r,a,i)):c!=null&&c.startsWith("INV_PURCHASE_")?c.replace("INV_PURCHASE_","")===o?(console.log("ðŸ“‹ Scenario B.1: Item in Purchase, allocating to same project"),await this.handlePurchaseToInventoryMove(t,e,c,o,r,a,i)):(console.log("ðŸ“‹ Scenario B.2: Item in Purchase, allocating to different project"),await this.handlePurchaseToDifferentProjectMove(t,e,c,o,r,a,i)):c?(console.log("ðŸ“‹ Fallback: Unknown scenario, treating as new allocation"),await this.handleInventoryToPurchaseMove(t,e,o,r,a,i)):(console.log("ðŸ“‹ Scenario C: Item in inventory, allocating to project"),await this.handleInventoryToPurchaseMove(t,e,o,r,a,i))},async handleSaleToPurchaseMove(t,e,o,n,a,i,s){const r=`INV_PURCHASE_${n}`;await this.removeItemFromTransaction(t,e,o,a),await this.addItemToTransaction(t,e,r,a,"Purchase","Inventory allocation",i),await this.updateItem(t,e,{projectId:n,inventoryStatus:"allocated",transactionId:r,disposition:"keep",space:s}),console.log("âœ… A.1 completed: Sale â†’ Purchase (same project)");try{await v.logAllocationEvent(t,"allocation",e,n,r,{action:"allocation_completed",scenario:"A.1",from_transaction:o,to_transaction:r,amount:a})}catch(c){console.warn("âš ï¸ Failed to log allocation completion:",c)}return r},async handleSaleToInventoryMove(t,e,o,n,a,i,s){await this.removeItemFromTransaction(t,e,o,a),await this.updateItem(t,e,{projectId:n,inventoryStatus:"allocated",transactionId:null,disposition:"keep",space:s??""}),console.log("âœ… A.1 completed: Sale â†’ Inventory (same project)");try{await v.logAllocationEvent(t,"allocation",e,n,null,{action:"allocation_completed",scenario:"A.1",from_transaction:o,to_status:"allocated",amount:a})}catch(r){console.warn("âš ï¸ Failed to log allocation completion (A.1):",r)}return o},async handleSaleToDifferentProjectMove(t,e,o,n,a,i,s){const r=`INV_PURCHASE_${n}`;await this.removeItemFromTransaction(t,e,o,a),await this.addItemToTransaction(t,e,r,a,"Purchase","Inventory allocation",i),await this.updateItem(t,e,{projectId:n,inventoryStatus:"allocated",transactionId:r,disposition:"keep",space:s}),console.log("âœ… A.2 completed: Sale â†’ Purchase (different project)");try{await v.logAllocationEvent(t,"allocation",e,n,r,{action:"allocation_completed",scenario:"A.2",from_transaction:o,to_transaction:r,amount:a})}catch(c){console.warn("âš ï¸ Failed to log allocation completion:",c)}return r},async handlePurchaseToInventoryMove(t,e,o,n,a,i,s){await this.removeItemFromTransaction(t,e,o,a),await this.updateItem(t,e,{projectId:null,inventoryStatus:"available",disposition:"inventory",notes:i,space:s??""}),console.log("âœ… B.1 completed: Purchase â†’ Inventory (same project)");try{await v.logAllocationEvent(t,"deallocation",e,null,"inventory",{action:"deallocation_completed",scenario:"B.1",from_transaction:o,to_status:"inventory",amount:a})}catch(r){console.warn("âš ï¸ Failed to log deallocation completion:",r)}return o},async handlePurchaseToDifferentProjectMove(t,e,o,n,a,i,s){const r=`INV_SALE_${n}`;await this.removeItemFromTransaction(t,e,o,a),await this.addItemToTransaction(t,e,r,a,"To Inventory","Inventory sale",i),await this.updateItem(t,e,{projectId:null,inventoryStatus:"available",transactionId:r,disposition:"inventory",space:s??""}),console.log("âœ… B.2 completed: Purchase â†’ Sale (different project)");try{await v.logAllocationEvent(t,"allocation",e,null,r,{action:"allocation_completed",scenario:"B.2",from_transaction:o,to_transaction:r,amount:a})}catch(c){console.warn("âš ï¸ Failed to log allocation completion:",c)}return r},async handleInventoryToPurchaseMove(t,e,o,n,a,i){const s=`INV_PURCHASE_${o}`;await this.addItemToTransaction(t,e,s,n,"Purchase","Inventory allocation",a),await this.updateItem(t,e,{projectId:o,inventoryStatus:"allocated",transactionId:s,disposition:"keep",space:i}),console.log("âœ… C completed: Inventory â†’ Purchase (new allocation)");try{await v.logAllocationEvent(t,"allocation",e,o,s,{action:"allocation_completed",scenario:"C",from_status:"inventory",to_transaction:s,amount:n})}catch(r){console.warn("âš ï¸ Failed to log allocation completion:",r)}return s},async removeItemFromTransaction(t,e,o,n){await p();const{data:a,error:i}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",o).single();if(i||!a){console.warn("âš ï¸ Transaction not found for removal:",o);return}const r=(a.item_ids||[]).filter(c=>c!==e);if(r.length===0)try{const{error:c}=await m.from("transactions").delete().eq("account_id",t).eq("transaction_id",o);if(c)throw c;console.log("ðŸ—‘ï¸ Deleted empty transaction:",o);try{await v.logTransactionStateChange(t,o,"deleted",a,null)}catch(u){console.warn("âš ï¸ Failed to log transaction deletion:",u)}}catch(c){console.error("âŒ Failed to delete empty transaction:",o,c)}else try{const{data:c,error:u}=await m.from("items").select("project_price, market_value").eq("account_id",t).in("item_id",r);if(u)throw u;const d=(c||[]).map(g=>g.project_price||g.market_value||"0.00").reduce((g,h)=>g+parseFloat(h||"0"),0).toFixed(2),l=parseFloat(d)<0?"0.00":d,_={item_ids:r,amount:l,updated_at:new Date().toISOString()},{error:f}=await m.from("transactions").update(_).eq("account_id",t).eq("transaction_id",o);if(f)throw f;console.log("ðŸ”„ Updated transaction after removal:",o,"new amount:",l);try{await v.logTransactionStateChange(t,o,"updated",a,_)}catch(g){console.warn("âš ï¸ Failed to log transaction update:",g)}}catch(c){console.error("âŒ Failed to update transaction after removal:",o,c)}},async addItemToTransaction(t,e,o,n,a,i,s){await p();const{data:r,error:c}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",o).single();if(r&&!c)try{const u=r.item_ids||[],d=[...new Set([...u,e])],{data:l,error:_}=await m.from("items").select("project_price, market_value").eq("account_id",t).in("item_id",d);if(_)throw _;const f=(l||[]).map(w=>w.project_price||w.market_value||"0.00").reduce((w,b)=>w+parseFloat(b||"0"),0).toFixed(2),g=parseFloat(f)<0?"0.00":f,h={item_ids:d,amount:g,updated_at:new Date().toISOString()},{error:y}=await m.from("transactions").update(h).eq("account_id",t).eq("transaction_id",o);if(y)throw y;console.log("ðŸ”„ Added item to existing transaction:",o,"new amount:",g);try{await v.logTransactionStateChange(t,o,"updated",r,h)}catch(w){console.warn("âš ï¸ Failed to log transaction update:",w)}try{const w=r.tax_rate_pct;w!=null&&await this.updateItem(t,e,{tax_rate_pct:w})}catch(w){console.warn("Failed to set tax_rate_pct on added item:",e,w)}}catch(u){console.error("âŒ Failed to update existing transaction:",o,u)}else try{const u=await F();if(!(u!=null&&u.id))throw new Error("User must be authenticated to create transactions");const d=o.replace(a==="Purchase"?"INV_PURCHASE_":"INV_SALE_",""),l=await j.getProject(t,d),_=(l==null?void 0:l.name)||"Other",f=new Date,g={account_id:t,transaction_id:o,project_id:d,transaction_date:P(f),source:a==="Purchase"?"Inventory":_,transaction_type:a,payment_method:"Pending",amount:n,budget_category:"Furnishings",notes:s||`Transaction for items ${a==="Purchase"?"purchased from":"sold to"} ${a==="Purchase"?"inventory":"project"}`,status:"pending",reimbursement_type:a==="Purchase"?x:D,trigger_event:i,item_ids:[e],created_by:u.id,created_at:f.toISOString(),updated_at:f.toISOString()},{error:h}=await m.from("transactions").insert(g);if(h)throw h;console.log("ðŸ†• Created new transaction:",o,"amount:",n);try{await v.logTransactionStateChange(t,o,"created",null,g)}catch(y){console.warn("âš ï¸ Failed to log transaction creation:",y)}}catch(u){console.error("âŒ Failed to create new transaction:",o,u)}},async batchAllocateItemsToProject(t,e,o,n={}){await p();const{data:a,error:i}=await m.from("items").select("*").eq("account_id",t).in("item_id",e);if(i||!a||a.length===0)throw new Error("No items found for allocation");const s=`INV_PURCHASE_${o}`;for(const r of a){const c=r.item_id,u=n.amount||r.project_price||r.market_value||"0.00",d=r.transaction_id||null;if(d!=null&&d.startsWith("INV_SALE_"))if(d.replace("INV_SALE_","")===o){console.log("ðŸ“‹ Batch A.1: Item in sale for target project â€” removing from sale and assigning to project",c),await this.removeItemFromTransaction(t,c,d,u),await this.updateItem(t,c,{projectId:o,inventoryStatus:"allocated",transactionId:null,disposition:"keep",notes:n.notes,space:n.space||""});continue}else{console.log("ðŸ“‹ Batch A.2: Item in sale for different project â€” moving to purchase for target project",c),await this.removeItemFromTransaction(t,c,d,u),await this.addItemToTransaction(t,c,s,u,"Purchase","Inventory allocation",n.notes),await this.updateItem(t,c,{projectId:o,inventoryStatus:"allocated",transactionId:s,disposition:"keep",space:n.space||""});continue}if(!d){console.log("ðŸ“‹ Batch C: Item in inventory â€” adding to purchase",c),await this.addItemToTransaction(t,c,s,u,"Purchase","Inventory allocation",n.notes),await this.updateItem(t,c,{projectId:o,inventoryStatus:"allocated",transactionId:s,disposition:"keep",space:n.space||""});continue}console.log("ðŸ“‹ Batch Fallback: Item in other transaction â€” adding to purchase",c,d),await this.addItemToTransaction(t,c,s,u,"Purchase","Inventory allocation",n.notes),await this.updateItem(t,c,{projectId:o,inventoryStatus:"allocated",transactionId:s,disposition:"keep",space:n.space||""})}return s},async returnItemFromProject(t,e,o,n,a){await p();const i=await this.getItemById(t,e);if(!i)throw new Error("Item not found");const s=n||i.projectPrice||i.marketValue||"0.00",r=i.transactionId||null;console.log("ðŸ”„ Starting return process:",{itemId:e,projectId:o,currentTransactionId:r,itemProjectId:i.projectId,finalAmount:s});try{await v.logAllocationEvent(t,"return",e,i.projectId??null,r??null,{action:"return_started",target_project_id:o,current_transaction_id:r,amount:s})}catch(c){console.warn("âš ï¸ Failed to log return start:",c)}return r!=null&&r.startsWith("INV_PURCHASE_")&&r.replace("INV_PURCHASE_","")===o?(console.log("ðŸ“‹ Return Scenario: Item in Purchase, returning from same project"),await this.handleReturnFromPurchase(t,e,r,o,s,a)):(console.log("ðŸ“‹ Return Scenario: Item not in transaction or new return"),await this.handleNewReturn(t,e,o,s,a))},async handleReturnFromPurchase(t,e,o,n,a,i){await this.removeItemFromTransaction(t,e,o,a),await this.updateItem(t,e,{projectId:null,inventoryStatus:"available",transactionId:null,disposition:"inventory",notes:i}),console.log("âœ… Return completed: Purchase â†’ Inventory (same project)");try{await v.logAllocationEvent(t,"return",e,null,o,{action:"return_completed",scenario:"return_from_purchase",from_transaction:o,to_status:"inventory",amount:a})}catch(s){console.warn("âš ï¸ Failed to log return completion:",s)}return o},async handleNewReturn(t,e,o,n,a){await p();const i=await F();if(!(i!=null&&i.id))throw new Error("User must be authenticated to create transactions");let s="Other";try{const l=await j.getProject(t,o);s=(l==null?void 0:l.name)||"Other"}catch(l){console.warn("Could not fetch project name for transaction source:",l)}const r=`INV_SALE_${o}`,{data:c,error:u}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",r).single(),d=new Date;if(c&&!u){console.log("ðŸ“‹ Existing INV_SALE transaction found, updating with new item");const l=c.item_ids||[],_=[...new Set([...l,e])],{data:f,error:g}=await m.from("items").select("project_price, market_value").eq("account_id",t).in("item_id",_);if(g)throw g;const h=(f||[]).map(b=>b.project_price||b.market_value||"0.00").reduce((b,C)=>b+parseFloat(C||"0"),0).toFixed(2),y={item_ids:_,amount:h,notes:a||"Transaction for items purchased from project and moved to business inventory",updated_at:d.toISOString()},{error:w}=await m.from("transactions").update(y).eq("account_id",t).eq("transaction_id",r);if(w)throw w;console.log("ðŸ”„ Updated INV_SALE transaction with",_.length,"items, amount:",h)}else{const l={account_id:t,transaction_id:r,project_id:o,transaction_date:P(d),source:s,transaction_type:"To Inventory",payment_method:"Pending",amount:n,budget_category:"Furnishings",notes:a||"Transaction for items purchased from project and moved to business inventory",status:"pending",reimbursement_type:D,trigger_event:"Inventory sale",item_ids:[e],created_by:i.id,created_at:d.toISOString(),updated_at:d.toISOString()};console.log("ðŸ†• Creating new INV_SALE transaction with amount:",l.amount);const{error:_}=await m.from("transactions").insert(l);if(_)throw _}await this.updateItem(t,e,{projectId:null,inventoryStatus:"available",transactionId:r,disposition:"inventory"}),console.log("âœ… New return completed: Inventory â†’ Sale");try{await v.logAllocationEvent(t,"return",e,null,r,{action:"return_completed",scenario:"new_return",from_status:"inventory",to_transaction:r,amount:n})}catch(l){console.warn("âš ï¸ Failed to log return completion:",l)}return r},async completePendingTransaction(t,e,o,n){await p();const a=e==="sale"?`INV_SALE_${o}`:`INV_PURCHASE_${o}`,{data:i,error:s}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",a).single();if(s||!i)throw new Error("Transaction not found");const r=i.item_ids||[],c=new Date,{error:u}=await m.from("transactions").update({status:"completed",payment_method:n,transaction_date:P(c),updated_at:c.toISOString()}).eq("account_id",t).eq("transaction_id",a);if(u)throw u;for(const d of r)e==="sale"?await this.updateItem(t,d,{transactionId:null,inventoryStatus:"sold"}):await this.updateItem(t,d,{projectId:null,transactionId:null,inventoryStatus:"available"})},async getItemById(t,e){await p();const{data:o,error:n}=await m.from("items").select("*").eq("account_id",t).eq("item_id",e).single();if(n){if(n.code==="PGRST116")return null;throw n}return o?this._convertItemFromDb(o):null},async duplicateItem(t,e,o){await p();const n=await this.getItemById(t,o);if(!n)throw new Error("Original item not found");const a=new Date,i=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,s=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,r={account_id:t,item_id:i,description:n.description||"",source:n.source||"",sku:n.sku||"",purchase_price:n.purchasePrice||null,project_price:n.projectPrice||null,market_value:n.marketValue||null,payment_method:n.paymentMethod||"",disposition:"keep",notes:n.notes||null,space:n.space||null,qr_key:s,bookmark:!1,transaction_id:n.transactionId||null,project_id:e,inventory_status:n.inventoryStatus||"available",business_inventory_location:n.businessInventoryLocation||null,date_created:n.dateCreated||P(a),last_updated:a.toISOString(),images:n.images||[],tax_rate_pct:n.taxRatePct||null,tax_amount:n.taxAmount||null,created_by:n.createdBy||null,created_at:a.toISOString()};Object.keys(r).forEach(u=>{r[u]===void 0&&delete r[u]});const{error:c}=await m.from("items").insert(r);if(c)throw c;return i},async createTransactionItems(t,e,o,n,a,i,s){await p();const r=[],c=new Date;let u;try{if(s==null&&o){const{data:l,error:_}=await m.from("transactions").select("tax_rate_pct").eq("account_id",t).eq("transaction_id",o).single();!_&&l&&l.tax_rate_pct!==void 0&&l.tax_rate_pct!==null&&(u=l.tax_rate_pct)}}catch{}const d=[];for(const l of i){const _=`I-${Date.now()}-${Math.random().toString(36).substr(2,4)}`;r.push(_);const f=`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,g={account_id:t,item_id:_,description:l.description||"",source:a,sku:l.sku||"",purchase_price:l.purchasePrice||null,project_price:l.projectPrice||null,market_value:l.marketValue||null,payment_method:"Client Card",disposition:"keep",notes:l.notes||null,qr_key:f,bookmark:!1,transaction_id:o,project_id:e,inventory_status:"allocated",date_created:n,last_updated:c.toISOString(),images:[],created_at:c.toISOString()};s!=null?g.tax_rate_pct=s:u!==void 0&&(g.tax_rate_pct=u),d.push(g)}if(d.length>0){const{error:l}=await m.from("items").insert(d);if(l)throw l}return r}},k={async handleInventoryDesignation(t,e,o,n){if(console.log("ðŸ”„ handleInventoryDesignation called:",{itemId:e,projectId:o,disposition:n}),n!=="inventory"){console.log("â­ï¸ Skipping - disposition is not inventory:",n);return}try{console.log("ðŸ” Getting item details for:",e);const a=await T.getItemById(t,e);if(!a)throw new Error("Item not found");if(console.log("âœ… Item found:",a.itemId,"disposition:",a.disposition,"projectId:",a.projectId),a.transactionId&&a.transactionId.startsWith("INV_PURCHASE_")&&a.transactionId.replace("INV_PURCHASE_","")===o){console.log("ðŸ” Detected purchase-reversion: removing from INV_PURCHASE and returning to inventory"),await T.removeItemFromTransaction(t,a.itemId,a.transactionId,a.projectPrice||a.marketValue||"0.00"),await T.updateItem(t,a.itemId,{projectId:null,inventoryStatus:"available",transactionId:null,lastUpdated:new Date().toISOString()});try{await v.logAllocationEvent(t,"deallocation",e,null,a.transactionId,{action:"deallocation_completed",scenario:"purchase_reversion",from_transaction:a.transactionId,to_status:"inventory",amount:a.projectPrice||a.marketValue||"0.00"})}catch(r){console.warn("âš ï¸ Failed to log deallocation completion for purchase-reversion:",r)}console.log("âœ… Purchase-reversion handled: item returned to inventory without creating INV_SALE");return}console.log("ðŸ¦ Creating/updating Sale transaction for inventory designation");try{await v.logAllocationEvent(t,"deallocation",e,a.projectId??null,a.transactionId??null,{action:"deallocation_started",target_status:"inventory",current_transaction_id:a.transactionId})}catch(s){console.warn("âš ï¸ Failed to log deallocation start:",s)}const i=await this.ensureSaleTransaction(t,a,o,"Transaction for items purchased from project and moved to business inventory");console.log("ðŸ“¦ Moving item to business inventory..."),await T.updateItem(t,a.itemId,{projectId:null,inventoryStatus:"available",transactionId:i,space:"",lastUpdated:new Date().toISOString()});try{await v.logAllocationEvent(t,"deallocation",e,null,i,{action:"deallocation_completed",from_project_id:a.projectId,to_transaction:i,amount:a.projectPrice||a.marketValue||"0.00"})}catch(s){console.warn("âš ï¸ Failed to log deallocation completion:",s)}console.log("âœ… Item moved to business inventory successfully"),console.log("âœ… Deallocation completed successfully")}catch(a){throw console.error("âŒ Error handling inventory designation:",a),a}},async ensureSaleTransaction(t,e,o,n){await p();const a=await F();if(!(a!=null&&a.id))throw new Error("User must be authenticated to create transactions");console.log("ðŸ¦ Creating/updating sale transaction for item:",e.itemId);let i="Other";try{const u=await j.getProject(t,o);i=(u==null?void 0:u.name)||"Other"}catch(u){console.warn("Could not fetch project name for transaction source:",u)}if(e.transactionId&&e.transactionId.startsWith("INV_PURCHASE_")&&e.transactionId.replace("INV_PURCHASE_","")===o)return console.log("â„¹ï¸ ensureSaleTransaction detected existing INV_PURCHASE for same project; performing purchase-reversion instead of creating INV_SALE"),await T.removeItemFromTransaction(t,e.itemId,e.transactionId,e.projectPrice||e.marketValue||"0.00"),await T.updateItem(t,e.itemId,{projectId:null,inventoryStatus:"available",transactionId:null}),null;const s=`INV_SALE_${o}`;console.log("ðŸ”‘ Canonical transaction ID:",s);const{data:r,error:c}=await m.from("transactions").select("*").eq("account_id",t).eq("transaction_id",s).single();if(r&&!c){console.log("ðŸ“‹ Existing INV_SALE transaction found, updating with new item");const u=r.item_ids||[],d=[...new Set([...u,e.itemId])],{data:l,error:_}=await m.from("items").select("project_price, market_value").eq("account_id",t).in("item_id",d);if(_)throw _;const f=(l||[]).map(w=>w.project_price||w.market_value||"0.00").reduce((w,b)=>w+parseFloat(b||"0"),0).toFixed(2),h={item_ids:d,amount:f,notes:n||"Transaction for items purchased from project and moved to business inventory",updated_at:new Date().toISOString()},{error:y}=await m.from("transactions").update(h).eq("account_id",t).eq("transaction_id",s);if(y)throw y;console.log("ðŸ”„ Updated INV_SALE transaction with",d.length,"items, amount:",f)}else{const u=e.projectPrice||e.marketValue||"0.00",d=new Date,l={account_id:t,transaction_id:s,project_id:o,transaction_date:P(d),source:i,transaction_type:"To Inventory",payment_method:"Pending",amount:parseFloat(u).toFixed(2),budget_category:"Furnishings",notes:n||"Transaction for items purchased from project and moved to business inventory",status:"pending",reimbursement_type:D,trigger_event:"Inventory sale",item_ids:[e.itemId],created_by:a.id,created_at:d.toISOString(),updated_at:d.toISOString()};console.log("ðŸ†• Creating new INV_SALE transaction with amount:",l.amount);const{error:_}=await m.from("transactions").insert(l);if(_)throw _}return console.log("âœ… Sale transaction created/updated successfully"),s}},$={async allocateBusinessInventoryToProject(t,e,o,n,a){return await T.allocateItemToProject(t,e,o,n,a)},async returnItemToBusinessInventory(t,e,o,n){await T.returnItemFromProject(t,e,n)},async completePendingTransaction(t,e,o,n,a){return await T.completePendingTransaction(t,"sale",n,a)},async handleItemDeallocation(t,e,o,n){return await k.handleInventoryDesignation(t,e,o,n)}},M=Object.freeze(Object.defineProperty({__proto__:null,auditService:v,deallocationService:k,integrationService:$,projectService:j,transactionService:R,unifiedItemsService:T},Symbol.toStringTag,{value:"Module"}));export{U as a,P as b,M as c,B as f,$ as i,j as p,R as t,T as u};
//# sourceMappingURL=inventoryService.js.map
