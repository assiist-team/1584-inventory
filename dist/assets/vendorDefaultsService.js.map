{"version":3,"file":"vendorDefaultsService.js","sources":["../../src/constants/transactionSources.ts","../../src/services/vendorDefaultsService.ts"],"sourcesContent":["/**\n * Predefined transaction sources for Add/Edit forms\n * These match the sources shown in the UI design\n */\nexport const TRANSACTION_SOURCES = [\n  'Homegoods',\n  'Amazon',\n  'Wayfair',\n  'Target',\n  'Ross',\n  'Arhaus',\n  'Pottery Barn',\n  'Crate & Barrel',\n  'West Elm',\n  'Living Spaces',\n  'Home Depot',\n  'Lowes',\n  'Movers',\n  'Gas',\n  'Inventory'\n] as const\n\nexport type TransactionSource = typeof TRANSACTION_SOURCES[number]\n","import { TRANSACTION_SOURCES } from '@/constants/transactionSources'\nimport { getAccountPresets, upsertAccountPresets } from './accountPresetsService'\n\nexport interface VendorSlot {\n  id: string | null\n  name: string | null\n}\n\nexport interface VendorDefaultsResponse {\n  slots: VendorSlot[]\n}\n\n/**\n * Get vendor defaults from Postgres for an account\n * Returns exactly 10 slots (may contain null values)\n */\nexport async function getVendorDefaults(accountId: string): Promise<VendorDefaultsResponse> {\n  try {\n    // Read canonical vendor_defaults from account_presets\n    const ap = await getAccountPresets(accountId)\n    const migrated: any[] | undefined = ap?.presets?.vendor_defaults\n    if (Array.isArray(migrated)) {\n      const rawSlots: any[] = migrated.slice()\n      while (rawSlots.length < 10) rawSlots.push(null)\n      const truncated = rawSlots.slice(0, 10)\n      const slots: VendorSlot[] = truncated.map(slot => {\n        if (typeof slot === 'string') return { id: slot, name: slot }\n        return { id: null, name: null }\n      })\n      return { slots }\n    }\n\n    // Initialize vendor defaults from TRANSACTION_SOURCES if missing\n    const initialStoredSlots: Array<string | null> = TRANSACTION_SOURCES.slice(0, 10).map(name => name)\n    while (initialStoredSlots.length < 10) initialStoredSlots.push(null)\n    try {\n      await upsertAccountPresets(accountId, { presets: { vendor_defaults: initialStoredSlots } })\n    } catch (err) {\n      console.warn('Failed to initialize vendor_defaults in account_presets:', err)\n    }\n    const initialSlots = initialStoredSlots.map(s => (s ? { id: s, name: s } : { id: null, name: null }))\n    return { slots: initialSlots }\n  } catch (error) {\n    console.error('Error fetching vendor defaults from Postgres:', error)\n    // Fallback to first 10 from TRANSACTION_SOURCES\n    const fallbackStored: Array<string | null> = TRANSACTION_SOURCES.slice(0, 10).map(name => name)\n    while (fallbackStored.length < 10) {\n      fallbackStored.push(null)\n    }\n    const fallbackSlots = fallbackStored.map(s => (s ? { id: s, name: s } : { id: null, name: null }))\n    return { slots: fallbackSlots }\n  }\n}\n\n/**\n * Update a single vendor slot (index 1-10)\n * @param accountId Account ID\n * @param slotIndex Slot index (1-10)\n * @param vendorId Vendor name/id or null to clear\n */\nexport async function updateVendorSlot(\n  accountId: string,\n  slotIndex: number,\n  vendorId: string | null,\n  updatedBy?: string\n): Promise<void> {\n  if (slotIndex < 1 || slotIndex > 10) {\n    throw new Error('Slot index must be between 1 and 10')\n  }\n\n  try {\n    // Get current slots (normalized)\n    const current = await getVendorDefaults(accountId)\n    // Convert to stored-format array (string | null)\n    const storedSlots: Array<string | null> = current.slots.map(s => (s.id ? s.id : null))\n\n    // Update the specific slot (1-based -> 0-based)\n    storedSlots[slotIndex - 1] = vendorId ? vendorId : null\n\n    // Update all slots in stored-format\n    await updateVendorDefaults(accountId, storedSlots, updatedBy)\n  } catch (error) {\n    console.error('Error updating vendor slot:', error)\n    throw error\n  }\n}\n\n/**\n * Update all vendor defaults in Postgres for an account\n * @param accountId Account ID\n * @param slots Array of exactly 10 vendor slots\n * @param updatedBy Optional user ID who made the update\n */\nexport async function updateVendorDefaults(\n  accountId: string,\n  slots: Array<string | null>,\n  updatedBy?: string\n): Promise<void> {\n  try {\n    // Validate slots\n    if (!Array.isArray(slots)) {\n      throw new Error('Slots must be an array')\n    }\n\n    if (slots.length !== 10) {\n      throw new Error('Must have exactly 10 slots')\n    }\n\n    // Normalize slots to stored-format: plain strings or null\n    const storedSlots: Array<string | null> = slots.map(slot => {\n      if (typeof slot === 'string') {\n        return slot\n      }\n      if (slot === null) {\n        return null\n      }\n      // Reject any non-string/non-null input to enforce no backwards compatibility\n      throw new Error('Slots must be plain strings or null (legacy object formats are not supported)')\n    })\n    // Persist exclusively to canonical account_presets\n    await upsertAccountPresets(accountId, { presets: { vendor_defaults: storedSlots } })\n    console.log('Vendor defaults updated successfully (account_presets)')\n  } catch (error) {\n    console.error('Error updating vendor defaults:', error)\n    throw error\n  }\n}\n\n/**\n * Get list of available vendors (non-null slots) for transaction forms\n * This filters out empty slots and returns only configured vendors\n */\nexport async function getAvailableVendors(accountId: string): Promise<string[]> {\n  const defaults = await getVendorDefaults(accountId)\n  return defaults.slots\n    .filter(slot => slot.id && slot.name)\n    .map(slot => slot.name!)\n}\n\n"],"names":["TRANSACTION_SOURCES","getVendorDefaults","accountId","ap","getAccountPresets","migrated","_a","rawSlots","slot","initialStoredSlots","name","upsertAccountPresets","err","s","error","fallbackStored","updateVendorSlot","slotIndex","vendorId","updatedBy","storedSlots","updateVendorDefaults","slots","getAvailableVendors"],"mappings":"kDAIO,MAAMA,EAAsB,CACjC,YACA,SACA,UACA,SACA,OACA,SACA,eACA,iBACA,WACA,gBACA,aACA,QACA,SACA,MACA,WACF,ECJA,eAAsBC,EAAkBC,EAAoD,OAC1F,GAAI,CAEF,MAAMC,EAAK,MAAMC,EAAkBF,CAAS,EACtCG,GAA8BC,EAAAH,GAAA,YAAAA,EAAI,UAAJ,YAAAG,EAAa,gBACjD,GAAI,MAAM,QAAQD,CAAQ,EAAG,CAC3B,MAAME,EAAkBF,EAAS,MAAA,EACjC,KAAOE,EAAS,OAAS,IAAIA,EAAS,KAAK,IAAI,EAM/C,MAAO,CAAE,MALSA,EAAS,MAAM,EAAG,EAAE,EACA,IAAIC,GACpC,OAAOA,GAAS,SAAiB,CAAE,GAAIA,EAAM,KAAMA,CAAA,EAChD,CAAE,GAAI,KAAM,KAAM,IAAA,CAC1B,CACQ,CACX,CAGA,MAAMC,EAA2CT,EAAoB,MAAM,EAAG,EAAE,EAAE,OAAYU,CAAI,EAClG,KAAOD,EAAmB,OAAS,IAAIA,EAAmB,KAAK,IAAI,EACnE,GAAI,CACF,MAAME,EAAqBT,EAAW,CAAE,QAAS,CAAE,gBAAiBO,CAAA,EAAsB,CAC5F,OAASG,EAAK,CACZ,QAAQ,KAAK,2DAA4DA,CAAG,CAC9E,CAEA,MAAO,CAAE,MADYH,EAAmB,IAAII,GAAMA,EAAI,CAAE,GAAIA,EAAG,KAAMA,CAAA,EAAM,CAAE,GAAI,KAAM,KAAM,KAAO,CACpF,CAClB,OAASC,EAAO,CACd,QAAQ,MAAM,gDAAiDA,CAAK,EAEpE,MAAMC,EAAuCf,EAAoB,MAAM,EAAG,EAAE,EAAE,OAAYU,CAAI,EAC9F,KAAOK,EAAe,OAAS,IAC7BA,EAAe,KAAK,IAAI,EAG1B,MAAO,CAAE,MADaA,EAAe,IAAI,GAAM,EAAI,CAAE,GAAI,EAAG,KAAM,CAAA,EAAM,CAAE,GAAI,KAAM,KAAM,KAAO,CACjF,CAClB,CACF,CAQA,eAAsBC,EACpBd,EACAe,EACAC,EACAC,EACe,CACf,GAAIF,EAAY,GAAKA,EAAY,GAC/B,MAAM,IAAI,MAAM,qCAAqC,EAGvD,GAAI,CAIF,MAAMG,GAFU,MAAMnB,EAAkBC,CAAS,GAEC,MAAM,OAAUW,EAAE,GAAKA,EAAE,GAAK,IAAK,EAGrFO,EAAYH,EAAY,CAAC,EAAIC,GAAsB,KAGnD,MAAMG,EAAqBnB,EAAWkB,EAAaD,CAAS,CAC9D,OAASL,EAAO,CACd,cAAQ,MAAM,8BAA+BA,CAAK,EAC5CA,CACR,CACF,CAQA,eAAsBO,EACpBnB,EACAoB,EACAH,EACe,CACf,GAAI,CAEF,GAAI,CAAC,MAAM,QAAQG,CAAK,EACtB,MAAM,IAAI,MAAM,wBAAwB,EAG1C,GAAIA,EAAM,SAAW,GACnB,MAAM,IAAI,MAAM,4BAA4B,EAI9C,MAAMF,EAAoCE,EAAM,IAAId,GAAQ,CAC1D,GAAI,OAAOA,GAAS,SAClB,OAAOA,EAET,GAAIA,IAAS,KACX,OAAO,KAGT,MAAM,IAAI,MAAM,+EAA+E,CACjG,CAAC,EAED,MAAMG,EAAqBT,EAAW,CAAE,QAAS,CAAE,gBAAiBkB,CAAA,EAAe,EACnF,QAAQ,IAAI,wDAAwD,CACtE,OAASN,EAAO,CACd,cAAQ,MAAM,kCAAmCA,CAAK,EAChDA,CACR,CACF,CAMA,eAAsBS,EAAoBrB,EAAsC,CAE9E,OADiB,MAAMD,EAAkBC,CAAS,GAClC,MACb,OAAOM,GAAQA,EAAK,IAAMA,EAAK,IAAI,EACnC,IAAIA,GAAQA,EAAK,IAAK,CAC3B"}