import{j as e,a as M}from"./index.js";import{r as o,b as T}from"./vendor.js";import{I as E}from"./imageService.js";import{U as R,t as B,A as G,n as O,E as z,T as L,b as _,o as q,e as K,P as V}from"./ui.js";import{I as W}from"./ImagePreview.js";function ee({onImagesChange:a,maxImages:v=5,acceptedTypes:w=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],maxFileSize:k=10,disabled:p=!1,className:g=""}){const[d,y]=o.useState([]),[b,j]=o.useState(!1),[N,I]=o.useState(null),P=o.useRef(null),i=o.useRef(null),D=o.useRef(null),r=o.useCallback(s=>{if(!w.includes(s.type))return`Invalid file type. Please upload: ${w.join(", ")}`;const l=k*1024*1024;return s.size>l?`File too large. Maximum size: ${k}MB`:null},[w,k]),m=o.useCallback(s=>{const l=Array.from(s),c=[],u=[];if(l.forEach(h=>{const U=r(h);U?u.push({file:h,previewUrl:"",error:U}):(c.push(h),u.push({file:h,previewUrl:E.createPreviewUrl(h)}))}),c.length+d.length>v){const h=v-d.length;h>0?(c.splice(h),u.splice(h)):(c.length=0,u.length=0),u.push({file:new File([],""),previewUrl:"",error:`Maximum ${v} images allowed. Additional images were skipped.`})}y(h=>[...h,...u]),a(c)},[d.length,v,r,a]),f=o.useCallback(s=>{const l=d[s];l.previewUrl&&E.revokePreviewUrl(l.previewUrl),y(u=>u.filter((h,U)=>U!==s));const c=d.filter((u,h)=>h!==s).filter(u=>!u.error).map(u=>u.file);a(c)},[d,a]),C=s=>{const l=s.target.files;l&&l.length>0&&m(l)},$=async()=>{try{const s=await E.selectFromGallery();s.length>0&&m(s)}catch(s){console.error("Error selecting from gallery:",s)}},A=o.useCallback(s=>{s.preventDefault(),s.stopPropagation(),p||j(!0)},[p]),S=o.useCallback(s=>{s.preventDefault(),s.stopPropagation(),j(!1)},[]),t=o.useCallback(s=>{if(s.preventDefault(),s.stopPropagation(),j(!1),p)return;const l=s.dataTransfer.files;l&&l.length>0&&m(l)},[p,m]),x=s=>{if(s===0)return"0 Bytes";const l=1024,c=["Bytes","KB","MB","GB"],u=Math.floor(Math.log(s)/Math.log(l));return(s/Math.pow(l,u)).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})+" "+c[u]},n=(s,l)=>{s.stopPropagation(),I(N===l?null:l)},F=(s,l,c)=>{switch(s.stopPropagation(),I(null),l){case"preview":window.open(d[c].previewUrl,"_blank");break;case"delete":f(c);break}};return T.useEffect(()=>{const s=l=>{N!==null&&!l.target.closest(".image-menu-container")&&I(null)};return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[N]),e.jsxs("div",{className:`space-y-4 ${g}`,children:[e.jsxs("div",{className:`relative border-2 border-dashed rounded-lg p-6 sm:p-8 text-center transition-colors touch-manipulation ${b?"border-primary-500 bg-primary-50":"border-gray-300 hover:border-gray-400"} ${p?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,onDragOver:A,onDragLeave:S,onDrop:t,onClick:()=>{var s;return!p&&((s=P.current)==null?void 0:s.click())},children:[e.jsx("input",{ref:P,type:"file",multiple:!0,accept:w.join(","),onChange:C,disabled:p,className:"hidden"}),e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx("div",{className:`p-3 rounded-full ${b?"bg-primary-100":"bg-gray-100"}`,children:e.jsx(R,{className:`h-6 w-6 ${b?"text-primary-600":"text-gray-600"}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Drop images here, or click to browse"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Supports: JPEG, PNG, GIF, WebP (max ",k,"MB each, up to ",v," images)"]})]}),e.jsxs("button",{type:"button",onClick:s=>{s.stopPropagation(),$()},disabled:p,className:"inline-flex items-center justify-center px-4 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 mt-3 touch-manipulation",title:"Add images from gallery or camera",children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Add Images"]})]})]}),e.jsx("input",{ref:i,type:"file",accept:"image/*",capture:"environment",onChange:C,className:"hidden"}),e.jsx("input",{ref:D,type:"file",accept:"image/*",multiple:!0,onChange:C,className:"hidden"}),d.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"Transaction Images"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:d.map((s,l)=>e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"aspect-w-4 aspect-h-3 rounded-lg overflow-visible bg-gray-100",children:s.error?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx(G,{className:"h-8 w-8 text-red-500 mx-auto mb-2"}),e.jsx("p",{className:"text-xs text-red-600",children:s.error})]})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.previewUrl,alt:s.file.name,className:"w-full h-full object-cover"}),s.isUploading&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-white text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white mx-auto mb-2"}),e.jsx("p",{className:"text-xs",children:s.uploadProgress?`${Math.round(s.uploadProgress)}%`:"Uploading..."})]})}),e.jsxs("div",{className:"absolute top-1 right-1 image-menu-container",children:[e.jsx("button",{type:"button",onClick:c=>n(c,l),className:"p-1.5 bg-primary-500 text-white rounded-full opacity-90 hover:opacity-100 transition-opacity",children:e.jsx(O,{className:"h-3 w-3"})}),N===l&&e.jsxs("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 mt-1 w-28 bg-white rounded-md shadow-lg border border-gray-200 py-1 z-50",children:[e.jsxs("button",{onClick:c=>F(c,"preview",l),className:"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center transition-colors",children:[e.jsx(z,{className:"h-4 w-4 mr-2 text-gray-500"}),"Open"]}),e.jsxs("button",{onClick:c=>F(c,"delete",l),className:"w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center transition-colors",children:[e.jsx(L,{className:"h-4 w-4 mr-2 text-red-500"}),"Delete"]})]})]})]})}),e.jsxs("div",{className:"mt-1",children:[e.jsx("p",{className:"text-xs text-gray-500 truncate",title:s.file.name,children:s.file.name}),e.jsx("p",{className:"text-xs text-gray-400",children:x(s.file.size)})]})]},l))})]})]})}function J({item:a,onSave:v,onCancel:w,isEditing:k=!1,onImageFilesChange:p}){const[g,d]=o.useState(a||{id:`temp_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,description:"",sku:"",price:"",market_value:"",notes:""}),[y,b]=o.useState((a==null?void 0:a.images)||[]),[j,N]=o.useState((a==null?void 0:a.imageFiles)||[]),[I,P]=o.useState(!1),[i,D]=o.useState({}),{showError:r}=M();o.useEffect(()=>{var t,x;a&&(console.log("TransactionItemForm: Editing item with images:",((t=a.images)==null?void 0:t.length)||0,"imageFiles:",((x=a.imageFiles)==null?void 0:x.length)||0),b(a.images||[]),N(a.imageFiles||[]),d({id:a.id,description:a.description,sku:a.sku||"",price:a.price,market_value:a.market_value||"",notes:a.notes||""}))},[a]);const m=async()=>{var t,x;try{P(!0);const n=await E.selectFromGallery();if(n&&n.length>0){console.log("Selected",n.length,"files from gallery"),N(s=>[...s,...n]);const F=n.map((s,l)=>({url:"",alt:s.name,isPrimary:y.length===0&&l===0,uploadedAt:new Date,fileName:s.name,size:s.size,mimeType:s.type}));b(s=>[...s,...F]),console.log("Added",F.length,"preview images")}else console.log("No files selected from gallery")}catch(n){if(console.error("Error selecting from gallery:",n),(t=n.message)!=null&&t.includes("timeout")||(x=n.message)!=null&&x.includes("canceled")){console.log("User canceled image selection or selection timed out");return}r("Failed to select images from gallery. Please try again.")}finally{P(!1)}},f=t=>{const x=y.findIndex(n=>n.url===t);x!==-1&&x<j.length&&(b(n=>n.filter(F=>F.url!==t)),N(n=>n.filter((F,s)=>s!==x)))},C=t=>{b(x=>x.map(n=>({...n,isPrimary:n.url===t})))},$=()=>{const t={};return g.description.trim()||(t.description="Description is required"),g.price.trim()?(isNaN(Number(g.price))||Number(g.price)<=0)&&(t.price="Price must be a positive number"):t.price="Price is required",D(t),Object.keys(t).length===0},A=()=>{if(!$())return;const t={...g,images:y,imageFiles:j};p&&j.length>0&&p(g.id,j),v(t)},S=(t,x)=>{d(n=>({...n,[t]:x})),i[t]&&D(n=>({...n,[t]:void 0}))};return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:k?"Edit Item":"Add Item"}),e.jsx("button",{onClick:w,className:"text-gray-400 hover:text-gray-600",type:"button",children:e.jsx(_,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description *"}),e.jsx("input",{type:"text",id:"description",value:g.description,onChange:t=>S("description",t.target.value),placeholder:"Item description",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.description?"border-red-300":"border-gray-300"}`}),i.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.description})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sku",className:"block text-sm font-medium text-gray-700",children:"SKU"}),e.jsx("input",{type:"text",id:"sku",value:g.sku,onChange:t=>S("sku",t.target.value),placeholder:"Stock keeping unit",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.sku?"border-red-300":"border-gray-300"}`}),i.sku&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.sku})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"price",className:"block text-sm font-medium text-gray-700",children:"Price *"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"price",value:g.price,onChange:t=>S("price",t.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.price?"border-red-300":"border-gray-300"}`})]}),i.price&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.price})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"market_value",className:"block text-sm font-medium text-gray-700",children:"Market Value"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"market_value",value:g.market_value,onChange:t=>S("market_value",t.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.market_value?"border-red-300":"border-gray-300"}`})]}),i.market_value&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.market_value})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:2,value:g.notes,onChange:t=>S("notes",t.target.value),placeholder:"Additional notes about this item",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${i.notes?"border-red-300":"border-gray-300"}`}),i.notes&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:i.notes})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Item Images"}),e.jsxs("button",{type:"button",onClick:m,disabled:I,className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 mb-3",title:"Add images from gallery or camera",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),I?"Uploading...":"Add Images"]}),e.jsx(W,{images:y,onRemoveImage:f,onSetPrimary:C,maxImages:3,size:"md"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),w()},className:"px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:"Cancel"}),e.jsx("button",{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),A()},className:"px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:k?"Update Item":"Add Item"})]})]})]})}function se({items:a,onItemsChange:v,projectId:w,projectName:k,onImageFilesChange:p}){const[g,d]=o.useState(!1),[y,b]=o.useState(null),j=r=>{if(y){const m=a.map(f=>f.id===y?r:f);v(m)}else v([...a,r]);r.imageFiles&&r.imageFiles.length>0&&p&&p(r.id,r.imageFiles),d(!1),b(null)},N=()=>{d(!1),b(null)},I=r=>{b(r),d(!1)},P=r=>{const m=a.filter(f=>f.id!==r);v(m)},i=()=>y&&a.find(r=>r.id===y)||null,D=r=>{const m=parseFloat(r);return isNaN(m)?"$0.00":`$${m.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`};if(g||y){const r=i();return e.jsx(J,{item:r||void 0,onSave:j,onCancel:N,isEditing:!!r,projectId:w,projectName:k,onImageFilesChange:p})}return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Transaction Items"})}),e.jsxs("div",{className:"space-y-3",children:[a.map((r,m)=>e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-4 mb-2",children:[e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800",children:["Item ",m+1]}),e.jsx("span",{className:"text-sm text-gray-500",children:D(r.price)})]}),e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-1",children:r.description||"No description"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600",children:[r.sku&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"SKU:"})," ",r.sku]}),r.market_value&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Market Value:"})," $",r.market_value]})]}),r.notes&&e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Notes:"})," ",r.notes]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[e.jsx("button",{onClick:f=>{f.preventDefault(),f.stopPropagation(),I(r.id)},className:"text-primary-600 hover:text-primary-900 p-1",title:"Edit item",children:e.jsx(K,{className:"h-4 w-4"})}),e.jsx("button",{onClick:f=>{f.preventDefault(),f.stopPropagation(),P(r.id)},className:"text-red-600 hover:text-red-900 p-1",title:"Delete item",children:e.jsx(_,{className:"h-4 w-4"})})]})]})},r.id)),e.jsx("div",{className:"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg",children:e.jsxs("button",{onClick:()=>d(!0),className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Add new item",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Add Item"]})}),a.length>0&&e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Total Items: ",a.length]}),e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:["Total: ",D(a.reduce((r,m)=>r+(parseFloat(m.price)||0),0).toString())]})]})]})]})}export{ee as I,se as T};
//# sourceMappingURL=TransactionItemsList.js.map
