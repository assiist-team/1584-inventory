import{j as e,a as $}from"./index.js";import{r as c}from"./vendor.js";import{I as P}from"./imageService.js";import{U as A,r as E,A as _,b as U,k as M,e as T,P as R}from"./ui.js";import{I as B}from"./ImagePreview.js";function V({onImagesChange:a,maxImages:h=5,acceptedTypes:v=["image/jpeg","image/jpg","image/png","image/gif","image/webp"],maxFileSize:j=10,disabled:u=!1,className:p=""}){const[d,x]=c.useState([]),[f,y]=c.useState(!1),N=c.useRef(null),k=c.useRef(null),I=c.useRef(null),o=c.useCallback(s=>{if(!v.includes(s.type))return`Invalid file type. Please upload: ${v.join(", ")}`;const r=j*1024*1024;return s.size>r?`File too large. Maximum size: ${j}MB`:null},[v,j]),b=c.useCallback(s=>{const r=Array.from(s),l=[],n=[];if(r.forEach(i=>{const F=o(i);F?n.push({file:i,previewUrl:"",error:F}):(l.push(i),n.push({file:i,previewUrl:P.createPreviewUrl(i)}))}),l.length+d.length>h){const i=h-d.length;i>0?(l.splice(i),n.splice(i)):(l.length=0,n.length=0),n.push({file:new File([],""),previewUrl:"",error:`Maximum ${h} images allowed. Additional images were skipped.`})}x(i=>[...i,...n]),a(l)},[d.length,h,o,a]),t=c.useCallback(s=>{const r=d[s];r.previewUrl&&P.revokePreviewUrl(r.previewUrl),x(n=>n.filter((i,F)=>F!==s));const l=d.filter((n,i)=>i!==s).filter(n=>!n.error).map(n=>n.file);a(l)},[d,a]),m=s=>{const r=s.target.files;r&&r.length>0&&b(r)},g=async()=>{try{const s=await P.selectFromGallery();s.length>0&&b(s)}catch(s){console.error("Error selecting from gallery:",s)}},S=c.useCallback(s=>{s.preventDefault(),s.stopPropagation(),u||y(!0)},[u]),D=c.useCallback(s=>{s.preventDefault(),s.stopPropagation(),y(!1)},[]),C=c.useCallback(s=>{if(s.preventDefault(),s.stopPropagation(),y(!1),u)return;const r=s.dataTransfer.files;r&&r.length>0&&b(r)},[u,b]),w=s=>{if(s===0)return"0 Bytes";const r=1024,l=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(s)/Math.log(r));return(s/Math.pow(r,n)).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})+" "+l[n]};return e.jsxs("div",{className:`space-y-4 ${p}`,children:[e.jsxs("div",{className:`relative border-2 border-dashed rounded-lg p-6 sm:p-8 text-center transition-colors touch-manipulation ${f?"border-primary-500 bg-primary-50":"border-gray-300 hover:border-gray-400"} ${u?"opacity-50 cursor-not-allowed":"cursor-pointer"}`,onDragOver:S,onDragLeave:D,onDrop:C,onClick:()=>{var s;return!u&&((s=N.current)==null?void 0:s.click())},children:[e.jsx("input",{ref:N,type:"file",multiple:!0,accept:v.join(","),onChange:m,disabled:u,className:"hidden"}),e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx("div",{className:`p-3 rounded-full ${f?"bg-primary-100":"bg-gray-100"}`,children:e.jsx(A,{className:`h-6 w-6 ${f?"text-primary-600":"text-gray-600"}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Drop images here, or click to browse"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Supports: JPEG, PNG, GIF, WebP (max ",j,"MB each, up to ",h," images)"]})]}),e.jsxs("button",{type:"button",onClick:s=>{s.stopPropagation(),g()},disabled:u,className:"inline-flex items-center justify-center px-4 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 mt-3 touch-manipulation",title:"Add images from gallery or camera",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Add Images"]})]})]}),e.jsx("input",{ref:k,type:"file",accept:"image/*",capture:"environment",onChange:m,className:"hidden"}),e.jsx("input",{ref:I,type:"file",accept:"image/*",multiple:!0,onChange:m,className:"hidden"}),d.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:"Transaction Images"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:d.map((s,r)=>e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"aspect-w-4 aspect-h-3 rounded-lg overflow-hidden bg-gray-100",children:s.error?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx(_,{className:"h-8 w-8 text-red-500 mx-auto mb-2"}),e.jsx("p",{className:"text-xs text-red-600",children:s.error})]})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.previewUrl,alt:s.file.name,className:"w-full h-full object-cover"}),s.isUploading&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-white text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-white mx-auto mb-2"}),e.jsx("p",{className:"text-xs",children:s.uploadProgress?`${Math.round(s.uploadProgress)}%`:"Uploading..."})]})}),e.jsx("button",{type:"button",onClick:()=>t(r),className:"absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",children:e.jsx(U,{className:"h-3 w-3"})})]})}),e.jsxs("div",{className:"mt-1",children:[e.jsx("p",{className:"text-xs text-gray-500 truncate",title:s.file.name,children:s.file.name}),e.jsx("p",{className:"text-xs text-gray-400",children:w(s.file.size)})]})]},r))})]})]})}function G({item:a,onSave:h,onCancel:v,isEditing:j=!1,onImageFilesChange:u}){const[p,d]=c.useState(a||{id:`temp_${Date.now()}_${Math.random().toString(36).substr(2,6)}`,description:"",sku:"",price:"",market_value:"",notes:""}),[x,f]=c.useState((a==null?void 0:a.images)||[]),[y,N]=c.useState((a==null?void 0:a.imageFiles)||[]),[k,I]=c.useState(!1),[o,b]=c.useState({}),{showError:t}=$();c.useEffect(()=>{var s,r;a&&(console.log("TransactionItemForm: Editing item with images:",((s=a.images)==null?void 0:s.length)||0,"imageFiles:",((r=a.imageFiles)==null?void 0:r.length)||0),f(a.images||[]),N(a.imageFiles||[]),d({id:a.id,description:a.description,sku:a.sku||"",price:a.price,market_value:a.market_value||"",notes:a.notes||""}))},[a]);const m=async()=>{var s,r;try{I(!0);const l=await P.selectFromGallery();if(l&&l.length>0){console.log("Selected",l.length,"files from gallery"),N(i=>[...i,...l]);const n=l.map((i,F)=>({url:"",alt:i.name,isPrimary:x.length===0&&F===0,uploadedAt:new Date,fileName:i.name,size:i.size,mimeType:i.type}));f(i=>[...i,...n]),console.log("Added",n.length,"preview images")}else console.log("No files selected from gallery")}catch(l){if(console.error("Error selecting from gallery:",l),(s=l.message)!=null&&s.includes("timeout")||(r=l.message)!=null&&r.includes("canceled")){console.log("User canceled image selection or selection timed out");return}t("Failed to select images from gallery. Please try again.")}finally{I(!1)}},g=s=>{const r=x.findIndex(l=>l.url===s);r!==-1&&r<y.length&&(f(l=>l.filter(n=>n.url!==s)),N(l=>l.filter((n,i)=>i!==r)))},S=s=>{f(r=>r.map(l=>({...l,isPrimary:l.url===s})))},D=()=>{const s={};return p.description.trim()||(s.description="Description is required"),p.price.trim()?(isNaN(Number(p.price))||Number(p.price)<=0)&&(s.price="Price must be a positive number"):s.price="Price is required",b(s),Object.keys(s).length===0},C=()=>{if(!D())return;const s={...p,images:x,imageFiles:y};u&&y.length>0&&u(p.id,y),h(s)},w=(s,r)=>{d(l=>({...l,[s]:r})),o[s]&&b(l=>({...l,[s]:void 0}))};return e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:j?"Edit Item":"Add Item"}),e.jsx("button",{onClick:v,className:"text-gray-400 hover:text-gray-600",type:"button",children:e.jsx(U,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description *"}),e.jsx("input",{type:"text",id:"description",value:p.description,onChange:s=>w("description",s.target.value),placeholder:"Item description",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.description?"border-red-300":"border-gray-300"}`}),o.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.description})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sku",className:"block text-sm font-medium text-gray-700",children:"SKU"}),e.jsx("input",{type:"text",id:"sku",value:p.sku,onChange:s=>w("sku",s.target.value),placeholder:"Stock keeping unit",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.sku?"border-red-300":"border-gray-300"}`}),o.sku&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.sku})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"price",className:"block text-sm font-medium text-gray-700",children:"Price *"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"price",value:p.price,onChange:s=>w("price",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.price?"border-red-300":"border-gray-300"}`})]}),o.price&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.price})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"market_value",className:"block text-sm font-medium text-gray-700",children:"Market Value"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"market_value",value:p.market_value,onChange:s=>w("market_value",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.market_value?"border-red-300":"border-gray-300"}`})]}),o.market_value&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.market_value})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:2,value:p.notes,onChange:s=>w("notes",s.target.value),placeholder:"Additional notes about this item",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.notes?"border-red-300":"border-gray-300"}`}),o.notes&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.notes})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Item Images"}),e.jsxs("button",{type:"button",onClick:m,disabled:k,className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 mb-3",title:"Add images from gallery or camera",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),k?"Uploading...":"Add Images"]}),e.jsx(B,{images:x,onRemoveImage:g,onSetPrimary:S,maxImages:3,size:"md"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),v()},className:"px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:"Cancel"}),e.jsx("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),C()},className:"px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:j?"Update Item":"Add Item"})]})]})]})}function W({items:a,onItemsChange:h,projectId:v,projectName:j,onImageFilesChange:u}){const[p,d]=c.useState(!1),[x,f]=c.useState(null),y=t=>{if(x){const m=a.map(g=>g.id===x?t:g);h(m)}else h([...a,t]);t.imageFiles&&t.imageFiles.length>0&&u&&u(t.id,t.imageFiles),d(!1),f(null)},N=()=>{d(!1),f(null)},k=t=>{f(t),d(!1)},I=t=>{const m=a.filter(g=>g.id!==t);h(m)},o=()=>x&&a.find(t=>t.id===x)||null,b=t=>{const m=parseFloat(t);return isNaN(m)?"$0.00":`$${m.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`};if(p||x){const t=o();return e.jsx(G,{item:t||void 0,onSave:y,onCancel:N,isEditing:!!t,projectId:v,projectName:j,onImageFilesChange:u})}return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Transaction Items"})}),e.jsxs("div",{className:"space-y-3",children:[a.map((t,m)=>e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-4 mb-2",children:[e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800",children:["Item ",m+1]}),e.jsx("span",{className:"text-sm text-gray-500",children:b(t.price)})]}),e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-1",children:t.description||"No description"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600",children:[t.sku&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"SKU:"})," ",t.sku]}),t.market_value&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Market Value:"})," $",t.market_value]})]}),t.notes&&e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Notes:"})," ",t.notes]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[e.jsx("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),k(t.id)},className:"text-primary-600 hover:text-primary-900 p-1",title:"Edit item",children:e.jsx(T,{className:"h-4 w-4"})}),e.jsx("button",{onClick:g=>{g.preventDefault(),g.stopPropagation(),I(t.id)},className:"text-red-600 hover:text-red-900 p-1",title:"Delete item",children:e.jsx(U,{className:"h-4 w-4"})})]})]})},t.id)),e.jsx("div",{className:"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg",children:e.jsxs("button",{onClick:()=>d(!0),className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Add new item",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Add Item"]})}),a.length>0&&e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Total Items: ",a.length]}),e.jsxs("div",{className:"text-lg font-semibold text-gray-900",children:["Total: ",b(a.reduce((t,m)=>t+(parseFloat(m.price)||0),0).toString())]})]})]})]})}export{V as I,W as T};
//# sourceMappingURL=TransactionItemsList.js.map
