import{a as F,j as e}from"./index.js";import{r as i}from"./vendor.js";import{I as U}from"./ImageGallery.js";import{u as K,b as M,L as o}from"./router.js";import{t as j,p as O,i as N}from"./inventoryService.js";import{a as b,f as v}from"./dateUtils.js";import{d as w,e as X,T as Y,j as H,r as J,g as Q,q as V,m as T,E as W}from"./ui.js";import"./firebase.js";const g=()=>{document.querySelectorAll(".no-icon").forEach(n=>{Array.from(n.childNodes).forEach(s=>{s.nodeType!==Node.TEXT_NODE&&s.parentNode&&s.parentNode.removeChild(s)})})};function ce(){var p;const{id:a,transactionId:n}=K(),h=M(),[s,I]=i.useState(null),[c,_]=i.useState(null),[l,d]=i.useState([]),[k,E]=i.useState(!0),[S,P]=i.useState(!0),[D,u]=i.useState(!1),[C,L]=i.useState(0),{showError:A}=F();i.useEffect(()=>{(async()=>{if(!(!a||!n))try{const[r,z,m]=await Promise.all([j.getTransaction(a,n),O.getProject(a),N.getTransactionItems(a,n)]),y={...r,transaction_images:Array.isArray(r==null?void 0:r.transaction_images)?r.transaction_images:[]};if(console.log("TransactionDetail - loaded transactionData:",r),console.log("TransactionDetail - convertedTransaction:",y),console.log("TransactionDetail - item IDs:",m),I(y),_(z),m.length>0){const B=m.map(x=>N.getItem(a,x)),f=(await Promise.all(B)).filter(x=>x!==null);console.log("TransactionDetail - fetched items:",f.length),d(f)}else d([])}catch(r){console.error("Error loading transaction:",r),d([])}finally{E(!1),P(!1)}})()},[a,n]),i.useEffect(()=>{},[a,n]),i.useEffect(()=>{if(s){g();const t=setTimeout(g,100),r=setTimeout(g,500);return()=>{clearTimeout(t),clearTimeout(r)}}},[s]);const $=async()=>{if(!(!a||!n||!s)&&window.confirm("Are you sure you want to delete this transaction? This action cannot be undone."))try{await j.deleteTransaction(a,n),h(`/project/${a}?tab=transactions`)}catch(t){console.error("Error deleting transaction:",t),A("Failed to delete transaction. Please try again.")}},G=t=>{L(t),u(!0)},q=()=>{u(!1)},R=((p=s==null?void 0:s.transaction_images)==null?void 0:p.map((t,r)=>({url:t.url,alt:t.fileName,fileName:t.fileName,uploadedAt:t.uploadedAt,size:t.size,mimeType:t.mimeType,isPrimary:r===0})))||[];return k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):s?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(o,{to:`/project/${a}?tab=transactions`,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs(o,{to:`/project/${a}/transaction/${n}/edit`,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Edit"]}),e.jsxs("button",{onClick:$,className:"inline-flex items-center px-4 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-6 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900 leading-tight",children:s.source})}),e.jsx("div",{className:"px-6 py-4",children:e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Amount"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:b(s.amount)})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(H,{className:"h-4 w-4 mr-1"}),"Payment Method"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:s.payment_method})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(J,{className:"h-4 w-4 mr-1"}),"Transaction Date"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:s.transaction_date?v(s.transaction_date):"No date"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Type"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium no-icon ${s.transaction_type==="Purchase"?"bg-green-100 text-green-800":s.transaction_type==="Return"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:s.transaction_type})})]}),s.receipt_emailed&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Receipt Emailed"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Yes"})})]}),s.notes&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(Q,{className:"h-4 w-4 mr-1"}),"Notes"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 whitespace-pre-wrap",children:s.notes})]})]})}),s.transaction_images&&s.transaction_images.length>0&&e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(V,{className:"h-5 w-5 mr-2"}),"Transaction Images"]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 sm:gap-4 md:gap-6",style:{width:"fit-content"},children:s.transaction_images.map((t,r)=>e.jsxs("div",{className:"w-24 h-24 sm:w-20 sm:h-20 relative group cursor-pointer rounded-lg overflow-hidden border-2 border-gray-200 hover:border-primary-300 transition-colors",onClick:()=>G(r),children:[e.jsx("img",{src:t.url,alt:t.fileName,className:"w-full h-full object-cover transition-transform group-hover:scale-105"}),s.transaction_images&&s.transaction_images.length>1&&e.jsx("div",{className:"absolute bottom-1 right-1 bg-black bg-opacity-70 text-white text-xs px-1 py-0.5 rounded",children:r+1})]},r))}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[s.transaction_images.length," image",s.transaction_images.length!==1?"s":""]})]}),S?e.jsx("div",{className:"px-6 py-6 border-t border-gray-200",children:e.jsxs("div",{className:"flex justify-center items-center h-16",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Loading items..."})]})}):l.length>0?e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(T,{className:"h-5 w-5 mr-2"}),"Items in this Transaction (",l.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:l.map(t=>e.jsx(o,{to:`/project/${a}/item/${t.item_id}`,className:"block p-4 border border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-sm transition-all duration-200 group",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate group-hover:text-primary-600",children:t.description}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:b(t.price)}),t.sku&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["SKU: ",t.sku]}),t.disposition&&e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mt-2 ${t.disposition==="keep"?"bg-green-100 text-green-800":t.disposition==="return"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:t.disposition})]}),e.jsx(W,{className:"h-4 w-4 text-gray-400 group-hover:text-primary-500 flex-shrink-0 ml-2"})]})},t.item_id))})]}):e.jsx("div",{className:"px-6 py-6 border-t border-gray-200",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(T,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No items linked"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Items created separately can be linked to this transaction when adding them to inventory."})]})}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(c==null?void 0:c.name)||s.project_name})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:v(s.created_at)})]})]})})]}),D&&e.jsx(U,{images:R,initialIndex:C,onClose:q})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"ðŸ“„"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Transaction not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The transaction you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(o,{to:`/project/${a}?tab=transactions`,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Back"]})})]})}export{ce as default};
//# sourceMappingURL=TransactionDetail.js.map
