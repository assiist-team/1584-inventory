import{a as pe,j as e}from"./index.js";import{r as m}from"./vendor.js";import{T as X,a as he}from"./ImagePreview.js";import{b as ye,c as fe,L as S}from"./router.js";import{a as F,f as Y,t as p,p as J,u as f}from"./inventoryService.js";import{I as T}from"./imageService.js";import{T as je}from"./TransactionItemForm.js";import{u as be}from"./useNavigationContext.js";import{e as Z,f as Ne,q as I,P,T as Ie}from"./ui.js";import"./firebase.js";const O=()=>{document.querySelectorAll(".no-icon").forEach(i=>{Array.from(i.childNodes).forEach(t=>{t.nodeType!==Node.TEXT_NODE&&t.parentNode&&t.parentNode.removeChild(t)})})},we=n=>{var i,w;return(i=n.transaction_id)!=null&&i.startsWith("INV_SALE_")?"1584 Inventory Sale":(w=n.transaction_id)!=null&&w.startsWith("INV_PURCHASE_")?"1584 Inventory Purchase":n.source};function Fe(){const{id:n,transactionId:i}=ye(),w=fe(),[t,v]=m.useState(null),[x,ee]=m.useState(null),[k,b]=m.useState([]),[te,U]=m.useState(!0),[M,$]=m.useState(!0),[se,L]=m.useState(!1),[ae,re]=m.useState(0),[C,z]=m.useState(!1),[B,G]=m.useState(!1),[D,R]=m.useState(!1),[ne,A]=m.useState(new Map),{showError:N,showSuccess:_}=pe(),{buildContextUrl:q,getBackDestination:W}=be(),V=m.useMemo(()=>W(`/project/${n}?tab=transactions`),[W,n]);m.useEffect(()=>{(async()=>{if(i)try{let a=n,r,o=null;if(a){const[c,u,h]=await Promise.all([p.getTransaction(a,i),J.getProject(a),f.getItemsForTransaction(a,i)]);if(r=c,o=u,h.length>0&&a){const g=h.map(j=>j.item_id).map(j=>f.getItemById(j)),d=(await Promise.all(g)).filter(j=>j!==null);console.log("TransactionDetail - fetched items:",d.length),b(d)}else b([])}else{console.log("TransactionDetail - No projectId provided, searching across all projects for business inventory transaction");const c=await p.getTransactionById(i);if(!c.transaction||!c.projectId){console.error("TransactionDetail - Transaction not found in any project"),U(!1),$(!1);return}r=c.transaction,a=c.projectId,o=await J.getProject(a)}const l={...r,transaction_images:Array.isArray(r==null?void 0:r.transaction_images)?r.transaction_images:[]};if(console.log("TransactionDetail - loaded transactionData:",r),console.log("TransactionDetail - convertedTransaction:",l),console.log("TransactionDetail - actualProjectId:",a),v(l),ee(o),!n&&a){const c=await f.getItemsForTransaction(a,i);if(c.length>0){const h=c.map(y=>y.item_id).map(y=>f.getItemById(y)),g=(await Promise.all(h)).filter(y=>y!==null);console.log("TransactionDetail - fetched items for business inventory transaction:",g.length),b(g)}else b([])}}catch(a){console.error("Error loading transaction:",a),b([])}finally{U(!1),$(!1)}})()},[n,i]),m.useEffect(()=>{!i||!t||(n||t.project_id)},[n,i,t]),m.useEffect(()=>{if(t){O();const s=setTimeout(O,100),a=setTimeout(O,500);return()=>{clearTimeout(s),clearTimeout(a)}}},[t]);const ie=async()=>{if(!(!n||!i||!t)&&window.confirm("Are you sure you want to delete this transaction? This action cannot be undone."))try{await p.deleteTransaction(n,i),w(`/project/${n}?tab=transactions`)}catch(s){console.error("Error deleting transaction:",s),N("Failed to delete transaction. Please try again.")}},H=s=>{re(s),L(!0)},oe=()=>{L(!1)},K=async s=>{if(!(!n||!i||!x||s.length===0)){z(!0);try{const a=await T.uploadMultipleReceiptImages(s,x.name,i),r=T.convertFilesToReceiptImages(a),l=[...(t==null?void 0:t.receipt_images)||[],...r],c=(t==null?void 0:t.project_id)||n;await p.updateTransaction(c||"",i,{receipt_images:l,transaction_images:l});const u=(t==null?void 0:t.project_id)||n,h=await p.getTransaction(u||"",i);v(h),_("Receipt images uploaded successfully")}catch(a){console.error("Error uploading receipt images:",a),N("Failed to upload receipt images. Please try again.")}finally{z(!1)}}},ce=async s=>{if(!(!n||!i||!x||s.length===0)){G(!0);try{const a=await T.uploadMultipleOtherImages(s,x.name,i),r=T.convertFilesToOtherImages(a),l=[...(t==null?void 0:t.other_images)||[],...r],c=(t==null?void 0:t.project_id)||n;await p.updateTransaction(c||"",i,{other_images:l});const u=(t==null?void 0:t.project_id)||n,h=await p.getTransaction(u||"",i);v(h),_("Other images uploaded successfully")}catch(a){console.error("Error uploading other images:",a),N("Failed to upload other images. Please try again.")}finally{G(!1)}}},le=async s=>{if(!(!n||!i||!t))try{const r=(t.receipt_images||[]).filter(u=>u.url!==s),o=(t==null?void 0:t.project_id)||n;await p.updateTransaction(o||"",i,{receipt_images:r,transaction_images:r});const l=(t==null?void 0:t.project_id)||n,c=await p.getTransaction(l||"",i);v(c),_("Receipt image deleted successfully")}catch(a){console.error("Error deleting receipt image:",a),N("Failed to delete receipt image. Please try again.")}},de=async s=>{if(!(!n||!i||!t))try{const r=(t.other_images||[]).filter(u=>u.url!==s),o=(t==null?void 0:t.project_id)||n;await p.updateTransaction(o||"",i,{other_images:r});const l=(t==null?void 0:t.project_id)||n,c=await p.getTransaction(l||"",i);v(c),_("Other image deleted successfully")}catch(a){console.error("Error deleting other image:",a),N("Failed to delete other image. Please try again.")}},me=(s,a)=>{A(r=>{const o=new Map(r);return o.set(s,a),o})},ge=async s=>{if(!(!n||!i||!t))try{const a={...s,project_id:n,transaction_id:i,date_created:t.transaction_date||new Date().toISOString(),source:t.source,inventory_status:"available",payment_method:"Unknown",qr_key:`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,bookmark:!1,sku:s.sku||"",purchase_price:s.purchase_price||"",project_price:s.project_price||"",market_value:s.market_value||"",notes:s.notes||"",space:s.space||"",disposition:"keep"},r=await f.createItem(a);let o=ne.get(s.id);if(!o&&s.imageFiles&&(o=s.imageFiles),o&&o.length>0)try{const y=(await Promise.all(o.map(async(d,j)=>{try{return{url:(await T.uploadItemImage(d,x?x.name:"Unknown Project",r)).url,alt:d.name,isPrimary:j===0,uploadedAt:new Date,fileName:d.name,size:d.size,mimeType:d.type}}catch(Q){return console.error(`Failed to upload ${d.name}:`,Q),{url:"",alt:d.name,isPrimary:!1,uploadedAt:new Date,fileName:d.name,size:d.size,mimeType:d.type}}}))).filter(d=>d.url&&d.url.trim()!=="");y.length>0&&await f.updateItem(r,{images:y})}catch(g){console.error("Error in image upload process:",g)}const u=(await f.getItemsForTransaction(n,i)).map(g=>g.item_id).map(g=>f.getItemById(g)),E=(await Promise.all(u)).filter(g=>g!==null);b(E),R(!1),A(new Map),_("Item added successfully")}catch(a){console.error("Error adding item:",a),N("Failed to add item. Please try again.")}},ue=()=>{R(!1),A(new Map)},xe=[...(t==null?void 0:t.receipt_images)||[],...(t==null?void 0:t.other_images)||[]].map((s,a)=>({url:s.url,alt:s.fileName,fileName:s.fileName,uploadedAt:s.uploadedAt,size:s.size,mimeType:s.mimeType,isPrimary:a===0}))||[];return te?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(S,{to:V,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsx("div",{className:"flex space-x-3",children:e.jsx(S,{to:`/project/${n}/transaction/${i}/edit`,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Transaction",children:e.jsx(Ne,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-6 border-b border-gray-200",children:e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 leading-tight",children:[we(t)," - ",F(t.amount)]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Transaction Details"}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.source})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Budget Category"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${t.budget_category==="Design Fee"?"bg-amber-100 text-amber-800":t.budget_category==="Furnishings"?"bg-yellow-100 text-yellow-800":t.budget_category==="Property Management"?"bg-orange-100 text-orange-800":t.budget_category==="Kitchen"?"bg-amber-200 text-amber-900":t.budget_category==="Install"?"bg-yellow-200 text-yellow-900":t.budget_category==="Storage & Receiving"?"bg-orange-200 text-orange-900":t.budget_category==="Fuel"?"bg-amber-300 text-amber-900":"bg-gray-100 text-gray-800"}`,children:t.budget_category||"Not specified"})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Type"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium no-icon ${t.transaction_type==="Purchase"?"bg-green-100 text-green-800":t.transaction_type==="Return"?"bg-red-100 text-red-800":t.transaction_type==="To Inventory"?"bg-primary-100 text-primary-800":"bg-gray-100 text-gray-800"}`,children:t.transaction_type})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Amount"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:F(t.amount)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Date"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.transaction_date?Y(t.transaction_date):"No date"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Payment Method"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.payment_method})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(t.status||"pending").charAt(0).toUpperCase()+(t.status||"pending").slice(1)})]}),t.reimbursement_type&&t.reimbursement_type!==""&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Reimbursement Type"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.reimbursement_type==="Client Owes"?"Client Owes":"We Owe"})]}),t.receipt_emailed&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Receipt Emailed"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Yes"})})]}),t.notes&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 whitespace-pre-wrap",children:t.notes})]})]})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(I,{className:"h-5 w-5 mr-2"}),"Receipt Images"]}),t.receipt_images&&t.receipt_images.length>0&&e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const r=a.target.files;r&&K(Array.from(r))},s.click()},disabled:C,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),C?"Uploading...":"Add Images"]})]}),t.receipt_images&&t.receipt_images.length>0?e.jsx(X,{images:t.receipt_images,onRemoveImage:le,onImageClick:H,maxImages:5,showControls:!0,size:"md",className:"mb-4"}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No receipt images uploaded"}),e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const r=a.target.files;r&&K(Array.from(r))},s.click()},disabled:C,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3 disabled:opacity-50",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),C?"Uploading...":"Add Receipt Images"]})]})]}),t.other_images&&t.other_images.length>0&&e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(I,{className:"h-5 w-5 mr-2"}),"Other Images"]}),e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const r=a.target.files;r&&ce(Array.from(r))},s.click()},disabled:B,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),B?"Uploading...":"Add Images"]})]}),e.jsx(X,{images:t.other_images,onRemoveImage:de,onImageClick:s=>{var l,c;const a=((l=t.receipt_images)==null?void 0:l.length)||0,r=((c=t.transaction_images)==null?void 0:c.length)||0,o=a+r+s;H(o)},maxImages:5,showControls:!0,size:"md",className:"mb-4"})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(P,{className:"h-5 w-5 mr-2"}),"Transaction Items"]}),!M&&!D&&k.length>0&&e.jsxs("button",{onClick:()=>R(!0),className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Add new item",children:[e.jsx(P,{className:"h-3 w-3 mr-1"}),"Add Item"]})]}),M?e.jsxs("div",{className:"flex justify-center items-center h-16",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Loading items..."})]}):e.jsxs("div",{className:"space-y-4",children:[k.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:k.map(s=>{const r=s.project_id===null?q(`/business-inventory/${s.item_id}`,{from:"business-inventory-item"}):q(`/project/${n}/item/${s.item_id}`,{from:"transaction"});return e.jsxs(S,{to:r,className:"block p-4 border border-gray-200 rounded-lg bg-white hover:border-primary-300 hover:shadow-sm transition-all duration-200 group relative",children:[s.disposition&&e.jsx("div",{className:"absolute top-1 right-1 z-10",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${s.disposition==="keep"?"bg-green-100 text-green-800":s.disposition==="to return"||s.disposition==="return"?"bg-red-100 text-red-700":s.disposition==="returned"?"bg-red-800 text-red-100":s.disposition==="inventory"?"bg-primary-100 text-primary-600":"bg-gray-100 text-gray-800"}`,children:s.disposition==="to return"?"To Return":s.disposition?s.disposition.charAt(0).toUpperCase()+s.disposition.slice(1):"Not Set"})}),e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsx("div",{className:"flex-shrink-0",children:s.images&&s.images.length>0?(()=>{const o=s.images.find(l=>l.isPrimary)||s.images[0];return e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:o.url,alt:o.alt||"Item image",className:"w-full h-full object-cover"})})})():e.jsx("div",{className:"w-16 h-16 rounded-lg border-2 border-gray-200 flex items-center justify-center text-gray-400 bg-gray-100",children:e.jsx(P,{className:"h-6 w-6"})})}),e.jsx("div",{className:"flex-1 min-w-0 flex items-center",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-900 line-clamp-2 break-words",children:s.description}),s.space&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.space})]})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[(s.project_price||s.purchase_price)&&e.jsx("span",{className:"font-medium text-gray-700",children:F(s.project_price||s.purchase_price||"0")}),s.source&&e.jsxs(e.Fragment,{children:[(s.project_price||s.purchase_price)&&e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:s.source})]}),s.sku&&e.jsxs(e.Fragment,{children:[(s.project_price||s.purchase_price||s.source)&&e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:s.sku})]})]})]},s.item_id)})}),D&&e.jsx(je,{onSave:ge,onCancel:ue,projectId:n,projectName:x?x.name:"",onImageFilesChange:me}),k.length===0&&!D&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(P,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No items added"}),e.jsxs("button",{onClick:()=>R(!0),className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3",title:"Add new item",children:[e.jsx(P,{className:"h-3 w-3 mr-1"}),"Add Item"]})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(x==null?void 0:x.name)||t.project_name})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:Y(t.created_at)})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:ie,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Transaction",children:e.jsx(Ie,{className:"h-4 w-4"})})})]})})]}),se&&e.jsx(he,{images:xe,initialIndex:ae,onClose:oe})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"ðŸ“„"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Transaction not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The transaction you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(S,{to:V,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Back"]})})]})}export{Fe as default};
//# sourceMappingURL=TransactionDetail.js.map
