import{d as we,e as Te,j as e,f as pe,C as Le,h as Pe,i as Se}from"./index.js";import{r as h}from"./vendor.js";import{T as fe,a as Ue}from"./ImagePreview.js";import{C as ye}from"./ContextBackLink.js";import{C as je}from"./ContextLink.js";import{u as _e}from"./useStackedNavigate.js";import{f as T,t as b,u as R,l as te,a as Ie,p as be}from"./inventoryService.js";import{I as W}from"./imageService.js";import{T as Be}from"./TransactionItemForm.js";import{u as ze}from"./useNavigationContext.js";import{a as Ve}from"./taxPresetsService.js";import{w as Ne,s as Ye,j as We,f as Ge,X as He,x as Ke,g as ve,h as qe,v as z,P as G,T as Xe}from"./ui.js";import{b as Qe}from"./router.js";import"./supabase.js";function Je({transaction:n,projectId:i,transactionItems:P,onItemsUpdated:o}){const{currentAccountId:t}=we(),{showError:F,showSuccess:N}=Te(),[u,H]=h.useState(null),[se,D]=h.useState(!0),[v,$]=h.useState(!0),[K,_]=h.useState([]),[q,L]=h.useState(!1);if(!(n.transactionType!=="Return"&&n.transactionType!=="Internal Transfer"))return null;h.useEffect(()=>{(async()=>{if(!(!t||!n.transactionId||!i)){D(!0);try{const x=await b.getTransactionCompleteness(t,i,n.transactionId);H(x)}catch(x){console.error("Error loading completeness metrics:",x),H({itemsNetTotal:0,itemsCount:P.length,itemsMissingPriceCount:P.filter(y=>!y.purchasePrice||y.purchasePrice.trim()==="").length,transactionSubtotal:parseFloat(n.amount||"0"),completenessRatio:0,completenessStatus:P.length===0?"incomplete":"complete",missingTaxData:!n.taxRatePct&&!n.subtotal,varianceDollars:0,variancePercent:0})}finally{D(!1)}}})()},[t,i,n.transactionId,P,n.amount,n.taxRatePct,n.subtotal]),h.useEffect(()=>{(async()=>{if(!(!t||!u)){if(u.completenessStatus==="complete"){_([]);return}L(!0);try{const x=await b.getSuggestedItemsForTransaction(t,n.source,5);let y=x;if(u){const S=u.transactionSubtotal-u.itemsNetTotal;y=(x||[]).filter(B=>{const O=parseFloat(B.purchasePrice||"0");return isNaN(O)?!0:O<=S})}_(y)}catch(x){console.error("Error loading suggested items:",x)}finally{L(!1)}}})()},[t,n.source,u==null?void 0:u.completenessStatus]);const ae=async g=>{if(!(!t||!n.transactionId))try{await R.addItemToTransaction(t,g.itemId,n.transactionId,g.purchasePrice||"0",n.transactionType,"Manual","Added via transaction audit"),N("Item added to transaction"),_(x=>x.filter(y=>y.itemId!==g.itemId)),o();try{L(!0);const x=await b.getSuggestedItemsForTransaction(t,n.source,5);let y=x;if(u){const S=u.transactionSubtotal-u.itemsNetTotal;y=(x||[]).filter(B=>{const O=parseFloat(B.purchasePrice||"0");return isNaN(O)?!0:O<=S})}_(y)}catch(x){console.error("Error refreshing suggested items after add:",x)}finally{L(!1)}}catch(x){console.error("Error adding item to transaction:",x),F("Failed to add item to transaction")}};if(se||!u)return e.jsx("div",{className:"bg-white shadow rounded-lg p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/4 mb-4"}),e.jsx("div",{className:"h-2 bg-gray-200 rounded w-full"})]})});const X=g=>{switch(g){case"complete":return"bg-green-500";case"near":return"bg-yellow-500";case"incomplete":case"over":return"bg-red-500";default:return"bg-gray-500"}},ne=g=>{switch(g){case"complete":return e.jsx(Ke,{className:"h-5 w-5 text-green-600"});case"near":return e.jsx(Ne,{className:"h-5 w-5 text-yellow-600"});case"incomplete":case"over":return e.jsx(He,{className:"h-5 w-5 text-red-600"});default:return null}},ie=g=>{switch(g){case"complete":return"Complete";case"near":return"Needs Review";case"incomplete":return"Incomplete";case"over":return"Over Budget";default:return"Unknown"}},U=P.filter(g=>{const x=g.purchasePrice;return!x||x.trim()===""||parseFloat(x)===0}),Q=Math.min(u.completenessRatio*100,100),J=n.subtotal?"Subtotal (pre-tax)":"Estimated subtotal (pre-tax)",Z="Associated items total (pre-tax)",V="Calculated tax",M=Math.round((u.transactionSubtotal-u.itemsNetTotal)*100)/100,oe=M>=0?`${T(M.toString())} remaining`:`Over by ${T(Math.abs(M).toString())}`;return e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Transaction Audit"})})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ne(u.completenessStatus),e.jsx("span",{className:"text-base font-medium text-gray-900",children:ie(u.completenessStatus)})]}),e.jsxs("span",{className:"text-sm text-gray-500",children:[T(u.itemsNetTotal.toString())," / ",T(u.transactionSubtotal.toString())]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3 mb-1",children:e.jsx("div",{className:`h-3 rounded-full transition-all duration-300 ${X(u.completenessStatus)}`,style:{width:`${Math.min(Q,100)}%`}})}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:[u.itemsCount," items"]}),e.jsx("span",{children:oe})]})]}),e.jsx("div",{className:"mt-3 text-xs text-gray-600 space-y-1",children:u.itemsCount===0?e.jsx("div",{className:"text-red-600 font-medium",children:"No items linked yet"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[J,": ",T(u.transactionSubtotal.toString())]}),e.jsxs("div",{children:[Z,": ",T(u.itemsNetTotal.toString())]}),u.inferredTax!==void 0&&e.jsxs("div",{children:[V,": ",T(u.inferredTax.toString())]}),u.itemsMissingPriceCount>0&&e.jsxs("div",{className:"text-yellow-600",children:[u.itemsMissingPriceCount," items missing purchase price"]})]})})]}),u.missingTaxData&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(Ne,{className:"h-5 w-5 text-yellow-600 mr-2 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("strong",{children:"Tax rate not set."})," Set tax rate or transaction subtotal for accurate calculations."]})]})}),U.length>0&&e.jsx("div",{className:"space-y-4 border-t border-gray-200 pt-4",children:e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-2",children:"Missing Purchase Price"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Item"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"SKU"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Action"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:U.map(g=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 text-sm text-gray-900",children:g.description}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-500",children:g.sku||"-"}),e.jsx("td",{className:"px-3 py-2 text-sm",children:e.jsx("a",{href:`/project/${i}/item/${g.itemId}/edit`,className:"text-primary-600 hover:text-primary-800",children:"Edit Price"})})]},g.itemId))})]})})]})}),(u.completenessStatus==="near"||u.completenessStatus==="incomplete")&&e.jsxs("div",{className:"mt-4 border-t border-gray-200 pt-4",children:[e.jsx("button",{onClick:()=>$(!v),className:"inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-800",children:v?e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Hide suggested items"]}):e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"h-4 w-4 mr-1"}),"Show suggested items to add"]})}),v&&(q?e.jsx("div",{className:"text-sm text-gray-500 mt-3",children:"Loading suggestions..."}):K.length>0?e.jsx("div",{className:"space-y-2 mt-3",children:K.map(g=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-md",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:g.description}),e.jsxs("div",{className:"text-xs text-gray-500",children:[g.sku&&`SKU: ${g.sku}`,g.purchasePrice&&` â€¢ ${T(g.purchasePrice)}`]})]}),e.jsxs("button",{onClick:()=>ae(g),className:"ml-4 inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(Ge,{className:"h-3 w-3 mr-1"}),"Add"]})]},g.itemId))}):e.jsx("div",{className:"text-sm text-gray-500 mt-3",children:"No unassociated items found for this vendor."}))]})]})]})}const de=()=>{document.querySelectorAll(".no-icon").forEach(i=>{Array.from(i.childNodes).forEach(o=>{o.nodeType!==Node.TEXT_NODE&&o.parentNode&&o.parentNode.removeChild(o)})})},me=n=>{var i,P;return(i=n.transactionId)!=null&&i.startsWith("INV_SALE_")?Pe:(P=n.transactionId)!=null&&P.startsWith("INV_PURCHASE_")?Se:n.source};function xt(){const{id:n,transactionId:i}=Qe(),P=_e(),{currentAccountId:o}=we(),[t,F]=h.useState(null),[N,u]=h.useState(null),[H,se]=h.useState([]);h.useEffect(()=>{(async()=>{if(o)try{const a=await Ve(o);se(a)}catch(a){console.error("Error loading tax presets:",a)}})()},[o]);const[D,v]=h.useState([]),[$,K]=h.useState({}),[_,q]=h.useState(!0),[L,re]=h.useState(!0),[ae,X]=h.useState(!1),[ne,ie]=h.useState(0),[U,Q]=h.useState(!1),[J,Z]=h.useState(!1),[V,M]=h.useState(!1),[oe,g]=h.useState(new Map),{showError:x,showSuccess:y}=Te(),{buildContextUrl:S,getBackDestination:B}=ze(),O=h.useMemo(()=>B(`/project/${n}?tab=transactions`),[B,n]),ue=async()=>{if(!o||!i)return;const s=n||(t==null?void 0:t.projectId);if(s)try{const c=(await R.getItemsForTransaction(o,s,i)).map(l=>l.itemId).map(l=>R.getItemById(o,l)),d=(await Promise.all(c)).filter(l=>l!==null),p=await te.getEdgesFromTransaction(i,o),C=new Set(p.map(l=>l.itemId)),k=d.filter(l=>{const E=(l.latestTransactionId??l.transactionId)===i,j=C.has(l.itemId);return E&&!j}),f=d.filter(l=>{const A=C.has(l.itemId),E=!l.latestTransactionId&&l.projectId==null&&l.previousProjectTransactionId===i;return A||E}),w=[...k,...f];v(w),ce(w).catch(l=>console.debug("resolveMissingProjectIds error:",l))}catch(a){console.error("Error refreshing transaction items:",a)}};h.useEffect(()=>{(async()=>{if(!(!i||!o))try{let a=n,r,c=null;if(a){const[d,p]=await Promise.all([b.getTransaction(o,a,i),be.getProject(o,a)]);r=d,c=p;const C=Array.isArray(r==null?void 0:r.itemIds)?r.itemIds:[];if(C.length>0&&a){const k=C.map(l=>R.getItemById(o,l)),w=(await Promise.all(k)).filter(l=>l!==null);console.log("TransactionDetail - fetched items (from transaction.itemIds):",w.length);try{const l=await te.getEdgesFromTransaction(i,o),A=new Set(l.map(I=>I.itemId)),E=w.filter(I=>{const le=(I.latestTransactionId??I.transactionId)===i,$e=A.has(I.itemId);return le&&!$e}),j=w.filter(I=>{const ee=A.has(I.itemId),le=!I.latestTransactionId&&I.projectId==null&&I.previousProjectTransactionId===i;return ee||le}),Y=[...E,...j];v(Y),ce(Y).catch(I=>console.debug("resolveMissingProjectIds error:",I))}catch(l){console.error("TransactionDetail - failed to fetch lineage edges:",l),v(w)}}else v([])}else{console.log("TransactionDetail - No projectId provided, searching across all projects for business inventory transaction");const d=await b.getTransactionById(o,i);if(!d.transaction){console.error("TransactionDetail - Transaction not found in any project"),q(!1),re(!1);return}r=d.transaction,a=d.projectId,a&&(c=await be.getProject(o,a))}const m={...r,transactionImages:Array.isArray(r==null?void 0:r.transactionImages)?r.transactionImages:[]};if(console.log("TransactionDetail - loaded transactionData:",r),console.log("TransactionDetail - convertedTransaction:",m),console.log("TransactionDetail - actualProjectId:",a),F(m),u(c),!n){const d=Array.isArray(r==null?void 0:r.itemIds)?r.itemIds:[];if(d.length>0){const p=d.map(f=>R.getItemById(o,f)),k=(await Promise.all(p)).filter(f=>f!==null);console.log("TransactionDetail - fetched items for business inventory transaction:",k.length);try{const f=await te.getEdgesFromTransaction(i,o),w=new Set(f.map(j=>j.itemId)),l=k.filter(j=>{const I=(j.latestTransactionId??j.transactionId)===i,ee=w.has(j.itemId);return I&&!ee}),A=k.filter(j=>{const Y=w.has(j.itemId),I=!j.latestTransactionId&&j.projectId==null&&j.previousProjectTransactionId===i;return Y||I}),E=[...l,...A];v(E),ce(E).catch(j=>console.debug("resolveMissingProjectIds error:",j))}catch(f){console.error("TransactionDetail - failed to fetch lineage edges (business inventory):",f),v(k)}}else v([])}}catch(a){console.error("Error loading transaction:",a),v([])}finally{q(!1),re(!1)}})()},[n,i,o]),h.useEffect(()=>{!i||!t||(n||t.projectId)},[n,i,t]),h.useEffect(()=>{if(!o||!i)return;const s=te.subscribeToEdgesFromTransaction(o,i,a=>{try{ue()}catch(r){console.debug("TransactionDetail - failed to refresh on lineage event",r)}});return()=>{try{s()}catch{}}},[o,i]),h.useEffect(()=>{if(t){de();const s=setTimeout(de,100),a=setTimeout(de,500);return()=>{clearTimeout(s),clearTimeout(a)}}},[t]);const Ce=async()=>{if(!(!n||!i||!t||!o)&&window.confirm("Are you sure you want to delete this transaction? This action cannot be undone."))try{await b.deleteTransaction(o,n,i),P(`/project/${n}?tab=transactions`)}catch(s){console.error("Error deleting transaction:",s),x("Failed to delete transaction. Please try again.")}},ge=s=>{ie(s),X(!0)},Ee=()=>{X(!1)},xe=async s=>{if(!(!n||!i||!N||s.length===0)){Q(!0);try{const a=await W.uploadMultipleReceiptImages(s,N.name,i),r=W.convertFilesToReceiptImages(a),m=[...(t==null?void 0:t.receiptImages)||[],...r],d=(t==null?void 0:t.projectId)||n;if(!o)return;await b.updateTransaction(o,d||"",i,{receiptImages:m,transactionImages:m});const p=(t==null?void 0:t.projectId)||n,C=await b.getTransaction(o,p||"",i);F(C),y("Receipt images uploaded successfully")}catch(a){console.error("Error uploading receipt images:",a),x("Failed to upload receipt images. Please try again.")}finally{Q(!1)}}},ke=async s=>{if(!(!n||!i||!N||s.length===0)){Z(!0);try{const a=await W.uploadMultipleOtherImages(s,N.name,i),r=W.convertFilesToOtherImages(a),m=[...(t==null?void 0:t.otherImages)||[],...r],d=(t==null?void 0:t.projectId)||n;if(!o)return;await b.updateTransaction(o,d||"",i,{otherImages:m});const p=(t==null?void 0:t.projectId)||n,C=await b.getTransaction(o,p||"",i);F(C),y("Other images uploaded successfully")}catch(a){console.error("Error uploading other images:",a),x("Failed to upload other images. Please try again.")}finally{Z(!1)}}},Ae=async s=>{if(!(!n||!i||!t||!o))try{const r=(t.receiptImages||[]).filter(p=>p.url!==s),c=(t==null?void 0:t.projectId)||n;await b.updateTransaction(o,c||"",i,{receiptImages:r,transactionImages:r});const m=(t==null?void 0:t.projectId)||n,d=await b.getTransaction(o,m||"",i);F(d),y("Receipt image deleted successfully")}catch(a){console.error("Error deleting receipt image:",a),x("Failed to delete receipt image. Please try again.")}},Re=async s=>{if(!(!n||!i||!t))try{const r=(t.otherImages||[]).filter(p=>p.url!==s),c=(t==null?void 0:t.projectId)||n;if(!o)return;await b.updateTransaction(o,c||"",i,{otherImages:r});const m=(t==null?void 0:t.projectId)||n,d=await b.getTransaction(o,m||"",i);F(d),y("Other image deleted successfully")}catch(a){console.error("Error deleting other image:",a),x("Failed to delete other image. Please try again.")}},Me=(s,a)=>{g(r=>{const c=new Map(r);return c.set(s,a),c})},Oe=async s=>{if(!(!n||!i||!t||!o))try{const a={...s,projectId:n,transactionId:i,dateCreated:t.transactionDate||new Date().toISOString(),source:t.source,inventoryStatus:"available",paymentMethod:"Unknown",qrKey:`QR-${Date.now()}-${Math.random().toString(36).substr(2,4)}`,bookmark:!1,sku:s.sku||"",purchasePrice:s.purchasePrice||"",projectPrice:s.projectPrice||"",marketValue:s.marketValue||"",notes:s.notes||"",space:s.space||"",disposition:"keep"},r=await R.createItem(o,a);let c=oe.get(s.id);if(!c&&s.imageFiles&&(c=s.imageFiles),c&&c.length>0)try{const w=(await Promise.all(c.map(async(l,A)=>{try{return{url:(await W.uploadItemImage(l,N?N.name:"Unknown Project",r)).url,alt:l.name,isPrimary:A===0,uploadedAt:new Date,fileName:l.name,size:l.size,mimeType:l.type}}catch(E){return console.error(`Failed to upload ${l.name}:`,E),{url:"",alt:l.name,isPrimary:!1,uploadedAt:new Date,fileName:l.name,size:l.size,mimeType:l.type}}}))).filter(l=>l.url&&l.url.trim()!=="");w.length>0&&await R.updateItem(o,r,{images:w})}catch(f){console.error("Error in image upload process:",f)}const p=(await R.getItemsForTransaction(o,n,i)).map(f=>f.itemId).map(f=>R.getItemById(o,f)),k=(await Promise.all(p)).filter(f=>f!==null);v(k),M(!1),g(new Map),y("Item added successfully")}catch(a){console.error("Error adding item:",a),x("Failed to add item. Please try again.")}},Fe=()=>{M(!1),g(new Map)},De=[...(t==null?void 0:t.receiptImages)||[],...(t==null?void 0:t.otherImages)||[]].map((s,a)=>({url:s.url,alt:s.fileName,fileName:s.fileName,uploadedAt:s.uploadedAt,size:s.size,mimeType:s.mimeType,isPrimary:a===0}))||[];async function ce(s){if(!o)return;const a=Array.from(new Set(s.map(r=>r.latestTransactionId??r.transactionId).filter(Boolean))).filter(r=>!$[r]);if(a.length!==0)try{const r=await Promise.all(a.map(async m=>{try{const d=await b.getTransactionById(o,m);return{txId:m,projectId:d.projectId||null}}catch(d){return console.debug("TransactionDetail - failed to fetch transaction for project resolution",{txId:m,err:d}),{txId:m,projectId:null}}})),c={...$};r.forEach(m=>{m.projectId&&(c[m.txId]=m.projectId)}),Object.keys(c).length>Object.keys($).length&&K(c)}catch(r){console.debug("TransactionDetail - resolveMissingProjectIds unexpected error",r)}}function he(s,a,r){const c=`block p-4 border border-gray-200 rounded-lg bg-white hover:border-primary-300 hover:shadow-sm transition-all duration-200 group relative ${r?"opacity-60":""}`,m=e.jsxs(e.Fragment,{children:[r&&e.jsx("div",{className:"absolute top-1 right-1 z-10",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600",children:"Moved"})}),!r&&s.disposition&&e.jsx("div",{className:"absolute top-1 right-1 z-10",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${s.disposition==="keep"?"bg-green-100 text-green-800":s.disposition==="to return"?"bg-red-100 text-red-700":s.disposition==="returned"?"bg-red-800 text-red-100":s.disposition==="inventory"?"bg-primary-100 text-primary-600":"bg-gray-100 text-gray-800"}`,children:s.disposition==="to return"?"To Return":s.disposition?s.disposition.charAt(0).toUpperCase()+s.disposition.slice(1):"Not Set"})}),e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsx("div",{className:"flex-shrink-0",children:s.images&&s.images.length>0?(()=>{const d=s.images.find(p=>p.isPrimary)||s.images[0];return e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:d.url,alt:d.alt||"Item image",className:"w-full h-full object-cover"})})})():e.jsx("div",{className:"w-16 h-16 rounded-lg border-2 border-gray-200 flex items-center justify-center text-gray-400 bg-gray-100",children:e.jsx(G,{className:"h-6 w-6"})})}),e.jsx("div",{className:"flex-1 min-w-0 flex items-center",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-900 line-clamp-2 break-words",children:s.description}),s.space&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.space})]})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[(s.projectPrice||s.purchasePrice)&&e.jsx("span",{className:"font-medium text-gray-700",children:T(s.projectPrice||s.purchasePrice||"0")}),s.source&&e.jsxs(e.Fragment,{children:[(s.projectPrice||s.purchasePrice)&&e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:s.source})]}),s.sku&&e.jsxs(e.Fragment,{children:[(s.projectPrice||s.purchasePrice||s.source)&&e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:s.sku})]})]})]});return a?e.jsx(je,{to:a,className:c,children:m},s.itemId):(console.debug("TransactionDetail - rendering moved item without link",{itemId:s.itemId,latestTransactionId:s.latestTransactionId??s.transactionId,projectId:s.projectId}),e.jsx("div",{className:c,children:m},s.itemId))}return _?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ye,{fallback:O,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(ve,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsx("div",{className:"flex space-x-3",children:e.jsx(je,{to:S(n&&(t!=null&&t.projectId)?`/project/${n}/transaction/${i}/edit`:`/business-inventory/transaction/${(t==null?void 0:t.projectId)||"null"}/${i}/edit`),className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Transaction",children:e.jsx(qe,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-6 border-b border-gray-200",children:e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 leading-tight",children:[me(t)," - ",T(t.amount)]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Transaction Details"}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.source})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Budget Category"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${t.budgetCategory==="Design Fee"?"bg-amber-100 text-amber-800":t.budgetCategory==="Furnishings"?"bg-yellow-100 text-yellow-800":t.budgetCategory==="Property Management"?"bg-orange-100 text-orange-800":t.budgetCategory==="Kitchen"?"bg-amber-200 text-amber-900":t.budgetCategory==="Install"?"bg-yellow-200 text-yellow-900":t.budgetCategory==="Storage & Receiving"?"bg-orange-200 text-orange-900":t.budgetCategory==="Fuel"?"bg-amber-300 text-amber-900":"bg-gray-100 text-gray-800"}`,children:t.budgetCategory||"Not specified"})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Type"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium no-icon ${t.transactionType==="Purchase"?"bg-green-100 text-green-800":t.transactionType==="Return"?"bg-red-100 text-red-800":t.transactionType==="To Inventory"?"bg-primary-100 text-primary-800":"bg-gray-100 text-gray-800"}`,children:t.transactionType})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Amount"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:T(t.amount)})]}),t.taxRatePreset&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Tax Rate Preset"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.taxRatePreset==="Other"?"Custom":(()=>{const s=H.find(a=>a.id===t.taxRatePreset);return s?`${s.name} (${s.rate.toFixed(2)}%)`:t.taxRatePreset})()})]}),t.subtotal&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Subtotal"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:T(t.subtotal)})]}),t.taxRatePct!==void 0&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Tax Rate"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900",children:[Number(t.taxRatePct).toFixed(2),"%"]})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Date"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.transactionDate?Ie(t.transactionDate):"No date"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Payment Method"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.paymentMethod})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(t.status||"pending").charAt(0).toUpperCase()+(t.status||"pending").slice(1)})]}),t.reimbursementType&&t.reimbursementType!==""&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Reimbursement Type"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.reimbursementType===pe?pe:Le})]}),t.receiptEmailed&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Receipt Emailed"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Yes"})})]}),t.notes&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 whitespace-pre-wrap",children:t.notes})]})]})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(z,{className:"h-5 w-5 mr-2"}),"Receipt Images"]}),t.receiptImages&&t.receiptImages.length>0&&e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const r=a.target.files;r&&xe(Array.from(r))},s.click()},disabled:U,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),U?"Uploading...":"Add Images"]})]}),t.receiptImages&&t.receiptImages.length>0?e.jsx(fe,{images:t.receiptImages,onRemoveImage:Ae,onImageClick:ge,maxImages:5,showControls:!0,size:"md",className:"mb-4"}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(z,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No receipt images uploaded"}),e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const r=a.target.files;r&&xe(Array.from(r))},s.click()},disabled:U,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3 disabled:opacity-50",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),U?"Uploading...":"Add Receipt Images"]})]})]}),t.otherImages&&t.otherImages.length>0&&e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(z,{className:"h-5 w-5 mr-2"}),"Other Images"]}),e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const r=a.target.files;r&&ke(Array.from(r))},s.click()},disabled:J,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),J?"Uploading...":"Add Images"]})]}),e.jsx(fe,{images:t.otherImages,onRemoveImage:Re,onImageClick:s=>{var m,d;const a=((m=t.receiptImages)==null?void 0:m.length)||0,r=((d=t.transactionImages)==null?void 0:d.length)||0,c=a+r+s;ge(c)},maxImages:5,showControls:!0,size:"md",className:"mb-4"})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(G,{className:"h-5 w-5 mr-2"}),"Transaction Items"]}),!L&&!V&&D.length>0&&e.jsxs("button",{onClick:()=>M(!0),className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Add new item",children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),"Add Item"]})]}),L?e.jsxs("div",{className:"flex justify-center items-center h-16",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Loading items..."})]}):e.jsx("div",{className:"space-y-6",children:(()=>{const s=D.filter(r=>(r.latestTransactionId??r.transactionId)===i),a=D.filter(r=>{const m=(r.latestTransactionId??r.transactionId)!==i,d=!r.latestTransactionId&&r.projectId==null&&r.previousProjectTransactionId===i;return m||d});return e.jsxs(e.Fragment,{children:[s.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"In this project"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(r=>{const c=r.projectId==null,m=n||(t==null?void 0:t.projectId)||"",d=c?S(`/business-inventory/${r.itemId}`,{from:"business-inventory-item"}):S(`/project/${m}/item/${r.itemId}`,{from:"transaction",project:m,transactionId:i||""});return he(r,d,!1)})})]}),a.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Moved"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(r=>{const c=r.latestTransactionId??r.transactionId,m=!c;let d=null;if(m)d=S(`/business-inventory/${r.itemId}`,{from:"business-inventory-item"});else if(r.projectId)d=S(`/project/${r.projectId}/item/${r.itemId}`,{from:"transaction"});else if(c!=null&&c.startsWith("INV_SALE_")||c!=null&&c.startsWith("INV_PURCHASE_"))d=S(`/business-inventory/${r.itemId}`,{from:"business-inventory-item"});else{const p=c?$[c]:void 0;p?d=S(`/project/${p}/item/${r.itemId}`,{from:"transaction",project:p,transactionId:i||""}):(console.debug("TransactionDetail - unresolved moved item link",{itemId:r.itemId,currentTransactionId:c,itemProjectId:r.projectId,resolvedProjectId:$[c||""]}),d=null)}return he(r,d,!0)})})]}),s.length===0&&a.length===0&&!V&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(G,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No items added"}),e.jsxs("button",{onClick:()=>M(!0),className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3",title:"Add new item",children:[e.jsx(G,{className:"h-3 w-3 mr-1"}),"Add Item"]})]}),V&&e.jsx(Be,{onSave:Oe,onCancel:Fe,projectId:n,projectName:N?N.name:"",onImageFilesChange:Me})]})})()})]}),t&&(n||t.projectId)&&me(t)!==Pe&&me(t)!==Se&&e.jsx("div",{className:"px-6 py-6 border-t border-gray-200",children:e.jsx(Je,{transaction:t,projectId:n||t.projectId||"",transactionItems:D,onItemsUpdated:ue})}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(N==null?void 0:N.name)||t.projectName})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:Ie(t.createdAt)})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:Ce,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Transaction",children:e.jsx(Xe,{className:"h-4 w-4"})})})]})})]}),ae&&e.jsx(Ue,{images:De,initialIndex:ne,onClose:Ee})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"ðŸ“„"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Transaction not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The transaction you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(ye,{fallback:O,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Back"]})})]})}export{xt as default};
//# sourceMappingURL=TransactionDetail.js.map
