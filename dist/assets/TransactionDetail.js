import{a as ue,j as e}from"./index.js";import{r as l}from"./vendor.js";import{T as K,a as xe}from"./ImagePreview.js";import{b as pe,c as he,u as ye,L as S}from"./router.js";import{t as g,p as fe,i as f}from"./inventoryService.js";import{I}from"./imageService.js";import{a as W,f as X}from"./dateUtils.js";import{T as je}from"./TransactionItemForm.js";import{e as Y,f as be,p as j,P as w,T as Ne}from"./ui.js";import"./firebase.js";const A=()=>{document.querySelectorAll(".no-icon").forEach(i=>{Array.from(i.childNodes).forEach(p=>{p.nodeType!==Node.TEXT_NODE&&p.parentNode&&p.parentNode.removeChild(p)})})};function Ee(){const{id:r,transactionId:i}=pe(),E=he(),p=ye(),[s,b]=l.useState(null),[m,H]=l.useState(null),[v,T]=l.useState([]),[J,Q]=l.useState(!0),[F,V]=l.useState(!0),[Z,O]=l.useState(!1),[ee,te]=l.useState(0),[_,D]=l.useState(!1),[U,M]=l.useState(!1),[k,P]=l.useState(!1),[se,C]=l.useState(new Map),{showError:h,showSuccess:N}=ue(),R=new URLSearchParams(p.search),L=R.get("from")==="business-inventory-item",$=l.useMemo(()=>{const t=R.get("returnTo");if(t)return t;if(L){const a=R.get("returnTo");return a&&a.includes("/business-inventory/")?a:"/business-inventory"}return`/project/${r}?tab=transactions`},[L,R,r]);l.useEffect(()=>{(async()=>{if(!(!r||!i))try{const[a,n,c]=await Promise.all([g.getTransaction(r,i),fe.getProject(r),f.getTransactionItems(r,i)]),o={...a,transaction_images:Array.isArray(a==null?void 0:a.transaction_images)?a.transaction_images:[]};if(console.log("TransactionDetail - loaded transactionData:",a),console.log("TransactionDetail - convertedTransaction:",o),console.log("TransactionDetail - item IDs:",c),b(o),H(n),c.length>0){const u=c.map(y=>f.getItem(r,y)),x=(await Promise.all(u)).filter(y=>y!==null);console.log("TransactionDetail - fetched items:",x.length),T(x)}else T([])}catch(a){console.error("Error loading transaction:",a),T([])}finally{Q(!1),V(!1)}})()},[r,i]),l.useEffect(()=>{},[r,i]),l.useEffect(()=>{if(s){A();const t=setTimeout(A,100),a=setTimeout(A,500);return()=>{clearTimeout(t),clearTimeout(a)}}},[s]);const ae=async()=>{if(!(!r||!i||!s)&&window.confirm("Are you sure you want to delete this transaction? This action cannot be undone."))try{await g.deleteTransaction(r,i),E(`/project/${r}?tab=transactions`)}catch(t){console.error("Error deleting transaction:",t),h("Failed to delete transaction. Please try again.")}},z=t=>{te(t),O(!0)},re=()=>{O(!1)},G=async t=>{if(!(!r||!i||!m||t.length===0)){D(!0);try{const a=await I.uploadMultipleReceiptImages(t,m.name,i),n=I.convertFilesToReceiptImages(a),o=[...(s==null?void 0:s.receipt_images)||[],...n];await g.updateTransaction(r,i,{receipt_images:o,transaction_images:o});const u=await g.getTransaction(r,i);b(u),N("Receipt images uploaded successfully")}catch(a){console.error("Error uploading receipt images:",a),h("Failed to upload receipt images. Please try again.")}finally{D(!1)}}},ne=async t=>{if(!(!r||!i||!m||t.length===0)){M(!0);try{const a=await I.uploadMultipleOtherImages(t,m.name,i),n=I.convertFilesToOtherImages(a),o=[...(s==null?void 0:s.other_images)||[],...n];await g.updateTransaction(r,i,{other_images:o});const u=await g.getTransaction(r,i);b(u),N("Other images uploaded successfully")}catch(a){console.error("Error uploading other images:",a),h("Failed to upload other images. Please try again.")}finally{M(!1)}}},ie=async t=>{if(!(!r||!i||!s))try{const n=(s.receipt_images||[]).filter(o=>o.url!==t);await g.updateTransaction(r,i,{receipt_images:n,transaction_images:n});const c=await g.getTransaction(r,i);b(c),N("Receipt image deleted successfully")}catch(a){console.error("Error deleting receipt image:",a),h("Failed to delete receipt image. Please try again.")}},oe=async t=>{if(!(!r||!i||!s))try{const n=(s.other_images||[]).filter(o=>o.url!==t);await g.updateTransaction(r,i,{other_images:n});const c=await g.getTransaction(r,i);b(c),N("Other image deleted successfully")}catch(a){console.error("Error deleting other image:",a),h("Failed to delete other image. Please try again.")}},ce=(t,a)=>{C(n=>{const c=new Map(n);return c.set(t,a),c})},le=async t=>{if(!(!r||!i||!s))try{const a=await f.addItemToTransaction(r,i,s.transaction_date||new Date().toISOString(),s.source,t);let n=se.get(t.id);if(!n&&t.imageFiles&&(n=t.imageFiles),n&&n.length>0)try{const y=(await Promise.all(n.map(async(d,ge)=>{try{return{url:(await I.uploadItemImage(d,m?m.name:"Unknown Project",a)).url,alt:d.name,isPrimary:ge===0,uploadedAt:new Date,fileName:d.name,size:d.size,mimeType:d.type}}catch(q){return console.error(`Failed to upload ${d.name}:`,q),{url:"",alt:d.name,isPrimary:!1,uploadedAt:new Date,fileName:d.name,size:d.size,mimeType:d.type}}}))).filter(d=>d.url&&d.url.trim()!=="");y.length>0&&await f.updateItemImages(r,a,y)}catch(x){console.error("Error in image upload process:",x)}const o=(await f.getTransactionItems(r,i)).map(x=>f.getItem(r,x)),B=(await Promise.all(o)).filter(x=>x!==null);T(B),P(!1),C(new Map),N("Item added successfully")}catch(a){console.error("Error adding item:",a),h("Failed to add item. Please try again.")}},de=()=>{P(!1),C(new Map)},me=[...(s==null?void 0:s.receipt_images)||[],...(s==null?void 0:s.other_images)||[]].map((t,a)=>({url:t.url,alt:t.fileName,fileName:t.fileName,uploadedAt:t.uploadedAt,size:t.size,mimeType:t.mimeType,isPrimary:a===0}))||[];return J?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):s?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(S,{to:$,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsx("div",{className:"flex space-x-3",children:e.jsx(S,{to:`/project/${r}/transaction/${i}/edit`,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Transaction",children:e.jsx(be,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-6 border-b border-gray-200",children:e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 leading-tight",children:[s.source," - ",s.transaction_type]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Transaction Details"}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:s.source})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Budget Category"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${s.budget_category==="Design Fee"?"bg-amber-100 text-amber-800":s.budget_category==="Furnishings"?"bg-yellow-100 text-yellow-800":s.budget_category==="Property Management"?"bg-orange-100 text-orange-800":s.budget_category==="Kitchen"?"bg-amber-200 text-amber-900":s.budget_category==="Install"?"bg-yellow-200 text-yellow-900":s.budget_category==="Storage & Receiving"?"bg-orange-200 text-orange-900":s.budget_category==="Fuel"?"bg-amber-300 text-amber-900":"bg-gray-100 text-gray-800"}`,children:s.budget_category||"Not specified"})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Type"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium no-icon ${s.transaction_type==="Purchase"?"bg-green-100 text-green-800":s.transaction_type==="Return"?"bg-red-100 text-red-800":s.transaction_type==="To Inventory"?"bg-primary-100 text-primary-800":"bg-gray-100 text-gray-800"}`,children:s.transaction_type==="To Inventory"?"Inventory":s.transaction_type})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Amount"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:W(s.amount)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Date"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:s.transaction_date?X(s.transaction_date):"No date"})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Payment Method"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:s.payment_method})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(s.status||"pending").charAt(0).toUpperCase()+(s.status||"pending").slice(1)})]}),s.reimbursement_type&&s.reimbursement_type!==""&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Reimbursement Type"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:s.reimbursement_type==="Client Owes"?"Client Owes":"We Owe"})]}),s.receipt_emailed&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Receipt Emailed"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Yes"})})]}),s.notes&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 whitespace-pre-wrap",children:s.notes})]})]})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(j,{className:"h-5 w-5 mr-2"}),"Receipt Images"]}),s.receipt_images&&s.receipt_images.length>0&&e.jsxs("button",{onClick:()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.accept="image/*",t.onchange=a=>{const n=a.target.files;n&&G(Array.from(n))},t.click()},disabled:_,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),_?"Uploading...":"Add Images"]})]}),s.receipt_images&&s.receipt_images.length>0?e.jsx(K,{images:s.receipt_images,onRemoveImage:ie,onImageClick:z,maxImages:5,showControls:!0,size:"md",className:"mb-4"}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(j,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No receipt images uploaded"}),e.jsxs("button",{onClick:()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.accept="image/*",t.onchange=a=>{const n=a.target.files;n&&G(Array.from(n))},t.click()},disabled:_,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3 disabled:opacity-50",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),_?"Uploading...":"Add Receipt Images"]})]})]}),s.other_images&&s.other_images.length>0&&e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(j,{className:"h-5 w-5 mr-2"}),"Other Images"]}),e.jsxs("button",{onClick:()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.accept="image/*",t.onchange=a=>{const n=a.target.files;n&&ne(Array.from(n))},t.click()},disabled:U,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(j,{className:"h-3 w-3 mr-1"}),U?"Uploading...":"Add Images"]})]}),e.jsx(K,{images:s.other_images,onRemoveImage:oe,onImageClick:t=>{var o,u;const a=((o=s.receipt_images)==null?void 0:o.length)||0,n=((u=s.transaction_images)==null?void 0:u.length)||0,c=a+n+t;z(c)},maxImages:5,showControls:!0,size:"md",className:"mb-4"})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(w,{className:"h-5 w-5 mr-2"}),"Transaction Items"]}),!F&&!k&&v.length>0&&e.jsxs("button",{onClick:()=>P(!0),className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Add new item",children:[e.jsx(w,{className:"h-3 w-3 mr-1"}),"Add Item"]})]}),F?e.jsxs("div",{className:"flex justify-center items-center h-16",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Loading items..."})]}):e.jsxs("div",{className:"space-y-4",children:[v.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:v.map(t=>e.jsxs(S,{to:`/project/${r}/item/${t.item_id}?from=transaction`,className:"block p-4 border border-gray-200 rounded-lg bg-white hover:border-primary-300 hover:shadow-sm transition-all duration-200 group relative",children:[t.disposition&&e.jsx("div",{className:"absolute top-1 right-1 z-10",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${t.disposition==="keep"?"bg-green-100 text-green-800":t.disposition==="to return"||t.disposition==="return"?"bg-red-100 text-red-700":t.disposition==="returned"?"bg-red-800 text-red-100":t.disposition==="inventory"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:t.disposition==="to return"?"To Return":t.disposition?t.disposition.charAt(0).toUpperCase()+t.disposition.slice(1):"Not Set"})}),e.jsxs("div",{className:"flex items-center gap-3 py-3",children:[e.jsx("div",{className:"flex-shrink-0",children:t.images&&t.images.length>0?(()=>{const a=t.images.find(n=>n.isPrimary)||t.images[0];return e.jsx("div",{className:"w-16 h-16 rounded-lg overflow-hidden border-2 border-gray-200",children:e.jsx("img",{src:a.url,alt:a.alt||"Item image",className:"w-full h-full object-cover"})})})():e.jsx("div",{className:"w-16 h-16 rounded-lg border-2 border-gray-200 flex items-center justify-center text-gray-400 bg-gray-100",children:e.jsx(w,{className:"h-6 w-6"})})}),e.jsx("div",{className:"flex-1 min-w-0 flex items-center",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-medium text-gray-900 line-clamp-2 break-words",children:t.description}),t.space&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:t.space})]})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500",children:[t.purchase_price&&e.jsx("span",{className:"font-medium text-gray-700",children:W(t.purchase_price)}),t.source&&e.jsxs(e.Fragment,{children:[t.purchase_price&&e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.source})]}),t.sku&&e.jsxs(e.Fragment,{children:[(t.purchase_price||t.source)&&e.jsx("span",{className:"hidden sm:inline",children:"â€¢"}),e.jsx("span",{className:"font-medium text-gray-700",children:t.sku})]})]})]},t.item_id))}),k&&e.jsx(je,{onSave:le,onCancel:de,projectId:r,projectName:m?m.name:"",onImageFilesChange:ce}),v.length===0&&!k&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(w,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No items added"}),e.jsxs("button",{onClick:()=>P(!0),className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3",title:"Add new item",children:[e.jsx(w,{className:"h-3 w-3 mr-1"}),"Add Item"]})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(m==null?void 0:m.name)||s.project_name})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:X(s.created_at)})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:ae,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Transaction",children:e.jsx(Ne,{className:"h-4 w-4"})})})]})})]}),Z&&e.jsx(xe,{images:me,initialIndex:ee,onClose:re})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"ðŸ“„"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Transaction not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The transaction you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(S,{to:$,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Back"]})})]})}export{Ee as default};
//# sourceMappingURL=TransactionDetail.js.map
