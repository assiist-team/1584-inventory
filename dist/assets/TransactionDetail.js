import{a as Z,j as e}from"./index.js";import{r as o}from"./vendor.js";import{T as A,a as ee}from"./ImagePreview.js";import{u as te,b as se,L as p}from"./router.js";import{t as m,p as ae,i as D}from"./inventoryService.js";import{I as j}from"./imageService.js";import{a as U,f as $}from"./dateUtils.js";import{d as F,e as re,j as w,t as ie,h as ne,s as x,o as I,u as ce,k as oe}from"./ui.js";import"./firebase.js";const v=()=>{document.querySelectorAll(".no-icon").forEach(i=>{Array.from(i.childNodes).forEach(t=>{t.nodeType!==Node.TEXT_NODE&&t.parentNode&&t.parentNode.removeChild(t)})})};function Ne(){const{id:r,transactionId:i}=te(),T=se(),[t,u]=o.useState(null),[g,L]=o.useState(null),[_,N]=o.useState([]),[G,z]=o.useState(!0),[M,B]=o.useState(!0),[q,k]=o.useState(!1),[K,X]=o.useState(0),[f,R]=o.useState(!1),[E,C]=o.useState(!1),{showError:h,showSuccess:y}=Z();o.useEffect(()=>{(async()=>{if(!(!r||!i))try{const[a,n,l]=await Promise.all([m.getTransaction(r,i),ae.getProject(r),D.getTransactionItems(r,i)]),c={...a,transaction_images:Array.isArray(a==null?void 0:a.transaction_images)?a.transaction_images:[]};if(console.log("TransactionDetail - loaded transactionData:",a),console.log("TransactionDetail - convertedTransaction:",c),console.log("TransactionDetail - item IDs:",l),u(c),L(n),l.length>0){const d=l.map(b=>D.getItem(r,b)),O=(await Promise.all(d)).filter(b=>b!==null);console.log("TransactionDetail - fetched items:",O.length),N(O)}else N([])}catch(a){console.error("Error loading transaction:",a),N([])}finally{z(!1),B(!1)}})()},[r,i]),o.useEffect(()=>{},[r,i]),o.useEffect(()=>{if(t){v();const s=setTimeout(v,100),a=setTimeout(v,500);return()=>{clearTimeout(s),clearTimeout(a)}}},[t]);const Y=async()=>{if(!(!r||!i||!t)&&window.confirm("Are you sure you want to delete this transaction? This action cannot be undone."))try{await m.deleteTransaction(r,i),T(`/project/${r}?tab=transactions`)}catch(s){console.error("Error deleting transaction:",s),h("Failed to delete transaction. Please try again.")}},S=s=>{X(s),k(!0)},H=()=>{k(!1)},P=async s=>{if(!(!r||!i||!g||s.length===0)){R(!0);try{const a=await j.uploadMultipleReceiptImages(s,g.name,i),n=j.convertFilesToReceiptImages(a),c=[...(t==null?void 0:t.receipt_images)||[],...n];await m.updateTransaction(r,i,{receipt_images:c,transaction_images:c});const d=await m.getTransaction(r,i);u(d),y("Receipt images uploaded successfully")}catch(a){console.error("Error uploading receipt images:",a),h("Failed to upload receipt images. Please try again.")}finally{R(!1)}}},J=async s=>{if(!(!r||!i||!g||s.length===0)){C(!0);try{const a=await j.uploadMultipleOtherImages(s,g.name,i),n=j.convertFilesToOtherImages(a),c=[...(t==null?void 0:t.other_images)||[],...n];await m.updateTransaction(r,i,{other_images:c});const d=await m.getTransaction(r,i);u(d),y("Other images uploaded successfully")}catch(a){console.error("Error uploading other images:",a),h("Failed to upload other images. Please try again.")}finally{C(!1)}}},Q=async s=>{if(!(!r||!i||!t))try{const n=(t.receipt_images||[]).filter(c=>c.url!==s);await m.updateTransaction(r,i,{receipt_images:n,transaction_images:n});const l=await m.getTransaction(r,i);u(l),y("Receipt image deleted successfully")}catch(a){console.error("Error deleting receipt image:",a),h("Failed to delete receipt image. Please try again.")}},V=async s=>{if(!(!r||!i||!t))try{const n=(t.other_images||[]).filter(c=>c.url!==s);await m.updateTransaction(r,i,{other_images:n});const l=await m.getTransaction(r,i);u(l),y("Other image deleted successfully")}catch(a){console.error("Error deleting other image:",a),h("Failed to delete other image. Please try again.")}},W=[...(t==null?void 0:t.receipt_images)||[],...(t==null?void 0:t.other_images)||[]].map((s,a)=>({url:s.url,alt:s.fileName,fileName:s.fileName,uploadedAt:s.uploadedAt,size:s.size,mimeType:s.mimeType,isPrimary:a===0}))||[];return G?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Loading transaction..."})]})}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(p,{to:`/project/${r}?tab=transactions`,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(F,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsx("div",{className:"flex space-x-3",children:e.jsx(p,{to:`/project/${r}/transaction/${i}/edit`,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Transaction",children:e.jsx(re,{className:"h-4 w-4"})})})]})}),e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-6 border-b border-gray-200",children:e.jsxs("h1",{className:"text-2xl font-bold text-gray-900 leading-tight",children:[t.source," - ",t.transaction_type]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(w,{className:"h-5 w-5 mr-2"}),"Transaction Details"]}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.source})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Budget Category"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${t.budget_category==="Design Fee"?"bg-amber-100 text-amber-800":t.budget_category==="Furnishings"?"bg-yellow-100 text-yellow-800":t.budget_category==="Property Management"?"bg-orange-100 text-orange-800":t.budget_category==="Kitchen"?"bg-amber-200 text-amber-900":t.budget_category==="Install"?"bg-yellow-200 text-yellow-900":t.budget_category==="Storage & Receiving"?"bg-orange-200 text-orange-900":t.budget_category==="Fuel"?"bg-amber-300 text-amber-900":"bg-gray-100 text-gray-800"}`,children:t.budget_category||"Not specified"})})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Transaction Type"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium no-icon ${t.transaction_type==="Purchase"?"bg-green-100 text-green-800":t.transaction_type==="Return"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:t.transaction_type})})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"Amount"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:U(t.amount)})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"Transaction Date"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.transaction_date?$(t.transaction_date):"No date"})]}),e.jsxs("div",{children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(w,{className:"h-4 w-4 mr-1"}),"Payment Method"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.payment_method})]}),t.receipt_emailed&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Receipt Emailed"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Yes"})})]}),t.notes&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsxs("dt",{className:"text-sm font-medium text-gray-500 flex items-center",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Notes"]}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 whitespace-pre-wrap",children:t.notes})]})]})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(x,{className:"h-5 w-5 mr-2"}),"Receipt Images"]}),t.receipt_images&&t.receipt_images.length>0&&e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const n=a.target.files;n&&P(Array.from(n))},s.click()},disabled:f,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(x,{className:"h-3 w-3 mr-1"}),f?"Uploading...":"Add Images"]})]}),t.receipt_images&&t.receipt_images.length>0?e.jsx(A,{images:t.receipt_images,onRemoveImage:Q,onImageClick:S,maxImages:5,showControls:!0,size:"md",className:"mb-4"}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(x,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No receipt images uploaded"}),e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const n=a.target.files;n&&P(Array.from(n))},s.click()},disabled:f,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3 disabled:opacity-50",children:[e.jsx(x,{className:"h-3 w-3 mr-1"}),f?"Uploading...":"Add Receipt Images"]})]})]}),t.other_images&&t.other_images.length>0&&e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(x,{className:"h-5 w-5 mr-2"}),"Other Images"]}),e.jsxs("button",{onClick:()=>{const s=document.createElement("input");s.type="file",s.multiple=!0,s.accept="image/*",s.onchange=a=>{const n=a.target.files;n&&J(Array.from(n))},s.click()},disabled:E,className:"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:[e.jsx(x,{className:"h-3 w-3 mr-1"}),E?"Uploading...":"Add Images"]})]}),e.jsx(A,{images:t.other_images,onRemoveImage:V,onImageClick:s=>{var c,d;const a=((c=t.receipt_images)==null?void 0:c.length)||0,n=((d=t.transaction_images)==null?void 0:d.length)||0,l=a+n+s;S(l)},maxImages:5,showControls:!0,size:"md",className:"mb-4"})]}),e.jsxs("div",{className:"px-6 py-6 border-t border-gray-200",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(I,{className:"h-5 w-5 mr-2"}),"Transaction Items"]}),M?e.jsxs("div",{className:"flex justify-center items-center h-16",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Loading items..."})]}):_.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:_.map(s=>e.jsx(p,{to:`/project/${r}/item/${s.item_id}?from=transaction`,className:"block p-4 border border-gray-200 rounded-lg hover:border-primary-300 hover:shadow-sm transition-all duration-200 group",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate group-hover:text-primary-600",children:s.description}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:U(s.price)}),s.sku&&e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["SKU: ",s.sku]}),s.disposition&&e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mt-2 ${s.disposition==="keep"?"bg-green-100 text-green-800":s.disposition==="return"?"bg-red-100 text-red-800":"bg-gray-100 text-gray-800"}`,children:s.disposition})]}),e.jsx(ce,{className:"h-4 w-4 text-gray-400 group-hover:text-primary-500 flex-shrink-0 ml-2"})]})},s.item_id))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No items linked"}),e.jsxs(p,{to:`/project/${r}/transaction/${i}/edit`,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),"Add Items"]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:(g==null?void 0:g.name)||t.project_name})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Created"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:$(t.created_at)})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:Y,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Transaction",children:e.jsx(oe,{className:"h-4 w-4"})})})]})})]}),q&&e.jsx(ee,{images:W,initialIndex:K,onClose:H})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"📄"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Transaction not found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"The transaction you're looking for doesn't exist."}),e.jsx("div",{className:"mt-6",children:e.jsxs(p,{to:`/project/${r}?tab=transactions`,className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),"Back"]})})]})}export{Ne as default};
//# sourceMappingURL=TransactionDetail.js.map
