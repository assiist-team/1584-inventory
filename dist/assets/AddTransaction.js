import{u as oe,U as ce,j as e}from"./index.js";import{u as le,b as me,L as T}from"./router.js";import{r as d}from"./vendor.js";import{T as P}from"./transactionSources.js";import{p as de,t as G,i as V}from"./inventoryService.js";import{I as $}from"./imageService.js";import{T as ge,I as ue}from"./TransactionItemsList.js";import{q as pe,d as he,b as xe,r as ye}from"./ui.js";import"./firebase.js";import"./ImagePreview.js";import"./ImageGallery.js";function Se(){const{id:l}=le(),W=me(),{hasRole:X}=oe();if(!X(ce.DESIGNER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(pe,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to add transactions. Please contact an administrator if you need access."}),e.jsx(T,{to:`/project/${l}`,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Project"})]})});const[b,H]=d.useState("");d.useEffect(()=>{(async()=>{if(l)try{const r=await de.getProject(l);r&&H(r.name)}catch(r){console.error("Failed to fetch project:",r)}})()},[l]);const[a,E]=d.useState({transaction_date:(()=>{const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`})(),source:"",transaction_type:"Purchase",payment_method:"",amount:"",budget_category:"Furnishings",notes:"",transaction_images:[],receipt_emailed:!1,items:[]}),[h,D]=d.useState([]),[R,J]=d.useState(new Map),[U,f]=d.useState(!1);d.useEffect(()=>{a.source&&!P.includes(a.source)?f(!0):a.source&&P.includes(a.source)&&f(!1)},[a.source]);const[s,u]=d.useState({}),[w,k]=d.useState(!1),[C,I]=d.useState(!1),Q=()=>{var r;const t={};return a.source.trim()||(t.source="Source is required"),a.transaction_type.trim()||(t.transaction_type="Transaction type is required"),a.payment_method.trim()||(t.payment_method="Payment method is required"),(r=a.budget_category)!=null&&r.trim()||(t.budget_category="Budget category is required"),a.amount.trim()?(isNaN(Number(a.amount))||Number(a.amount)<=0)&&(t.amount="Amount must be a positive number"):t.amount="Amount is required",a.transaction_date||(t.transaction_date="Transaction date is required"),u(t),Object.keys(t).length===0},Z=async t=>{var r,m,g,A,M,q,L,z,O;if(t.preventDefault(),!(!Q()||!l)){k(!0);try{const{transaction_images:j,...se}=a,_={...se,project_id:l,project_name:b,created_by:"system"};console.log("Attempting to create transaction with data:",_),console.log("Transaction date value:",_.transaction_date),console.log("Transaction date type:",typeof _.transaction_date),console.log("Transaction items:",h);const F=await G.createTransaction(l,_,h);if(a.transaction_images&&a.transaction_images.length>0){I(!0);try{const i=await $.uploadMultipleTransactionImages(a.transaction_images,b,F,ae),o=$.convertFilesToTransactionImages(i);if(console.log("Transaction images uploaded successfully:",o.length,"images"),console.log("Transaction images to save:",o),o&&o.length>0){console.log("Updating transaction with transaction images...");try{await G.updateTransaction(l,F,{transaction_images:o}),console.log("Transaction updated successfully with transaction images")}catch(p){console.error("Failed to update transaction with transaction images:",p)}}await new Promise(p=>setTimeout(p,500))}catch(i){console.error("Error uploading images:",i);let o="Failed to upload transaction images. Please try again.";(r=i.message)!=null&&r.includes("Storage service is not available")?o="Storage service is unavailable. Please check your internet connection.":(m=i.message)!=null&&m.includes("Network error")||(g=i.message)!=null&&g.includes("offline")?o="Network connection issue. Please check your internet and try again.":(A=i.message)!=null&&A.includes("quota exceeded")?o="Storage quota exceeded. Please contact support.":(M=i.message)!=null&&M.includes("Unauthorized")?o="Permission denied. Please check your account permissions.":((q=i.message)!=null&&q.includes("CORS")||(L=i.message)!=null&&L.includes("Access-Control")||(z=i.message)!=null&&z.includes("ERR_FAILED")||(O=i.message)!=null&&O.includes("preflight"))&&(o="Upload blocked by browser security policy. Please check Firebase Storage configuration or try refreshing the page."),u({transaction_images:o}),k(!1),I(!1);return}I(!1)}if(R.size>0)try{console.log("Starting image upload process...");const i=await V.getTransactionItems(l,F);console.log("Created item IDs:",i);for(let o=0;o<h.length&&o<i.length;o++){const p=h[o],N=i[o],x=R.get(p.id);if(x&&x.length>0){console.log(`Uploading ${x.length} images for item ${N}`);const re=x.map(async(c,ne)=>{var B,K;try{console.log(`Uploading file ${ne+1}/${x.length}: ${c.name}`);const y=await $.uploadItemImage(c,b,N);console.log(`Upload successful for ${c.name}:`,y),console.log(`Upload result URL: ${y.url}`);const Y={url:y.url,alt:c.name,isPrimary:((K=(B=p.images)==null?void 0:B.find(ie=>ie.fileName===c.name))==null?void 0:K.isPrimary)||!1,uploadedAt:new Date,fileName:c.name,size:c.size,mimeType:c.type};return console.log("Created ItemImage object:",Y),Y}catch(y){return console.error(`Failed to upload ${c.name}:`,y),{url:"",alt:c.name,isPrimary:!1,uploadedAt:new Date,fileName:c.name,size:c.size,mimeType:c.type}}}),S=await Promise.all(re);console.log("All uploads completed, updating item with images:",S);const v=S.filter(c=>c.url&&c.url.trim()!=="");console.log(`Valid images to save: ${v.length}/${S.length}`),v.length>0&&(await V.updateItemImages(l,N,v),console.log(`Successfully updated item ${N} with ${v.length} images`))}}}catch(i){console.error("Error in image upload process:",i)}W(`/project/${l}?tab=transactions`)}catch(j){console.error("Error creating transaction:",j),u({general:j instanceof Error?j.message:"Failed to create transaction. Please try again."})}finally{k(!1)}}},n=(t,r)=>{E(m=>({...m,[t]:r})),s[t]&&u(m=>({...m,[t]:void 0}))},ee=t=>{E(r=>({...r,transaction_images:t})),s.transaction_images&&u(r=>({...r,transaction_images:void 0}))},te=(t,r)=>{J(m=>{const g=new Map(m);return g.set(t,r),g}),D(m=>m.map(g=>g.id===t?{...g,imageFiles:r}:g))},ae=(t,r)=>{console.log(`Upload progress for file ${t}: ${r.percentage}%`)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(T,{to:`/project/${l}?tab=transactions`,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(he,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Add Transaction"})}),e.jsxs("form",{onSubmit:Z,className:"space-y-8 p-8",children:[s.general&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:e.jsx("div",{className:"flex",children:e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:s.general})})]})})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"transaction_date",className:"block text-sm font-medium text-gray-700",children:"Transaction Date *"}),e.jsx("input",{type:"date",id:"transaction_date",value:a.transaction_date,onChange:t=>{n("transaction_date",t.target.value)},className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${s.transaction_date?"border-red-300":"border-gray-300"}`}),s.transaction_date&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.transaction_date})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Transaction Source *"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 mb-3",children:P.map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`source_${t.toLowerCase().replace(/\s+/g,"_")}`,name:"source",value:t,checked:a.source===t,onChange:r=>{n("source",r.target.value),f(!1)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`source_${t.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:t})]},t))}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"source_custom",name:"source",value:"custom",checked:U,onChange:()=>{f(!0),n("source","")},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"source_custom",className:"ml-2 block text-sm text-gray-900",children:"Other"})]}),U&&e.jsx("input",{type:"text",id:"source_custom_input",value:a.source,onChange:t=>n("source",t.target.value),placeholder:"Enter custom source...",className:`mt-3 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${s.source?"border-red-300":"border-gray-300"}`}),s.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.source})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Transaction Type *"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"type_purchase",name:"transaction_type",value:"Purchase",checked:a.transaction_type==="Purchase",onChange:t=>n("transaction_type",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"type_purchase",className:"ml-2 block text-sm text-gray-900",children:"Purchase"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"type_return",name:"transaction_type",value:"Return",checked:a.transaction_type==="Return",onChange:t=>n("transaction_type",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"type_return",className:"ml-2 block text-sm text-gray-900",children:"Return"})]})]}),s.transaction_type&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.transaction_type})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"amount",className:"block text-sm font-medium text-gray-700",children:"Amount *"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"amount",value:a.amount,onChange:t=>n("amount",t.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${s.amount?"border-red-300":"border-gray-300"}`})]}),s.amount&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.amount})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Transaction Method *"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"method_client_card",name:"payment_method",value:"Client Card",checked:a.payment_method==="Client Card",onChange:t=>n("payment_method",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"method_client_card",className:"ml-2 block text-sm text-gray-900",children:"Client Card"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"method_1584_card",name:"payment_method",value:"1584 Design",checked:a.payment_method==="1584 Design",onChange:t=>n("payment_method",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"method_1584_card",className:"ml-2 block text-sm text-gray-900",children:"1584 Design"})]})]}),s.payment_method&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.payment_method})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Budget Category *"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_design_fee",name:"budget_category",value:"Design Fee",checked:a.budget_category==="Design Fee",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_design_fee",className:"ml-2 block text-sm text-gray-900",children:"Design Fee"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_furnishings",name:"budget_category",value:"Furnishings",checked:a.budget_category==="Furnishings",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_furnishings",className:"ml-2 block text-sm text-gray-900",children:"Furnishings"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_property_management",name:"budget_category",value:"Property Management",checked:a.budget_category==="Property Management",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_property_management",className:"ml-2 block text-sm text-gray-900",children:"Property Management"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_kitchen",name:"budget_category",value:"Kitchen",checked:a.budget_category==="Kitchen",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_kitchen",className:"ml-2 block text-sm text-gray-900",children:"Kitchen"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_install",name:"budget_category",value:"Install",checked:a.budget_category==="Install",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_install",className:"ml-2 block text-sm text-gray-900",children:"Install"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_storage_receiving",name:"budget_category",value:"Storage & Receiving",checked:a.budget_category==="Storage & Receiving",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_storage_receiving",className:"ml-2 block text-sm text-gray-900",children:"Storage & Receiving"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"budget_fuel",name:"budget_category",value:"Fuel",checked:a.budget_category==="Fuel",onChange:t=>n("budget_category",t.target.value),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"budget_fuel",className:"ml-2 block text-sm text-gray-900",children:"Fuel"})]})]}),s.budget_category&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.budget_category})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Receipt Email Copy"}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"receipt_yes",name:"receipt_emailed",checked:a.receipt_emailed===!0,onChange:()=>n("receipt_emailed",!0),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"receipt_yes",className:"ml-2 block text-sm text-gray-900",children:"Yes"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"receipt_no",name:"receipt_emailed",checked:a.receipt_emailed===!1,onChange:()=>n("receipt_emailed",!1),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"receipt_no",className:"ml-2 block text-sm text-gray-900",children:"No"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:a.notes,onChange:t=>n("notes",t.target.value),placeholder:"Additional notes about this transaction...",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${s.notes?"border-red-300":"border-gray-300"}`}),s.notes&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.notes})]}),e.jsxs("div",{children:[e.jsx(ge,{items:h,onItemsChange:t=>{D(t),s.items&&t.length>0&&u(r=>({...r,items:void 0}))},projectId:l,projectName:b,onImageFilesChange:te}),s.items&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.items})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Transaction Images"}),e.jsx(ue,{onImagesChange:ee,maxImages:5,maxFileSize:10,disabled:w||C,className:"mb-2"}),s.transaction_images&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.transaction_images})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4",children:[e.jsxs(T,{to:`/project/${l}?tab=transactions`,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:w||C,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),w?"Creating...":C?"Uploading Images...":"Create Transaction"]})]})]})]})]})}export{Se as default};
//# sourceMappingURL=AddTransaction.js.map
