import{d as Z,j as e}from"./index.js";import{r as c}from"./vendor.js";import{C as $}from"./ContextBackLink.js";import{C as f}from"./ContextLink.js";import{u as _}from"./useStackedNavigate.js";import{p as ee,u as l,l as te,a as T}from"./inventoryService.js";import{I as se}from"./ImagePreview.js";import{I as L}from"./imageService.js";import{u as re}from"./useDuplication.js";import{I as ae}from"./ItemLineageBreadcrumb.js";import{u as ie}from"./useNavigationContext.js";import{b as oe}from"./router.js";import{P as ne,g as U,D as ce,h as le,i as de,k as N,l as me,T as xe}from"./ui.js";import"./supabase.js";import"./taxPresetsService.js";function Ae(){const{id:o}=oe(),I=_(),{currentAccountId:i}=Z(),{buildContextUrl:x}=ie(),[t,m]=c.useState(null),[B,R]=c.useState(!0),[h,w]=c.useState(!1),[y,z]=c.useState([]),[F,P]=c.useState(!1),[u,g]=c.useState(!1),[d,j]=c.useState({projectId:"",space:""}),[k,S]=c.useState(!1),[b,A]=c.useState(0),C="/business-inventory",{duplicateItem:M}=re({items:t?[t]:[],setItems:s=>{typeof s=="function"?m(r=>s([r])[0]||r):s.length>0&&m(s[0])},duplicationService:async s=>{if(!i)throw new Error("Account ID is required");const r=await l.getItemById(i,s);if(!r)throw new Error("Item not found");const{itemId:a,dateCreated:n,lastUpdated:v,...p}=r;return await l.createItem(i,{...p,inventoryStatus:"available",projectId:null,disposition:p.disposition||"keep"})}}),O=s=>{const r=y.find(a=>a.id===s);return r?`${r.name} - ${r.clientName}`:s};c.useEffect(()=>{o&&i&&(q(),V())},[o,i]),c.useEffect(()=>{const s=r=>{if(u&&!r.target)return;const a=r.target;!a.closest(".project-dropdown")&&!a.closest(".project-dropdown-button")&&g(!1)};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[u]);const V=async()=>{if(i)try{const s=await ee.getProjects(i);z(s)}catch(s){console.error("Error loading projects:",s)}};c.useEffect(()=>!o||!i?void 0:l.subscribeToBusinessInventory(i,r=>{const a=r.find(n=>n.itemId===o);a&&m(a)},{}),[o,i]),c.useEffect(()=>{if(!o||!i)return;const s=te.subscribeToItemLineageForItem(i,o,async()=>{try{const r=await l.getItemById(i,o);r&&m(r)}catch(r){console.debug("BusinessInventoryItemDetail - failed to refetch item on lineage event",r)}});return()=>{try{s()}catch{}}},[o,i]);const q=async()=>{if(!(!o||!i))try{const s=await l.getItemById(i,o);m(s)}catch(s){console.error("Error loading item:",s)}finally{R(!1)}},G=async()=>{if(!(!o||!t||!i)&&window.confirm("Are you sure you want to delete this item? This action cannot be undone."))try{await l.deleteItem(i,o),I("/business-inventory")}catch(s){console.error("Error deleting item:",s),alert("Error deleting item. Please try again.")}},W=()=>{P(!0)},E=()=>{P(!1),g(!1),j({projectId:"",space:""})},K=()=>{const s=y.find(r=>r.id===d.projectId);return s?`${s.name} - ${s.clientName}`:"Select a project..."},H=async()=>{if(!(!o||!d.projectId||!i)){w(!0);try{await l.allocateItemToProject(i,o,d.projectId,void 0,void 0,d.space),E(),I(`/project/${d.projectId}/item/${o}`)}catch(s){console.error("Error allocating item:",s),alert("Error allocating item. Please try again.")}finally{w(!1)}}},J=async()=>{var s,r;if(!(!t||!t.itemId))try{S(!0),A(0);const a=await L.selectFromGallery();if(a&&a.length>0){console.log("Selected",a.length,"files from gallery");for(let n=0;n<a.length;n++){const v=a[n];await Q(v,a)}}else console.log("No files selected from gallery")}catch(a){if(console.error("Error selecting from gallery:",a),(s=a.message)!=null&&s.includes("timeout")||(r=a.message)!=null&&r.includes("canceled")){console.log("User canceled image selection or selection timed out");return}alert("Failed to add images. Please try again.")}finally{S(!1),A(0)}},Q=async(s,r)=>{var D;if(!(t!=null&&t.itemId))return;const n={url:(await L.uploadItemImage(s,"Business Inventory",t.itemId)).url,alt:s.name,isPrimary:((D=t.images)==null?void 0:D.length)===0,uploadedAt:new Date,fileName:s.name,size:s.size,mimeType:s.type};if(!i)return;const p=[...t.images||[],n];await l.updateItem(i,t.itemId,{images:p})},X=async s=>{var r;if(!(!(t!=null&&t.itemId)||!i))try{const a=((r=t.images)==null?void 0:r.filter(n=>n.url!==s))||[];await l.updateItem(i,t.itemId,{images:a}),m({...t,images:a})}catch(a){console.error("Error removing image:",a),alert("Error removing image. Please try again.")}},Y=async s=>{var r;if(!(!(t!=null&&t.itemId)||!i))try{const a=((r=t.images)==null?void 0:r.map(n=>({...n,isPrimary:n.url===s})))||[];await l.updateItem(i,t.itemId,{images:a}),m({...t,images:a})}catch(a){console.error("Error setting primary image:",a),alert("Error setting primary image. Please try again.")}};return B?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"})}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"sticky top-0 bg-gray-50 z-10 px-4 py-2 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs($,{fallback:C,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:space-x-2",children:[t.inventoryStatus==="available"&&e.jsx("button",{onClick:W,disabled:h,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Allocate to Project",children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsx(f,{to:x(`/business-inventory/${o}/edit`),className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Item",children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>t&&M(t.itemId),className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Duplicate Item",children:e.jsx(de,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4",children:e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:t.description})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(N,{className:"h-5 w-5 mr-2"}),"Item Images"]}),e.jsxs("button",{onClick:J,disabled:k,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Add images from gallery or camera",children:[e.jsx(N,{className:"h-3 w-3 mr-1"}),k?b>0&&b<100?`Uploading... ${Math.round(b)}%`:"Uploading...":"Add Images"]})]}),t.images&&t.images.length>0?e.jsx(se,{images:t.images,onRemoveImage:X,onSetPrimary:Y,maxImages:5,size:"md",showControls:!0}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(N,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No images uploaded"})]})]}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(me,{className:"h-5 w-5 mr-2"}),"Item Details"]}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[t.source&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 capitalize",children:t.source})]}),t.sku&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"SKU"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.sku})]}),t.purchasePrice&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Purchase Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"What the item was purchased for"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.purchasePrice]})]}),t.projectPrice&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Project Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"What the client is charged"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.projectPrice]})]}),t.marketValue&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Market Value"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"The fair market value of the item"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.marketValue]})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${t.inventoryStatus==="available"?"bg-green-100 text-green-800":t.inventoryStatus==="allocated"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:t.inventoryStatus==="available"?"Available":t.inventoryStatus==="allocated"?"Allocated":"Sold"})})]}),t.businessInventoryLocation&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Location"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.businessInventoryLocation})]}),t.notes&&t.notes!=="No notes"&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md",children:t.notes})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2 lg:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Date Added"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:T(t.dateCreated)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Last Updated"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:T(t.lastUpdated)})]}),t.projectId&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Project"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:e.jsx(f,{to:x(`/project/${t.projectId}`,{from:"business-inventory-item"}),className:"text-primary-600 hover:text-primary-800 font-medium",children:O(t.projectId)})})]}),t.transactionId&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"TRANSACTION"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:e.jsx(f,{to:x(`/project/${t.projectId}/transaction/${t.transactionId}`,{from:"business-inventory-item"}),className:"text-primary-600 hover:text-primary-800 font-medium",children:t.transactionId})})]}),t.itemId&&e.jsx("div",{className:"sm:col-span-3 mt-2",children:e.jsx(ae,{itemId:t.itemId})}),t.previousProjectTransactionId&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Original Transaction"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.previousProjectId?e.jsx(f,{to:x(`/project/${t.previousProjectId}/transaction/${t.previousProjectTransactionId}`,{from:"business-inventory-item"}),className:"text-primary-600 hover:text-primary-800 font-medium",children:t.previousProjectTransactionId}):e.jsx("span",{children:t.previousProjectTransactionId})})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:G,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Item",children:e.jsx(xe,{className:"h-4 w-4"})})})]})})]})}),F&&e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Allocate Item to Project"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Project"}),e.jsxs("div",{className:"relative mt-1",children:[e.jsxs("button",{type:"button",onClick:()=>g(!u),className:"project-dropdown-button relative w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500 sm:text-sm",children:[e.jsx("span",{className:`block truncate ${d.projectId?"text-gray-900":"text-gray-500"}`,children:K()}),e.jsx("span",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:e.jsx("svg",{className:"h-5 w-5 text-gray-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})})]}),u&&e.jsx("div",{className:"project-dropdown absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base border border-gray-200 overflow-auto focus:outline-none sm:text-sm",children:y.map(s=>e.jsxs("button",{type:"button",onClick:()=>{j(r=>({...r,projectId:s.id})),g(!1)},className:`w-full text-left px-3 py-2 hover:bg-gray-50 ${d.projectId===s.id?"bg-primary-50 text-primary-600":"text-gray-900"}`,children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-sm text-gray-500",children:s.clientName})]},s.id))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Space (optional)"}),e.jsx("input",{type:"text",value:d.space,onChange:s=>j(r=>({...r,space:s.target.value})),placeholder:"e.g. Living Room, Bedroom",className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{type:"button",onClick:E,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"button",onClick:H,disabled:!d.projectId||h,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 disabled:opacity-50",children:h?"Allocating...":"Allocate Item"})]})]})})})]}):e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx(ne,{className:"mx-auto h-16 w-16 text-gray-400 -mb-1"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"Item not found"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"The item you're looking for doesn't exist or has been deleted."}),e.jsxs($,{fallback:C,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Back to Inventory"]})]})}export{Ae as default};
//# sourceMappingURL=BusinessInventoryItemDetail.js.map
