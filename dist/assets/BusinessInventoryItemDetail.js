import{j as e}from"./index.js";import{r as l}from"./vendor.js";import{b as V,c as H,L as y}from"./router.js";import{p as J,b as d}from"./inventoryService.js";import{f as I}from"./dateUtils.js";import{I as Q}from"./ImagePreview.js";import{I as _}from"./imageService.js";import{P as W,e as P,d as X,f as Y,h,i as Z,y as ee,l as te}from"./ui.js";import"./firebase.js";function me(){const{id:n}=V(),k=H(),[t,u]=l.useState(null),[S,A]=l.useState(!0),[m,c]=l.useState(!1),[E,C]=l.useState([]),[U,p]=l.useState(!1),[o,x]=l.useState({projectId:"",amount:"",notes:""}),[f,j]=l.useState(!1),[g,b]=l.useState(0);l.useEffect(()=>{n&&(D(),B())},[n]);const B=async()=>{try{const s=await J.getProjects();C(s)}catch(s){console.error("Error loading projects:",s)}};l.useEffect(()=>n?d.subscribeToBusinessInventory(r=>{const a=r.find(i=>i.item_id===n);a&&u(a)}):void 0,[n]);const D=async()=>{if(n)try{const s=await d.getBusinessInventoryItem(n);u(s)}catch(s){console.error("Error loading item:",s)}finally{A(!1)}},F=async()=>{if(!(!n||!t)&&window.confirm("Are you sure you want to delete this item? This action cannot be undone."))try{await d.deleteBusinessInventoryItem(n),k("/business-inventory")}catch(s){console.error("Error deleting item:",s),alert("Error deleting item. Please try again.")}},M=async()=>{if(!(!n||!(t!=null&&t.pending_transaction_id))){c(!0);try{await d.returnItemFromProject(n,t.pending_transaction_id,t.current_project_id)}catch(s){console.error("Error returning item:",s),alert("Error returning item. Please try again.")}finally{c(!1)}}},T=async s=>{if(!(!n||!(t!=null&&t.pending_transaction_id))){c(!0);try{await d.markItemAsSold(n,t.pending_transaction_id,t.current_project_id,s)}catch(r){console.error("Error marking item as sold:",r),alert("Error marking item as sold. Please try again.")}finally{c(!1)}}},L=()=>{p(!0)},v=()=>{p(!1),x({projectId:"",amount:"",notes:""})},R=async()=>{if(!(!n||!o.projectId||!o.amount)){c(!0);try{await d.allocateItemToProject(n,o.projectId,o.amount,o.notes),v()}catch(s){console.error("Error allocating item:",s),alert("Error allocating item. Please try again.")}finally{c(!1)}}},z=async()=>{var s,r;if(!(!t||!t.item_id))try{j(!0),b(0);const a=await _.selectFromGallery();if(a&&a.length>0){console.log("Selected",a.length,"files from gallery");for(let i=0;i<a.length;i++){const N=a[i];await $(N,a)}}else console.log("No files selected from gallery")}catch(a){if(console.error("Error selecting from gallery:",a),(s=a.message)!=null&&s.includes("timeout")||(r=a.message)!=null&&r.includes("canceled")){console.log("User canceled image selection or selection timed out");return}alert("Failed to add images. Please try again.")}finally{j(!1),b(0)}},$=async(s,r)=>{var w;if(!(t!=null&&t.item_id))return;const i={url:(await _.uploadItemImage(s,"Business Inventory",t.item_id)).url,alt:s.name,isPrimary:((w=t.images)==null?void 0:w.length)===0,uploadedAt:new Date,fileName:s.name,size:s.size,mimeType:s.type},q=[...t.images||[],i];if(await d.updateBusinessInventoryItem(t.item_id,{images:q}),r&&r.indexOf(s)===r.length-1){const K=r.length>1?`${r.length} images uploaded successfully!`:"Image uploaded successfully!";alert(K)}},G=async s=>{var r;if(t!=null&&t.item_id)try{const a=((r=t.images)==null?void 0:r.filter(i=>i.url!==s))||[];await d.updateBusinessInventoryItem(t.item_id,{images:a}),u({...t,images:a})}catch(a){console.error("Error removing image:",a),alert("Error removing image. Please try again.")}},O=async s=>{var r;if(t!=null&&t.item_id)try{const a=((r=t.images)==null?void 0:r.map(i=>({...i,isPrimary:i.url===s})))||[];await d.updateBusinessInventoryItem(t.item_id,{images:a}),u({...t,images:a})}catch(a){console.error("Error setting primary image:",a),alert("Error setting primary image. Please try again.")}};return S?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"})}):t?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"sticky top-0 bg-gray-50 z-10 px-4 py-2 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs(y,{to:"/business-inventory",className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(P,{className:"h-4 w-4 mr-1"}),"Back"]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:space-x-2",children:[t.inventory_status==="available"&&e.jsx("button",{onClick:L,disabled:m,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Allocate to Project",children:e.jsx(X,{className:"h-4 w-4"})}),e.jsx(y,{to:`/business-inventory/${n}/edit`,className:"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",title:"Edit Item",children:e.jsx(Y,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-white shadow rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4",children:e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:t.description})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:[e.jsx(h,{className:"h-5 w-5 mr-2"}),"Item Images"]}),e.jsxs("button",{onClick:z,disabled:f,className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",title:"Add images from gallery or camera",children:[e.jsx(h,{className:"h-3 w-3 mr-1"}),f?g>0&&g<100?`Uploading... ${Math.round(g)}%`:"Uploading...":"Add Images"]})]}),t.images&&t.images.length>0?e.jsx(Q,{images:t.images,onRemoveImage:G,onSetPrimary:O,maxImages:5,size:"md",showControls:!0}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(h,{className:"mx-auto h-8 w-8 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No images uploaded"})]})]}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4 flex items-center",children:[e.jsx(Z,{className:"h-5 w-5 mr-2"}),"Item Details"]}),e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2",children:[t.source&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Source"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 capitalize",children:t.source})]}),t.sku&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"SKU"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.sku})]}),t.price&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Price"}),e.jsxs("dd",{className:"mt-1 text-sm text-gray-900 font-medium",children:["$",t.price]})]}),t.market_value&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Market Value"}),e.jsxs("dd",{className:"mt-1 text-sm text-green-600 font-medium",children:["$",t.market_value]})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Status"}),e.jsx("dd",{className:"mt-1",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${t.inventory_status==="available"?"bg-green-100 text-green-800":t.inventory_status==="pending"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:t.inventory_status==="available"?"Available":t.inventory_status==="pending"?"Allocated":"Sold"})})]}),t.business_inventory_location&&e.jsxs("div",{children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Location"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:t.business_inventory_location})]}),t.notes&&t.notes!=="No notes"&&e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("dt",{className:"text-sm font-medium text-gray-500",children:"Notes"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md",children:t.notes})]})]})]}),t.current_project_id&&e.jsxs("div",{className:"px-6 py-4 bg-blue-50",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Project Assignment"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Currently allocated to project: ",e.jsx("span",{className:"font-medium",children:t.current_project_id})]}),t.pending_transaction_id&&e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Pending transaction: ",t.pending_transaction_id]})]}),e.jsx("div",{className:"flex gap-2",children:t.inventory_status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:M,disabled:m,className:"inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Return to Inventory"}),e.jsxs("button",{onClick:()=>T("Client Card"),disabled:m,className:"inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition-colors disabled:opacity-50",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Mark as Sold"]})]})})]})]}),e.jsx("div",{className:"px-6 py-4 bg-gray-50",children:e.jsxs("div",{className:"relative",children:[e.jsxs("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Date Added"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:I(t.date_created)})]}),e.jsxs("div",{children:[e.jsx("dt",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Last Updated"}),e.jsx("dd",{className:"mt-1 text-sm text-gray-900",children:I(t.last_updated)})]})]}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx("button",{onClick:F,className:"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",title:"Delete Item",children:e.jsx(te,{className:"h-4 w-4"})})})]})})]})}),U&&e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Allocate Item to Project"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"project-select",className:"block text-sm font-medium text-gray-700",children:"Select Project"}),e.jsxs("select",{id:"project-select",value:o.projectId,onChange:s=>x(r=>({...r,projectId:s.target.value})),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm",children:[e.jsx("option",{value:"",children:"Select a project..."}),E.map(s=>e.jsxs("option",{value:s.id,children:[s.name," - ",s.clientName]},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"allocation-amount",className:"block text-sm font-medium text-gray-700",children:"Amount to Bill Client"}),e.jsx("input",{type:"number",step:"0.01",id:"allocation-amount",value:o.amount,onChange:s=>x(r=>({...r,amount:s.target.value})),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"allocation-notes",className:"block text-sm font-medium text-gray-700",children:"Notes (Optional)"}),e.jsx("textarea",{id:"allocation-notes",rows:3,value:o.notes,onChange:s=>x(r=>({...r,notes:s.target.value})),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"Additional notes about this allocation..."})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 mt-6",children:[e.jsx("button",{type:"button",onClick:v,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"button",onClick:R,disabled:!o.projectId||!o.amount||m,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 disabled:opacity-50",children:m?"Allocating...":"Allocate Item"})]})]})})})]}):e.jsxs("div",{className:"text-center py-12 px-4",children:[e.jsx(W,{className:"mx-auto h-16 w-16 text-gray-400 -mb-1"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"Item not found"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"The item you're looking for doesn't exist or has been deleted."}),e.jsxs(y,{to:"/business-inventory",className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Back to Inventory"]})]})}export{me as default};
//# sourceMappingURL=BusinessInventoryItemDetail.js.map
