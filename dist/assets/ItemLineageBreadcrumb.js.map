{"version":3,"file":"ItemLineageBreadcrumb.js","sources":["../../src/components/ui/ItemLineageBreadcrumb.tsx"],"sourcesContent":["import { useEffect, useState } from 'react'\nimport { Link } from 'react-router-dom'\nimport { useAccount } from '@/contexts/AccountContext'\nimport { lineageService } from '@/services/lineageService'\nimport { transactionService } from '@/services/inventoryService'\nimport type { ItemLineageEdge } from '@/types'\n\ninterface ItemLineageBreadcrumbProps {\n  itemId: string\n  compact?: boolean\n}\n\nexport default function ItemLineageBreadcrumb({ itemId, compact = true }: ItemLineageBreadcrumbProps) {\n  const { currentAccountId } = useAccount()\n  const [edges, setEdges] = useState<ItemLineageEdge[]>([])\n  const [resolvedProjectByTx, setResolvedProjectByTx] = useState<Record<string, string | null>>({})\n\n  useEffect(() => {\n    if (!currentAccountId || !itemId) return\n\n    let unsubscribed = false\n\n    const load = async () => {\n      try {\n        const history = await lineageService.getItemLineageHistory(itemId, currentAccountId)\n        if (unsubscribed) return\n        setEdges(history)\n\n        // Resolve any transaction -> project mappings we don't have yet\n        const txIds = Array.from(new Set(history.flatMap(e => [e.fromTransactionId, e.toTransactionId]).filter(Boolean as any))) as string[]\n        const toResolve = txIds.filter(tx => !resolvedProjectByTx[tx])\n        if (toResolve.length > 0) {\n          const results = await Promise.all(toResolve.map(async (txId) => {\n            try {\n              const res = await transactionService.getTransactionById(currentAccountId, txId)\n              return { txId, projectId: res.projectId || null }\n            } catch (err) {\n              return { txId, projectId: null }\n            }\n          }))\n          const newMap = { ...resolvedProjectByTx }\n          results.forEach(r => { newMap[r.txId] = r.projectId })\n          if (!unsubscribed) setResolvedProjectByTx(newMap)\n        }\n      } catch (err) {\n        console.debug('ItemLineageBreadcrumb - failed to load history', err)\n      }\n    }\n\n    load()\n\n    // Use strict realtime subscription (no polling) for item-level edges.\n    let unsubscribeFn: (() => void) | null = null\n    try {\n      unsubscribeFn = lineageService.subscribeToItemLineageForItem(currentAccountId, itemId, (edge) => {\n        // Append new edge if not already present (guard by id)\n        setEdges(prev => {\n          if (prev.find(e => e.id === edge.id)) return prev\n          return [...prev, edge].sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime())\n        })\n        // Try to resolve any transaction -> project mapping for the new edge nodes\n        const txs = [edge.fromTransactionId, edge.toTransactionId].filter(Boolean) as string[]\n        txs.forEach(async (txId) => {\n          if (!resolvedProjectByTx[txId]) {\n            try {\n              const res = await transactionService.getTransactionById(currentAccountId, txId)\n              setResolvedProjectByTx(prev => ({ ...prev, [txId]: res.projectId || null }))\n            } catch (err) {\n              setResolvedProjectByTx(prev => ({ ...prev, [txId]: null }))\n            }\n          }\n        })\n      })\n    } catch (err) {\n      console.debug('ItemLineageBreadcrumb - failed to subscribe to lineage events', err)\n    }\n\n    return () => {\n      unsubscribed = true\n      if (unsubscribeFn) unsubscribeFn()\n    }\n  }, [currentAccountId, itemId])\n\n  if (!edges || edges.length === 0) {\n    return null\n  }\n\n  // Build a simple path: start = first.fromTransactionId (may be null == Inventory), then append each toTransactionId\n  const path: (string | null)[] = []\n  if (edges.length > 0) {\n    const first = edges[0]\n    path.push(first.fromTransactionId ?? null)\n    edges.forEach(e => path.push(e.toTransactionId ?? null))\n  }\n\n  // Remove consecutive duplicates\n  const compactPath = path.filter((p, idx) => idx === 0 || p !== path[idx - 1])\n\n  return (\n    <nav aria-label=\"Item lineage\" className={compact ? 'text-xs text-gray-600' : 'text-sm text-gray-700'}>\n      <ol className=\"flex items-center gap-2\">\n        {compactPath.map((node, idx) => {\n          const isInventory = !node\n          const displayLabel = isInventory ? 'Inventory' : (node!.length > 12 ? `${node!.slice(0, 12)}…` : node)\n          const projectId = node ? resolvedProjectByTx[node] : null\n          const to = isInventory\n            ? `/business-inventory`\n            : projectId\n              ? `/project/${projectId}/transaction/${node}`\n              : `/project/unknown/transaction/${node}`\n\n          return (\n            <li key={`${node ?? 'inventory'}-${idx}`} className=\"flex items-center\">\n              {idx > 0 && <span className=\"text-gray-300 mx-1\">→</span>}\n              {isInventory ? (\n                <span className=\"text-gray-500\">{displayLabel}</span>\n              ) : (\n                <Link to={to} className=\"text-primary-600 hover:underline\">\n                  {displayLabel}\n                </Link>\n              )}\n            </li>\n          )\n        })}\n      </ol>\n    </nav>\n  )\n}\n\n\n"],"names":["ItemLineageBreadcrumb","itemId","compact","currentAccountId","useAccount","edges","setEdges","useState","resolvedProjectByTx","setResolvedProjectByTx","useEffect","unsubscribed","history","lineageService","toResolve","e","tx","results","txId","res","transactionService","newMap","r","err","unsubscribeFn","edge","prev","a","b","path","first","compactPath","p","idx","jsx","node","isInventory","displayLabel","projectId","to","jsxs","Link"],"mappings":"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"}