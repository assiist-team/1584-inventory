{"version":3,"file":"Projects.js","sources":["../../src/pages/Projects.tsx"],"sourcesContent":["import { useState, useEffect } from 'react'\nimport { Plus, FolderOpen } from 'lucide-react'\nimport { Link } from 'react-router-dom'\nimport { useNavigationContext } from '@/hooks/useNavigationContext'\nimport { Project, Transaction } from '@/types'\nimport { projectService, transactionService } from '@/services/inventoryService'\nimport { useAuth } from '@/contexts/AuthContext'\nimport { useAccount } from '@/contexts/AccountContext'\nimport ProjectForm from '@/components/ProjectForm'\nimport BudgetProgress from '@/components/ui/BudgetProgress'\nimport ContextLink from '@/components/ContextLink'\n\nexport default function Projects() {\n  const { buildContextUrl } = useNavigationContext()\n  const { user } = useAuth()\n  const { currentAccountId, loading: accountLoading } = useAccount()\n  const [projects, setProjects] = useState<Project[]>([])\n  const [transactions, setTransactions] = useState<Record<string, Transaction[]>>({})\n  const [isLoadingData, setIsLoadingData] = useState(false)\n  const [showCreateForm, setShowCreateForm] = useState(false)\n  \n  // Combined loading state - show loading if account is loading OR data is loading\n  const isLoading = accountLoading || isLoadingData\n\n  useEffect(() => {\n    console.log('ðŸ” Projects - useEffect triggered. accountLoading:', accountLoading, 'currentAccountId:', currentAccountId, 'isLoading:', isLoading)\n    \n    let unsubscribe: (() => void) | undefined\n\n    const setupSubscription = (initialProjects: Project[]) => {\n      if (!currentAccountId) return\n      unsubscribe = projectService.subscribeToProjects(\n        currentAccountId,\n        (updatedProjects) => {\n          setProjects(updatedProjects)\n          // Also refetch transactions when projects change\n          loadTransactionsForProjects(updatedProjects)\n        },\n        initialProjects\n      )\n    }\n\n    const loadTransactionsForProjects = async (projectsToLoad: Project[]) => {\n      if (!currentAccountId || projectsToLoad.length === 0) {\n        setTransactions({})\n        return\n      }\n\n      try {\n        const projectIds = projectsToLoad.map(p => p.id)\n        const allTransactions = await transactionService.getTransactionsForProjects(currentAccountId, projectIds, projectsToLoad)\n        const transactionsByProject: Record<string, Transaction[]> = {}\n        allTransactions.forEach(t => {\n          if (!t.projectId) return;\n          if (!transactionsByProject[t.projectId]) {\n            transactionsByProject[t.projectId] = []\n          }\n          transactionsByProject[t.projectId].push(t)\n        })\n        setTransactions(transactionsByProject)\n      } catch (error) {\n        console.error('Error loading transactions for projects:', error)\n        setTransactions({})\n      }\n    }\n\n    const loadInitialData = async () => {\n      console.log('ðŸ” Projects - loadInitialData called. accountLoading:', accountLoading, 'currentAccountId:', currentAccountId)\n      \n      // Don't load if account is still loading - wait for it to finish\n      // The useEffect will re-run when accountLoading changes to false\n      if (accountLoading) {\n        console.log('ðŸ” Projects - Account still loading, waiting...')\n        return\n      }\n\n      if (currentAccountId) {\n        console.log('ðŸ” Projects - Loading projects for account:', currentAccountId)\n        setIsLoadingData(true)\n        try {\n          const projectsData = await projectService.getProjects(currentAccountId)\n          console.log('ðŸ” Projects - Loaded', projectsData.length, 'projects')\n          setProjects(projectsData)\n          await loadTransactionsForProjects(projectsData)\n          setupSubscription(projectsData)\n        } catch (error) {\n          console.error('Error loading initial projects data:', error)\n          setProjects([])\n          setTransactions({})\n        } finally {\n          setIsLoadingData(false)\n        }\n      } else {\n        console.log('ðŸ” Projects - No account ID, clearing data')\n        setIsLoadingData(false)\n        setProjects([])\n        setTransactions({})\n      }\n    }\n\n    loadInitialData()\n\n    return () => {\n      if (unsubscribe) {\n        unsubscribe()\n      }\n    }\n  }, [currentAccountId, accountLoading])\n\n  const handleCreateProject = async (projectData: any) => {\n    if (!user?.email) {\n      throw new Error('User must be authenticated to create projects')\n    }\n    if (!currentAccountId) {\n      throw new Error('Account ID is required to create projects')\n    }\n\n    try {\n      await projectService.createProject(currentAccountId, {\n        ...projectData,\n        createdBy: user.id\n      })\n      // The subscription will handle the update\n      setShowCreateForm(false)\n    } catch (error) {\n      console.error('Error creating project:', error)\n      throw error // Let the form handle the error\n    }\n  }\n\n  const handleShowCreateForm = () => {\n    setShowCreateForm(true)\n  }\n\n  const handleCloseCreateForm = () => {\n    setShowCreateForm(false)\n  }\n\n  // Check if not loading but no account - this shouldn't happen with proper auth/account flow\n  // but we guard against it for UX safety\n  if (!isLoading && !accountLoading && !currentAccountId) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"flex justify-between items-center\">\n          <h1 className=\"text-2xl font-bold text-gray-900\">Projects</h1>\n        </div>\n        <div className=\"bg-white shadow rounded-lg border border-yellow-200 bg-yellow-50\">\n          <div className=\"px-4 py-5 sm:p-6\">\n            <div className=\"text-center py-12\">\n              <FolderOpen className=\"mx-auto h-12 w-12 text-yellow-600\" />\n              <h3 className=\"mt-2 text-sm font-medium text-gray-900\">\n                No Account Selected\n              </h3>\n              <p className=\"mt-1 text-sm text-gray-600\">\n                Please select or create an account to view projects.\n              </p>\n              <div className=\"mt-6\">\n                <Link\n                  to=\"/settings\"\n                  className=\"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n                >\n                  Go to Settings\n                </Link>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Projects</h1>\n        </div>\n        <div className=\"flex space-x-3\">\n          <button\n            onClick={handleShowCreateForm}\n            className=\"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n          >\n            <Plus className=\"h-4 w-4 mr-2\" />\n            New\n          </button>\n        </div>\n      </div>\n\n      {/* Projects Grid */}\n      {isLoading ? (\n        <div className=\"flex justify-center items-center h-64\">\n          <div className=\"text-center\">\n            <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto\"></div>\n            <p className=\"mt-2 text-sm text-gray-600\">Loading projects...</p>\n          </div>\n        </div>\n      ) : projects.length === 0 ? (\n        <div className=\"bg-white shadow rounded-lg\">\n          <div className=\"px-4 py-5 sm:p-6\">\n            <div className=\"text-center py-12\">\n              <FolderOpen className=\"mx-auto h-12 w-12 text-gray-400\" />\n              <h3 className=\"mt-2 text-sm font-medium text-gray-900\">\n                No projects yet\n              </h3>\n              <p className=\"mt-1 text-sm text-gray-500\">\n                Create your first project to start organizing your inventory.\n              </p>\n              <div className=\"mt-6\">\n                <button\n                  onClick={handleShowCreateForm}\n                  className=\"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Create Project\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      ) : (\n        <div className=\"grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3\">\n          {projects.map((project) => (\n            <div key={project.id} className=\"bg-white shadow rounded-lg border border-gray-200\">\n              <div className=\"p-6\">\n                {/* Project Header */}\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center\">\n                    <FolderOpen className=\"h-8 w-8 text-primary-600 mr-3\" />\n                    <h3 className=\"text-lg font-semibold text-gray-900\">\n                      {project.name}\n                    </h3>\n                  </div>\n                </div>\n\n                {/* Project Client */}\n                <div className=\"mb-4\">\n                  <div className=\"text-sm font-normal text-gray-900 ml-11\">\n                    {project.clientName}\n                  </div>\n                </div>\n\n                {/* Budget Progress */}\n                <div className=\"mb-4\">\n                  <BudgetProgress\n                    budget={project.budget}\n                    designFee={project.designFee}\n                    budgetCategories={project.budgetCategories}\n                    transactions={transactions[project.id] || []}\n                    previewMode={true}\n                  />\n                </div>\n\n\n\n\n                {/* Action Button */}\n                <div className=\"flex justify-center\">\n                  <ContextLink\n                    to={buildContextUrl(`/project/${project.id}`)}\n                    className=\"flex-1 inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n                  >\n                    <FolderOpen className=\"h-4 w-4 mr-2\" />\n                    Open Project\n                  </ContextLink>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* Project Creation Form */}\n      {showCreateForm && (\n        <ProjectForm\n          onSubmit={handleCreateProject}\n          onCancel={handleCloseCreateForm}\n        />\n      )}\n\n    </div>\n  )\n}\n"],"names":["Projects","buildContextUrl","useNavigationContext","user","useAuth","currentAccountId","accountLoading","useAccount","projects","setProjects","useState","transactions","setTransactions","isLoadingData","setIsLoadingData","showCreateForm","setShowCreateForm","isLoading","useEffect","unsubscribe","setupSubscription","initialProjects","projectService","updatedProjects","loadTransactionsForProjects","projectsToLoad","projectIds","p","allTransactions","transactionService","transactionsByProject","t","error","projectsData","handleCreateProject","projectData","handleShowCreateForm","handleCloseCreateForm","jsxs","jsx","FolderOpen","Link","Plus","project","BudgetProgress","ContextLink","ProjectForm"],"mappings":"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"}