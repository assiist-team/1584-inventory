{"version":3,"file":"TransactionDetail.js","sources":["../../src/components/ui/TransactionAudit.tsx","../../src/pages/TransactionDetail.tsx"],"sourcesContent":["import { useState, useEffect } from 'react'\nimport { Transaction, Item, TransactionCompleteness } from '@/types'\nimport { transactionService, unifiedItemsService } from '@/services/inventoryService'\nimport { formatCurrency } from '@/utils/dateUtils'\nimport { ChevronDown, ChevronUp, AlertTriangle, CheckCircle2, XCircle, Plus } from 'lucide-react'\nimport { useToast } from './ToastContext'\nimport { useAccount } from '@/contexts/AccountContext'\n\ninterface TransactionAuditProps {\n  transaction: Transaction\n  projectId: string\n  transactionItems: Item[]\n  onItemsUpdated: () => void\n}\n\nexport default function TransactionAudit({\n  transaction,\n  projectId,\n  transactionItems,\n  onItemsUpdated\n}: TransactionAuditProps) {\n  const { currentAccountId } = useAccount()\n  const { showError, showSuccess } = useToast()\n  const [completeness, setCompleteness] = useState<TransactionCompleteness | null>(null)\n  const [isLoading, setIsLoading] = useState(true)\n  const [showSuggested, setShowSuggested] = useState(true)\n  const [suggestedItems, setSuggestedItems] = useState<Item[]>([])\n  const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false)\n\n  // Filter out transaction types that don't require item attribution\n  const shouldShowAudit = transaction.transactionType !== 'Return' && \n                          transaction.transactionType !== 'Internal Transfer'\n  \n  if (!shouldShowAudit) {\n    return null\n  }\n\n  // Load completeness metrics\n  useEffect(() => {\n    const loadCompleteness = async () => {\n      if (!currentAccountId || !transaction.transactionId || !projectId) return\n\n      setIsLoading(true)\n      try {\n        const metrics = await transactionService.getTransactionCompleteness(\n          currentAccountId,\n          projectId,\n          transaction.transactionId\n        )\n        setCompleteness(metrics)\n      } catch (error) {\n        console.error('Error loading completeness metrics:', error)\n        // Set default completeness for error cases\n        setCompleteness({\n          itemsNetTotal: 0,\n          itemsCount: transactionItems.length,\n          itemsMissingPriceCount: transactionItems.filter(item => !item.purchasePrice || item.purchasePrice.trim() === '').length,\n          transactionSubtotal: parseFloat(transaction.amount || '0'),\n          completenessRatio: 0,\n          completenessStatus: transactionItems.length === 0 ? 'incomplete' : 'complete',\n          missingTaxData: !transaction.taxRatePct && !transaction.subtotal,\n          varianceDollars: 0,\n          variancePercent: 0\n        })\n      } finally {\n        setIsLoading(false)\n      }\n    }\n\n    loadCompleteness()\n  }, [currentAccountId, projectId, transaction.transactionId, transactionItems, transaction.amount, transaction.taxRatePct, transaction.subtotal])\n\n  // Load suggested items when status is yellow or red\n  useEffect(() => {\n    const loadSuggestions = async () => {\n      if (!currentAccountId || !completeness) return\n      if (completeness.completenessStatus === 'complete') {\n        setSuggestedItems([])\n        return\n      }\n\n      setIsLoadingSuggestions(true)\n      try {\n        const items = await transactionService.getSuggestedItemsForTransaction(\n          currentAccountId,\n          transaction.source,\n          5\n        )\n        // Filter out items whose purchasePrice exceeds remaining amount (subtotal - items total)\n        let filteredItems = items\n        if (completeness) {\n          const remaining = completeness.transactionSubtotal - completeness.itemsNetTotal\n          filteredItems = (items || []).filter(it => {\n            const price = parseFloat((it.purchasePrice as any) || '0')\n            // If price is NaN treat as 0 (include). Exclude only when price > remaining.\n            if (isNaN(price)) return true\n            return price <= remaining\n          })\n        }\n        setSuggestedItems(filteredItems)\n      } catch (error) {\n        console.error('Error loading suggested items:', error)\n      } finally {\n        setIsLoadingSuggestions(false)\n      }\n    }\n\n    loadSuggestions()\n  }, [currentAccountId, transaction.source, completeness?.completenessStatus])\n\n  const handleAddItemToTransaction = async (item: Item) => {\n    if (!currentAccountId || !transaction.transactionId) return\n\n    try {\n      await unifiedItemsService.addItemToTransaction(\n        currentAccountId,\n        item.itemId,\n        transaction.transactionId,\n        item.purchasePrice || '0',\n        transaction.transactionType as 'Purchase' | 'Sale' | 'To Inventory',\n        'Manual',\n        'Added via transaction audit'\n      )\n      showSuccess('Item added to transaction')\n      // Optimistically remove the item from the suggested list so UI updates immediately\n      setSuggestedItems(prev => prev.filter(si => si.itemId !== item.itemId))\n      onItemsUpdated()\n\n      // Refresh suggestions from server to ensure consistency (server filters on transaction_id = null)\n      try {\n        setIsLoadingSuggestions(true)\n        const freshItems = await transactionService.getSuggestedItemsForTransaction(\n          currentAccountId,\n          transaction.source,\n          5\n        )\n        // Apply the same remaining-price filter used by loadSuggestions\n        let filteredItems = freshItems\n        if (completeness) {\n          const remaining = completeness.transactionSubtotal - completeness.itemsNetTotal\n          filteredItems = (freshItems || []).filter(it => {\n            const price = parseFloat((it.purchasePrice as any) || '0')\n            if (isNaN(price)) return true\n            return price <= remaining\n          })\n        }\n        setSuggestedItems(filteredItems)\n      } catch (refreshError) {\n        console.error('Error refreshing suggested items after add:', refreshError)\n      } finally {\n        setIsLoadingSuggestions(false)\n      }\n    } catch (error) {\n      console.error('Error adding item to transaction:', error)\n      showError('Failed to add item to transaction')\n    }\n  }\n\n  if (isLoading || !completeness) {\n    return (\n      <div className=\"bg-white shadow rounded-lg p-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-4 bg-gray-200 rounded w-1/4 mb-4\"></div>\n          <div className=\"h-2 bg-gray-200 rounded w-full\"></div>\n        </div>\n      </div>\n    )\n  }\n\n  const getStatusColor = (status: TransactionCompleteness['completenessStatus']) => {\n    switch (status) {\n      case 'complete':\n        return 'bg-green-500'\n      case 'near':\n        return 'bg-yellow-500'\n      case 'incomplete':\n      case 'over':\n        return 'bg-red-500'\n      default:\n        return 'bg-gray-500'\n    }\n  }\n\n  const getStatusIcon = (status: TransactionCompleteness['completenessStatus']) => {\n    switch (status) {\n      case 'complete':\n        return <CheckCircle2 className=\"h-5 w-5 text-green-600\" />\n      case 'near':\n        return <AlertTriangle className=\"h-5 w-5 text-yellow-600\" />\n      case 'incomplete':\n      case 'over':\n        return <XCircle className=\"h-5 w-5 text-red-600\" />\n      default:\n        return null\n    }\n  }\n\n  const getStatusLabel = (status: TransactionCompleteness['completenessStatus']) => {\n    switch (status) {\n      case 'complete':\n        return 'Complete'\n      case 'near':\n        return 'Needs Review'\n      case 'incomplete':\n        return 'Incomplete'\n      case 'over':\n        return 'Over Budget'\n      default:\n        return 'Unknown'\n    }\n  }\n\n  const itemsMissingPrice = transactionItems.filter(item => {\n    const purchasePrice = item.purchasePrice\n    return !purchasePrice || purchasePrice.trim() === '' || parseFloat(purchasePrice) === 0\n  })\n\n  const progressPercentage = Math.min(completeness.completenessRatio * 100, 100)\n  // Labels: show explicit subtotal vs estimated subtotal and clarify item totals are pre-tax\n  const subtotalLabel = transaction.subtotal ? 'Subtotal (pre-tax)' : 'Estimated subtotal (pre-tax)'\n  const itemsLabel = 'Associated items total (pre-tax)'\n  const taxLabel = 'Calculated tax'\n  // Dollar remaining (positive means remaining to reach subtotal; negative means over by)\n  const remainingDollars = Math.round((completeness.transactionSubtotal - completeness.itemsNetTotal) * 100) / 100\n  const remainingLabel = remainingDollars >= 0\n    ? `${formatCurrency(remainingDollars.toString())} remaining`\n    : `Over by ${formatCurrency(Math.abs(remainingDollars).toString())}`\n\n  return (\n    <div className=\"bg-white shadow rounded-lg overflow-hidden\">\n      <div className=\"px-6 py-4 border-b border-gray-200\">\n          <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-lg font-medium text-gray-900\">Transaction Audit</h3>\n        </div>\n      </div>\n\n      <div className=\"px-6 py-4\">\n        {/* Progress Tracker */}\n        <div className=\"mb-6\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <div className=\"flex items-center gap-2\">\n              {getStatusIcon(completeness.completenessStatus)}\n              <span className=\"text-base font-medium text-gray-900\">\n                {getStatusLabel(completeness.completenessStatus)}\n              </span>\n            </div>\n            <span className=\"text-sm text-gray-500\">\n              {formatCurrency(completeness.itemsNetTotal.toString())} / {formatCurrency(completeness.transactionSubtotal.toString())}\n            </span>\n          </div>\n\n          {/* Progress Bar */}\n          <div className=\"relative\">\n            <div className=\"w-full bg-gray-200 rounded-full h-3 mb-1\">\n              <div\n                className={`h-3 rounded-full transition-all duration-300 ${getStatusColor(completeness.completenessStatus)}`}\n                style={{ width: `${Math.min(progressPercentage, 100)}%` }}\n              />\n            </div>\n            <div className=\"flex items-center justify-between text-xs text-gray-500 mt-1\">\n              <span>{completeness.itemsCount} items</span>\n              <span>{remainingLabel}</span>\n            </div>\n          </div>\n\n          {/* Tooltip-like info */}\n          <div className=\"mt-3 text-xs text-gray-600 space-y-1\">\n            {completeness.itemsCount === 0 ? (\n              <div className=\"text-red-600 font-medium\">No items linked yet</div>\n            ) : (\n              <>\n            <div>{subtotalLabel}: {formatCurrency(completeness.transactionSubtotal.toString())}</div>\n            <div>{itemsLabel}: {formatCurrency(completeness.itemsNetTotal.toString())}</div>\n            {completeness.inferredTax !== undefined && (\n              <div>{taxLabel}: {formatCurrency(completeness.inferredTax.toString())}</div>\n            )}\n                {completeness.itemsMissingPriceCount > 0 && (\n                  <div className=\"text-yellow-600\">\n                    {completeness.itemsMissingPriceCount} items missing purchase price\n                  </div>\n                )}\n              </>\n            )}\n          </div>\n        </div>\n\n        {/* Missing Tax Data Warning */}\n        {completeness.missingTaxData && (\n          <div className=\"mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md\">\n            <div className=\"flex items-start\">\n              <AlertTriangle className=\"h-5 w-5 text-yellow-600 mr-2 flex-shrink-0 mt-0.5\" />\n              <div className=\"text-sm text-yellow-800\">\n                <strong>Tax rate not set.</strong> Set tax rate or transaction subtotal for accurate calculations.\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Missing Purchase Price */}\n        {itemsMissingPrice.length > 0 && (\n          <div className=\"space-y-4 border-t border-gray-200 pt-4\">\n            <div>\n              <h4 className=\"text-sm font-medium text-gray-900 mb-2\">Missing Purchase Price</h4>\n              <div className=\"overflow-x-auto\">\n                <table className=\"min-w-full divide-y divide-gray-200\">\n                  <thead className=\"bg-gray-50\">\n                    <tr>\n                      <th className=\"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase\">Item</th>\n                      <th className=\"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase\">SKU</th>\n                      <th className=\"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase\">Action</th>\n                    </tr>\n                  </thead>\n                  <tbody className=\"bg-white divide-y divide-gray-200\">\n                    {itemsMissingPrice.map((item) => (\n                      <tr key={item.itemId}>\n                        <td className=\"px-3 py-2 text-sm text-gray-900\">{item.description}</td>\n                        <td className=\"px-3 py-2 text-sm text-gray-500\">{item.sku || '-'}</td>\n                        <td className=\"px-3 py-2 text-sm\">\n                          <a\n                            href={`/project/${projectId}/item/${item.itemId}/edit`}\n                            className=\"text-primary-600 hover:text-primary-800\"\n                          >\n                            Edit Price\n                          </a>\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Suggested Items toggle and list (moved out of details) */}\n        {(completeness.completenessStatus === 'near' || completeness.completenessStatus === 'incomplete') && (\n          <div className=\"mt-4 border-t border-gray-200 pt-4\">\n            <button\n              onClick={() => setShowSuggested(!showSuggested)}\n              className=\"inline-flex items-center text-sm font-medium text-primary-600 hover:text-primary-800\"\n            >\n              {showSuggested ? (\n                <>\n                  <ChevronUp className=\"h-4 w-4 mr-1\" />\n                  Hide suggested items\n                </>\n              ) : (\n                <>\n                  <ChevronDown className=\"h-4 w-4 mr-1\" />\n                  Show suggested items to add\n                </>\n              )}\n            </button>\n\n            {showSuggested && (\n              isLoadingSuggestions ? (\n                <div className=\"text-sm text-gray-500 mt-3\">Loading suggestions...</div>\n              ) : suggestedItems.length > 0 ? (\n                <div className=\"space-y-2 mt-3\">\n                  {suggestedItems.map((item) => (\n                    <div\n                      key={item.itemId}\n                      className=\"flex items-center justify-between p-2 bg-gray-50 rounded-md\"\n                    >\n                      <div className=\"flex-1\">\n                        <div className=\"text-sm font-medium text-gray-900\">{item.description}</div>\n                        <div className=\"text-xs text-gray-500\">\n                          {item.sku && `SKU: ${item.sku}`}\n                          {item.purchasePrice && ` â€¢ ${formatCurrency(item.purchasePrice)}`}\n                        </div>\n                      </div>\n                      <button\n                        onClick={() => handleAddItemToTransaction(item)}\n                        className=\"ml-4 inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50\"\n                      >\n                        <Plus className=\"h-3 w-3 mr-1\" />\n                        Add\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-sm text-gray-500 mt-3\">No unassociated items found for this vendor.</div>\n              )\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\n","import { ArrowLeft, Edit, Trash2, Image as ImageIcon, Package } from 'lucide-react'\nimport { useState, useEffect, useMemo } from 'react'\nimport ImageGallery from '@/components/ui/ImageGallery'\nimport { TransactionImagePreview } from '@/components/ui/ImagePreview'\nimport { Link, useParams, useNavigate } from 'react-router-dom'\nimport { Transaction, Project, Item, TransactionItemFormData, TaxPreset } from '@/types'\nimport { transactionService, projectService, unifiedItemsService } from '@/services/inventoryService'\nimport { lineageService } from '@/services/lineageService'\nimport { ImageUploadService } from '@/services/imageService'\nimport { formatDate, formatCurrency } from '@/utils/dateUtils'\nimport { useToast } from '@/components/ui/ToastContext'\nimport TransactionItemForm from '@/components/TransactionItemForm'\nimport { useNavigationContext } from '@/hooks/useNavigationContext'\nimport { getTaxPresets } from '@/services/taxPresetsService'\nimport { useAccount } from '@/contexts/AccountContext'\nimport type { ItemLineageEdge } from '@/types'\nimport { COMPANY_INVENTORY_SALE, COMPANY_INVENTORY_PURCHASE, CLIENT_OWES_COMPANY, COMPANY_OWES_CLIENT } from '@/constants/company'\nimport TransactionAudit from '@/components/ui/TransactionAudit'\n\n// Remove any unwanted icons from transaction type badges\nconst removeUnwantedIcons = () => {\n  const badges = document.querySelectorAll('.no-icon')\n  badges.forEach(badge => {\n    // Remove any child elements that aren't text nodes\n    const children = Array.from(badge.childNodes)\n    children.forEach(child => {\n      if (child.nodeType !== Node.TEXT_NODE) {\n        if (child.parentNode) {\n          child.parentNode.removeChild(child)\n        }\n      }\n    })\n  })\n}\n\n// Get canonical transaction title for display\nconst getCanonicalTransactionTitle = (transaction: Transaction): string => {\n  // Check if this is a canonical inventory transaction\n  if (transaction.transactionId?.startsWith('INV_SALE_')) {\n    return COMPANY_INVENTORY_SALE\n  }\n  if (transaction.transactionId?.startsWith('INV_PURCHASE_')) {\n    return COMPANY_INVENTORY_PURCHASE\n  }\n  // Return the original source for non-canonical transactions\n  return transaction.source\n}\n\n\nexport default function TransactionDetail() {\n  const { id: projectId, transactionId } = useParams<{ id?: string; transactionId: string }>()\n  const navigate = useNavigate()\n  const { currentAccountId } = useAccount()\n  const [transaction, setTransaction] = useState<Transaction | null>(null)\n  const [project, setProject] = useState<Project | null>(null)\n  const [taxPresets, setTaxPresets] = useState<TaxPreset[]>([])\n\n  // Load tax presets on mount\n  useEffect(() => {\n    const loadPresets = async () => {\n      if (!currentAccountId) return\n      try {\n        const presets = await getTaxPresets(currentAccountId)\n        setTaxPresets(presets)\n      } catch (error) {\n        console.error('Error loading tax presets:', error)\n      }\n    }\n    loadPresets()\n  }, [currentAccountId])\n  const [transactionItems, setTransactionItems] = useState<Item[]>([])\n  // Cache resolved project IDs for transactions referenced by items when item.projectId is missing\n  const [resolvedProjectByTx, setResolvedProjectByTx] = useState<Record<string, string>>({})\n  const [isLoading, setIsLoading] = useState(true)\n  const [isLoadingItems, setIsLoadingItems] = useState(true)\n  const [showGallery, setShowGallery] = useState(false)\n  const [galleryInitialIndex, setGalleryInitialIndex] = useState(0)\n  const [isUploadingReceiptImages, setIsUploadingReceiptImages] = useState(false)\n  const [isUploadingOtherImages, setIsUploadingOtherImages] = useState(false)\n  const [isAddingItem, setIsAddingItem] = useState(false)\n  const [imageFilesMap, setImageFilesMap] = useState<Map<string, File[]>>(new Map())\n  const { showError, showSuccess } = useToast()\n  const { buildContextUrl, getBackDestination } = useNavigationContext()\n\n  // Navigation context logic\n\n  const backDestination = useMemo(() => {\n    // Use navigation context's getBackDestination function\n    return getBackDestination(`/project/${projectId}?tab=transactions`)\n  }, [getBackDestination, projectId])\n\n  // Refresh transaction items\n  const refreshTransactionItems = async () => {\n    if (!currentAccountId || !transactionId) return\n    \n    const actualProjectId = projectId || transaction?.projectId\n    if (!actualProjectId) return\n\n    try {\n      const transactionItems = await unifiedItemsService.getItemsForTransaction(currentAccountId, actualProjectId, transactionId)\n      const itemIds = transactionItems.map(item => item.itemId)\n      const itemsPromises = itemIds.map(id => unifiedItemsService.getItemById(currentAccountId, id))\n      const items = await Promise.all(itemsPromises)\n      const validItems = items.filter(item => item !== null) as Item[]\n      \n      // Fetch edges that moved FROM this transaction to determine \"moved out\" items\n      const edgesFromTransaction = await lineageService.getEdgesFromTransaction(transactionId, currentAccountId)\n      const movedOutItemIds = new Set(edgesFromTransaction.map(edge => edge.itemId))\n      \n      // Split items into \"In this transaction\" vs \"Moved out\"\n      const itemsInTransaction = validItems.filter(item => {\n        // Use latestTransactionId if available, fallback to transactionId for transitional period\n        const currentTransactionId = item.latestTransactionId ?? item.transactionId\n        const isInTransaction = currentTransactionId === transactionId\n        const hasMovedOut = movedOutItemIds.has(item.itemId)\n        // Item is \"in\" if it's currently in this transaction AND hasn't moved out\n        return isInTransaction && !hasMovedOut\n      })\n      \n      const itemsMovedOut = validItems.filter(item => {\n        const hasMovedOut = movedOutItemIds.has(item.itemId)\n        // Transitional fallback: also check previousProjectTransactionId\n        const transitionalMovedOut = !item.latestTransactionId && \n          item.projectId == null && \n          item.previousProjectTransactionId === transactionId\n        return hasMovedOut || transitionalMovedOut\n      })\n      \n      // Store both sets - we'll display them separately\n      const combined = [...itemsInTransaction, ...itemsMovedOut]\n      setTransactionItems(combined)\n      // Resolve any missing project IDs referenced by moved items (fire-and-forget)\n      resolveMissingProjectIds(combined).catch(err => console.debug('resolveMissingProjectIds error:', err))\n    } catch (error) {\n      console.error('Error refreshing transaction items:', error)\n    }\n  }\n\n  useEffect(() => {\n    const loadTransaction = async () => {\n      if (!transactionId || !currentAccountId) return\n\n      try {\n        let actualProjectId = projectId\n        let transactionData: any\n        let projectData: Project | null = null\n\n        if (!actualProjectId) {\n          // For business inventory transactions, we need to find the transaction across all projects\n          console.log('TransactionDetail - No projectId provided, searching across all projects for business inventory transaction')\n          const result = await transactionService.getTransactionById(currentAccountId, transactionId)\n\n          if (!result.transaction || !result.projectId) {\n            console.error('TransactionDetail - Transaction not found in any project')\n            setIsLoading(false)\n            setIsLoadingItems(false)\n            return\n          }\n\n          transactionData = result.transaction\n          actualProjectId = result.projectId\n\n          // Get project data for the found project\n          projectData = await projectService.getProject(currentAccountId, actualProjectId)\n        } else {\n          // Fetch transaction and project data for regular project transactions.\n          // We intentionally do NOT rely on `getItemsForTransaction` here because moved/deallocated\n          // items may have been cleared from the `transaction_id` column. Instead, read\n          // `itemIds` from the transaction row and load each item by `item_id` so moved items\n          // are still discoverable and can be shown in the \"Moved out\" section.\n          const [fetchedTransactionData, fetchedProjectData] = await Promise.all([\n            transactionService.getTransaction(currentAccountId, actualProjectId, transactionId),\n            projectService.getProject(currentAccountId, actualProjectId)\n          ])\n\n          transactionData = fetchedTransactionData\n          projectData = fetchedProjectData\n\n          // Prefer item IDs stored on the transaction record\n          const itemIdsFromTransaction = Array.isArray(transactionData?.itemIds) ? transactionData.itemIds : []\n          if (itemIdsFromTransaction.length > 0 && actualProjectId) {\n            const itemsPromises = itemIdsFromTransaction.map((itemId: string) => unifiedItemsService.getItemById(currentAccountId, itemId))\n            const items = await Promise.all(itemsPromises)\n            const validItems = items.filter(item => item !== null) as Item[]\n            console.log('TransactionDetail - fetched items (from transaction.itemIds):', validItems.length)\n\n            // Include items that were moved out of this transaction by consulting lineage edges.\n            try {\n              const edgesFromTransaction = await lineageService.getEdgesFromTransaction(transactionId, currentAccountId)\n              const movedOutItemIds = new Set(edgesFromTransaction.map(edge => edge.itemId))\n\n              const itemsInTransaction = validItems.filter(item => {\n                const currentTransactionId = item.latestTransactionId ?? item.transactionId\n                const isInTransaction = currentTransactionId === transactionId\n                const hasMovedOut = movedOutItemIds.has(item.itemId)\n                return isInTransaction && !hasMovedOut\n              })\n\n              const itemsMovedOut = validItems.filter(item => {\n                const hasMovedOut = movedOutItemIds.has(item.itemId)\n                const transitionalMovedOut = !item.latestTransactionId &&\n                  item.projectId == null &&\n                  item.previousProjectTransactionId === transactionId\n                return hasMovedOut || transitionalMovedOut\n              })\n\n              const combined = [...itemsInTransaction, ...itemsMovedOut]\n              setTransactionItems(combined)\n              resolveMissingProjectIds(combined).catch(err => console.debug('resolveMissingProjectIds error:', err))\n            } catch (edgeErr) {\n              console.error('TransactionDetail - failed to fetch lineage edges:', edgeErr)\n              setTransactionItems(validItems)\n            }\n          } else {\n            setTransactionItems([])\n          }\n        }\n\n        const convertedTransaction: Transaction = {\n          ...transactionData,\n          transactionImages: Array.isArray(transactionData?.transactionImages) ? transactionData.transactionImages : []\n        } as Transaction\n\n        console.log('TransactionDetail - loaded transactionData:', transactionData)\n        console.log('TransactionDetail - convertedTransaction:', convertedTransaction)\n        console.log('TransactionDetail - actualProjectId:', actualProjectId)\n        setTransaction(convertedTransaction)\n        setProject(projectData)\n\n        // Fetch transaction items for business inventory transactions\n        if (!projectId && actualProjectId) {\n          // For business inventory transactions, prefer item IDs stored on the transaction record\n          // so deallocated/moved items remain discoverable.\n          const transactionItemIds = Array.isArray(transactionData?.itemIds) ? transactionData.itemIds : []\n          if (transactionItemIds.length > 0) {\n            const itemsPromises = transactionItemIds.map((itemId: string) => unifiedItemsService.getItemById(currentAccountId, itemId))\n            const items = await Promise.all(itemsPromises)\n            const validItems = items.filter(item => item !== null) as Item[]\n            console.log('TransactionDetail - fetched items for business inventory transaction:', validItems.length)\n\n            try {\n              const edgesFromTransaction = await lineageService.getEdgesFromTransaction(transactionId, currentAccountId)\n              const movedOutItemIds = new Set(edgesFromTransaction.map(edge => edge.itemId))\n\n              const itemsInTransaction = validItems.filter(item => {\n                const currentTransactionId = item.latestTransactionId ?? item.transactionId\n                const isInTransaction = currentTransactionId === transactionId\n                const hasMovedOut = movedOutItemIds.has(item.itemId)\n                return isInTransaction && !hasMovedOut\n              })\n\n              const itemsMovedOut = validItems.filter(item => {\n                const hasMovedOut = movedOutItemIds.has(item.itemId)\n                const transitionalMovedOut = !item.latestTransactionId &&\n                  item.projectId == null &&\n                  item.previousProjectTransactionId === transactionId\n                return hasMovedOut || transitionalMovedOut\n              })\n\n              const combined = [...itemsInTransaction, ...itemsMovedOut]\n              setTransactionItems(combined)\n              resolveMissingProjectIds(combined).catch(err => console.debug('resolveMissingProjectIds error:', err))\n            } catch (edgeErr) {\n              console.error('TransactionDetail - failed to fetch lineage edges (business inventory):', edgeErr)\n              setTransactionItems(validItems)\n            }\n          } else {\n            setTransactionItems([])\n          }\n        }\n\n      } catch (error) {\n        console.error('Error loading transaction:', error)\n        setTransactionItems([])\n      } finally {\n        setIsLoading(false)\n        setIsLoadingItems(false)\n      }\n    }\n\n    loadTransaction()\n  }, [projectId, transactionId, currentAccountId])\n\n  // Set up real-time subscription for transaction updates\n  useEffect(() => {\n    if (!transactionId || !transaction) return\n    // Use the actual project ID (whether from URL params or discovered from transaction lookup)\n    const actualProjectId = projectId || transaction.projectId\n\n    if (!actualProjectId) return\n\n    // Temporarily disable real-time subscription to debug\n    // const unsubscribe = transactionService.subscribeToTransaction(\n    //   actualProjectId,\n    //   transactionId,\n    //   (updatedTransaction) => {\n    //     if (updatedTransaction) {\n    //       console.log('TransactionDetail - real-time updatedTransaction:', updatedTransaction)\n    //       console.log('TransactionDetail - real-time updatedTransaction.transaction_images:', updatedTransaction.transaction_images)\n    //       console.log('TransactionDetail - real-time updatedTransaction.transaction_images length:', updatedTransaction.transaction_images?.length)\n\n    //       const convertedTransaction: Transaction = {\n    //         ...updatedTransaction,\n    //         transaction_images: Array.isArray(updatedTransaction.transaction_images) ? updatedTransaction.transaction_images : []\n    //       } as Transaction\n\n    //       console.log('TransactionDetail - real-time convertedTransaction:', convertedTransaction)\n    //       setTransaction(convertedTransaction)\n    //     } else {\n    //       setTransaction(null)\n    //     }\n    //   }\n    // )\n\n    // return () => {\n    //   unsubscribe()\n    // }\n  }, [projectId, transactionId, transaction])\n\n  // Subscribe to new lineage edges that moved items FROM this transaction and refresh items (strict realtime)\n  useEffect(() => {\n    if (!currentAccountId || !transactionId) return\n    const unsubscribe = lineageService.subscribeToEdgesFromTransaction(currentAccountId, transactionId, (edge) => {\n      try {\n        // If an edge's from_transaction_id matches this transaction, it indicates the item moved out\n        refreshTransactionItems()\n      } catch (err) {\n        console.debug('TransactionDetail - failed to refresh on lineage event', err)\n      }\n    })\n\n    return () => {\n      try { unsubscribe() } catch (err) { /* noop */ }\n    }\n  }, [currentAccountId, transactionId])\n\n\n  // Clean up any unwanted icons from transaction type badges\n  useEffect(() => {\n    if (transaction) {\n      removeUnwantedIcons()\n      // Also run after a short delay to catch any dynamically added icons\n      const timer = setTimeout(removeUnwantedIcons, 100)\n      const timer2 = setTimeout(removeUnwantedIcons, 500)\n      return () => {\n        clearTimeout(timer)\n        clearTimeout(timer2)\n      }\n    }\n  }, [transaction])\n\n  const handleDelete = async () => {\n    if (!projectId || !transactionId || !transaction || !currentAccountId) return\n\n    if (window.confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {\n      try {\n        await transactionService.deleteTransaction(currentAccountId, projectId, transactionId)\n        navigate(`/project/${projectId}?tab=transactions`)\n      } catch (error) {\n        console.error('Error deleting transaction:', error)\n        showError('Failed to delete transaction. Please try again.')\n      }\n    }\n  }\n\n  const handleImageClick = (index: number) => {\n    setGalleryInitialIndex(index)\n    setShowGallery(true)\n  }\n\n  const handleGalleryClose = () => {\n    setShowGallery(false)\n  }\n\n  const handleReceiptImagesUpload = async (files: File[]) => {\n    if (!projectId || !transactionId || !project || files.length === 0) return\n\n    setIsUploadingReceiptImages(true)\n\n    try {\n      // Upload receipt images\n      const uploadResults = await ImageUploadService.uploadMultipleReceiptImages(\n        files,\n        project.name,\n        transactionId\n      )\n\n      // Convert to TransactionImage format\n      const newReceiptImages = ImageUploadService.convertFilesToReceiptImages(uploadResults)\n\n      // Update transaction with new receipt images\n      const currentReceiptImages = transaction?.receiptImages || []\n      const updatedReceiptImages = [...currentReceiptImages, ...newReceiptImages]\n\n      const updateProjectId = transaction?.projectId || projectId\n      if (!currentAccountId) return\n      await transactionService.updateTransaction(currentAccountId, updateProjectId || '', transactionId, {\n        receiptImages: updatedReceiptImages,\n        transactionImages: updatedReceiptImages // Also update legacy field for compatibility\n      })\n\n      // Refresh transaction data (use actual project_id from transaction)\n      const refreshProjectId = transaction?.projectId || projectId\n      const updatedTransaction = await transactionService.getTransaction(currentAccountId, refreshProjectId || '', transactionId)\n      setTransaction(updatedTransaction)\n\n      showSuccess('Receipt images uploaded successfully')\n    } catch (error) {\n      console.error('Error uploading receipt images:', error)\n      showError('Failed to upload receipt images. Please try again.')\n    } finally {\n      setIsUploadingReceiptImages(false)\n    }\n  }\n\n  const handleOtherImagesUpload = async (files: File[]) => {\n    if (!projectId || !transactionId || !project || files.length === 0) return\n\n    setIsUploadingOtherImages(true)\n\n    try {\n      // Upload other images\n      const uploadResults = await ImageUploadService.uploadMultipleOtherImages(\n        files,\n        project.name,\n        transactionId\n      )\n\n      // Convert to TransactionImage format\n      const newOtherImages = ImageUploadService.convertFilesToOtherImages(uploadResults)\n\n      // Update transaction with new other images\n      const currentOtherImages = transaction?.otherImages || []\n      const updatedOtherImages = [...currentOtherImages, ...newOtherImages]\n\n      const updateProjectId = transaction?.projectId || projectId\n      if (!currentAccountId) return\n      await transactionService.updateTransaction(currentAccountId, updateProjectId || '', transactionId, {\n        otherImages: updatedOtherImages\n      })\n\n      // Refresh transaction data (use actual project_id from transaction)\n      const refreshProjectId = transaction?.projectId || projectId\n      const updatedTransaction = await transactionService.getTransaction(currentAccountId, refreshProjectId || '', transactionId)\n      setTransaction(updatedTransaction)\n\n      showSuccess('Other images uploaded successfully')\n    } catch (error) {\n      console.error('Error uploading other images:', error)\n      showError('Failed to upload other images. Please try again.')\n    } finally {\n      setIsUploadingOtherImages(false)\n    }\n  }\n\n  const handleDeleteReceiptImage = async (imageUrl: string) => {\n    if (!projectId || !transactionId || !transaction || !currentAccountId) return\n\n    try {\n      // Filter out the image to be deleted\n      const currentReceiptImages = transaction.receiptImages || []\n      const updatedReceiptImages = currentReceiptImages.filter(img => img.url !== imageUrl)\n\n      const updateProjectId = transaction?.projectId || projectId\n      await transactionService.updateTransaction(currentAccountId, updateProjectId || '', transactionId, {\n        receiptImages: updatedReceiptImages,\n        transactionImages: updatedReceiptImages // Also update legacy field for compatibility\n      })\n\n      // Refresh transaction data (use actual project_id from transaction)\n      const refreshProjectId = transaction?.projectId || projectId\n      const updatedTransaction = await transactionService.getTransaction(currentAccountId, refreshProjectId || '', transactionId)\n      setTransaction(updatedTransaction)\n\n      showSuccess('Receipt image deleted successfully')\n    } catch (error) {\n      console.error('Error deleting receipt image:', error)\n      showError('Failed to delete receipt image. Please try again.')\n    }\n  }\n\n  const handleDeleteOtherImage = async (imageUrl: string) => {\n    if (!projectId || !transactionId || !transaction) return\n\n    try {\n      // Filter out the image to be deleted\n      const currentOtherImages = transaction.otherImages || []\n      const updatedOtherImages = currentOtherImages.filter(img => img.url !== imageUrl)\n\n      const updateProjectId = transaction?.projectId || projectId\n      if (!currentAccountId) return\n      await transactionService.updateTransaction(currentAccountId, updateProjectId || '', transactionId, {\n        otherImages: updatedOtherImages\n      })\n\n      // Refresh transaction data (use actual project_id from transaction)\n      const refreshProjectId = transaction?.projectId || projectId\n      const updatedTransaction = await transactionService.getTransaction(currentAccountId, refreshProjectId || '', transactionId)\n      setTransaction(updatedTransaction)\n\n      showSuccess('Other image deleted successfully')\n    } catch (error) {\n      console.error('Error deleting other image:', error)\n      showError('Failed to delete other image. Please try again.')\n    }\n  }\n\n  const handleImageFilesChange = (itemId: string, imageFiles: File[]) => {\n    setImageFilesMap(prev => {\n      const newMap = new Map(prev)\n      newMap.set(itemId, imageFiles)\n      return newMap\n    })\n  }\n\n  const handleSaveItem = async (item: TransactionItemFormData) => {\n    if (!projectId || !transactionId || !transaction || !currentAccountId) return\n\n    try {\n      // Create the item linked to the existing transaction\n      const itemData = {\n        ...item,\n        projectId: projectId,\n        transactionId: transactionId,\n        dateCreated: transaction.transactionDate || new Date().toISOString(),\n        source: transaction.source,\n        inventoryStatus: 'available' as const,\n        paymentMethod: 'Unknown',\n        qrKey: `QR-${Date.now()}-${Math.random().toString(36).substr(2, 4)}`,\n        bookmark: false,\n        sku: item.sku || '',\n        purchasePrice: item.purchasePrice || '',\n        projectPrice: item.projectPrice || '',\n        marketValue: item.marketValue || '',\n        notes: item.notes || '',\n        space: item.space || '',\n        disposition: 'keep'\n      }\n      const itemId = await unifiedItemsService.createItem(currentAccountId, itemData)\n\n      // Upload item images if any\n      // Try to get files from the map first, then fall back to item.imageFiles\n      let imageFiles = imageFilesMap.get(item.id)\n      if (!imageFiles && item.imageFiles) {\n        imageFiles = item.imageFiles\n      }\n\n      if (imageFiles && imageFiles.length > 0) {\n        try {\n          const uploadedImages = await Promise.all(\n            imageFiles.map(async (file, index) => {\n              try {\n                const uploadResult = await ImageUploadService.uploadItemImage(\n                  file,\n                  project ? project.name : 'Unknown Project',\n                  itemId\n                )\n\n                return {\n                  url: uploadResult.url,\n                  alt: file.name,\n                  isPrimary: index === 0, // First image is primary\n                  uploadedAt: new Date(),\n                  fileName: file.name,\n                  size: file.size,\n                  mimeType: file.type\n                }\n              } catch (uploadError) {\n                console.error(`Failed to upload ${file.name}:`, uploadError)\n                // Return a placeholder for failed uploads so the process continues\n                return {\n                  url: '',\n                  alt: file.name,\n                  isPrimary: false,\n                  uploadedAt: new Date(),\n                  fileName: file.name,\n                  size: file.size,\n                  mimeType: file.type\n                }\n              }\n            })\n          )\n\n          // Filter out failed uploads (empty URLs)\n          const validImages = uploadedImages.filter(img => img.url && img.url.trim() !== '')\n\n          // Update the item with uploaded images\n          if (validImages.length > 0) {\n            await unifiedItemsService.updateItem(currentAccountId, itemId, { images: validImages })\n          }\n        } catch (error) {\n          console.error('Error in image upload process:', error)\n        }\n      }\n\n      // Refresh the transaction items list\n      const transactionItems = await unifiedItemsService.getItemsForTransaction(currentAccountId, projectId, transactionId)\n      const itemIds = transactionItems.map(item => item.itemId)\n      const itemsPromises = itemIds.map(id => unifiedItemsService.getItemById(currentAccountId, id))\n      const items = await Promise.all(itemsPromises)\n      const validItems = items.filter(item => item !== null) as Item[]\n      setTransactionItems(validItems)\n\n      // Reset state\n      setIsAddingItem(false)\n      setImageFilesMap(new Map())\n\n      showSuccess('Item added successfully')\n    } catch (error) {\n      console.error('Error adding item:', error)\n      showError('Failed to add item. Please try again.')\n    }\n  }\n\n  const handleCancelAddItem = () => {\n    setIsAddingItem(false)\n    setImageFilesMap(new Map())\n  }\n\n  // Convert all transaction images (receipt and other) to ItemImage format for the gallery\n  const allTransactionImages = [\n    ...(transaction?.receiptImages || []),\n    ...(transaction?.otherImages || [])\n  ]\n\n    const itemImages = allTransactionImages.map((img, index) => ({\n    url: img.url,\n    alt: img.fileName,\n    fileName: img.fileName,\n    uploadedAt: img.uploadedAt,\n    size: img.size,\n    mimeType: img.mimeType,\n    isPrimary: index === 0 // First image is primary\n  })) || []\n\n  // Resolve missing project IDs for transactions referenced by items.\n  // This avoids interpolating `undefined` into project routes when an item\n  // has had its `projectId` cleared but still references a `latestTransactionId`.\n  async function resolveMissingProjectIds(items: Item[]) {\n    if (!currentAccountId) return\n\n    // Collect unique transaction IDs that need resolution and aren't already cached.\n    const txIdsToResolve = Array.from(new Set(\n      items\n        .map(i => i.latestTransactionId ?? i.transactionId)\n        .filter(Boolean) as string[]\n    )).filter(txId => !resolvedProjectByTx[txId])\n\n    if (txIdsToResolve.length === 0) return\n\n    try {\n      const results = await Promise.all(\n        txIdsToResolve.map(async (txId) => {\n          try {\n            const res = await transactionService.getTransactionById(currentAccountId, txId)\n            return { txId, projectId: res.projectId || null }\n          } catch (err) {\n            console.debug('TransactionDetail - failed to fetch transaction for project resolution', { txId, err })\n            return { txId, projectId: null }\n          }\n        })\n      )\n\n      const newMap = { ...resolvedProjectByTx }\n      results.forEach(r => {\n        if (r.projectId) {\n          newMap[r.txId] = r.projectId\n        }\n      })\n\n      // Only update state if we found any new mappings\n      if (Object.keys(newMap).length > Object.keys(resolvedProjectByTx).length) {\n        setResolvedProjectByTx(newMap)\n      }\n    } catch (err) {\n      console.debug('TransactionDetail - resolveMissingProjectIds unexpected error', err)\n    }\n  }\n\n  // Helper function to render item card\n  function renderItemCard(item: Item, itemLink: string | null, isMovedOut: boolean) {\n    const cardClass = `block p-4 border border-gray-200 rounded-lg bg-white hover:border-primary-300 hover:shadow-sm transition-all duration-200 group relative ${isMovedOut ? 'opacity-60' : ''}`\n\n    const cardInner = (\n      <>\n        {/* Moved badge for moved out items */}\n        {isMovedOut && (\n          <div className=\"absolute top-1 right-1 z-10\">\n            <span className=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600\">\n              Moved\n            </span>\n          </div>\n        )}\n\n        {/* Disposition badge in upper right corner (if not moved) */}\n        {!isMovedOut && item.disposition && (\n          <div className=\"absolute top-1 right-1 z-10\">\n            <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${\n              item.disposition === 'keep'\n                ? 'bg-green-100 text-green-800'\n                : item.disposition === 'to return'\n                ? 'bg-red-100 text-red-700'\n                : item.disposition === 'return' // Backward compatibility\n                ? 'bg-red-100 text-red-700'\n                : item.disposition === 'returned'\n                ? 'bg-red-800 text-red-100'\n                : item.disposition === 'inventory'\n                ? 'bg-primary-100 text-primary-600'\n                : 'bg-gray-100 text-gray-800'\n            }`}>\n              {item.disposition === 'to return' ? 'To Return' : item.disposition ? item.disposition.charAt(0).toUpperCase() + item.disposition.slice(1) : 'Not Set'}\n            </span>\n          </div>\n        )}\n\n        {/* Image and Description row - side by side like inventory list */}\n        <div className=\"flex items-center gap-3 py-3\">\n          <div className=\"flex-shrink-0\">\n            {item.images && item.images.length > 0 ? (\n              // Show primary image thumbnail or first image if no primary\n              (() => {\n                const primaryImage = item.images.find(img => img.isPrimary) || item.images[0]\n                return (\n                  <div className=\"w-16 h-16 rounded-lg overflow-hidden border-2 border-gray-200\">\n                    <img\n                      src={primaryImage.url}\n                      alt={primaryImage.alt || 'Item image'}\n                      className=\"w-full h-full object-cover\"\n                    />\n                  </div>\n                )\n              })()\n            ) : (\n              // Show placeholder when no images\n              <div className=\"w-16 h-16 rounded-lg border-2 border-gray-200 flex items-center justify-center text-gray-400 bg-gray-100\">\n                <Package className=\"h-6 w-6\" />\n              </div>\n            )}\n          </div>\n\n          {/* Item description - matching inventory list styling */}\n          <div className=\"flex-1 min-w-0 flex items-center\">\n            <div>\n              <h3 className=\"text-base font-medium text-gray-900 line-clamp-2 break-words\">\n                {item.description}\n              </h3>\n              {/* Space field - if available */}\n              {item.space && (\n                <p className=\"text-sm text-gray-600 mt-1\">\n                  {item.space}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Bottom row: Price, Source, SKU - exactly like inventory list */}\n        <div className=\"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500\">\n          {(item.projectPrice || item.purchasePrice) && (\n            <span className=\"font-medium text-gray-700\">{formatCurrency(item.projectPrice || item.purchasePrice || '0')}</span>\n          )}\n          {item.source && (\n            <>\n              {(item.projectPrice || item.purchasePrice) && <span className=\"hidden sm:inline\">â€¢</span>}\n              <span className=\"font-medium text-gray-700\">{item.source}</span>\n            </>\n          )}\n          {item.sku && (\n            <>\n              {(item.projectPrice || item.purchasePrice || item.source) && <span className=\"hidden sm:inline\">â€¢</span>}\n              <span className=\"font-medium text-gray-700\">{item.sku}</span>\n            </>\n          )}\n        </div>\n      </>\n    )\n\n    // If we couldn't resolve a safe link, render as non-clickable card and log for debugging\n    if (!itemLink) {\n      console.debug('TransactionDetail - rendering moved item without link', {\n        itemId: item.itemId,\n        latestTransactionId: item.latestTransactionId ?? item.transactionId,\n        projectId: item.projectId,\n      })\n\n      return (\n        <div key={item.itemId} className={cardClass}>\n          {cardInner}\n        </div>\n      )\n    }\n\n    return (\n      <Link key={item.itemId} to={itemLink} className={cardClass}>\n        {cardInner}\n      </Link>\n    )\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center items-center h-64\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto\"></div>\n          <p className=\"mt-2 text-sm text-gray-600\">Loading transaction...</p>\n        </div>\n      </div>\n    )\n  }\n\n  if (!transaction) {\n    return (\n      <div className=\"text-center py-12\">\n        <div className=\"mx-auto h-12 w-12 text-gray-400\">ðŸ“„</div>\n        <h3 className=\"mt-2 text-sm font-medium text-gray-900\">Transaction not found</h3>\n        <p className=\"mt-1 text-sm text-gray-500\">The transaction you're looking for doesn't exist.</p>\n        <div className=\"mt-6\">\n          <Link\n            to={backDestination}\n            className=\"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back\n          </Link>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"space-y-4\">\n        {/* Back button row */}\n        <div className=\"flex items-center justify-between\">\n          <Link\n            to={backDestination}\n            className=\"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-1\" />\n            Back\n          </Link>\n          <div className=\"flex space-x-3\">\n            <Link\n              to={`/project/${projectId}/transaction/${transactionId}/edit`}\n              className=\"inline-flex items-center justify-center p-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n              title=\"Edit Transaction\"\n            >\n              <Edit className=\"h-4 w-4\" />\n            </Link>\n          </div>\n        </div>\n      </div>\n\n      {/* Transaction Details */}\n      <div className=\"bg-white shadow rounded-lg overflow-hidden\">\n        <div className=\"px-6 py-6 border-b border-gray-200\">\n          <h1 className=\"text-2xl font-bold text-gray-900 leading-tight\">\n            {getCanonicalTransactionTitle(transaction)} - {formatCurrency(transaction.amount)}\n          </h1>\n        </div>\n\n\n        <div className=\"px-6 py-4 border-t border-gray-200\">\n          <h3 className=\"text-lg font-medium text-gray-900 mb-4\">\n            Transaction Details\n          </h3>\n          <dl className=\"grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2\">\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Source</dt>\n              <dd className=\"mt-1 text-sm text-gray-900\">{transaction.source}</dd>\n            </div>\n\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Budget Category</dt>\n              <dd className=\"mt-1\">\n              <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${\n                  transaction.budgetCategory === 'Design Fee'\n                    ? 'bg-amber-100 text-amber-800'\n                    : transaction.budgetCategory === 'Furnishings'\n                    ? 'bg-yellow-100 text-yellow-800'\n                    : transaction.budgetCategory === 'Property Management'\n                    ? 'bg-orange-100 text-orange-800'\n                    : transaction.budgetCategory === 'Kitchen'\n                    ? 'bg-amber-200 text-amber-900'\n                    : transaction.budgetCategory === 'Install'\n                    ? 'bg-yellow-200 text-yellow-900'\n                    : transaction.budgetCategory === 'Storage & Receiving'\n                    ? 'bg-orange-200 text-orange-900'\n                    : transaction.budgetCategory === 'Fuel'\n                    ? 'bg-amber-300 text-amber-900'\n                    : 'bg-gray-100 text-gray-800'\n                }`}>\n                  {transaction.budgetCategory || 'Not specified'}\n                </span>\n              </dd>\n            </div>\n\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Transaction Type</dt>\n              <dd className=\"mt-1\">\n                <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium no-icon ${\n                  transaction.transactionType === 'Purchase'\n                    ? 'bg-green-100 text-green-800'\n                    : transaction.transactionType === 'Return'\n                    ? 'bg-red-100 text-red-800'\n                    : transaction.transactionType === 'To Inventory'\n                    ? 'bg-primary-100 text-primary-800'\n                    : 'bg-gray-100 text-gray-800'\n                }`}>\n                  {transaction.transactionType}\n                </span>\n              </dd>\n            </div>\n\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Amount</dt>\n              <dd className=\"mt-1 text-sm text-gray-900\">{formatCurrency(transaction.amount)}</dd>\n            </div>\n\n            {transaction.taxRatePreset && (\n              <div>\n                <dt className=\"text-sm font-medium text-gray-500\">Tax Rate Preset</dt>\n                <dd className=\"mt-1 text-sm text-gray-900\">\n                  {transaction.taxRatePreset === 'Other' \n                    ? 'Custom'\n                    : (() => {\n                        const preset = taxPresets.find(p => p.id === transaction.taxRatePreset)\n                        return preset ? `${preset.name} (${preset.rate.toFixed(2)}%)` : transaction.taxRatePreset\n                      })()\n                  }\n                </dd>\n              </div>\n            )}\n\n            {transaction.subtotal && (\n              <div>\n                <dt className=\"text-sm font-medium text-gray-500\">Subtotal</dt>\n                <dd className=\"mt-1 text-sm text-gray-900\">{formatCurrency(transaction.subtotal)}</dd>\n              </div>\n            )}\n\n            {transaction.taxRatePct !== undefined && (\n              <div>\n                <dt className=\"text-sm font-medium text-gray-500\">Tax Rate</dt>\n                <dd className=\"mt-1 text-sm text-gray-900\">{Number(transaction.taxRatePct).toFixed(2)}%</dd>\n              </div>\n            )}\n\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Transaction Date</dt>\n              <dd className=\"mt-1 text-sm text-gray-900\">\n                {transaction.transactionDate ? formatDate(transaction.transactionDate) : 'No date'}\n              </dd>\n            </div>\n\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Payment Method</dt>\n              <dd className=\"mt-1 text-sm text-gray-900\">{transaction.paymentMethod}</dd>\n            </div>\n\n            <div>\n              <dt className=\"text-sm font-medium text-gray-500\">Status</dt>\n              <dd className=\"mt-1 text-sm text-gray-900\">\n                {(transaction.status || 'pending').charAt(0).toUpperCase() + (transaction.status || 'pending').slice(1)}\n              </dd>\n            </div>\n\n            {transaction.reimbursementType && (transaction.reimbursementType as string) !== '' && (\n              <div>\n                <dt className=\"text-sm font-medium text-gray-500\">Reimbursement Type</dt>\n                <dd className=\"mt-1 text-sm text-gray-900\">\n                  {transaction.reimbursementType === CLIENT_OWES_COMPANY ? CLIENT_OWES_COMPANY : COMPANY_OWES_CLIENT}\n                </dd>\n              </div>\n            )}\n\n            {transaction.receiptEmailed && (\n              <div>\n                <dt className=\"text-sm font-medium text-gray-500\">\n                  Receipt Emailed\n                </dt>\n                <dd className=\"mt-1\">\n                  <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800\">\n                    Yes\n                  </span>\n                </dd>\n              </div>\n            )}\n\n            {transaction.notes && (\n              <div className=\"sm:col-span-2\">\n                <dt className=\"text-sm font-medium text-gray-500\">Notes</dt>\n                <dd className=\"mt-1 text-sm text-gray-900 whitespace-pre-wrap\">{transaction.notes}</dd>\n              </div>\n            )}\n          </dl>\n        </div>\n\n        {/* Receipt Images */}\n        <div className=\"px-6 py-6 border-t border-gray-200\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\n              <ImageIcon className=\"h-5 w-5 mr-2\" />\n              Receipt Images\n            </h3>\n                {transaction.receiptImages && transaction.receiptImages.length > 0 && (\n              <button\n                onClick={() => {\n                  // Trigger file input click programmatically\n                  const input = document.createElement('input')\n                  input.type = 'file'\n                  input.multiple = true\n                  input.accept = 'image/*'\n                  input.onchange = (e) => {\n                    const files = (e.target as HTMLInputElement).files\n                    if (files) {\n                      handleReceiptImagesUpload(Array.from(files))\n                    }\n                  }\n                  input.click()\n                }}\n                disabled={isUploadingReceiptImages}\n                className=\"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50\"\n              >\n                <ImageIcon className=\"h-3 w-3 mr-1\" />\n                {isUploadingReceiptImages ? 'Uploading...' : 'Add Images'}\n              </button>\n            )}\n          </div>\n          {transaction.receiptImages && transaction.receiptImages.length > 0 ? (\n            <TransactionImagePreview\n              images={transaction.receiptImages}\n              onRemoveImage={handleDeleteReceiptImage}\n              onImageClick={handleImageClick}\n              maxImages={5}\n              showControls={true}\n              size=\"md\"\n              className=\"mb-4\"\n            />\n          ) : (\n            <div className=\"text-center py-8\">\n              <ImageIcon className=\"mx-auto h-8 w-8 text-gray-400\" />\n              <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No receipt images uploaded</h3>\n              <button\n                onClick={() => {\n                  // Trigger file input click programmatically\n                  const input = document.createElement('input')\n                  input.type = 'file'\n                  input.multiple = true\n                  input.accept = 'image/*'\n                  input.onchange = (e) => {\n                    const files = (e.target as HTMLInputElement).files\n                    if (files) {\n                      handleReceiptImagesUpload(Array.from(files))\n                    }\n                  }\n                  input.click()\n                }}\n                disabled={isUploadingReceiptImages}\n                className=\"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3 disabled:opacity-50\"\n              >\n                <ImageIcon className=\"h-3 w-3 mr-1\" />\n                {isUploadingReceiptImages ? 'Uploading...' : 'Add Receipt Images'}\n              </button>\n            </div>\n          )}\n        </div>\n\n        {/* Other Images - Only show if there are other images */}\n            {transaction.otherImages && transaction.otherImages.length > 0 && (\n          <div className=\"px-6 py-6 border-t border-gray-200\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\n                <ImageIcon className=\"h-5 w-5 mr-2\" />\n                Other Images\n              </h3>\n              <button\n                onClick={() => {\n                  // Trigger file input click programmatically\n                  const input = document.createElement('input')\n                  input.type = 'file'\n                  input.multiple = true\n                  input.accept = 'image/*'\n                  input.onchange = (e) => {\n                    const files = (e.target as HTMLInputElement).files\n                    if (files) {\n                      handleOtherImagesUpload(Array.from(files))\n                    }\n                  }\n                  input.click()\n                }}\n                disabled={isUploadingOtherImages}\n                className=\"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50\"\n              >\n                <ImageIcon className=\"h-3 w-3 mr-1\" />\n                {isUploadingOtherImages ? 'Uploading...' : 'Add Images'}\n              </button>\n            </div>\n            <TransactionImagePreview\n              images={transaction.otherImages}\n              onRemoveImage={handleDeleteOtherImage}\n              onImageClick={(index) => {\n                // Find the correct index in the combined array for gallery navigation\n                const receiptCount = transaction.receiptImages?.length || 0\n                const legacyCount = transaction.transactionImages?.length || 0\n                const galleryIndex = receiptCount + legacyCount + index\n                handleImageClick(galleryIndex)\n              }}\n              maxImages={5}\n              showControls={true}\n              size=\"md\"\n              className=\"mb-4\"\n            />\n\n          </div>\n        )}\n\n        {/* Transaction Items */}\n        <div className=\"px-6 py-6 border-t border-gray-200\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h3 className=\"text-lg font-medium text-gray-900 flex items-center\">\n              <Package className=\"h-5 w-5 mr-2\" />\n              Transaction Items\n            </h3>\n            {/* Add Item Button - Only show when items exist (like Receipt Images section) */}\n            {(!isLoadingItems && !isAddingItem && transactionItems.length > 0) && (\n              <button\n                onClick={() => setIsAddingItem(true)}\n                className=\"inline-flex items-center px-2 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500\"\n                title=\"Add new item\"\n              >\n                <Package className=\"h-3 w-3 mr-1\" />\n                Add Item\n              </button>\n            )}\n          </div>\n\n          {isLoadingItems ? (\n            <div className=\"flex justify-center items-center h-16\">\n              <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600\"></div>\n              <span className=\"ml-2 text-sm text-gray-600\">Loading items...</span>\n            </div>\n          ) : (\n            <div className=\"space-y-6\">\n              {/* Items In This Transaction */}\n              {(() => {\n                // Split items into \"In this transaction\" vs \"Moved out\"\n                const itemsInTransaction = transactionItems.filter(item => {\n                  const currentTransactionId = item.latestTransactionId ?? item.transactionId\n                  return currentTransactionId === transactionId\n                })\n                \n                const itemsMovedOut = transactionItems.filter(item => {\n                  const currentTransactionId = item.latestTransactionId ?? item.transactionId\n                  const hasMovedOut = currentTransactionId !== transactionId\n                  // Transitional fallback\n                  const transitionalMovedOut = !item.latestTransactionId && \n                    item.projectId == null && \n                    item.previousProjectTransactionId === transactionId\n                  return hasMovedOut || transitionalMovedOut\n                })\n                \n                return (\n                  <>\n                    {/* Section A: In this project */}\n                    {itemsInTransaction.length > 0 && (\n                      <div>\n                        <h3 className=\"text-lg font-semibold text-gray-900 mb-3\">In this project</h3>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                          {itemsInTransaction.map((item) => {\n                            const isDeallocated = item.projectId == null\n                            const originProjectId = projectId || transaction?.projectId || ''\n                            const itemLink = isDeallocated\n                              ? buildContextUrl(`/business-inventory/${item.itemId}`, { from: 'business-inventory-item' })\n                              : buildContextUrl(`/project/${originProjectId}/item/${item.itemId}`, { from: 'transaction', project: originProjectId, transactionId: transactionId || '' })\n                            \n                            return renderItemCard(item, itemLink, false)\n                          })}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {/* Section B: Moved to inventory */}\n                    {itemsMovedOut.length > 0 && (\n                      <div>\n                        <h3 className=\"text-lg font-semibold text-gray-900 mb-3\">Moved</h3>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                          {itemsMovedOut.map((item) => {\n                            const currentTransactionId = item.latestTransactionId ?? item.transactionId\n                            const isInInventory = !currentTransactionId\n\n                            // Default to no link (defensive) and build a deterministic link below\n                            let itemLink: string | null = null\n\n                            if (isInInventory) {\n                              itemLink = buildContextUrl(`/business-inventory/${item.itemId}`, { from: 'business-inventory-item' })\n                            } else if (item.projectId) {\n                              // Item still carries a projectId - use it\n                              itemLink = buildContextUrl(`/project/${item.projectId}/item/${item.itemId}`, { from: 'transaction' })\n                            } else if (currentTransactionId?.startsWith('INV_SALE_') || currentTransactionId?.startsWith('INV_PURCHASE_')) {\n                              // Canonical inventory transaction - treat as company/business inventory for now\n                              itemLink = buildContextUrl(`/business-inventory/${item.itemId}`, { from: 'business-inventory-item' })\n                            } else {\n                              // Try resolved cache (populated asynchronously). If present, use it; otherwise leave null.\n                              const resolvedProjectId = currentTransactionId ? resolvedProjectByTx[currentTransactionId] : undefined\n                              if (resolvedProjectId) {\n                                itemLink = buildContextUrl(`/project/${resolvedProjectId}/item/${item.itemId}`, { from: 'transaction', project: resolvedProjectId, transactionId: transactionId || '' })\n                              } else {\n                                // Log debug info - will render as non-link until resolution completes\n                                console.debug('TransactionDetail - unresolved moved item link', {\n                                  itemId: item.itemId,\n                                  currentTransactionId,\n                                  itemProjectId: item.projectId,\n                                  resolvedProjectId: resolvedProjectByTx[currentTransactionId || '']\n                                })\n                                itemLink = null\n                              }\n                            }\n\n                            return renderItemCard(item, itemLink, true)\n                          })}\n                        </div>\n                      </div>\n                    )}\n                    \n                    {itemsInTransaction.length === 0 && itemsMovedOut.length === 0 && !isAddingItem && (\n                      <div className=\"text-center py-8\">\n                        <Package className=\"mx-auto h-8 w-8 text-gray-400\" />\n                        <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No items added</h3>\n                        <button\n                          onClick={() => setIsAddingItem(true)}\n                          className=\"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mt-3\"\n                          title=\"Add new item\"\n                        >\n                          <Package className=\"h-3 w-3 mr-1\" />\n                          Add Item\n                        </button>\n                      </div>\n                    )}\n\n                    {isAddingItem && (\n                      <TransactionItemForm\n                        onSave={handleSaveItem}\n                        onCancel={handleCancelAddItem}\n                        projectId={projectId}\n                        projectName={project ? project.name : ''}\n                        onImageFilesChange={handleImageFilesChange}\n                      />\n                    )}\n                  </>\n                )\n              })()}\n\n            </div>\n          )}\n        </div>\n\n        {/* Transaction Audit */}\n        {transaction && (projectId || transaction.projectId) && getCanonicalTransactionTitle(transaction) !== COMPANY_INVENTORY_SALE && getCanonicalTransactionTitle(transaction) !== COMPANY_INVENTORY_PURCHASE && (\n          <div className=\"px-6 py-6 border-t border-gray-200\">\n            <TransactionAudit\n              transaction={transaction}\n              projectId={projectId || transaction.projectId || ''}\n              transactionItems={transactionItems}\n              onItemsUpdated={refreshTransactionItems}\n            />\n          </div>\n        )}\n\n        {/* Metadata */}\n        <div className=\"px-6 py-4 bg-gray-50 border-t border-gray-200\">\n          <div className=\"relative\">\n            <dl className=\"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-3\">\n              <div>\n                <dt className=\"text-xs font-medium text-gray-500 uppercase tracking-wide\">Project</dt>\n                <dd className=\"mt-1 text-sm text-gray-900\">{project?.name || transaction.projectName}</dd>\n              </div>\n              <div>\n                <dt className=\"text-xs font-medium text-gray-500 uppercase tracking-wide\">Created</dt>\n                <dd className=\"mt-1 text-sm text-gray-900\">\n                  {formatDate(transaction.createdAt)}\n                </dd>\n              </div>\n            </dl>\n\n            {/* Delete button in lower right corner */}\n            <div className=\"absolute bottom-0 right-0\">\n              <button\n                onClick={handleDelete}\n                className=\"inline-flex items-center justify-center p-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-red-50 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500\"\n                title=\"Delete Transaction\"\n              >\n                <Trash2 className=\"h-4 w-4\" />\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Image gallery modal */}\n      {showGallery && (\n        <ImageGallery\n          images={itemImages}\n          initialIndex={galleryInitialIndex}\n          onClose={handleGalleryClose}\n        />\n      )}\n    </div>\n  )\n}\n"],"names":["TransactionAudit","transaction","projectId","transactionItems","onItemsUpdated","currentAccountId","useAccount","showError","showSuccess","useToast","completeness","setCompleteness","useState","isLoading","setIsLoading","showSuggested","setShowSuggested","suggestedItems","setSuggestedItems","isLoadingSuggestions","setIsLoadingSuggestions","useEffect","metrics","transactionService","error","item","items","filteredItems","remaining","it","price","handleAddItemToTransaction","unifiedItemsService","prev","si","freshItems","refreshError","jsxs","jsx","getStatusColor","status","getStatusIcon","CheckCircle2","AlertTriangle","XCircle","getStatusLabel","itemsMissingPrice","purchasePrice","progressPercentage","subtotalLabel","itemsLabel","taxLabel","remainingDollars","remainingLabel","formatCurrency","Fragment","ChevronUp","ChevronDown","Plus","removeUnwantedIcons","badge","child","getCanonicalTransactionTitle","_a","COMPANY_INVENTORY_SALE","_b","COMPANY_INVENTORY_PURCHASE","TransactionDetail","transactionId","useParams","navigate","useNavigate","setTransaction","project","setProject","taxPresets","setTaxPresets","presets","getTaxPresets","setTransactionItems","resolvedProjectByTx","setResolvedProjectByTx","isLoadingItems","setIsLoadingItems","showGallery","setShowGallery","galleryInitialIndex","setGalleryInitialIndex","isUploadingReceiptImages","setIsUploadingReceiptImages","isUploadingOtherImages","setIsUploadingOtherImages","isAddingItem","setIsAddingItem","imageFilesMap","setImageFilesMap","buildContextUrl","getBackDestination","useNavigationContext","backDestination","useMemo","refreshTransactionItems","actualProjectId","itemsPromises","id","validItems","edgesFromTransaction","lineageService","movedOutItemIds","edge","itemsInTransaction","isInTransaction","hasMovedOut","itemsMovedOut","transitionalMovedOut","combined","resolveMissingProjectIds","err","transactionData","projectData","fetchedTransactionData","fetchedProjectData","projectService","itemIdsFromTransaction","itemId","edgeErr","result","convertedTransaction","transactionItemIds","unsubscribe","timer","timer2","handleDelete","handleImageClick","index","handleGalleryClose","handleReceiptImagesUpload","files","uploadResults","ImageUploadService","newReceiptImages","updatedReceiptImages","updateProjectId","refreshProjectId","updatedTransaction","handleOtherImagesUpload","newOtherImages","updatedOtherImages","handleDeleteReceiptImage","imageUrl","img","handleDeleteOtherImage","handleImageFilesChange","imageFiles","newMap","handleSaveItem","itemData","validImages","file","uploadError","handleCancelAddItem","itemImages","txIdsToResolve","i","txId","results","res","r","renderItemCard","itemLink","isMovedOut","cardClass","cardInner","primaryImage","Package","Link","ArrowLeft","Edit","preset","p","formatDate","CLIENT_OWES_COMPANY","COMPANY_OWES_CLIENT","ImageIcon","input","e","TransactionImagePreview","receiptCount","legacyCount","galleryIndex","isDeallocated","originProjectId","currentTransactionId","isInInventory","resolvedProjectId","TransactionItemForm","Trash2","ImageGallery"],"mappings":"+kBAeA,SAAwBA,GAAiB,CACvC,YAAAC,EACA,UAAAC,EACA,iBAAAC,EACA,eAAAC,CACF,EAA0B,CACxB,KAAM,CAAE,iBAAAC,CAAA,EAAqBC,GAAA,EACvB,CAAE,UAAAC,EAAW,YAAAC,CAAA,EAAgBC,GAAA,EAC7B,CAACC,EAAcC,CAAe,EAAIC,EAAAA,SAAyC,IAAI,EAC/E,CAACC,GAAWC,CAAY,EAAIF,EAAAA,SAAS,EAAI,EACzC,CAACG,EAAeC,CAAgB,EAAIJ,EAAAA,SAAS,EAAI,EACjD,CAACK,EAAgBC,CAAiB,EAAIN,EAAAA,SAAiB,CAAA,CAAE,EACzD,CAACO,EAAsBC,CAAuB,EAAIR,EAAAA,SAAS,EAAK,EAMtE,GAAI,EAHoBX,EAAY,kBAAoB,UAChCA,EAAY,kBAAoB,qBAGtD,OAAO,KAIToB,EAAAA,UAAU,IAAM,EACW,SAAY,CACnC,GAAI,GAAChB,GAAoB,CAACJ,EAAY,eAAiB,CAACC,GAExD,CAAAY,EAAa,EAAI,EACjB,GAAI,CACF,MAAMQ,EAAU,MAAMC,EAAmB,2BACvClB,EACAH,EACAD,EAAY,aAAA,EAEdU,EAAgBW,CAAO,CACzB,OAASE,EAAO,CACd,QAAQ,MAAM,sCAAuCA,CAAK,EAE1Db,EAAgB,CACd,cAAe,EACf,WAAYR,EAAiB,OAC7B,uBAAwBA,EAAiB,OAAOsB,GAAQ,CAACA,EAAK,eAAiBA,EAAK,cAAc,SAAW,EAAE,EAAE,OACjH,oBAAqB,WAAWxB,EAAY,QAAU,GAAG,EACzD,kBAAmB,EACnB,mBAAoBE,EAAiB,SAAW,EAAI,aAAe,WACnE,eAAgB,CAACF,EAAY,YAAc,CAACA,EAAY,SACxD,gBAAiB,EACjB,gBAAiB,CAAA,CAClB,CACH,QAAA,CACEa,EAAa,EAAK,CACpB,EACF,GAEA,CACF,EAAG,CAACT,EAAkBH,EAAWD,EAAY,cAAeE,EAAkBF,EAAY,OAAQA,EAAY,WAAYA,EAAY,QAAQ,CAAC,EAG/IoB,EAAAA,UAAU,IAAM,EACU,SAAY,CAClC,GAAI,GAAChB,GAAoB,CAACK,GAC1B,IAAIA,EAAa,qBAAuB,WAAY,CAClDQ,EAAkB,CAAA,CAAE,EACpB,MACF,CAEAE,EAAwB,EAAI,EAC5B,GAAI,CACF,MAAMM,EAAQ,MAAMH,EAAmB,gCACrClB,EACAJ,EAAY,OACZ,CAAA,EAGF,IAAI0B,EAAgBD,EACpB,GAAIhB,EAAc,CAChB,MAAMkB,EAAYlB,EAAa,oBAAsBA,EAAa,cAClEiB,GAAiBD,GAAS,CAAA,GAAI,OAAOG,GAAM,CACzC,MAAMC,EAAQ,WAAYD,EAAG,eAAyB,GAAG,EAEzD,OAAI,MAAMC,CAAK,EAAU,GAClBA,GAASF,CAClB,CAAC,CACH,CACAV,EAAkBS,CAAa,CACjC,OAASH,EAAO,CACd,QAAQ,MAAM,iCAAkCA,CAAK,CACvD,QAAA,CACEJ,EAAwB,EAAK,CAC/B,EACF,GAEA,CACF,EAAG,CAACf,EAAkBJ,EAAY,OAAQS,GAAA,YAAAA,EAAc,kBAAkB,CAAC,EAE3E,MAAMqB,GAA6B,MAAON,GAAe,CACvD,GAAI,GAACpB,GAAoB,CAACJ,EAAY,eAEtC,GAAI,CACF,MAAM+B,EAAoB,qBACxB3B,EACAoB,EAAK,OACLxB,EAAY,cACZwB,EAAK,eAAiB,IACtBxB,EAAY,gBACZ,SACA,6BAAA,EAEFO,EAAY,2BAA2B,EAEvCU,EAAkBe,GAAQA,EAAK,OAAOC,GAAMA,EAAG,SAAWT,EAAK,MAAM,CAAC,EACtErB,EAAA,EAGA,GAAI,CACFgB,EAAwB,EAAI,EAC5B,MAAMe,EAAa,MAAMZ,EAAmB,gCAC1ClB,EACAJ,EAAY,OACZ,CAAA,EAGF,IAAI0B,EAAgBQ,EACpB,GAAIzB,EAAc,CAChB,MAAMkB,EAAYlB,EAAa,oBAAsBA,EAAa,cAClEiB,GAAiBQ,GAAc,CAAA,GAAI,OAAON,GAAM,CAC9C,MAAMC,EAAQ,WAAYD,EAAG,eAAyB,GAAG,EACzD,OAAI,MAAMC,CAAK,EAAU,GAClBA,GAASF,CAClB,CAAC,CACH,CACAV,EAAkBS,CAAa,CACjC,OAASS,EAAc,CACrB,QAAQ,MAAM,8CAA+CA,CAAY,CAC3E,QAAA,CACEhB,EAAwB,EAAK,CAC/B,CACF,OAASI,EAAO,CACd,QAAQ,MAAM,oCAAqCA,CAAK,EACxDjB,EAAU,mCAAmC,CAC/C,CACF,EAEA,GAAIM,IAAa,CAACH,EAChB,aACG,MAAA,CAAI,UAAU,iCACb,SAAA2B,EAAAA,KAAC,MAAA,CAAI,UAAU,gBACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,oCAAA,CAAqC,EACpDA,EAAAA,IAAC,MAAA,CAAI,UAAU,gCAAA,CAAiC,CAAA,CAAA,CAClD,CAAA,CACF,EAIJ,MAAMC,EAAkBC,GAA0D,CAChF,OAAQA,EAAA,CACN,IAAK,WACH,MAAO,eACT,IAAK,OACH,MAAO,gBACT,IAAK,aACL,IAAK,OACH,MAAO,aACT,QACE,MAAO,aAAA,CAEb,EAEMC,GAAiBD,GAA0D,CAC/E,OAAQA,EAAA,CACN,IAAK,WACH,OAAOF,EAAAA,IAACI,GAAA,CAAa,UAAU,wBAAA,CAAyB,EAC1D,IAAK,OACH,OAAOJ,EAAAA,IAACK,GAAA,CAAc,UAAU,yBAAA,CAA0B,EAC5D,IAAK,aACL,IAAK,OACH,OAAOL,EAAAA,IAACM,GAAA,CAAQ,UAAU,sBAAA,CAAuB,EACnD,QACE,OAAO,IAAA,CAEb,EAEMC,GAAkBL,GAA0D,CAChF,OAAQA,EAAA,CACN,IAAK,WACH,MAAO,WACT,IAAK,OACH,MAAO,eACT,IAAK,aACH,MAAO,aACT,IAAK,OACH,MAAO,cACT,QACE,MAAO,SAAA,CAEb,EAEMM,EAAoB3C,EAAiB,OAAOsB,GAAQ,CACxD,MAAMsB,EAAgBtB,EAAK,cAC3B,MAAO,CAACsB,GAAiBA,EAAc,KAAA,IAAW,IAAM,WAAWA,CAAa,IAAM,CACxF,CAAC,EAEKC,EAAqB,KAAK,IAAItC,EAAa,kBAAoB,IAAK,GAAG,EAEvEuC,EAAgBhD,EAAY,SAAW,qBAAuB,+BAC9DiD,EAAa,mCACbC,EAAW,iBAEXC,EAAmB,KAAK,OAAO1C,EAAa,oBAAsBA,EAAa,eAAiB,GAAG,EAAI,IACvG2C,GAAiBD,GAAoB,EACvC,GAAGE,EAAeF,EAAiB,UAAU,CAAC,aAC9C,WAAWE,EAAe,KAAK,IAAIF,CAAgB,EAAE,SAAA,CAAU,CAAC,GAEpE,OACEf,EAAAA,KAAC,MAAA,CAAI,UAAU,6CACb,SAAA,CAAAC,MAAC,MAAA,CAAI,UAAU,qCACX,SAAAA,EAAAA,IAAC,MAAA,CAAI,UAAU,oCACf,SAAAA,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,mBAAA,CAAiB,EACrE,EACF,EAEAD,EAAAA,KAAC,MAAA,CAAI,UAAU,YAEb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,OACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,yCACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,0BACZ,SAAA,CAAAI,GAAc/B,EAAa,kBAAkB,QAC7C,OAAA,CAAK,UAAU,sCACb,SAAAmC,GAAenC,EAAa,kBAAkB,CAAA,CACjD,CAAA,EACF,EACA2B,EAAAA,KAAC,OAAA,CAAK,UAAU,wBACb,SAAA,CAAAiB,EAAe5C,EAAa,cAAc,UAAU,EAAE,MAAI4C,EAAe5C,EAAa,oBAAoB,SAAA,CAAU,CAAA,CAAA,CACvH,CAAA,EACF,EAGA2B,EAAAA,KAAC,MAAA,CAAI,UAAU,WACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,2CACb,SAAAA,EAAAA,IAAC,MAAA,CACC,UAAW,gDAAgDC,EAAe7B,EAAa,kBAAkB,CAAC,GAC1G,MAAO,CAAE,MAAO,GAAG,KAAK,IAAIsC,EAAoB,GAAG,CAAC,GAAA,CAAI,CAAA,EAE5D,EACAX,EAAAA,KAAC,MAAA,CAAI,UAAU,+DACb,SAAA,CAAAA,OAAC,OAAA,CAAM,SAAA,CAAA3B,EAAa,WAAW,QAAA,EAAM,EACrC4B,EAAAA,IAAC,QAAM,SAAAe,EAAA,CAAe,CAAA,CAAA,CACxB,CAAA,EACF,EAGAf,MAAC,MAAA,CAAI,UAAU,uCACZ,SAAA5B,EAAa,aAAe,EAC3B4B,EAAAA,IAAC,MAAA,CAAI,UAAU,2BAA2B,SAAA,qBAAA,CAAmB,EAE7DD,EAAAA,KAAAkB,WAAA,CACF,SAAA,CAAAlB,OAAC,MAAA,CAAK,SAAA,CAAAY,EAAc,KAAGK,EAAe5C,EAAa,oBAAoB,SAAA,CAAU,CAAA,EAAE,SAClF,MAAA,CAAK,SAAA,CAAAwC,EAAW,KAAGI,EAAe5C,EAAa,cAAc,SAAA,CAAU,CAAA,EAAE,EACzEA,EAAa,cAAgB,QAC5B2B,EAAAA,KAAC,MAAA,CAAK,SAAA,CAAAc,EAAS,KAAGG,EAAe5C,EAAa,YAAY,SAAA,CAAU,CAAA,EAAE,EAEnEA,EAAa,uBAAyB,GACrC2B,EAAAA,KAAC,MAAA,CAAI,UAAU,kBACZ,SAAA,CAAA3B,EAAa,uBAAuB,+BAAA,CAAA,CACvC,CAAA,CAAA,CAEJ,CAAA,CAEJ,CAAA,EACF,EAGCA,EAAa,gBACZ4B,EAAAA,IAAC,MAAA,CAAI,UAAU,4DACb,SAAAD,EAAAA,KAAC,MAAA,CAAI,UAAU,mBACb,SAAA,CAAAC,EAAAA,IAACK,GAAA,CAAc,UAAU,mDAAA,CAAoD,EAC7EN,EAAAA,KAAC,MAAA,CAAI,UAAU,0BACb,SAAA,CAAAC,EAAAA,IAAC,UAAO,SAAA,mBAAA,CAAiB,EAAS,kEAAA,CAAA,CACpC,CAAA,CAAA,CACF,CAAA,CACF,EAIDQ,EAAkB,OAAS,GAC1BR,EAAAA,IAAC,OAAI,UAAU,0CACb,gBAAC,MAAA,CACC,SAAA,CAAAA,EAAAA,IAAC,KAAA,CAAG,UAAU,yCAAyC,SAAA,yBAAsB,QAC5E,MAAA,CAAI,UAAU,kBACb,SAAAD,EAAAA,KAAC,QAAA,CAAM,UAAU,sCACf,SAAA,CAAAC,MAAC,QAAA,CAAM,UAAU,aACf,SAAAD,EAAAA,KAAC,KAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,kEAAkE,SAAA,OAAI,EACpFA,EAAAA,IAAC,KAAA,CAAG,UAAU,kEAAkE,SAAA,MAAG,EACnFA,EAAAA,IAAC,KAAA,CAAG,UAAU,kEAAkE,SAAA,QAAA,CAAM,CAAA,CAAA,CACxF,CAAA,CACF,EACAA,EAAAA,IAAC,SAAM,UAAU,oCACd,WAAkB,IAAKb,GACtBY,EAAAA,KAAC,KAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,kCAAmC,SAAAb,EAAK,YAAY,QACjE,KAAA,CAAG,UAAU,kCAAmC,SAAAA,EAAK,KAAO,IAAI,EACjEa,EAAAA,IAAC,KAAA,CAAG,UAAU,oBACZ,SAAAA,EAAAA,IAAC,IAAA,CACC,KAAM,YAAYpC,CAAS,SAASuB,EAAK,MAAM,QAC/C,UAAU,0CACX,SAAA,YAAA,CAAA,CAED,CACF,CAAA,GAVOA,EAAK,MAWd,CACD,CAAA,CACH,CAAA,CAAA,CACF,CAAA,CACF,CAAA,CAAA,CACF,CAAA,CACF,GAIAf,EAAa,qBAAuB,QAAUA,EAAa,qBAAuB,eAClF2B,EAAAA,KAAC,MAAA,CAAI,UAAU,qCACb,SAAA,CAAAC,EAAAA,IAAC,SAAA,CACC,QAAS,IAAMtB,EAAiB,CAACD,CAAa,EAC9C,UAAU,uFAET,WACCsB,EAAAA,KAAAkB,EAAAA,SAAA,CACE,SAAA,CAAAjB,EAAAA,IAACkB,GAAA,CAAU,UAAU,cAAA,CAAe,EAAE,sBAAA,CAAA,CAExC,EAEAnB,EAAAA,KAAAkB,EAAAA,SAAA,CACE,SAAA,CAAAjB,EAAAA,IAACmB,GAAA,CAAY,UAAU,cAAA,CAAe,EAAE,6BAAA,CAAA,CAE1C,CAAA,CAAA,EAIH1C,IACCI,EACEmB,EAAAA,IAAC,OAAI,UAAU,6BAA6B,kCAAsB,EAChErB,EAAe,OAAS,QACzB,MAAA,CAAI,UAAU,iBACZ,SAAAA,EAAe,IAAKQ,GACnBY,EAAAA,KAAC,MAAA,CAEC,UAAU,8DAEV,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,SACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,oCAAqC,SAAAb,EAAK,YAAY,EACrEY,EAAAA,KAAC,MAAA,CAAI,UAAU,wBACZ,SAAA,CAAAZ,EAAK,KAAO,QAAQA,EAAK,GAAG,GAC5BA,EAAK,eAAiB,MAAM6B,EAAe7B,EAAK,aAAa,CAAC,EAAA,CAAA,CACjE,CAAA,EACF,EACAY,EAAAA,KAAC,SAAA,CACC,QAAS,IAAMN,GAA2BN,CAAI,EAC9C,UAAU,qIAEV,SAAA,CAAAa,EAAAA,IAACoB,GAAA,CAAK,UAAU,cAAA,CAAe,EAAE,KAAA,CAAA,CAAA,CAEnC,CAAA,EAhBKjC,EAAK,MAAA,CAkBb,CAAA,CACH,QAEC,MAAA,CAAI,UAAU,6BAA6B,SAAA,+CAA4C,EAAA,CAAA,CAG9F,CAAA,CAAA,CAEJ,CAAA,EACF,CAEJ,CClXA,MAAMkC,GAAsB,IAAM,CACjB,SAAS,iBAAiB,UAAU,EAC5C,QAAQC,GAAS,CAEL,MAAM,KAAKA,EAAM,UAAU,EACnC,QAAQC,GAAS,CACpBA,EAAM,WAAa,KAAK,WACtBA,EAAM,YACRA,EAAM,WAAW,YAAYA,CAAK,CAGxC,CAAC,CACH,CAAC,CACH,EAGMC,GAAgC7D,GAAqC,SAEzE,OAAI8D,EAAA9D,EAAY,gBAAZ,MAAA8D,EAA2B,WAAW,aACjCC,IAELC,EAAAhE,EAAY,gBAAZ,MAAAgE,EAA2B,WAAW,iBACjCC,GAGFjE,EAAY,MACrB,EAGA,SAAwBkE,IAAoB,CAC1C,KAAM,CAAE,GAAIjE,EAAW,cAAAkE,CAAA,EAAkBC,GAAA,EACnCC,EAAWC,GAAA,EACX,CAAE,iBAAAlE,CAAA,EAAqBC,GAAA,EACvB,CAACL,EAAauE,CAAc,EAAI5D,EAAAA,SAA6B,IAAI,EACjE,CAAC6D,EAASC,CAAU,EAAI9D,EAAAA,SAAyB,IAAI,EACrD,CAAC+D,EAAYC,EAAa,EAAIhE,EAAAA,SAAsB,CAAA,CAAE,EAG5DS,EAAAA,UAAU,IAAM,EACM,SAAY,CAC9B,GAAKhB,EACL,GAAI,CACF,MAAMwE,EAAU,MAAMC,GAAczE,CAAgB,EACpDuE,GAAcC,CAAO,CACvB,OAASrD,EAAO,CACd,QAAQ,MAAM,6BAA8BA,CAAK,CACnD,CACF,GACA,CACF,EAAG,CAACnB,CAAgB,CAAC,EACrB,KAAM,CAACF,EAAkB4E,CAAmB,EAAInE,EAAAA,SAAiB,CAAA,CAAE,EAE7D,CAACoE,EAAqBC,CAAsB,EAAIrE,EAAAA,SAAiC,CAAA,CAAE,EACnF,CAACC,EAAWC,CAAY,EAAIF,EAAAA,SAAS,EAAI,EACzC,CAACsE,EAAgBC,EAAiB,EAAIvE,EAAAA,SAAS,EAAI,EACnD,CAACwE,GAAaC,CAAc,EAAIzE,EAAAA,SAAS,EAAK,EAC9C,CAAC0E,GAAqBC,EAAsB,EAAI3E,EAAAA,SAAS,CAAC,EAC1D,CAAC4E,EAA0BC,CAA2B,EAAI7E,EAAAA,SAAS,EAAK,EACxE,CAAC8E,EAAwBC,CAAyB,EAAI/E,EAAAA,SAAS,EAAK,EACpE,CAACgF,EAAcC,CAAe,EAAIjF,EAAAA,SAAS,EAAK,EAChD,CAACkF,GAAeC,CAAgB,EAAInF,EAAAA,SAA8B,IAAI,GAAK,EAC3E,CAAE,UAAAL,EAAW,YAAAC,CAAA,EAAgBC,GAAA,EAC7B,CAAE,gBAAAuF,EAAiB,mBAAAC,CAAA,EAAuBC,GAAA,EAI1CC,EAAkBC,EAAAA,QAAQ,IAEvBH,EAAmB,YAAY/F,CAAS,mBAAmB,EACjE,CAAC+F,EAAoB/F,CAAS,CAAC,EAG5BmG,GAA0B,SAAY,CAC1C,GAAI,CAAChG,GAAoB,CAAC+D,EAAe,OAEzC,MAAMkC,EAAkBpG,IAAaD,GAAA,YAAAA,EAAa,WAClD,GAAKqG,EAEL,GAAI,CAGF,MAAMC,GAFmB,MAAMvE,EAAoB,uBAAuB3B,EAAkBiG,EAAiBlC,CAAa,GACzF,IAAI3C,GAAQA,EAAK,MAAM,EAC1B,IAAI+E,GAAMxE,EAAoB,YAAY3B,EAAkBmG,CAAE,CAAC,EAEvFC,GADQ,MAAM,QAAQ,IAAIF,CAAa,GACpB,OAAO9E,GAAQA,IAAS,IAAI,EAG/CiF,EAAuB,MAAMC,GAAe,wBAAwBvC,EAAe/D,CAAgB,EACnGuG,EAAkB,IAAI,IAAIF,EAAqB,IAAIG,GAAQA,EAAK,MAAM,CAAC,EAGvEC,EAAqBL,EAAW,OAAOhF,GAAQ,CAGnD,MAAMsF,GADuBtF,EAAK,qBAAuBA,EAAK,iBACb2C,EAC3C4C,EAAcJ,EAAgB,IAAInF,EAAK,MAAM,EAEnD,OAAOsF,GAAmB,CAACC,CAC7B,CAAC,EAEKC,EAAgBR,EAAW,OAAOhF,GAAQ,CAC9C,MAAMuF,EAAcJ,EAAgB,IAAInF,EAAK,MAAM,EAE7CyF,EAAuB,CAACzF,EAAK,qBACjCA,EAAK,WAAa,MAClBA,EAAK,+BAAiC2C,EACxC,OAAO4C,GAAeE,CACxB,CAAC,EAGKC,EAAW,CAAC,GAAGL,EAAoB,GAAGG,CAAa,EACzDlC,EAAoBoC,CAAQ,EAE5BC,GAAyBD,CAAQ,EAAE,MAAME,GAAO,QAAQ,MAAM,kCAAmCA,CAAG,CAAC,CACvG,OAAS7F,EAAO,CACd,QAAQ,MAAM,sCAAuCA,CAAK,CAC5D,CACF,EAEAH,EAAAA,UAAU,IAAM,EACU,SAAY,CAClC,GAAI,GAAC+C,GAAiB,CAAC/D,GAEvB,GAAI,CACF,IAAIiG,EAAkBpG,EAClBoH,EACAC,EAA8B,KAElC,GAAKjB,EAiBE,CAML,KAAM,CAACkB,EAAwBC,CAAkB,EAAI,MAAM,QAAQ,IAAI,CACrElG,EAAmB,eAAelB,EAAkBiG,EAAiBlC,CAAa,EAClFsD,GAAe,WAAWrH,EAAkBiG,CAAe,CAAA,CAC5D,EAEDgB,EAAkBE,EAClBD,EAAcE,EAGd,MAAME,EAAyB,MAAM,QAAQL,GAAA,YAAAA,EAAiB,OAAO,EAAIA,EAAgB,QAAU,CAAA,EACnG,GAAIK,EAAuB,OAAS,GAAKrB,EAAiB,CACxD,MAAMC,EAAgBoB,EAAuB,IAAKC,GAAmB5F,EAAoB,YAAY3B,EAAkBuH,CAAM,CAAC,EAExHnB,GADQ,MAAM,QAAQ,IAAIF,CAAa,GACpB,OAAO9E,GAAQA,IAAS,IAAI,EACrD,QAAQ,IAAI,gEAAiEgF,EAAW,MAAM,EAG9F,GAAI,CACF,MAAMC,EAAuB,MAAMC,GAAe,wBAAwBvC,EAAe/D,CAAgB,EACnGuG,EAAkB,IAAI,IAAIF,EAAqB,IAAIG,GAAQA,EAAK,MAAM,CAAC,EAEvEC,EAAqBL,EAAW,OAAOhF,GAAQ,CAEnD,MAAMsF,IADuBtF,EAAK,qBAAuBA,EAAK,iBACb2C,EAC3C4C,GAAcJ,EAAgB,IAAInF,EAAK,MAAM,EACnD,OAAOsF,IAAmB,CAACC,EAC7B,CAAC,EAEKC,EAAgBR,EAAW,OAAOhF,GAAQ,CAC9C,MAAMuF,GAAcJ,EAAgB,IAAInF,EAAK,MAAM,EAC7CyF,GAAuB,CAACzF,EAAK,qBACjCA,EAAK,WAAa,MAClBA,EAAK,+BAAiC2C,EACxC,OAAO4C,IAAeE,EACxB,CAAC,EAEKC,EAAW,CAAC,GAAGL,EAAoB,GAAGG,CAAa,EACzDlC,EAAoBoC,CAAQ,EAC5BC,GAAyBD,CAAQ,EAAE,MAAME,GAAO,QAAQ,MAAM,kCAAmCA,CAAG,CAAC,CACvG,OAASQ,EAAS,CAChB,QAAQ,MAAM,qDAAsDA,CAAO,EAC3E9C,EAAoB0B,CAAU,CAChC,CACF,MACE1B,EAAoB,CAAA,CAAE,CAE1B,KArEsB,CAEpB,QAAQ,IAAI,6GAA6G,EACzH,MAAM+C,EAAS,MAAMvG,EAAmB,mBAAmBlB,EAAkB+D,CAAa,EAE1F,GAAI,CAAC0D,EAAO,aAAe,CAACA,EAAO,UAAW,CAC5C,QAAQ,MAAM,0DAA0D,EACxEhH,EAAa,EAAK,EAClBqE,GAAkB,EAAK,EACvB,MACF,CAEAmC,EAAkBQ,EAAO,YACzBxB,EAAkBwB,EAAO,UAGzBP,EAAc,MAAMG,GAAe,WAAWrH,EAAkBiG,CAAe,CACjF,CAsDA,MAAMyB,EAAoC,CACxC,GAAGT,EACH,kBAAmB,MAAM,QAAQA,GAAA,YAAAA,EAAiB,iBAAiB,EAAIA,EAAgB,kBAAoB,CAAA,CAAC,EAU9G,GAPA,QAAQ,IAAI,8CAA+CA,CAAe,EAC1E,QAAQ,IAAI,4CAA6CS,CAAoB,EAC7E,QAAQ,IAAI,uCAAwCzB,CAAe,EACnE9B,EAAeuD,CAAoB,EACnCrD,EAAW6C,CAAW,EAGlB,CAACrH,GAAaoG,EAAiB,CAGjC,MAAM0B,EAAqB,MAAM,QAAQV,GAAA,YAAAA,EAAiB,OAAO,EAAIA,EAAgB,QAAU,CAAA,EAC/F,GAAIU,EAAmB,OAAS,EAAG,CACjC,MAAMzB,EAAgByB,EAAmB,IAAKJ,GAAmB5F,EAAoB,YAAY3B,EAAkBuH,CAAM,CAAC,EAEpHnB,GADQ,MAAM,QAAQ,IAAIF,CAAa,GACpB,OAAO9E,GAAQA,IAAS,IAAI,EACrD,QAAQ,IAAI,wEAAyEgF,EAAW,MAAM,EAEtG,GAAI,CACF,MAAMC,EAAuB,MAAMC,GAAe,wBAAwBvC,EAAe/D,CAAgB,EACnGuG,EAAkB,IAAI,IAAIF,EAAqB,IAAIG,GAAQA,EAAK,MAAM,CAAC,EAEvEC,EAAqBL,EAAW,OAAOhF,GAAQ,CAEnD,MAAMsF,GADuBtF,EAAK,qBAAuBA,EAAK,iBACb2C,EAC3C4C,GAAcJ,EAAgB,IAAInF,EAAK,MAAM,EACnD,OAAOsF,GAAmB,CAACC,EAC7B,CAAC,EAEKC,EAAgBR,EAAW,OAAOhF,GAAQ,CAC9C,MAAMuF,EAAcJ,EAAgB,IAAInF,EAAK,MAAM,EAC7CyF,EAAuB,CAACzF,EAAK,qBACjCA,EAAK,WAAa,MAClBA,EAAK,+BAAiC2C,EACxC,OAAO4C,GAAeE,CACxB,CAAC,EAEKC,EAAW,CAAC,GAAGL,EAAoB,GAAGG,CAAa,EACzDlC,EAAoBoC,CAAQ,EAC5BC,GAAyBD,CAAQ,EAAE,MAAME,GAAO,QAAQ,MAAM,kCAAmCA,CAAG,CAAC,CACvG,OAASQ,EAAS,CAChB,QAAQ,MAAM,0EAA2EA,CAAO,EAChG9C,EAAoB0B,CAAU,CAChC,CACF,MACE1B,EAAoB,CAAA,CAAE,CAE1B,CAEF,OAASvD,EAAO,CACd,QAAQ,MAAM,6BAA8BA,CAAK,EACjDuD,EAAoB,CAAA,CAAE,CACxB,QAAA,CACEjE,EAAa,EAAK,EAClBqE,GAAkB,EAAK,CACzB,CACF,GAEA,CACF,EAAG,CAACjF,EAAWkE,EAAe/D,CAAgB,CAAC,EAG/CgB,EAAAA,UAAU,IAAM,CACV,CAAC+C,GAAiB,CAACnE,IAECC,GAAaD,EAAY,UA8BnD,EAAG,CAACC,EAAWkE,EAAenE,CAAW,CAAC,EAG1CoB,EAAAA,UAAU,IAAM,CACd,GAAI,CAAChB,GAAoB,CAAC+D,EAAe,OACzC,MAAM6D,EAActB,GAAe,gCAAgCtG,EAAkB+D,EAAgByC,GAAS,CAC5G,GAAI,CAEFR,GAAA,CACF,OAASgB,EAAK,CACZ,QAAQ,MAAM,yDAA0DA,CAAG,CAC7E,CACF,CAAC,EAED,MAAO,IAAM,CACX,GAAI,CAAEY,EAAA,CAAc,MAAc,CAAa,CACjD,CACF,EAAG,CAAC5H,EAAkB+D,CAAa,CAAC,EAIpC/C,EAAAA,UAAU,IAAM,CACd,GAAIpB,EAAa,CACf0D,GAAA,EAEA,MAAMuE,EAAQ,WAAWvE,GAAqB,GAAG,EAC3CwE,EAAS,WAAWxE,GAAqB,GAAG,EAClD,MAAO,IAAM,CACX,aAAauE,CAAK,EAClB,aAAaC,CAAM,CACrB,CACF,CACF,EAAG,CAAClI,CAAW,CAAC,EAEhB,MAAMmI,GAAe,SAAY,CAC/B,GAAI,GAAClI,GAAa,CAACkE,GAAiB,CAACnE,GAAe,CAACI,IAEjD,OAAO,QAAQ,iFAAiF,EAClG,GAAI,CACF,MAAMkB,EAAmB,kBAAkBlB,EAAkBH,EAAWkE,CAAa,EACrFE,EAAS,YAAYpE,CAAS,mBAAmB,CACnD,OAASsB,EAAO,CACd,QAAQ,MAAM,8BAA+BA,CAAK,EAClDjB,EAAU,iDAAiD,CAC7D,CAEJ,EAEM8H,GAAoBC,GAAkB,CAC1C/C,GAAuB+C,CAAK,EAC5BjD,EAAe,EAAI,CACrB,EAEMkD,GAAqB,IAAM,CAC/BlD,EAAe,EAAK,CACtB,EAEMmD,GAA4B,MAAOC,GAAkB,CACzD,GAAI,GAACvI,GAAa,CAACkE,GAAiB,CAACK,GAAWgE,EAAM,SAAW,GAEjE,CAAAhD,EAA4B,EAAI,EAEhC,GAAI,CAEF,MAAMiD,EAAgB,MAAMC,EAAmB,4BAC7CF,EACAhE,EAAQ,KACRL,CAAA,EAIIwE,EAAmBD,EAAmB,4BAA4BD,CAAa,EAI/EG,EAAuB,CAAC,IADD5I,GAAA,YAAAA,EAAa,gBAAiB,CAAA,EACJ,GAAG2I,CAAgB,EAEpEE,GAAkB7I,GAAA,YAAAA,EAAa,YAAaC,EAClD,GAAI,CAACG,EAAkB,OACvB,MAAMkB,EAAmB,kBAAkBlB,EAAkByI,GAAmB,GAAI1E,EAAe,CACjG,cAAeyE,EACf,kBAAmBA,CAAA,CACpB,EAGD,MAAME,GAAmB9I,GAAA,YAAAA,EAAa,YAAaC,EAC7C8I,EAAqB,MAAMzH,EAAmB,eAAelB,EAAkB0I,GAAoB,GAAI3E,CAAa,EAC1HI,EAAewE,CAAkB,EAEjCxI,EAAY,sCAAsC,CACpD,OAASgB,EAAO,CACd,QAAQ,MAAM,kCAAmCA,CAAK,EACtDjB,EAAU,oDAAoD,CAChE,QAAA,CACEkF,EAA4B,EAAK,CACnC,EACF,EAEMwD,GAA0B,MAAOR,GAAkB,CACvD,GAAI,GAACvI,GAAa,CAACkE,GAAiB,CAACK,GAAWgE,EAAM,SAAW,GAEjE,CAAA9C,EAA0B,EAAI,EAE9B,GAAI,CAEF,MAAM+C,EAAgB,MAAMC,EAAmB,0BAC7CF,EACAhE,EAAQ,KACRL,CAAA,EAII8E,EAAiBP,EAAmB,0BAA0BD,CAAa,EAI3ES,EAAqB,CAAC,IADDlJ,GAAA,YAAAA,EAAa,cAAe,CAAA,EACJ,GAAGiJ,CAAc,EAE9DJ,GAAkB7I,GAAA,YAAAA,EAAa,YAAaC,EAClD,GAAI,CAACG,EAAkB,OACvB,MAAMkB,EAAmB,kBAAkBlB,EAAkByI,GAAmB,GAAI1E,EAAe,CACjG,YAAa+E,CAAA,CACd,EAGD,MAAMJ,GAAmB9I,GAAA,YAAAA,EAAa,YAAaC,EAC7C8I,EAAqB,MAAMzH,EAAmB,eAAelB,EAAkB0I,GAAoB,GAAI3E,CAAa,EAC1HI,EAAewE,CAAkB,EAEjCxI,EAAY,oCAAoC,CAClD,OAASgB,EAAO,CACd,QAAQ,MAAM,gCAAiCA,CAAK,EACpDjB,EAAU,kDAAkD,CAC9D,QAAA,CACEoF,EAA0B,EAAK,CACjC,EACF,EAEMyD,GAA2B,MAAOC,GAAqB,CAC3D,GAAI,GAACnJ,GAAa,CAACkE,GAAiB,CAACnE,GAAe,CAACI,GAErD,GAAI,CAGF,MAAMwI,GADuB5I,EAAY,eAAiB,CAAA,GACR,OAAOqJ,GAAOA,EAAI,MAAQD,CAAQ,EAE9EP,GAAkB7I,GAAA,YAAAA,EAAa,YAAaC,EAClD,MAAMqB,EAAmB,kBAAkBlB,EAAkByI,GAAmB,GAAI1E,EAAe,CACjG,cAAeyE,EACf,kBAAmBA,CAAA,CACpB,EAGD,MAAME,GAAmB9I,GAAA,YAAAA,EAAa,YAAaC,EAC7C8I,EAAqB,MAAMzH,EAAmB,eAAelB,EAAkB0I,GAAoB,GAAI3E,CAAa,EAC1HI,EAAewE,CAAkB,EAEjCxI,EAAY,oCAAoC,CAClD,OAASgB,EAAO,CACd,QAAQ,MAAM,gCAAiCA,CAAK,EACpDjB,EAAU,mDAAmD,CAC/D,CACF,EAEMgJ,GAAyB,MAAOF,GAAqB,CACzD,GAAI,GAACnJ,GAAa,CAACkE,GAAiB,CAACnE,GAErC,GAAI,CAGF,MAAMkJ,GADqBlJ,EAAY,aAAe,CAAA,GACR,OAAOqJ,GAAOA,EAAI,MAAQD,CAAQ,EAE1EP,GAAkB7I,GAAA,YAAAA,EAAa,YAAaC,EAClD,GAAI,CAACG,EAAkB,OACvB,MAAMkB,EAAmB,kBAAkBlB,EAAkByI,GAAmB,GAAI1E,EAAe,CACjG,YAAa+E,CAAA,CACd,EAGD,MAAMJ,GAAmB9I,GAAA,YAAAA,EAAa,YAAaC,EAC7C8I,EAAqB,MAAMzH,EAAmB,eAAelB,EAAkB0I,GAAoB,GAAI3E,CAAa,EAC1HI,EAAewE,CAAkB,EAEjCxI,EAAY,kCAAkC,CAChD,OAASgB,EAAO,CACd,QAAQ,MAAM,8BAA+BA,CAAK,EAClDjB,EAAU,iDAAiD,CAC7D,CACF,EAEMiJ,GAAyB,CAAC5B,EAAgB6B,IAAuB,CACrE1D,EAAiB9D,GAAQ,CACvB,MAAMyH,EAAS,IAAI,IAAIzH,CAAI,EAC3B,OAAAyH,EAAO,IAAI9B,EAAQ6B,CAAU,EACtBC,CACT,CAAC,CACH,EAEMC,GAAiB,MAAOlI,GAAkC,CAC9D,GAAI,GAACvB,GAAa,CAACkE,GAAiB,CAACnE,GAAe,CAACI,GAErD,GAAI,CAEF,MAAMuJ,EAAW,CACf,GAAGnI,EACH,UAAAvB,EACA,cAAAkE,EACA,YAAanE,EAAY,iBAAmB,IAAI,KAAA,EAAO,YAAA,EACvD,OAAQA,EAAY,OACpB,gBAAiB,YACjB,cAAe,UACf,MAAO,MAAM,KAAK,IAAA,CAAK,IAAI,KAAK,OAAA,EAAS,SAAS,EAAE,EAAE,OAAO,EAAG,CAAC,CAAC,GAClE,SAAU,GACV,IAAKwB,EAAK,KAAO,GACjB,cAAeA,EAAK,eAAiB,GACrC,aAAcA,EAAK,cAAgB,GACnC,YAAaA,EAAK,aAAe,GACjC,MAAOA,EAAK,OAAS,GACrB,MAAOA,EAAK,OAAS,GACrB,YAAa,MAAA,EAETmG,EAAS,MAAM5F,EAAoB,WAAW3B,EAAkBuJ,CAAQ,EAI9E,IAAIH,EAAa3D,GAAc,IAAIrE,EAAK,EAAE,EAK1C,GAJI,CAACgI,GAAchI,EAAK,aACtBgI,EAAahI,EAAK,YAGhBgI,GAAcA,EAAW,OAAS,EACpC,GAAI,CAoCF,MAAMI,GAnCiB,MAAM,QAAQ,IACnCJ,EAAW,IAAI,MAAOK,EAAMxB,IAAU,CACpC,GAAI,CAOF,MAAO,CACL,KAPmB,MAAMK,EAAmB,gBAC5CmB,EACArF,EAAUA,EAAQ,KAAO,kBACzBmD,CAAA,GAIkB,IAClB,IAAKkC,EAAK,KACV,UAAWxB,IAAU,EACrB,eAAgB,KAChB,SAAUwB,EAAK,KACf,KAAMA,EAAK,KACX,SAAUA,EAAK,IAAA,CAEnB,OAASC,EAAa,CACpB,eAAQ,MAAM,oBAAoBD,EAAK,IAAI,IAAKC,CAAW,EAEpD,CACL,IAAK,GACL,IAAKD,EAAK,KACV,UAAW,GACX,eAAgB,KAChB,SAAUA,EAAK,KACf,KAAMA,EAAK,KACX,SAAUA,EAAK,IAAA,CAEnB,CACF,CAAC,CAAA,GAIgC,OAAOR,GAAOA,EAAI,KAAOA,EAAI,IAAI,KAAA,IAAW,EAAE,EAG7EO,EAAY,OAAS,GACvB,MAAM7H,EAAoB,WAAW3B,EAAkBuH,EAAQ,CAAE,OAAQiC,EAAa,CAE1F,OAASrI,EAAO,CACd,QAAQ,MAAM,iCAAkCA,CAAK,CACvD,CAMF,MAAM+E,GAFmB,MAAMvE,EAAoB,uBAAuB3B,EAAkBH,EAAWkE,CAAa,GACnF,IAAI3C,GAAQA,EAAK,MAAM,EAC1B,IAAI+E,GAAMxE,EAAoB,YAAY3B,EAAkBmG,CAAE,CAAC,EAEvFC,GADQ,MAAM,QAAQ,IAAIF,CAAa,GACpB,OAAO9E,GAAQA,IAAS,IAAI,EACrDsD,EAAoB0B,CAAU,EAG9BZ,EAAgB,EAAK,EACrBE,EAAiB,IAAI,GAAK,EAE1BvF,EAAY,yBAAyB,CACvC,OAASgB,EAAO,CACd,QAAQ,MAAM,qBAAsBA,CAAK,EACzCjB,EAAU,uCAAuC,CACnD,CACF,EAEMyJ,GAAsB,IAAM,CAChCnE,EAAgB,EAAK,EACrBE,EAAiB,IAAI,GAAK,CAC5B,EAQQkE,GALqB,CAC3B,IAAIhK,GAAA,YAAAA,EAAa,gBAAiB,CAAA,EAClC,IAAIA,GAAA,YAAAA,EAAa,cAAe,CAAA,CAAC,EAGO,IAAI,CAACqJ,EAAKhB,KAAW,CAC7D,IAAKgB,EAAI,IACT,IAAKA,EAAI,SACT,SAAUA,EAAI,SACd,WAAYA,EAAI,WAChB,KAAMA,EAAI,KACV,SAAUA,EAAI,SACd,UAAWhB,IAAU,CAAA,EACrB,GAAK,CAAA,EAKP,eAAelB,GAAyB1F,EAAe,CACrD,GAAI,CAACrB,EAAkB,OAGvB,MAAM6J,EAAiB,MAAM,KAAK,IAAI,IACpCxI,EACG,IAAIyI,GAAKA,EAAE,qBAAuBA,EAAE,aAAa,EACjD,OAAO,OAAO,CAAA,CAClB,EAAE,UAAe,CAACnF,EAAoBoF,CAAI,CAAC,EAE5C,GAAIF,EAAe,SAAW,EAE9B,GAAI,CACF,MAAMG,EAAU,MAAM,QAAQ,IAC5BH,EAAe,IAAI,MAAOE,GAAS,CACjC,GAAI,CACF,MAAME,EAAM,MAAM/I,EAAmB,mBAAmBlB,EAAkB+J,CAAI,EAC9E,MAAO,CAAE,KAAAA,EAAM,UAAWE,EAAI,WAAa,IAAA,CAC7C,OAASjD,EAAK,CACZ,eAAQ,MAAM,yEAA0E,CAAE,KAAA+C,EAAM,IAAA/C,EAAK,EAC9F,CAAE,KAAA+C,EAAM,UAAW,IAAA,CAC5B,CACF,CAAC,CAAA,EAGGV,EAAS,CAAE,GAAG1E,CAAA,EACpBqF,EAAQ,QAAQE,GAAK,CACfA,EAAE,YACJb,EAAOa,EAAE,IAAI,EAAIA,EAAE,UAEvB,CAAC,EAGG,OAAO,KAAKb,CAAM,EAAE,OAAS,OAAO,KAAK1E,CAAmB,EAAE,QAChEC,EAAuByE,CAAM,CAEjC,OAASrC,EAAK,CACZ,QAAQ,MAAM,gEAAiEA,CAAG,CACpF,CACF,CAGA,SAASmD,GAAe/I,EAAYgJ,EAAyBC,EAAqB,CAChF,MAAMC,EAAY,4IAA4ID,EAAa,aAAe,EAAE,GAEtLE,EACJvI,EAAAA,KAAAkB,EAAAA,SAAA,CAEG,SAAA,CAAAmH,GACCpI,EAAAA,IAAC,OAAI,UAAU,8BACb,eAAC,OAAA,CAAK,UAAU,kGAAkG,SAAA,OAAA,CAElH,CAAA,CACF,EAID,CAACoI,GAAcjJ,EAAK,aACnBa,EAAAA,IAAC,OAAI,UAAU,8BACb,SAAAA,EAAAA,IAAC,OAAA,CAAK,UAAW,yEACfb,EAAK,cAAgB,OACjB,8BACAA,EAAK,cAAgB,aAErBA,EAAK,cAAgB,SADrB,0BAGAA,EAAK,cAAgB,WACrB,0BACAA,EAAK,cAAgB,YACrB,kCACA,2BACN,GACG,SAAAA,EAAK,cAAgB,YAAc,YAAcA,EAAK,YAAcA,EAAK,YAAY,OAAO,CAAC,EAAE,YAAA,EAAgBA,EAAK,YAAY,MAAM,CAAC,EAAI,SAAA,CAC9I,CAAA,CACF,EAIFY,EAAAA,KAAC,MAAA,CAAI,UAAU,+BACb,SAAA,CAAAC,EAAAA,IAAC,OAAI,UAAU,gBACZ,WAAK,QAAUb,EAAK,OAAO,OAAS,GAElC,IAAM,CACL,MAAMoJ,EAAepJ,EAAK,OAAO,KAAK6H,GAAOA,EAAI,SAAS,GAAK7H,EAAK,OAAO,CAAC,EAC5E,OACEa,EAAAA,IAAC,MAAA,CAAI,UAAU,gEACb,SAAAA,EAAAA,IAAC,MAAA,CACC,IAAKuI,EAAa,IAClB,IAAKA,EAAa,KAAO,aACzB,UAAU,4BAAA,CAAA,EAEd,CAEJ,GAAA,EAGAvI,EAAAA,IAAC,OAAI,UAAU,2GACb,eAACwI,EAAA,CAAQ,UAAU,UAAU,CAAA,CAC/B,EAEJ,EAGAxI,MAAC,MAAA,CAAI,UAAU,mCACb,gBAAC,MAAA,CACC,SAAA,CAAAA,EAAAA,IAAC,KAAA,CAAG,UAAU,+DACX,SAAAb,EAAK,YACR,EAECA,EAAK,OACJa,EAAAA,IAAC,KAAE,UAAU,6BACV,WAAK,KAAA,CACR,CAAA,CAAA,CAEJ,CAAA,CACF,CAAA,EACF,EAGAD,EAAAA,KAAC,MAAA,CAAI,UAAU,oEACX,SAAA,EAAAZ,EAAK,cAAgBA,EAAK,gBAC1Ba,EAAAA,IAAC,OAAA,CAAK,UAAU,4BAA6B,SAAAgB,EAAe7B,EAAK,cAAgBA,EAAK,eAAiB,GAAG,EAAE,EAE7GA,EAAK,QACJY,EAAAA,KAAAkB,EAAAA,SAAA,CACI,SAAA,EAAA9B,EAAK,cAAgBA,EAAK,sBAAmB,OAAA,CAAK,UAAU,mBAAmB,SAAA,GAAA,CAAC,EAClFa,EAAAA,IAAC,OAAA,CAAK,UAAU,4BAA6B,WAAK,MAAA,CAAO,CAAA,EAC3D,EAEDb,EAAK,KACJY,EAAAA,KAAAkB,EAAAA,SAAA,CACI,SAAA,EAAA9B,EAAK,cAAgBA,EAAK,eAAiBA,EAAK,SAAWa,MAAC,OAAA,CAAK,UAAU,mBAAmB,SAAA,GAAA,CAAC,EACjGA,EAAAA,IAAC,OAAA,CAAK,UAAU,4BAA6B,WAAK,GAAA,CAAI,CAAA,CAAA,CACxD,CAAA,CAAA,CAEJ,CAAA,EACF,EAIF,OAAKmI,EAeHnI,MAACyI,IAAuB,GAAIN,EAAU,UAAWE,EAC9C,SAAAC,GADQnJ,EAAK,MAEhB,GAhBA,QAAQ,MAAM,wDAAyD,CACrE,OAAQA,EAAK,OACb,oBAAqBA,EAAK,qBAAuBA,EAAK,cACtD,UAAWA,EAAK,SAAA,CACjB,QAGE,MAAA,CAAsB,UAAWkJ,EAC/B,SAAAC,CAAA,EADOnJ,EAAK,MAEf,EASN,CAEA,OAAIZ,QAEC,MAAA,CAAI,UAAU,wCACb,SAAAwB,EAAAA,KAAC,MAAA,CAAI,UAAU,cACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,yEAAA,CAA0E,EACzFA,EAAAA,IAAC,IAAA,CAAE,UAAU,6BAA6B,SAAA,wBAAA,CAAsB,CAAA,CAAA,CAClE,CAAA,CACF,EAICrC,EAoBHoC,EAAAA,KAAC,MAAA,CAAI,UAAU,YAEb,SAAA,CAAAC,EAAAA,IAAC,OAAI,UAAU,YAEb,SAAAD,EAAAA,KAAC,MAAA,CAAI,UAAU,oCACb,SAAA,CAAAA,EAAAA,KAAC0I,GAAA,CACC,GAAI5E,EACJ,UAAU,iFAEV,SAAA,CAAA7D,EAAAA,IAAC0I,GAAA,CAAU,UAAU,cAAA,CAAe,EAAE,MAAA,CAAA,CAAA,EAGxC1I,EAAAA,IAAC,MAAA,CAAI,UAAU,iBACb,SAAAA,EAAAA,IAACyI,GAAA,CACC,GAAI,YAAY7K,CAAS,gBAAgBkE,CAAa,QACtD,UAAU,uNACV,MAAM,mBAEN,SAAA9B,EAAAA,IAAC2I,GAAA,CAAK,UAAU,SAAA,CAAU,CAAA,CAAA,CAC5B,CACF,CAAA,CAAA,CACF,CAAA,CACF,EAGA5I,EAAAA,KAAC,MAAA,CAAI,UAAU,6CACb,SAAA,CAAAC,EAAAA,IAAC,OAAI,UAAU,qCACb,SAAAD,EAAAA,KAAC,KAAA,CAAG,UAAU,iDACX,SAAA,CAAAyB,GAA6B7D,CAAW,EAAE,MAAIqD,EAAerD,EAAY,MAAM,CAAA,CAAA,CAClF,CAAA,CACF,EAGAoC,EAAAA,KAAC,MAAA,CAAI,UAAU,qCACb,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,yCAAyC,SAAA,sBAEvD,EACAD,EAAAA,KAAC,KAAA,CAAG,UAAU,kDACZ,SAAA,CAAAA,OAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,SAAM,EACxDA,EAAAA,IAAC,KAAA,CAAG,UAAU,6BAA8B,WAAY,MAAA,CAAO,CAAA,EACjE,SAEC,MAAA,CACC,SAAA,CAAAA,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,kBAAe,QAChE,KAAA,CAAG,UAAU,OACd,SAAAA,EAAAA,IAAC,OAAA,CAAK,UAAW,uEACbrC,EAAY,iBAAmB,aAC3B,8BACAA,EAAY,iBAAmB,cAC/B,gCACAA,EAAY,iBAAmB,sBAC/B,gCACAA,EAAY,iBAAmB,UAC/B,8BACAA,EAAY,iBAAmB,UAC/B,gCACAA,EAAY,iBAAmB,sBAC/B,gCACAA,EAAY,iBAAmB,OAC/B,8BACA,2BACN,GACG,SAAAA,EAAY,gBAAkB,gBACjC,CAAA,CACF,CAAA,EACF,SAEC,MAAA,CACC,SAAA,CAAAqC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,mBAAgB,EAClEA,EAAAA,IAAC,KAAA,CAAG,UAAU,OACZ,SAAAA,EAAAA,IAAC,QAAK,UAAW,+EACfrC,EAAY,kBAAoB,WAC5B,8BACAA,EAAY,kBAAoB,SAChC,0BACAA,EAAY,kBAAoB,eAChC,kCACA,2BACN,GACG,SAAAA,EAAY,eAAA,CACf,CAAA,CACF,CAAA,EACF,SAEC,MAAA,CACC,SAAA,CAAAqC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,SAAM,QACvD,KAAA,CAAG,UAAU,6BAA8B,SAAAgB,EAAerD,EAAY,MAAM,CAAA,CAAE,CAAA,EACjF,EAECA,EAAY,eACXoC,EAAAA,KAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,kBAAe,EACjEA,EAAAA,IAAC,MAAG,UAAU,6BACX,WAAY,gBAAkB,QAC3B,UACC,IAAM,CACL,MAAM4I,EAASvG,EAAW,QAAUwG,EAAE,KAAOlL,EAAY,aAAa,EACtE,OAAOiL,EAAS,GAAGA,EAAO,IAAI,KAAKA,EAAO,KAAK,QAAQ,CAAC,CAAC,KAAOjL,EAAY,aAC9E,IAAG,CAET,CAAA,EACF,EAGDA,EAAY,UACXoC,EAAAA,KAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,WAAQ,QACzD,KAAA,CAAG,UAAU,6BAA8B,SAAAgB,EAAerD,EAAY,QAAQ,CAAA,CAAE,CAAA,EACnF,EAGDA,EAAY,aAAe,QAC1BoC,EAAAA,KAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,WAAQ,EAC1DD,EAAAA,KAAC,KAAA,CAAG,UAAU,6BAA8B,SAAA,CAAA,OAAOpC,EAAY,UAAU,EAAE,QAAQ,CAAC,EAAE,GAAA,CAAA,CAAC,CAAA,EACzF,SAGD,MAAA,CACC,SAAA,CAAAqC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,mBAAgB,EAClEA,EAAAA,IAAC,KAAA,CAAG,UAAU,6BACX,SAAArC,EAAY,gBAAkBmL,GAAWnL,EAAY,eAAe,EAAI,SAAA,CAC3E,CAAA,EACF,SAEC,MAAA,CACC,SAAA,CAAAqC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,iBAAc,EAChEA,EAAAA,IAAC,KAAA,CAAG,UAAU,6BAA8B,WAAY,aAAA,CAAc,CAAA,EACxE,SAEC,MAAA,CACC,SAAA,CAAAA,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,SAAM,QACvD,KAAA,CAAG,UAAU,6BACV,UAAArC,EAAY,QAAU,WAAW,OAAO,CAAC,EAAE,eAAiBA,EAAY,QAAU,WAAW,MAAM,CAAC,CAAA,CACxG,CAAA,EACF,EAECA,EAAY,mBAAsBA,EAAY,oBAAiC,WAC7E,MAAA,CACC,SAAA,CAAAqC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,qBAAkB,EACpEA,EAAAA,IAAC,MAAG,UAAU,6BACX,WAAY,oBAAsB+I,GAAsBA,GAAsBC,EAAA,CACjF,CAAA,EACF,EAGDrL,EAAY,gBACXoC,EAAAA,KAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,kBAElD,EACAA,EAAAA,IAAC,MAAG,UAAU,OACZ,eAAC,OAAA,CAAK,UAAU,sGAAsG,SAAA,KAAA,CAEtH,CAAA,CACF,CAAA,EACF,EAGDrC,EAAY,OACXoC,OAAC,MAAA,CAAI,UAAU,gBACb,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,oCAAoC,SAAA,QAAK,EACvDA,EAAAA,IAAC,KAAA,CAAG,UAAU,iDAAkD,WAAY,KAAA,CAAM,CAAA,CAAA,CACpF,CAAA,CAAA,CAEJ,CAAA,EACF,EAGAD,EAAAA,KAAC,MAAA,CAAI,UAAU,qCACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,yCACb,SAAA,CAAAA,EAAAA,KAAC,KAAA,CAAG,UAAU,sDACZ,SAAA,CAAAC,EAAAA,IAACiJ,EAAA,CAAU,UAAU,cAAA,CAAe,EAAE,gBAAA,EAExC,EACKtL,EAAY,eAAiBA,EAAY,cAAc,OAAS,GACnEoC,EAAAA,KAAC,SAAA,CACC,QAAS,IAAM,CAEb,MAAMmJ,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,KAAO,OACbA,EAAM,SAAW,GACjBA,EAAM,OAAS,UACfA,EAAM,SAAYC,GAAM,CACtB,MAAMhD,EAASgD,EAAE,OAA4B,MACzChD,GACFD,GAA0B,MAAM,KAAKC,CAAK,CAAC,CAE/C,EACA+C,EAAM,MAAA,CACR,EACA,SAAUhG,EACV,UAAU,+NAEV,SAAA,CAAAlD,EAAAA,IAACiJ,EAAA,CAAU,UAAU,cAAA,CAAe,EACnC/F,EAA2B,eAAiB,YAAA,CAAA,CAAA,CAC/C,EAEJ,EACCvF,EAAY,eAAiBA,EAAY,cAAc,OAAS,EAC/DqC,EAAAA,IAACoJ,GAAA,CACC,OAAQzL,EAAY,cACpB,cAAemJ,GACf,aAAcf,GACd,UAAW,EACX,aAAc,GACd,KAAK,KACL,UAAU,MAAA,CAAA,EAGZhG,EAAAA,KAAC,MAAA,CAAI,UAAU,mBACb,SAAA,CAAAC,EAAAA,IAACiJ,EAAA,CAAU,UAAU,+BAAA,CAAgC,EACrDjJ,EAAAA,IAAC,KAAA,CAAG,UAAU,yCAAyC,SAAA,6BAA0B,EACjFD,EAAAA,KAAC,SAAA,CACC,QAAS,IAAM,CAEb,MAAMmJ,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,KAAO,OACbA,EAAM,SAAW,GACjBA,EAAM,OAAS,UACfA,EAAM,SAAYC,GAAM,CACtB,MAAMhD,EAASgD,EAAE,OAA4B,MACzChD,GACFD,GAA0B,MAAM,KAAKC,CAAK,CAAC,CAE/C,EACA+C,EAAM,MAAA,CACR,EACA,SAAUhG,EACV,UAAU,sOAEV,SAAA,CAAAlD,EAAAA,IAACiJ,EAAA,CAAU,UAAU,cAAA,CAAe,EACnC/F,EAA2B,eAAiB,oBAAA,CAAA,CAAA,CAC/C,CAAA,CACF,CAAA,EAEJ,EAGKvF,EAAY,aAAeA,EAAY,YAAY,OAAS,GAC/DoC,EAAAA,KAAC,MAAA,CAAI,UAAU,qCACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,yCACb,SAAA,CAAAA,EAAAA,KAAC,KAAA,CAAG,UAAU,sDACZ,SAAA,CAAAC,EAAAA,IAACiJ,EAAA,CAAU,UAAU,cAAA,CAAe,EAAE,cAAA,EAExC,EACAlJ,EAAAA,KAAC,SAAA,CACC,QAAS,IAAM,CAEb,MAAMmJ,EAAQ,SAAS,cAAc,OAAO,EAC5CA,EAAM,KAAO,OACbA,EAAM,SAAW,GACjBA,EAAM,OAAS,UACfA,EAAM,SAAYC,GAAM,CACtB,MAAMhD,EAASgD,EAAE,OAA4B,MACzChD,GACFQ,GAAwB,MAAM,KAAKR,CAAK,CAAC,CAE7C,EACA+C,EAAM,MAAA,CACR,EACA,SAAU9F,EACV,UAAU,+NAEV,SAAA,CAAApD,EAAAA,IAACiJ,EAAA,CAAU,UAAU,cAAA,CAAe,EACnC7F,EAAyB,eAAiB,YAAA,CAAA,CAAA,CAC7C,EACF,EACApD,EAAAA,IAACoJ,GAAA,CACC,OAAQzL,EAAY,YACpB,cAAesJ,GACf,aAAejB,GAAU,SAEvB,MAAMqD,IAAe5H,EAAA9D,EAAY,gBAAZ,YAAA8D,EAA2B,SAAU,EACpD6H,IAAc3H,EAAAhE,EAAY,oBAAZ,YAAAgE,EAA+B,SAAU,EACvD4H,EAAeF,EAAeC,EAActD,EAClDD,GAAiBwD,CAAY,CAC/B,EACA,UAAW,EACX,aAAc,GACd,KAAK,KACL,UAAU,MAAA,CAAA,CACZ,EAEF,EAIFxJ,EAAAA,KAAC,MAAA,CAAI,UAAU,qCACb,SAAA,CAAAA,EAAAA,KAAC,MAAA,CAAI,UAAU,yCACb,SAAA,CAAAA,EAAAA,KAAC,KAAA,CAAG,UAAU,sDACZ,SAAA,CAAAC,EAAAA,IAACwI,EAAA,CAAQ,UAAU,cAAA,CAAe,EAAE,mBAAA,EAEtC,EAEE,CAAC5F,GAAkB,CAACU,GAAgBzF,EAAiB,OAAS,GAC9DkC,EAAAA,KAAC,SAAA,CACC,QAAS,IAAMwD,EAAgB,EAAI,EACnC,UAAU,2MACV,MAAM,eAEN,SAAA,CAAAvD,EAAAA,IAACwI,EAAA,CAAQ,UAAU,cAAA,CAAe,EAAE,UAAA,CAAA,CAAA,CAEtC,EAEJ,EAEC5F,EACC7C,EAAAA,KAAC,MAAA,CAAI,UAAU,wCACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,iEAAA,CAAkE,EACjFA,EAAAA,IAAC,OAAA,CAAK,UAAU,6BAA6B,SAAA,kBAAA,CAAgB,CAAA,CAAA,CAC/D,EAEAA,EAAAA,IAAC,MAAA,CAAI,UAAU,YAEX,UAAA,IAAM,CAEN,MAAMwE,EAAqB3G,EAAiB,OAAOsB,IACpBA,EAAK,qBAAuBA,EAAK,iBAC9B2C,CACjC,EAEK6C,EAAgB9G,EAAiB,OAAOsB,GAAQ,CAEpD,MAAMuF,GADuBvF,EAAK,qBAAuBA,EAAK,iBACjB2C,EAEvC8C,EAAuB,CAACzF,EAAK,qBACjCA,EAAK,WAAa,MAClBA,EAAK,+BAAiC2C,EACxC,OAAO4C,GAAeE,CACxB,CAAC,EAED,OACE7E,EAAAA,KAAAkB,WAAA,CAEG,SAAA,CAAAuD,EAAmB,OAAS,GAC3BzE,EAAAA,KAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,2CAA2C,SAAA,kBAAe,QACvE,MAAA,CAAI,UAAU,uDACZ,SAAAwE,EAAmB,IAAKrF,GAAS,CAChC,MAAMqK,EAAgBrK,EAAK,WAAa,KAClCsK,EAAkB7L,IAAaD,GAAA,YAAAA,EAAa,YAAa,GACzDwK,EAAWqB,EACb9F,EAAgB,uBAAuBvE,EAAK,MAAM,GAAI,CAAE,KAAM,yBAAA,CAA2B,EACzFuE,EAAgB,YAAY+F,CAAe,SAAStK,EAAK,MAAM,GAAI,CAAE,KAAM,cAAe,QAASsK,EAAiB,cAAe3H,GAAiB,EAAA,CAAI,EAE5J,OAAOoG,GAAe/I,EAAMgJ,EAAU,EAAK,CAC7C,CAAC,CAAA,CACH,CAAA,EACF,EAIDxD,EAAc,OAAS,GACtB5E,EAAAA,KAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,2CAA2C,SAAA,QAAK,QAC7D,MAAA,CAAI,UAAU,uDACZ,SAAA2E,EAAc,IAAKxF,GAAS,CAC3B,MAAMuK,EAAuBvK,EAAK,qBAAuBA,EAAK,cACxDwK,EAAgB,CAACD,EAGvB,IAAIvB,EAA0B,KAE9B,GAAIwB,EACFxB,EAAWzE,EAAgB,uBAAuBvE,EAAK,MAAM,GAAI,CAAE,KAAM,0BAA2B,UAC3FA,EAAK,UAEdgJ,EAAWzE,EAAgB,YAAYvE,EAAK,SAAS,SAASA,EAAK,MAAM,GAAI,CAAE,KAAM,aAAA,CAAe,UAC3FuK,GAAA,MAAAA,EAAsB,WAAW,cAAgBA,GAAA,MAAAA,EAAsB,WAAW,iBAE3FvB,EAAWzE,EAAgB,uBAAuBvE,EAAK,MAAM,GAAI,CAAE,KAAM,0BAA2B,MAC/F,CAEL,MAAMyK,EAAoBF,EAAuBhH,EAAoBgH,CAAoB,EAAI,OACzFE,EACFzB,EAAWzE,EAAgB,YAAYkG,CAAiB,SAASzK,EAAK,MAAM,GAAI,CAAE,KAAM,cAAe,QAASyK,EAAmB,cAAe9H,GAAiB,GAAI,GAGvK,QAAQ,MAAM,iDAAkD,CAC9D,OAAQ3C,EAAK,OACb,qBAAAuK,EACA,cAAevK,EAAK,UACpB,kBAAmBuD,EAAoBgH,GAAwB,EAAE,CAAA,CAClE,EACDvB,EAAW,KAEf,CAEA,OAAOD,GAAe/I,EAAMgJ,EAAU,EAAI,CAC5C,CAAC,CAAA,CACH,CAAA,EACF,EAGD3D,EAAmB,SAAW,GAAKG,EAAc,SAAW,GAAK,CAACrB,GACjEvD,EAAAA,KAAC,MAAA,CAAI,UAAU,mBACb,SAAA,CAAAC,EAAAA,IAACwI,EAAA,CAAQ,UAAU,+BAAA,CAAgC,EACnDxI,EAAAA,IAAC,KAAA,CAAG,UAAU,yCAAyC,SAAA,iBAAc,EACrED,EAAAA,KAAC,SAAA,CACC,QAAS,IAAMwD,EAAgB,EAAI,EACnC,UAAU,kNACV,MAAM,eAEN,SAAA,CAAAvD,EAAAA,IAACwI,EAAA,CAAQ,UAAU,cAAA,CAAe,EAAE,UAAA,CAAA,CAAA,CAEtC,EACF,EAGDlF,GACCtD,EAAAA,IAAC6J,GAAA,CACC,OAAQxC,GACR,SAAUK,GACV,UAAA9J,EACA,YAAauE,EAAUA,EAAQ,KAAO,GACtC,mBAAoB+E,EAAA,CAAA,CACtB,EAEJ,CAEJ,IAAG,CAEL,CAAA,EAEJ,EAGCvJ,IAAgBC,GAAaD,EAAY,YAAc6D,GAA6B7D,CAAW,IAAM+D,IAA0BF,GAA6B7D,CAAW,IAAMiE,IAC5K5B,MAAC,MAAA,CAAI,UAAU,qCACb,SAAAA,EAAAA,IAACtC,GAAA,CACC,YAAAC,EACA,UAAWC,GAAaD,EAAY,WAAa,GACjD,iBAAAE,EACA,eAAgBkG,EAAA,CAAA,EAEpB,QAID,MAAA,CAAI,UAAU,gDACb,SAAAhE,EAAAA,KAAC,MAAA,CAAI,UAAU,WACb,SAAA,CAAAA,EAAAA,KAAC,KAAA,CAAG,UAAU,kDACZ,SAAA,CAAAA,OAAC,MAAA,CACC,SAAA,CAAAC,EAAAA,IAAC,KAAA,CAAG,UAAU,4DAA4D,SAAA,UAAO,QAChF,KAAA,CAAG,UAAU,6BAA8B,UAAAmC,GAAA,YAAAA,EAAS,OAAQxE,EAAY,WAAA,CAAY,CAAA,EACvF,SACC,MAAA,CACC,SAAA,CAAAqC,EAAAA,IAAC,KAAA,CAAG,UAAU,4DAA4D,SAAA,UAAO,QAChF,KAAA,CAAG,UAAU,6BACX,SAAA8I,GAAWnL,EAAY,SAAS,CAAA,CACnC,CAAA,CAAA,CACF,CAAA,EACF,EAGAqC,EAAAA,IAAC,MAAA,CAAI,UAAU,4BACb,SAAAA,EAAAA,IAAC,SAAA,CACC,QAAS8F,GACT,UAAU,kNACV,MAAM,qBAEN,SAAA9F,EAAAA,IAAC8J,GAAA,CAAO,UAAU,SAAA,CAAU,CAAA,CAAA,CAC9B,CACF,CAAA,CAAA,CACF,CAAA,CACF,CAAA,EACF,EAGChH,IACC9C,EAAAA,IAAC+J,GAAA,CACC,OAAQpC,GACR,aAAc3E,GACd,QAASiD,EAAA,CAAA,CACX,EAEJ,EAhfElG,EAAAA,KAAC,MAAA,CAAI,UAAU,oBACb,SAAA,CAAAC,EAAAA,IAAC,MAAA,CAAI,UAAU,kCAAkC,SAAA,KAAE,EACnDA,EAAAA,IAAC,KAAA,CAAG,UAAU,yCAAyC,SAAA,wBAAqB,EAC5EA,EAAAA,IAAC,IAAA,CAAE,UAAU,6BAA6B,SAAA,oDAAiD,EAC3FA,EAAAA,IAAC,MAAA,CAAI,UAAU,OACb,SAAAD,EAAAA,KAAC0I,GAAA,CACC,GAAI5E,EACJ,UAAU,uJAEV,SAAA,CAAA7D,EAAAA,IAAC0I,GAAA,CAAU,UAAU,cAAA,CAAe,EAAE,MAAA,CAAA,CAAA,CAExC,CACF,CAAA,EACF,CAqeN"}