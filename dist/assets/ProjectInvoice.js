import{d as z,l as G,j as e,B as g,f as E,C as L,h as J,i as K}from"./index.js";import{r as c}from"./vendor.js";import{a as A,p as Q,t as X,u as Z}from"./inventoryService.js";import{c as ee,b as te}from"./router.js";import"./supabase.js";import"./ui.js";import"./taxPresetsService.js";const d=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}),O=s=>{var n,o;return(n=s.transactionId)!=null&&n.startsWith("INV_SALE_")?J:(o=s.transactionId)!=null&&o.startsWith("INV_PURCHASE_")?K:s.source};function _(s){if(typeof s=="number")return isNaN(s)?0:s;if(typeof s=="string"){const n=parseFloat(s||"0");return isNaN(n)?0:n}return 0}function le(){const{id:s}=ee(),n=te(),{currentAccountId:o}=z(),{businessName:M,businessLogoUrl:b}=G(),[l,B]=c.useState(null),[h,k]=c.useState([]),[u,U]=c.useState([]),[Y,v]=c.useState(!0),[w,I]=c.useState(null),F=c.useMemo(()=>new Date().toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),[]);c.useEffect(()=>{(async()=>{if(!s||!o){if(!o)return;n("/projects");return}v(!0),I(null);try{const[r,m]=await Promise.all([Q.getProject(o,s),X.getTransactions(o,s)]);if(!r){n("/projects");return}B(r);const i=m.filter(a=>a.status!=="canceled").filter(a=>a.reimbursementType===E||a.reimbursementType===L),C=await Promise.all(i.map(async a=>{const y=(await Z.getItemsForTransaction(o,s,a.transactionId)).map(N=>{const x=N.projectPrice,D=!!x&&String(x).trim()!=="",$=D?_(x||"0"):0;return{item:N,amount:$,missingPrice:!D}}),S=y.length>0,q=S?y.reduce((N,x)=>N+x.amount,0):_(a.amount);return{transaction:a,items:y,hasItems:S,lineTotal:q}})),W=C.filter(a=>a.transaction.reimbursementType===E).sort((a,j)=>(a.transaction.transactionDate||"").localeCompare(j.transaction.transactionDate||"")),H=C.filter(a=>a.transaction.reimbursementType===L).sort((a,j)=>(a.transaction.transactionDate||"").localeCompare(j.transaction.transactionDate||""));k(W),U(H)}catch(r){console.error("Failed to load invoice data:",r),I("Failed to load invoice data. Please try again.")}finally{v(!1)}})()},[s,o,n]);const p=c.useMemo(()=>h.reduce((t,r)=>t+r.lineTotal,0),[h]),f=c.useMemo(()=>u.reduce((t,r)=>t+r.lineTotal,0),[u]),R=c.useMemo(()=>p-f,[p,f]),V=()=>window.print(),P=()=>{if(!s)return n("/projects");n(`/project/${s}?tab=transactions&budgetTab=accounting`)};if(Y)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Building invoice..."})]})});if(w)return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-red-400",children:"âš ï¸"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Error"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:w}),e.jsx("div",{className:"mt-6",children:e.jsx(g,{onClick:P,children:"Back"})})]});const T=h.length>0||u.length>0;return e.jsxs("div",{className:"max-w-4xl mx-auto bg-white shadow rounded-lg p-8 print:shadow-none print:p-0",children:[e.jsxs("div",{className:"flex justify-end space-x-3 mb-6 print:hidden",children:[e.jsx(g,{variant:"secondary",onClick:P,children:"Back"}),e.jsx(g,{onClick:V,children:"Print"})]}),e.jsx("div",{className:"border-b pb-4 mb-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[b&&e.jsx("img",{src:b,alt:M,className:"h-24 w-auto object-contain"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Invoice"}),e.jsxs("div",{className:"mt-1 text-sm text-gray-600",children:[e.jsx("div",{className:"font-medium text-gray-800",children:(l==null?void 0:l.name)||"Project"}),(l==null?void 0:l.clientName)&&e.jsxs("div",{children:["Client: ",l.clientName]}),e.jsxs("div",{children:["Date: ",F]})]})]})]})}),!T&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto h-12 w-12 text-gray-400",children:"ðŸ§¾"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No invoiceable items"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"There are no qualifying transactions for this project."})]}),T&&e.jsxs("div",{className:"space-y-10",children:[e.jsxs("section",{children:[e.jsx("div",{className:"flex items-baseline justify-between mb-3",children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Project Charges"})}),e.jsxs("div",{className:"rounded-lg border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"divide-y",children:h.map(t=>{const r=O(t.transaction),m=A(t.transaction.transactionDate,"",{year:void 0,month:"short",day:"numeric"});return e.jsxs("div",{className:"py-4 px-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-1 text-gray-900",children:[e.jsx("span",{className:"font-medium",children:r}),m&&e.jsx("span",{className:"text-xs font-normal text-gray-500",children:m})]}),t.transaction.notes&&e.jsx("div",{className:"text-sm text-gray-500",children:t.transaction.notes})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.format(t.lineTotal)})]}),t.hasItems&&e.jsx("div",{className:"mt-2 ml-4",children:e.jsx("ul",{className:"space-y-1",children:t.items.map(i=>e.jsxs("li",{className:"flex items-start justify-between text-sm",children:[e.jsxs("div",{className:"text-gray-700",children:[i.item.description||"Item",i.missingPrice&&e.jsx("span",{className:"ml-2 text-yellow-700 bg-yellow-50 border border-yellow-200 rounded px-1",children:"Missing project price"})]}),e.jsx("div",{className:"pr-4 text-right text-gray-600",children:d.format(i.amount)})]},i.item.itemId))})})]},t.transaction.transactionId)})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-white border-t border-gray-100",children:[e.jsx("span",{className:"text-base font-semibold text-gray-900",children:"Charges Total"}),e.jsx("span",{className:"text-base font-semibold text-gray-900",children:d.format(p)})]})]})]}),e.jsxs("section",{children:[e.jsx("div",{className:"flex items-baseline justify-between mb-3",children:e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Project Credits"})}),e.jsxs("div",{className:"rounded-lg border border-gray-100 overflow-hidden",children:[e.jsx("div",{className:"divide-y",children:u.map(t=>{const r=O(t.transaction),m=A(t.transaction.transactionDate,"",{year:void 0,month:"short",day:"numeric"});return e.jsxs("div",{className:"py-4 px-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-1 text-gray-900",children:[e.jsx("span",{className:"font-medium",children:r}),m&&e.jsx("span",{className:"text-xs font-normal text-gray-500",children:m})]}),t.transaction.notes&&e.jsx("div",{className:"text-sm text-gray-500",children:t.transaction.notes})]}),e.jsx("div",{className:"text-right text-gray-700",children:d.format(t.lineTotal)})]}),t.hasItems&&e.jsx("div",{className:"mt-2 ml-4",children:e.jsx("ul",{className:"space-y-1",children:t.items.map(i=>e.jsxs("li",{className:"flex items-start justify-between text-sm",children:[e.jsxs("div",{className:"text-gray-700",children:[i.item.description||"Item",i.missingPrice&&e.jsx("span",{className:"ml-2 text-yellow-700 bg-yellow-50 border border-yellow-200 rounded px-1",children:"Missing project price"})]}),e.jsx("div",{className:"pr-4 text-right text-gray-600",children:d.format(i.amount)})]},i.item.itemId))})})]},t.transaction.transactionId)})}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-white border-t border-gray-100",children:[e.jsx("span",{className:"text-base font-semibold text-gray-900",children:"Credits Total"}),e.jsx("span",{className:"text-base font-semibold text-gray-900",children:d.format(f)})]})]})]}),e.jsx("section",{className:"border-t pt-4",children:e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-primary-600",children:"Net Amount Due"}),e.jsx("div",{className:"text-xl font-bold text-primary-600",children:d.format(R)})]})})]})]})}export{le as default};
//# sourceMappingURL=ProjectInvoice.js.map
