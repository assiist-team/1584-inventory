import{u as D,d as R,U,j as e,l as O,h as B,i as Y}from"./index.js";import{C as x}from"./ContextBackLink.js";import{u as W}from"./useStackedNavigate.js";import{r as n}from"./vendor.js";import{u as P,t as q}from"./inventoryService.js";import{g as K}from"./vendorDefaultsService.js";import{S as H}from"./Select.js";import{b as z}from"./router.js";import{d as X,g as I,b as C,t as T}from"./ui.js";import"./supabase.js";import"./taxPresetsService.js";const G=o=>{var i,u;return(i=o.transactionId)!=null&&i.startsWith("INV_SALE_")?B:(u=o.transactionId)!=null&&u.startsWith("INV_PURCHASE_")?Y:o.source};function ie(){const{id:o,itemId:i}=z(),u=W(),{hasRole:E}=D(),{currentAccountId:l}=R(),p=()=>{const r=new URLSearchParams(window.location.search).get("returnTo");return r?decodeURIComponent(r):`/project/${o}?tab=inventory`};if(!E(U.USER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(X,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to edit items. Please contact an administrator if you need access."}),e.jsx(x,{fallback:p(),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Project"})]})});const[t,b]=n.useState({description:"",source:"",sku:"",purchasePrice:"",projectPrice:"",marketValue:"",paymentMethod:"",space:"",notes:"",selectedTransactionId:""}),[v,f]=n.useState(!1),[V,_]=n.useState(!0),[g,N]=n.useState(!1),[a,h]=n.useState({}),[w,M]=n.useState([]),[j,k]=n.useState(!1),[y,S]=n.useState([]),F=n.useRef(!1);console.log("EditItem - URL params:",{projectId:o,itemId:i}),n.useEffect(()=>{(async()=>{if(l)try{const r=await K(l);S(r)}catch(r){console.error("Error loading vendor defaults:",r),S([])}})()},[l]),n.useEffect(()=>{t.source&&!y.includes(t.source)?f(!0):t.source&&y.includes(t.source)&&f(!1)},[t.source,y]),n.useEffect(()=>{(async()=>{if(console.log("fetchItem called with:",{projectId:o,itemId:i}),i&&o&&l)try{const r=await P.getItemById(l,i);console.log("Fetched item data:",r),r&&(b({description:String(r.description||""),source:String(r.source||""),sku:String(r.sku||""),purchasePrice:String(r.purchasePrice||""),projectPrice:String(r.projectPrice||""),marketValue:String(r.marketValue||""),paymentMethod:String(r.paymentMethod||""),space:String(r.space||""),notes:String(r.notes||""),selectedTransactionId:String(r.transactionId||"")}),console.log("Form data set:",{description:String(r.description||""),source:String(r.source||""),sku:String(r.sku||""),purchasePrice:String(r.purchasePrice||""),marketValue:String(r.marketValue||""),paymentMethod:String(r.paymentMethod||""),notes:String(r.notes||"")}))}catch(r){console.error("Failed to fetch item:",r),h({fetch:"Failed to load item data"})}_(!1)})()},[i,o,l]),n.useEffect(()=>{(async()=>{if(o&&l){k(!0);try{const r=await q.getTransactions(l,o);M(r)}catch(r){console.error("Error fetching transactions:",r)}finally{k(!1)}}})()},[o,l]);const A=()=>{const s={};return t.description.trim()||(s.description="Description is required"),h(s),Object.keys(s).length===0},L=async s=>{if(s.preventDefault(),!A()||!i||!o||!l)return;N(!0);const r={description:t.description,source:t.source,sku:t.sku,purchasePrice:t.purchasePrice,projectPrice:t.projectPrice||t.purchasePrice,marketValue:t.marketValue,paymentMethod:t.paymentMethod,space:t.space,notes:t.notes,transactionId:t.selectedTransactionId||void 0,lastUpdated:new Date().toISOString()};try{await P.updateItem(l,i,r);const m=new URLSearchParams(window.location.search).get("returnTo");u(m||`/project/${o}?tab=inventory`)}catch(c){console.error("Error updating item:",c),console.error("Form data being submitted:",r),console.error("Item ID:",i),console.error("Project ID:",o);let m="Failed to update item. Please try again.";c instanceof Error&&(c.message.includes("permission-denied")?m="Permission denied. Please check your access rights.":c.message.includes("not-found")?m="Item not found. It may have been deleted.":c.message.includes("network")?m="Network error. Please check your connection and try again.":m=`Update failed: ${c.message}`),h({submit:m})}finally{N(!1)}},d=(s,r)=>{console.log("Updating field:",s,"with value:",r),b(c=>{const m={...c,[s]:r};return console.log("New form data:",m),m}),s==="projectPrice"&&(F.current=!0),a[s]&&h(c=>({...c,[s]:""}))},$=s=>{b(r=>({...r,selectedTransactionId:s})),a.selectedTransactionId&&h(r=>({...r,selectedTransactionId:""}))};return V?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(x,{fallback:p(),className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Edit Item"})}),e.jsx("div",{className:"p-8",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-3/4 mb-4"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-1/2 mb-4"}),e.jsx("div",{className:"h-4 bg-gray-300 rounded w-2/3"})]})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(x,{fallback:p(),className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Edit Item"})}),e.jsx("div",{className:"px-6 py-4",children:e.jsx("div",{className:"px-6 py-4",children:e.jsxs("form",{onSubmit:L,className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description *"}),e.jsx("input",{type:"text",id:"description",value:t.description,onChange:s=>d("description",s.target.value),placeholder:"e.g., Wooden dining table, 6 chairs",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${a.description?"border-red-300":"border-gray-300"}`}),a.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:a.description})]}),e.jsxs(H,{label:"Associate with Transaction (Optional)",id:"selectedTransactionId",value:t.selectedTransactionId,onChange:s=>$(s.target.value),error:a.selectedTransactionId,disabled:j,children:[e.jsx("option",{value:"",children:"Select a transaction"}),j?e.jsx("option",{disabled:!0,children:"Loading transactions..."}):w.map(s=>e.jsxs("option",{value:s.transactionId,children:[new Date(s.transactionDate).toLocaleDateString()," - ",G(s)," - $",s.amount]},s.transactionId))]}),!j&&w.length===0&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No transactions available for this project"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Source"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 mb-3",children:y.map(s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`source_${s.toLowerCase().replace(/\s+/g,"_")}`,name:"source",value:s,checked:t.source===s,onChange:r=>{d("source",r.target.value),f(!1)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`source_${s.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:s})]},s))}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"source_custom",name:"source",value:"custom",checked:v,onChange:()=>{f(!0),d("source","")},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"source_custom",className:"ml-2 block text-sm text-gray-900",children:"Other"})]}),v&&e.jsx("input",{type:"text",id:"source_custom_input",value:t.source,onChange:s=>d("source",s.target.value),placeholder:"Enter custom source...",className:`mt-3 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${a.source?"border-red-300":"border-gray-300"}`}),a.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:a.source})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Payment Method"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-3",children:["Client Card",O].map(s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`payment_${s.toLowerCase().replace(/\s+/g,"_")}`,name:"paymentMethod",value:s,checked:t.paymentMethod===s,onChange:r=>{d("paymentMethod",r.target.value)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`payment_${s.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:s})]},s))}),a.paymentMethod&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:a.paymentMethod})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sku",className:"block text-sm font-medium text-gray-700",children:"SKU"}),e.jsx("input",{type:"text",id:"sku",value:t.sku,onChange:s=>d("sku",s.target.value),placeholder:"Product SKU or model number",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"purchasePrice",className:"block text-sm font-medium text-gray-700",children:"Purchase Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What the item was purchased for"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"purchasePrice",value:t.purchasePrice,onChange:s=>d("purchasePrice",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${a.purchasePrice?"border-red-300":"border-gray-300"}`})]}),a.purchasePrice&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:a.purchasePrice})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"projectPrice",className:"block text-sm font-medium text-gray-700",children:"Project Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What the client is charged (defaults to purchase price)"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"projectPrice",value:t.projectPrice,onChange:s=>d("projectPrice",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${a.projectPrice?"border-red-300":"border-gray-300"}`})]}),a.projectPrice&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:a.projectPrice})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"marketValue",className:"block text-sm font-medium text-gray-700",children:"Market Value"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"The fair market value of the item"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"marketValue",value:t.marketValue,onChange:s=>d("marketValue",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${a.marketValue?"border-red-300":"border-gray-300"}`})]}),a.marketValue&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:a.marketValue})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"space",className:"block text-sm font-medium text-gray-700",children:"Space"}),e.jsx("input",{type:"text",id:"space",value:t.space,onChange:s=>d("space",s.target.value),placeholder:"e.g., Living Room, Master Bedroom, Kitchen",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:t.notes,onChange:s=>d("notes",s.target.value),placeholder:"Additional notes about this item...",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),a.submit&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:e.jsx("p",{className:"text-sm text-red-600",children:a.submit})}),e.jsxs("div",{className:"hidden sm:flex justify-end sm:space-x-3 pt-4",children:[e.jsxs(x,{fallback:p(),className:"inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(C,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:g,className:"inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),g?"Saving...":"Save"]})]})]})})}),e.jsx("div",{className:"sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50",children:e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs(x,{fallback:p(),className:"flex-1 inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(C,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:g,onClick:s=>{var c;const r=(c=s.currentTarget.closest(".space-y-6"))==null?void 0:c.querySelector("form");r&&r.requestSubmit()},className:"flex-1 inline-flex justify-center items-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),g?"Saving...":"Save"]})]})})]}),e.jsx("div",{className:"sm:hidden h-20"})]})}export{ie as default};
//# sourceMappingURL=EditItem.js.map
