import{u as J,d as Q,e as Z,U as ee,j as e,l as se,h as te,i as re}from"./index.js";import{C as w}from"./ContextBackLink.js";import{u as ae}from"./useStackedNavigate.js";import{u as oe}from"./useNavigationContext.js";import{r as i}from"./vendor.js";import{p as ne,t as ie,u as ce}from"./inventoryService.js";import{I as V,g as D,a as F}from"./imageService.js";import{g as le}from"./vendorDefaultsService.js";import{S as de}from"./Select.js";import{I as me}from"./ImagePreview.js";import{b as ue}from"./router.js";import{d as pe,g as xe,b as R,t as L}from"./ui.js";import"./supabase.js";import"./taxPresetsService.js";const he=n=>{var y,u;return(y=n.transactionId)!=null&&y.startsWith("INV_SALE_")?te:(u=n.transactionId)!=null&&u.startsWith("INV_PURCHASE_")?re:n.source};function Ae(){const{id:n}=ue(),y=ae(),{getBackDestination:u}=oe(),{hasRole:O}=J(),{currentAccountId:d}=Q(),{showError:k}=Z(),[S,q]=i.useState("");if(!O(ee.USER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(pe,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to add items. Please contact an administrator if you need access."}),e.jsx(w,{fallback:u(`/project/${n}`),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Project"})]})});const[a,M]=i.useState({description:"",source:"",sku:"",purchasePrice:"",projectPrice:"",marketValue:"",paymentMethod:"",space:"",notes:"",disposition:"keep",selectedTransactionId:""}),[A,x]=i.useState(!1),[h,$]=i.useState([]),[I,B]=i.useState([]),[P,E]=i.useState(!1),[m,T]=i.useState([]),[b,j]=i.useState(!1),[p,g]=i.useState(0),W=i.useRef(!1),C=!!a.selectedTransactionId;i.useEffect(()=>{(async()=>{if(n&&d){E(!0);try{const t=await ne.getProject(d,n);t&&q(t.name);const r=await ie.getTransactions(d,n);B(r)}catch(t){console.error("Error fetching project and transactions:",t)}finally{E(!1)}}})()},[n,d]),i.useEffect(()=>{(async()=>{if(d)try{const t=await le(d);$(t)}catch(t){console.error("Error loading vendor defaults:",t),$([])}})()},[d]),i.useEffect(()=>{a.source&&!h.includes(a.source)?x(!0):a.source&&h.includes(a.source)&&x(!1)},[a.source,h]);const[o,v]=i.useState({}),[N,_]=i.useState(!1),Y=()=>{const s={};return a.description.trim()||(s.description="Description is required"),v(s),Object.keys(s).length===0},K=async s=>{if(s.preventDefault(),!(!Y()||!n)){_(!0);try{const t={...a,projectId:n,qrKey:`qr_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,bookmark:!1,projectPrice:a.projectPrice||a.purchasePrice,transactionId:a.selectedTransactionId||"",dateCreated:new Date().toISOString(),lastUpdated:new Date().toISOString(),disposition:a.disposition||"keep",...m.length>0&&{images:m}};if(!d){k("Account ID is required");return}await ce.createItem(d,t),y(`/project/${n}?tab=inventory`)}catch(t){console.error("Error creating item:",t),v({submit:"Failed to create item. Please try again."})}finally{_(!1)}}},l=(s,t)=>{M(r=>({...r,[s]:t})),s==="projectPrice"&&(W.current=!0),o[s]&&v(r=>({...r,[s]:""}))},z=s=>{const t=I.find(r=>r.transactionId===s);if(M(r=>({...r,selectedTransactionId:s,source:(t==null?void 0:t.source)||"",paymentMethod:(t==null?void 0:t.paymentMethod)||""})),t!=null&&t.source){const r=h.includes(t.source);x(!r)}o.selectedTransactionId&&v(r=>({...r,selectedTransactionId:""}))},G=async s=>{if(S)try{j(!0),g(0),console.log("Starting multiple image upload for",s.length,"files");const t=await V.uploadMultipleItemImages(s,S,"new-item",(c,f)=>{const X=Math.round((c+f.percentage/100)/s.length*100);g(X)});console.log("All uploads completed successfully:",t.length,"images");const r=t.map((c,f)=>({url:c.url,alt:c.fileName,isPrimary:m.length===0&&f===0,uploadedAt:new Date,fileName:c.fileName,size:c.size,mimeType:c.mimeType}));console.log("New image objects created:",r.length),T(c=>[...c,...r]),g(100),console.log("Multiple image upload completed successfully")}catch(t){console.error("Error uploading multiple images:",t);const r=D(t),c=F(t);k(`${r} Suggestion: ${c}`)}finally{j(!1),g(0)}},U=async()=>{var s,t;if(S)try{j(!0);const r=await V.selectFromGallery();r&&r.length>0?(console.log("Selected",r.length,"files from gallery"),await G(r)):console.log("No files selected from gallery")}catch(r){if(console.error("Error selecting from gallery:",r),(s=r.message)!=null&&s.includes("timeout")||(t=r.message)!=null&&t.includes("canceled")){console.log("User canceled image selection or selection timed out");return}const c=D(r),f=F(r);k(`${c} Suggestion: ${f}`)}finally{j(!1),g(0)}},H=async s=>{T(t=>t.filter(r=>r.url!==s))};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(w,{fallback:u(`/project/${n}?tab=inventory`),className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(xe,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Add Item"})}),e.jsxs("form",{onSubmit:K,className:"space-y-8 p-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Item Images"}),m.length>0&&e.jsx("button",{onClick:U,disabled:b||m.length>=5,className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:b?p>0&&p<100?`Uploading... ${Math.round(p)}%`:"Uploading...":m.length>=5?"Max reached":"Add Images"})]}),m.length>0?e.jsx(me,{images:m,onRemoveImage:H,maxImages:5,size:"md",showControls:!0}):e.jsxs("div",{className:"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"No images for this item yet"}),e.jsx("button",{onClick:U,disabled:b,className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:b?p>0&&p<100?`Uploading... ${Math.round(p)}%`:"Uploading...":"Add Images"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description *"}),e.jsx("input",{type:"text",id:"description",value:a.description,onChange:s=>l("description",s.target.value),placeholder:"e.g., Wooden dining table, 6 chairs",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.description?"border-red-300":"border-gray-300"}`}),o.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.description})]}),e.jsxs(de,{label:"Associate with Transaction",id:"selectedTransactionId",value:a.selectedTransactionId,onChange:s=>z(s.target.value),error:o.selectedTransactionId,disabled:P,children:[e.jsx("option",{value:"",children:"Select a transaction"}),P?e.jsx("option",{disabled:!0,children:"Loading transactions..."}):I.map(s=>e.jsxs("option",{value:s.transactionId,children:[new Date(s.transactionDate).toLocaleDateString()," - ",he(s)," - $",s.amount]},s.transactionId))]}),!P&&I.length===0&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No transactions available for this project"}),C&&e.jsxs("div",{className:"mt-2 p-3 bg-primary-50 border border-primary-100 rounded-md",children:[e.jsxs("p",{className:"text-sm text-primary-700",children:[e.jsx("strong",{children:"Source:"})," ",a.source," |",e.jsx("strong",{children:" Payment Method:"})," ",a.paymentMethod]}),e.jsx("p",{className:"text-xs text-primary-600 mt-1",children:"These values are automatically filled from the selected transaction"})]}),!C&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Source"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 mb-3",children:h.map(s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`source_${s.toLowerCase().replace(/\s+/g,"_")}`,name:"source",value:s,checked:a.source===s,onChange:t=>{l("source",t.target.value),x(!1)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`source_${s.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:s})]},s))}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"source_custom",name:"source",value:"custom",checked:A,onChange:()=>{x(!0),l("source","")},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"source_custom",className:"ml-2 block text-sm text-gray-900",children:"Other"})]}),A&&e.jsx("input",{type:"text",id:"source_custom_input",value:a.source,onChange:s=>l("source",s.target.value),placeholder:"Enter custom source...",className:`mt-3 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.source?"border-red-300":"border-gray-300"}`}),o.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.source})]}),!C&&a.source!=="Inventory"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Payment Method"}),e.jsx("div",{className:"flex items-center space-x-6 mb-3",children:["Client Card",se].map(s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`payment_${s.toLowerCase().replace(/\s+/g,"_")}`,name:"paymentMethod",value:s,checked:a.paymentMethod===s,onChange:t=>{l("paymentMethod",t.target.value)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`payment_${s.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:s})]},s))}),o.paymentMethod&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.paymentMethod})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sku",className:"block text-sm font-medium text-gray-700",children:"SKU"}),e.jsx("input",{type:"text",id:"sku",value:a.sku,onChange:s=>l("sku",s.target.value),placeholder:"Product SKU or model number",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"purchasePrice",className:"block text-sm font-medium text-gray-700",children:"Purchase Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What the item was purchased for"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"purchasePrice",value:a.purchasePrice,onChange:s=>l("purchasePrice",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.purchasePrice?"border-red-300":"border-gray-300"}`})]}),o.purchasePrice&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.purchasePrice})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"projectPrice",className:"block text-sm font-medium text-gray-700",children:"Project Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What the client is charged (defaults to purchase price)"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"projectPrice",value:a.projectPrice,onChange:s=>l("projectPrice",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.projectPrice?"border-red-300":"border-gray-300"}`})]}),o.projectPrice&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.projectPrice})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"marketValue",className:"block text-sm font-medium text-gray-700",children:"Market Value"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"The fair market value of the item"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"marketValue",value:a.marketValue,onChange:s=>l("marketValue",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.marketValue?"border-red-300":"border-gray-300"}`})]}),o.marketValue&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.marketValue})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"space",className:"block text-sm font-medium text-gray-700",children:"Space"}),e.jsx("input",{type:"text",id:"space",value:a.space,onChange:s=>l("space",s.target.value),placeholder:"e.g., Living Room, Master Bedroom, Kitchen",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"disposition",className:"block text-sm font-medium text-gray-700",children:"Disposition"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What happens to this item after the project"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"disposition",value:a.disposition,onChange:s=>l("disposition",s.target.value),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500",children:[e.jsx("option",{value:"keep",children:"Keep"}),e.jsx("option",{value:"to return",children:"To Return"}),e.jsx("option",{value:"returned",children:"Returned"}),e.jsx("option",{value:"inventory",children:"Inventory"})]})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:a.notes,onChange:s=>l("notes",s.target.value),placeholder:"Additional notes about this item...",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),o.submit&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:e.jsx("p",{className:"text-sm text-red-600",children:o.submit})}),e.jsxs("div",{className:"hidden sm:flex justify-end sm:space-x-3 pt-4",children:[e.jsxs(w,{fallback:u(`/project/${n}?tab=inventory`),className:"inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:N,className:"inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),N?"Creating...":"Create"]})]})]})]}),e.jsx("div",{className:"sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50",children:e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs(w,{fallback:u(`/project/${n}?tab=inventory`),className:"flex-1 inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:N,onClick:s=>{var r;const t=(r=s.currentTarget.closest(".space-y-6"))==null?void 0:r.querySelector("form");t&&t.requestSubmit()},className:"flex-1 inline-flex justify-center items-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),N?"Creating...":"Create"]})]})}),e.jsx("div",{className:"sm:hidden h-20"})]})}export{Ae as default};
//# sourceMappingURL=AddItem.js.map
