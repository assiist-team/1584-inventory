import{u as K,a as H,U as X,j as e}from"./index.js";import{c as Y,u as J,L as N}from"./router.js";import{r as i}from"./vendor.js";import{t as Q,c as Z}from"./inventoryService.js";import{I as D,g as F,a as R}from"./imageService.js";import{T as I}from"./transactionSources.js";import{S as ee}from"./Select.js";import{I as se}from"./ImagePreview.js";import{o as re,e as te,b as M,p as L}from"./ui.js";import"./firebase.js";const ae=u=>{var p,g;return(p=u.transaction_id)!=null&&p.startsWith("INV_SALE_")?"1584 Inventory Sale":(g=u.transaction_id)!=null&&g.startsWith("INV_PURCHASE_")?"1584 Inventory Purchase":u.source};function xe(){const u=Y(),p=J(),{hasRole:g}=K(),{showError:k}=H(),f=i.useMemo(()=>{const r=new URLSearchParams(p.search).get("returnTo");return r||"/business-inventory"},[p.search]);if(!g(X.DESIGNER))return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full space-y-8 text-center",children:[e.jsx("div",{className:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-red-100",children:e.jsx(re,{className:"h-6 w-6 text-red-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to add items. Please contact an administrator if you need access."}),e.jsx(N,{to:f,className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Back to Business Inventory"})]})});const[a,_]=i.useState({description:"",source:"",sku:"",purchase_price:"",project_price:"",market_value:"",notes:"",business_inventory_location:"",selectedTransactionId:""}),[C,h]=i.useState(!1),[w,B]=i.useState([]),[S,T]=i.useState(!1),[l,E]=i.useState([]),[y,b]=i.useState(!1),[m,x]=i.useState(0),$=i.useRef(!1),P=!!a.selectedTransactionId;i.useEffect(()=>{(async()=>{T(!0);try{const r=[],t=await Q.getInventoryRelatedTransactions();r.push(...t),r.sort((n,d)=>new Date(d.created_at).getTime()-new Date(n.created_at).getTime()),B(r)}catch(r){console.error("Error fetching transactions:",r)}finally{T(!1)}})()},[]),i.useEffect(()=>{const s=I;a.source&&!s.includes(a.source)?h(!0):a.source&&s.includes(a.source)&&h(!1)},[a.source]),i.useEffect(()=>{a.purchase_price&&!a.project_price&&!$.current&&_(s=>({...s,project_price:a.purchase_price}))},[a.purchase_price]);const[o,j]=i.useState({}),[v,U]=i.useState(!1),O=()=>{const s={};return a.description.trim()||(s.description="Description is required"),j(s),Object.keys(s).length===0},W=async s=>{if(s.preventDefault(),!!O()){U(!0);try{const r={...a,qr_key:`qr_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,bookmark:!1,transaction_id:a.selectedTransactionId||"",inventory_status:"available",payment_method:"Cash",date_created:new Date().toISOString(),last_updated:new Date().toISOString(),...l.length>0&&{images:l}},t=await Z.createBusinessInventoryItem(r);u(`/business-inventory/${t}`)}catch(r){console.error("Error creating item:",r),j({submit:"Failed to create item. Please try again."})}finally{U(!1)}}},c=(s,r)=>{_(t=>({...t,[s]:r})),s==="project_price"&&($.current=!0),o[s]&&j(t=>({...t,[s]:""}))},q=s=>{const r=w.find(t=>t.transaction_id===s);if(_(t=>({...t,selectedTransactionId:s,source:(r==null?void 0:r.source)||""})),r!=null&&r.source){const t=I.includes(r.source);h(!t)}o.selectedTransactionId&&j(t=>({...t,selectedTransactionId:""}))},z=async s=>{try{b(!0),x(0),console.log("Starting multiple image upload for",s.length,"files");const r=await D.uploadMultipleItemImages(s,"Business Inventory","new-item",(n,d)=>{const V=Math.round((n+d.percentage/100)/s.length*100);x(V)});console.log("All uploads completed successfully:",r.length,"images");const t=r.map((n,d)=>({url:n.url,alt:n.fileName,isPrimary:l.length===0&&d===0,uploadedAt:new Date,fileName:n.fileName,size:n.size,mimeType:n.mimeType}));console.log("New image objects created:",t.length),E(n=>[...n,...t]),x(100),console.log("Multiple image upload completed successfully")}catch(r){console.error("Error uploading multiple images:",r);const t=F(r),n=R(r);k(`${t} Suggestion: ${n}`)}finally{b(!1),x(0)}},A=async()=>{var s,r;try{b(!0);const t=await D.selectFromGallery();t&&t.length>0?(console.log("Selected",t.length,"files from gallery"),await z(t)):console.log("No files selected from gallery")}catch(t){if(console.error("Error selecting from gallery:",t),(s=t.message)!=null&&s.includes("timeout")||(r=t.message)!=null&&r.includes("canceled")){console.log("User canceled image selection or selection timed out");return}const n=F(t),d=R(t);k(`${n} Suggestion: ${d}`)}finally{b(!1),x(0)}},G=async s=>{E(r=>r.filter(t=>t.url!==s))};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs(N,{to:f,className:"inline-flex items-center text-sm font-medium text-gray-500 hover:text-gray-700",children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),"Back"]})})}),e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Add Item"})}),e.jsxs("form",{onSubmit:W,className:"space-y-8 p-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Item Images"}),l.length>0&&e.jsx("button",{onClick:A,disabled:y||l.length>=5,className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:y?m>0&&m<100?`Uploading... ${Math.round(m)}%`:"Uploading...":l.length>=5?"Max reached":"Add Images"})]}),l.length>0?e.jsx(se,{images:l,onRemoveImage:G,maxImages:5,size:"md",showControls:!0}):e.jsxs("div",{className:"text-center py-8 border-2 border-dashed border-gray-300 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-3",children:"No images for this item yet"}),e.jsx("button",{onClick:A,disabled:y,className:"inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50",children:y?m>0&&m<100?`Uploading... ${Math.round(m)}%`:"Uploading...":"Add Images"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Description *"}),e.jsx("input",{type:"text",id:"description",value:a.description,onChange:s=>c("description",s.target.value),placeholder:"e.g., Wooden dining table, 6 chairs",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.description?"border-red-300":"border-gray-300"}`}),o.description&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.description})]}),e.jsxs(ee,{label:"Associate with Transaction",id:"selectedTransactionId",value:a.selectedTransactionId,onChange:s=>q(s.target.value),error:o.selectedTransactionId,disabled:S,children:[e.jsx("option",{value:"",children:"Select a transaction"}),S?e.jsx("option",{disabled:!0,children:"Loading transactions..."}):w.map(s=>e.jsxs("option",{value:s.transaction_id,children:[new Date(s.transaction_date).toLocaleDateString()," - ",ae(s)," - $",s.amount]},s.transaction_id))]}),!S&&w.length===0&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No transactions available"}),P&&e.jsxs("div",{className:"mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md",children:[e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Source:"})," ",a.source]}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"These values are automatically filled from the selected transaction"})]}),!P&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Source"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3 mb-3",children:I.map(s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:`source_${s.toLowerCase().replace(/\s+/g,"_")}`,name:"source",value:s,checked:a.source===s,onChange:r=>{c("source",r.target.value),h(!1)},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:`source_${s.toLowerCase().replace(/\s+/g,"_")}`,className:"ml-2 block text-sm text-gray-900",children:s})]},s))}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",id:"source_custom",name:"source",value:"custom",checked:C,onChange:()=>{h(!0),c("source","")},className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"source_custom",className:"ml-2 block text-sm text-gray-900",children:"Other"})]}),C&&e.jsx("input",{type:"text",id:"source_custom_input",value:a.source,onChange:s=>c("source",s.target.value),placeholder:"Enter custom source...",className:`mt-3 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.source?"border-red-300":"border-gray-300"}`}),o.source&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.source})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sku",className:"block text-sm font-medium text-gray-700",children:"SKU"}),e.jsx("input",{type:"text",id:"sku",value:a.sku,onChange:s=>c("sku",s.target.value),placeholder:"Product SKU or model number",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"purchase_price",className:"block text-sm font-medium text-gray-700",children:"Purchase Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What the item was purchased for"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"purchase_price",value:a.purchase_price,onChange:s=>c("purchase_price",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.purchase_price?"border-red-300":"border-gray-300"}`})]}),o.purchase_price&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.purchase_price})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"project_price",className:"block text-sm font-medium text-gray-700",children:"Project Price"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"What the client is charged (defaults to purchase price)"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"project_price",value:a.project_price,onChange:s=>c("project_price",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.project_price?"border-red-300":"border-gray-300"}`})]}),o.project_price&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.project_price})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"market_value",className:"block text-sm font-medium text-gray-700",children:"Market Value"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 mb-2",children:"The fair market value of the item"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"text",id:"market_value",value:a.market_value,onChange:s=>c("market_value",s.target.value),placeholder:"0.00",className:`block w-full pl-8 pr-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.market_value?"border-red-300":"border-gray-300"}`})]}),o.market_value&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.market_value})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"business_inventory_location",className:"block text-sm font-medium text-gray-700",children:"Storage Location"}),e.jsx("input",{type:"text",id:"business_inventory_location",value:a.business_inventory_location,onChange:s=>c("business_inventory_location",s.target.value),placeholder:"e.g., Warehouse A - Section 3 - Shelf 5",className:`mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 ${o.business_inventory_location?"border-red-300":"border-gray-300"}`}),o.business_inventory_location&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:o.business_inventory_location})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700",children:"Notes"}),e.jsx("textarea",{id:"notes",rows:3,value:a.notes,onChange:s=>c("notes",s.target.value),placeholder:"Additional notes about this item...",className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500"})]}),o.submit&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:e.jsx("p",{className:"text-sm text-red-600",children:o.submit})}),e.jsxs("div",{className:"hidden sm:flex justify-end sm:space-x-3 pt-4",children:[e.jsxs(N,{to:f,className:"inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:v,className:"inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),v?"Creating...":"Create"]})]})]})]}),e.jsx("div",{className:"sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50",children:e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs(N,{to:f,className:"flex-1 inline-flex justify-center items-center px-4 py-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:[e.jsx(M,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs("button",{type:"submit",disabled:v,onClick:s=>{var t;const r=(t=s.currentTarget.closest(".space-y-6"))==null?void 0:t.querySelector("form");r&&r.requestSubmit()},className:"flex-1 inline-flex justify-center items-center px-4 py-3 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),v?"Creating...":"Create"]})]})}),e.jsx("div",{className:"sm:hidden h-20"})]})}export{xe as default};
//# sourceMappingURL=AddBusinessInventoryItem.js.map
